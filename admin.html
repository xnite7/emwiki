<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #2e2e2e, #1e1e1e);
      margin: 0;
      color: white;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .title {

      text-align: center;
    }
    p{
      text-align: center;
    }

    #save-btn {
  background: #3a3a3a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  margin: 0 auto 20px;
  display: block;
  transition: background 0.2s;
}

#save-btn:hover {
  background: #505050;
}


    .grid {
      width: 564px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .gridall {

      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    .item-card {
      background: #3a3a3a;
      border-radius: 16px;
      padding: 10px;
      text-align: center;
      cursor: grab;
      transition: background 0.2s;
    }

    .item-card img {
      max-width: 100%;
      border-radius: 8px;
    }

    .item-card span {
      display: block;
      margin-top: 5px;
      font-size: 14px;
    }

    .panel {
      margin-bottom: 40px;
    }

    .search-bar {
      margin-bottom: 10px;
    }

    .pagination {
      margin-top: 10px;
      text-align: center;
    }

    .pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .title {
      font-size: 18px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
    <div class="title">Drag & Drop Items</div>
    <p>Drag items to the appropriate lists below.</p>
  <div class="panel" style="display: flex;justify-items: stretch;justify-content: space-evenly;">

  <div class="panel">
    <div class="title">New Items</div>
    <div class="grid" id="new-items" ondrop="dropFlag(event, 'new')" ondragover="allowDrop(event)"></div>
  </div>

  <div class="panel">
    <div class="title">Weekly Items</div>
    <div class="grid" id="weekly-items" ondrop="dropFlag(event, 'weekly')" ondragover="allowDrop(event)"></div>
  </div>

  <div class="panel">
    <div class="title">Weekly Starshop Items</div>
    <div class="grid" id="weeklystar-items" ondrop="dropFlag(event, 'weeklystar')" ondragover="allowDrop(event)"></div>
  </div>
  </div>



  <div class="panel" style="display: grid;justify-items: center;">
    <div class="search-bar">
      <input type="text" id="search" placeholder="Search items..." />
    </div>
    <div class="gridall" id="all-items" ondrop="dropFlag(event, null)" ondragover="allowDrop(event)"></div>
    <div class="pagination" id="pagination"></div>
  </div>



  <button id="save-btn">💾 Save Changes</button>


  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>
    let jsData = {};
    let filteredItems = [];
    let currentPage = 0;
    const ITEMS_PER_PAGE = 16;

    async function loadData() {
      const res = await fetch("https://gist.githubusercontent.com/xnite7/0d0a3800287f3e7c6e5e944c8337fa91/raw/auto.json");
      jsData = await res.json();
      setupSearch();
      renderLists();
    }
    document.getElementById("save-btn").addEventListener("click", async () => {
  try {
    const response = await fetch("/api/update-gist", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        username: prompt("Enter your name to save changes:"), // Or replace with auth
        content: jsData
      })

    });

    if (response.ok) {
      alert("✅ Changes saved successfully.");
    } else {
      alert("❌ Failed to save changes.");
    }
  } catch (err) {
    alert("⚠️ Error saving changes: " + err.message);
  }
});


    function getAllItems() {
      return Object.values(jsData).flat();
    }

    function setupSearch() {
      const allItems = getAllItems();
      const fuse = new Fuse(allItems, {
        keys: ["name"],
        threshold: 0.4,
      });

      const input = document.getElementById("search");
      input.addEventListener("input", () => {
        const query = input.value.trim();
        filteredItems = query ? fuse.search(query).map(r => r.item) : allItems;
        currentPage = 0;
        renderAllItems();
      });

      filteredItems = allItems;
      renderAllItems();
    }

    function renderLists() {
      const newEl = document.getElementById("new-items");
      const weeklyEl = document.getElementById("weekly-items");
      const starEl = document.getElementById("weeklystar-items");

      newEl.innerHTML = "";
      weeklyEl.innerHTML = "";
      starEl.innerHTML = "";

      for (const type in jsData) {
        jsData[type].forEach(item => {
          if (item.new) newEl.appendChild(makeCard(item, "new"));
          if (item.weekly) weeklyEl.appendChild(makeCard(item, "weekly"));
          if (item.weeklystar) starEl.appendChild(makeCard(item, "weeklystar"));
        });
      }
    }

    function renderAllItems() {
      const container = document.getElementById("all-items");
      container.innerHTML = "";

      const start = currentPage * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const itemsToShow = filteredItems.slice(start, end);

      itemsToShow.forEach(item => {
        container.appendChild(makeCard(item, null));
      });

      renderPagination();
    }

    function renderPagination() {
      const total = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      for (let i = 0; i < total; i++) {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        if (i === currentPage) btn.style.background = "#666";
        btn.onclick = () => {
          currentPage = i;
          renderAllItems();
        };
        container.appendChild(btn);
      }
    }

    function makeCard(item, flag) {
      const div = document.createElement("div");
      div.className = "item-card";
      div.draggable = true;
      div.ondragstart = (e) => drag(e, item, flag);

      const imgSrc = item.img || "./imgs/trs.png"; // Use default or placeholder image
      div.innerHTML = `<img src="${imgSrc}" alt="${item.name}" onerror="this.style.display='none'" /><span>${item.name}</span>`;

      return div;
    }


    function drag(ev, item, flag) {
      ev.dataTransfer.setData("text/plain", flag ? `${item.name}|${flag}` : `${item.name}|`);
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function dropFlag(ev, targetFlag) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text/plain");
      const [itemName, fromFlag] = data.split("|");

      for (const type in jsData) {
        const item = jsData[type].find(i => i.name === itemName);
        if (!item) continue;

        if (!targetFlag && fromFlag) {
          // Dragged into All Items → remove flag
          item[fromFlag] = false;
        } else if (targetFlag && !item[targetFlag]) {
          // Add to new list if not already present
          item[targetFlag] = true;
        }
      }

      renderLists();
    }

    loadData();
  </script>
</body>
</html>
