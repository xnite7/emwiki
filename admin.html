<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <link rel="icon" href="./imgs/admin.png" type="image/png" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #2e2e2e, #1e1e1e);
      margin: 0;
      color: white;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .title1 {
      text-align: center;
      background: #3f3f3f;
      padding: 19px 0 12px;
      color: #b7b7b7;
      border-radius: 17px;
    }
    .title {
      text-align: center;
      font: 600 22px 'Segoe UI';
      color: #d5d5d5;
      background: #1a1a1a;
      border-radius: 20px 20px 0 0;
      padding: 12px 0;
    }
    #save-btn {
      position: fixed;
      background: #ffd80c;
      color: #000;
      outline: 2px solid #fff;
      font-weight: 800;
      font-family: monospace;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      top: 20px;
      font-size: 20px;
      right: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #save-btn:hover {
      background: rgb(221, 169, 0);
    }
    .grid {
      border-radius: 0 0 20px 20px;
      background: #1a1a1a;
      padding: 20px;
      width: 517px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .gridall {
      border-radius: 20px;
      background: #1a1a1a;
      padding: 20px;
      width: -webkit-fill-available;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .item-card {
      background: #3a3a3a;
      border-radius: 16px;
      padding: 10px;
      text-align: center;
      cursor: grab;
      transition: background 0.2s;
    }
    .item-card img {
      max-width: 100%;
      border-radius: 8px;
      user-select: none;
    }
    .item-card span {
      display: block;
      margin-top: 5px;
      font-size: 14px;
    }
    .panel {
      margin: 20px;
      flex: 0 1 18%;
    }
    .search-bar {
      width: -webkit-fill-available;
      margin-bottom: 20px;
    }
    #pagination-container {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
    }
    #pagination-container button, #page-select {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #444;
      color: white;
      cursor: pointer;
    }
    #pagination-container button:disabled {
      background: #222;
      opacity: 0.5;
      cursor: default;
    }
    #page-count {
      margin-left: 16px;
      font-weight: 600;
      opacity: 0.7;
      font-size: 14px;
    }
    #tab-switcher {
      text-align: center;
      margin-bottom: 20px;
    }
    #tab-switcher button {
      margin: 0 5px;
      padding: 10px 15px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      background: #444;
      color: white;
      cursor: pointer;
    }
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #2e2e2e, #1e1e1e);
      color: white;
      margin: 0;
      padding: 0;
    }
    #tab-switcher {
      text-align: center;
      margin: 20px;
    }
    #tab-switcher button {
      margin: 0 10px;
      padding: 10px 20px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #tab-switcher button:hover {
      background-color: #666;
    }
    .search-sort-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px auto;
      max-width: 600px;
    }
    .search-sort-controls input, .search-sort-controls select {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    .item-card.flash {
      outline: 2px solid #ffd80c;
      animation: flashOutline 0.4s ease;
    }

    @keyframes flashOutline {
      0% {
        outline-color: #ffd80c;
        outline-offset: 0px;
      }
      100% {
        outline-color: transparent;
        outline-offset: 6px;
      }
    }

  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <div id="tab-switcher">
    <button onclick="switchTab('main')">🧩 Item Lists</button>
    <button onclick="switchTab('prices')">💰 Prices</button>
  </div>

  <div id="main-tab">
    <div class="title1">List Configurator<p>Drag items to the appropriate lists below.</p></div>
    <div class="panel" style="display: flex; flex-wrap: wrap; justify-content: space-evenly;">
      <div class="panel">
        <div class="title">New Items</div>
        <div class="grid" id="new-items" ondrop="dropFlag(event, 'new')" ondragover="allowDrop(event)"></div>
      </div>
      <div class="panel">
        <div class="title">Weekly Shop</div>
        <div class="grid" id="weekly-items" ondrop="dropFlag(event, 'weekly')" ondragover="allowDrop(event)"></div>
      </div>
      <div class="panel">
        <div class="title">Weekly Star Shop</div>
        <div class="grid" id="weeklystar-items" ondrop="dropFlag(event, 'weeklystar')" ondragover="allowDrop(event)"></div>
      </div>
    </div>
    <div class="panel" style="display: grid; justify-items: center;">
      <div class="search-bar">
        <input type="text" style="background:black; padding:8px; width:98%; border:2px solid #5b5b5b; font-size:20px; font-family:monospace; border-radius:14px; color:#d7d7d7;" id="search" placeholder="Search items..." />
      </div>
      <div class="gridall" id="all-items" ondrop="dropFlag(event, null)" ondragover="allowDrop(event)"></div>
      <div id="page-count">Page 1 of 1</div>
      <div id="pagination-container">
        <button id="prev-btn">&lt; Prev</button>
        <select id="page-select"></select>
        <button id="next-btn">Next &gt;</button>
      </div>
    </div>
  </div>

<div id="prices-tab" style="display: none; padding: 10px;">
    <h2 style="text-align:center;">💰 Item Prices</h2>
    <div class="search-sort-controls">
      <input type="text" id="price-search" placeholder="Search item name...">
      <select id="sort-select" onchange="renderPriceGroups()">
        <option value="default">Sort by Group</option>
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
        <option value="high">Price High → Low</option>
        <option value="low">Price Low → High</option>
      </select>
    </div>
    <div id="price-groups" style="display:flex; flex-direction:column; gap: 30px;"></div>

  </div>

  <button id="save-btn">💾 Save Changes</button>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>


const STORED_HASH = "16740bf13991fe083fbe5820cc8da08a5d88e5a48f44a3cfcc283c27b2797ba7"; // Replace with your actual SHA-256 hash of the password

async function promptPassword() {
  while (true) {
    const enteredPassword = prompt("Enter admin password:");
    if (enteredPassword === null) {
      alert("Login cancelled. Access denied.");
      throw new Error("Login cancelled");
    }
    const encoder = new TextEncoder();
    const data = encoder.encode(enteredPassword);
    const hashBuffer = await window.crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    if (hashHex === STORED_HASH) {

      break;
    } else {
      alert("❌ Invalid password, please try again.");
    }
  }
}

// Run password prompt before loading any data
promptPassword().then(() => {
  loadData();
  window.addEventListener("load", renderPriceGroups);
}).catch(() => {
  // block everything if login fails or cancelled
  document.body.innerHTML = "<h2 style='color:red; text-align:center; margin-top: 40px;'>Access denied.</h2>";
});









  let fusePrice = null;

  let allPriceItems = [];
  let jsData = {};
  let filteredItems = [];
  let currentPage = 1;
  const ITEMS_PER_PAGE = 16;

  function switchTab(tab) {
    document.getElementById("main-tab").style.display = tab === "main" ? "block" : "none";
    document.getElementById("prices-tab").style.display = tab === "prices" ? "block" : "none";
  }

  async function loadData() {
    const res = await fetch("https://gist.githubusercontent.com/xnite7/0d0a3800287f3e7c6e5e944c8337fa91/raw/auto.json");
    jsData = await res.json();
    cacheAllPriceItems();

    setupSearch();
    renderLists();
    renderPriceGroups();
  }

  document.getElementById("save-btn").addEventListener("click", async () => {
    try {
      const response = await fetch("https://emwiki.site/api/update-gist", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: prompt("Enter your name to save changes:"),
          content: jsData,
        }),
      });
      alert(response.ok ? "✅ Changes saved successfully." : "❌ Failed to save changes.");
    } catch (err) {
      alert("⚠️ Error saving changes: " + err.message);
    }
  });

  function getAllItems() {
    return Object.values(jsData).flat();
  }

  function setupSearch() {
    const allItems = getAllItems();
    const fuse = new Fuse(allItems, { keys: ["name"], threshold: 0.4 });
    const input = document.getElementById("search");
    input.addEventListener("input", () => {
      const query = input.value.trim();
      filteredItems = query ? fuse.search(query).map(r => r.item) : allItems;
      currentPage = 1;
      renderAllItems();
    });
    filteredItems = allItems;
    renderAllItems();
  }

  function renderLists() {
    const newEl = document.getElementById("new-items");
    const weeklyEl = document.getElementById("weekly-items");
    const starEl = document.getElementById("weeklystar-items");
    newEl.innerHTML = weeklyEl.innerHTML = starEl.innerHTML = "";
    for (const type in jsData) {
      jsData[type].forEach(item => {
        if (item.new) newEl.appendChild(makeCard(item, "new"));
        if (item.weekly) weeklyEl.appendChild(makeCard(item, "weekly"));
        if (item.weeklystar) starEl.appendChild(makeCard(item, "weeklystar"));
      });
    }
  }

  function renderAllItems() {
    const container = document.getElementById("all-items");
    container.innerHTML = "";
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    filteredItems.slice(start, end).forEach(item => container.appendChild(makeCard(item)));
    renderPagination();
  }

  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  const pageSelect = document.getElementById("page-select");
  const pageCount = document.getElementById("page-count");

  function populatePageSelect(totalPages) {
    pageSelect.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${i}`;
      pageSelect.appendChild(option);
    }
  }

  function updatePaginationUI() {
    const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE));
    if (currentPage > totalPages) currentPage = totalPages;
    pageSelect.value = currentPage;
    pageCount.textContent = `Page ${currentPage} of ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
  }

  function cacheAllPriceItems() {
    allPriceItems = [];
    for (const type in jsData) {
      allPriceItems.push(...jsData[type]);
    }
    fusePrice = new Fuse(allPriceItems, {
      keys: ["name"],
      threshold: 0.4,
      ignoreLocation: true,
    });
  }

  function renderPagination() {
    const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE));
    if (pageSelect.options.length !== totalPages) populatePageSelect(totalPages);
    updatePaginationUI();
  }

  prevBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderAllItems();
    }
  };
  nextBtn.onclick = () => {
    const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE));
    if (currentPage < totalPages) {
      currentPage++;
      renderAllItems();
    }
  };
  pageSelect.onchange = e => {
    currentPage = Number(e.target.value);
    renderAllItems();
  };

  function makeCard(item, flag) {
    const div = document.createElement("div");
    div.dataset.id = item.id;
    div.className = "item-card";
    div.draggable = true;
    div.ondragstart = e => drag(e, item, flag);
    const imgSrc = item.img || "./imgs/trs.png";
    div.innerHTML = `
      <img draggable="false" src="${imgSrc}" alt="${item.name}" onerror="this.style.display='none'" />
      <span>${item.name}</span>
      <span class="item-price" style="color:#ffd80c;font-size:12px;">
        ${item.price ? item.price + ' 🪙' : ''}
      </span>
    `;
    return div;
  }

  function drag(ev, item, flag) {
    ev.dataTransfer.setData("text/plain", flag ? `${item.name}|${flag}` : `${item.name}|`);
  }

  function allowDrop(ev) {
    ev.preventDefault();
  }

  function dropFlag(ev, targetFlag) {
    ev.preventDefault();
    const [itemName, fromFlag] = ev.dataTransfer.getData("text/plain").split("|");
    for (const type in jsData) {
      const item = jsData[type].find(i => i.name === itemName);
      if (!item) continue;
      if (!targetFlag && fromFlag) item[fromFlag] = false;
      else if (targetFlag && !item[targetFlag]) item[targetFlag] = true;
    }
    renderLists();
  }

  function renderPriceGroups() {
    const container = document.getElementById("price-groups");
    const search = document.getElementById("price-search").value.toLowerCase();
    const sort = document.getElementById("sort-select").value;
    container.innerHTML = "";

    let items = allPriceItems;

    let topMatch = null;
    if (search) {
      const fuseResults = fusePrice.search(search, { limit: 50 });
      items = fuseResults.map(r => r.item);
      topMatch = items.length > 0 ? items[0] : null;
      renderTopMatchEditor(topMatch);
      if (topMatch) {
        items = items.filter(i => i !== topMatch);
      }
    } else {
      renderTopMatchEditor(null);
    }

    if (!search) {
      if (sort === "az") items.sort((a, b) => a.name.localeCompare(b.name));
      else if (sort === "za") items.sort((a, b) => b.name.localeCompare(a.name));
      else if (sort === "high") items.sort((a, b) => (b.price || 0) - (a.price || 0));
      else if (sort === "low") items.sort((a, b) => (a.price || 0) - (b.price || 0));
    }

    const groups = sort === "default" ? {
      "1000+": [],
      "500–999": [],
      "1–499": [],
      "0 (unpriced)": []
    } : { All: items };

    if (sort === "default") {
      for (const item of items) {
        const price = parseInt(item.price || 0);
        if (isNaN(price) || price === 0) groups["0 (unpriced)"].push(item);
        else if (price >= 1000) groups["1000+"].push(item);
        else if (price >= 500) groups["500–999"].push(item);
        else groups["1–499"].push(item);
      }
    }

    for (const label in groups) {
      const section = document.createElement("div");
      section.innerHTML = `
        <div style="font-weight:bold; font-size:20px; color:#ffd80c;">${label}</div>
        <div style="width: 100%;height: 4px;background: #ffd80c;"></div>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>
      `;
      const itemGrid = section.querySelector("div:last-child");

      for (const item of groups[label]) {
        const card = document.createElement("div");
        card.style.cssText = "background: #3a3a3a; padding: 10px; border-radius: 12px; width: 110px; text-align: center; font-size: 13px; display: flex; flex-direction: column; align-items: center;";
        card.dataset.id = item.id;

        const img = document.createElement("img");
        img.src = item.img || "./imgs/trs.png";
        img.alt = item.name;
        img.style = "max-width: 80px; max-height: 80px; border-radius: 6px; margin-bottom: 4px;";
        img.onerror = () => (img.style.display = "none");
        img.draggable = false;

        const name = document.createElement("div");
        name.textContent = item.name;
        name.style = "margin-bottom: 6px;";


        const input = document.createElement("input");
        input.type = "number";
        input.min = 0;
        input.value = item.price ?? "";
        input.placeholder = "Set price";
        input.style = "width: 80px; padding: 3px 6px; border-radius: 6px; border: none; font-size: 13px;";
        input.onchange = () => {
          const val = Math.max(0, parseInt(input.value || 0));
          item.price = val;
          input.value = val;
          renderPriceGroups();
        };

        card.appendChild(img);
        card.appendChild(name);

        card.appendChild(input);
        itemGrid.appendChild(card);
      }

      container.appendChild(section);
      if (sort === "default") continue; // render only groups in default sort
      else break; // render only "All" group if sorting other than default
    }
  }

  function renderTopMatchEditor(item) {
    let editor = document.getElementById("top-price-editor");
    if (!editor) {
      editor = document.createElement("div");
      editor.id = "top-price-editor";
      editor.style = "display:flex; flex-direction:column; align-items:center; margin:20px auto; padding:15px; background:#2a2a2a; border:2px solid #555; border-radius:16px; max-width:320px;";
      document.querySelector(".search-sort-controls").after(editor);
    }

    editor.innerHTML = "";
    if (!item) return;

    const img = document.createElement("img");
    img.src = item.img || "./imgs/trs.png";
    img.alt = item.name;
    img.style = "width:100px; height:100px; object-fit:contain; margin-bottom:10px;";
    img.onerror = () => (img.style.display = "none");

    const name = document.createElement("div");
    name.textContent = item.name;
    name.style = "margin-bottom: 10px; font-size:18px; font-weight:bold;";

    const input = document.createElement("input");
    input.type = "number";
    input.min = 0;
    input.value = item.price ?? "";
    input.placeholder = "Set price";
    input.style = "padding: 6px 10px; font-size:16px; border-radius: 8px; border:none; width:150px;";
    input.addEventListener("input", () => {
      let val = input.value.trim();

      if (val !== "" && (!/^\d+$/.test(val) || parseInt(val) < 0)) {
        input.value = "";
        item.price = null;
      } else {
        item.price = val === "" ? null : parseInt(val);
      }

      
    });

    editor.appendChild(img);
    editor.appendChild(name);
    editor.appendChild(input);
  }

  // Debounce helper function
  function debounce(func, delay = 250) {
    let timer;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  const priceSearchInput = document.getElementById("price-search");
  priceSearchInput.removeAttribute("oninput");
  priceSearchInput.addEventListener("input", debounce(() => {
    renderPriceGroups();
  }, 250));

  loadData();
  window.addEventListener("load", renderPriceGroups);
</script>

</body>
</html>
