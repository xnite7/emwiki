<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - EMwiki</title>

    <meta name="description" content="View user profiles, trading stats, and reviews on EMwiki">
    <meta property="og:title" content="User Profile - EMwiki">
    <meta property="og:image" content="https://emwiki.com/imgs/QgWIUWf.png">

    <link rel="stylesheet" href="https://emwiki.com/css/style.css">
    <link rel="stylesheet" href="https://emwiki.com/css/profile.css">
    <link rel="icon" href="https://emwiki.com/imgs/favicon.png" type="image/png">
    <meta name="theme-color" content="#000000">

    <!-- Popover compatibility for older browsers -->
    <script src="https://emwiki.com/js/popover-loader.js"></script>
</head>

<body>

    <header>
        <a href="https://emwiki.com">
            <svg width="500" height="300" viewBox="451 471 100 39" xmlns="http://www.w3.org/2000/svg">
                <style>
                    @keyframes floatAnim {
    
                        0%,
                        to {
                            transform: translateY(0)
                        }
    
                        50% {
                            transform: translateY(-4px)
                        }
                    }
    
                    @keyframes glowPulse {
    
                        0%,
                        to {
                            filter: drop-shadow(0 0 0#fff)
                        }
    
                        50% {
                            filter: drop-shadow(0 0 8px #ff0) drop-shadow(0 0 15px #24ff5a)
                        }
                    }
    
                    @keyframes gradientShift {
    
                        0%,
                        to {
                            stop-color: #ff0
                        }
    
                        50% {
                            stop-color: #24ff5a
                        }
                    }
                </style>
                <defs>
                    <linearGradient id="eppp1" y1="1" x2="0">
                        <stop offset=".2" style="stop-color:#ff0" />
                        <stop offset="1" style="stop-color:#24ff5a" />
                    </linearGradient>
                    <linearGradient id="eppp2" y1="1" x2="0">
                        <stop offset="0" style="stop-color:#24ff5d" />
                        <stop offset="1" style="stop-color:#ff0" />
                    </linearGradient>
                </defs>
                <image id="cloud" x="461" y="459" href="https://emwiki.com/imgs/TWOKPhY.png" height="60" width="60"
                    style="filter:opacity(.6)" />
                <text x="489" y="503" text-anchor="middle" stroke="#000" stroke-width="2.3" paint-order="stroke"
                    stroke-linejoin="round" fill="url(#eppp1)"
                    style="animation:floatAnim 12s ease-in-out infinite;font:200 46px Slapstick">EM</text>
                <image id="epic-image" x="464" y="463" href="https://emwiki.com/imgs/epicfaces/kitta.png" height="60"
                    width="60"
                    style="scale:.48;transform:translate(846px,103px);rotate:20deg;transform-origin:center;animation:floatAnim2 15s ease-in-out 1s infinite alternate" />
                <image id="cloud" x="495" y="477" href="https://emwiki.com/imgs/8UUB0Gt.png" height="60" width="60"
                    style="filter:opacity(.86)" />
                <text x="516" y="514" text-anchor="middle" stroke="#000" stroke-width="2.3" paint-order="stroke"
                    stroke-linejoin="round" fill="url(#eppp2)"
                    style="animation:floatAnim 12s ease-in-out infinite;animation-delay:5.5s;font:200 16px Slapstick">wiki</text>
                <image id="cloud" x="445" y="487" href="https://emwiki.com/imgs/oYKd3nJ.png" height="28" width="42"
                    style="filter:opacity(.8)" />
            </svg>
    
        </a>
    
        <div class="nav-links">
            <a href="https://emwiki.com/catalog" class="nav-link">Catalog</a>
            <a href="https://emwiki.com/trading" class="nav-link">Trading Hub</a>
            <a href="https://emwiki.com/forum" class="nav-link">Forum</a>
            <a href="https://emwiki.com/gallery" class="nav-link">Gallery</a>
            <a href="https://emwiki.com/scammers" class="nav-link">Scammers</a>
        </div>
    
    
    </header>

    <main style="background:Canvas">
        <!-- User Directory View -->
        <div id="directory-view" class="directory-container" style="display: none;">
            <div class="directory-header">
                <h1 class="hero-epic">Player Directory</h1>
                <p class="hero-subtitle">Search and discover EMwiki users</p>
            </div>

            <div class="search-section">
                <div class="search-bar-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <path
                            d="M79.5 74.1 62.9 57.6c3.4-4.7 5.1-10.7 4.2-17.1C65.6 29.8 56.9 21.3 46 20.3c-14.7-1.5-27.2 11-25.7 25.8 1 10.7 9.5 19.6 20.2 21.1 6.4.9 12.3-.9 17.1-4.2l16.6 16.6c.7.7 1.9.7 2.6 0l2.6-2.6c.8-.9.8-2.1.1-2.9M27.7 43.7c0-8.8 7.2-16.1 16.1-16.1s16.1 7.2 16.1 16.1-7.2 16.1-16.1 16.1-16.1-7.1-16.1-16.1" />
                    </svg>
                    <input
                        type="text"
                        id="user-search-input"
                        class="user-search-input"
                        placeholder="Search for users..."
                        autocomplete="off">
                </div>
            </div>

            <div id="users-grid-container" class="users-grid-container">
                <div class="loading-spinner"></div>
                <p>Loading users...</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading profile...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container" style="display: none;">
            <div class="error-message">
                <h2>User Not Found</h2>
                <p>The user profile you're looking for doesn't exist or has been removed.</p>
                <a href="https://emwiki.com/profile" class="btn btn-primary">Browse All Users</a>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profile-content" class="profile-container" style="display: none;">
            <!-- Back to Directory Button -->
            <a href="https://emwiki.com/profile" class="back-to-directory">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to All Users
            </a>
            <!-- Profile Header -->
            <section class="profile-header">
                <div class="profile-header-content">
                    <div class="profile-avatar-container">
                        <img id="profile-avatar" class="profile-avatar" src="" alt="User Avatar">
                    </div>
                    <div class="profile-info">
                        <h1 id="profile-display-name" class="profile-display-name"></h1>
                        <p id="profile-username" class="profile-username"></p>
                        <div id="profile-roles" class="profile-roles"></div>
                        <div class="profile-meta">
                            <span id="profile-joined" class="profile-meta-item"></span>
                            <span id="profile-last-online" class="profile-meta-item"></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trading Stats -->
            <section style="display: none;" class="profile-stats">
                <h2 class="section-title">Trading Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="stat-total-trades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="stat-successful-trades">0</div>
                        <div class="stat-label">Successful Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="stat-rating">0.0</div>
                        <div class="stat-label">Average Rating</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí¨</div>
                        <div class="stat-value" id="stat-reviews">0</div>
                        <div class="stat-label">Total Reviews</div>
                    </div>
                </div>
            </section>

            <!-- Recent Trades -->
            <section class="profile-section">
                <h2 class="section-title">Recent Trades</h2>
                <div id="recent-trades-container" class="recent-trades-container">
                    <p class="no-data-message">No recent trades</p>
                </div>
            </section>

            <!-- Gallery Posts -->
            <section class="profile-section">
                <div class="gallery-section-header">
                    <h2 class="section-title">Gallery Posts</h2>
                    <div class="gallery-nav-arrows">
                        <button class="gallery-arrow gallery-arrow-left" aria-label="Scroll left">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <button class="gallery-arrow gallery-arrow-right" aria-label="Scroll right">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="gallery-posts-carousel-wrapper">
                    <div id="gallery-posts-container" class="gallery-posts-carousel">
                        <p class="no-data-message">No gallery posts yet</p>
                    </div>
                </div>
            </section>

            <!-- Wishlist -->
            <section class="profile-section">
                <h2 class="section-title">Wishlist</h2>
                <div class="wishlist-section">
                    <div id="wishlist-container" class="wishlist-grid">
                        <p class="no-data-message">Loading wishlist...</p>
                    </div>
                </div>
            </section>

            <!-- Reviews -->
            <section class="profile-section">
                <div class="reviews-section-header">
                    <h2 class="section-title">Reviews</h2>
                    <button id="write-review-btn" class="btn btn-primary" style="display: none;">
                        Write a Review
                    </button>
                </div>
                <div id="reviews-container" class="reviews-container">
                    <p class="no-data-message">No reviews yet</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content review-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Write a Review</h3>
                <button class="modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="review-form">
                    <div class="form-group">
                        <label for="review-rating" class="form-label">Rating</label>
                        <div class="star-rating-input">
                            <input type="radio" id="star5" name="rating" value="5" required>
                            <label for="star5" title="5 stars">‚òÖ</label>
                            <input type="radio" id="star4" name="rating" value="4">
                            <label for="star4" title="4 stars">‚òÖ</label>
                            <input type="radio" id="star3" name="rating" value="3">
                            <label for="star3" title="3 stars">‚òÖ</label>
                            <input type="radio" id="star2" name="rating" value="2">
                            <label for="star2" title="2 stars">‚òÖ</label>
                            <input type="radio" id="star1" name="rating" value="1">
                            <label for="star1" title="1 star">‚òÖ</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="review-comment" class="form-label">Comment (optional)</label>
                        <textarea
                            id="review-comment"
                            name="comment"
                            class="form-textarea"
                            rows="4"
                            maxlength="500"
                            placeholder="Share your experience with this user..."></textarea>
                        <div class="char-counter">
                            <span id="comment-char-count">0</span>/500
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-review-btn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submit-review-btn">Submit Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h4>Browse</h4>
            <a href="https://emwiki.com/catalog">Catalog</a>
            <a href="https://emwiki.com/scammers">Scammers List</a>
            <a href="https://emwiki.com/admin">Admin Portal</a>
        </div>
        <div class="footer-section">
            <h4>Community</h4>
            <a href="https://emwiki.com/forum">Forum</a>
            <a href="https://emwiki.com/trading">Trading</a>
            <a href="https://emwiki.com/gallery">Gallery</a>
            <a href="https://discord.com/invite/tg">Typical Games Discord</a>
        </div>
        <div class="footer-section">
            <h4>Contact</h4>
            <p>Found a bug? Reach out to <b>@xnite</b> on Discord!</p>
            <a href="https://discord.gg/YsKW6UDWZ6">Report a Scammer</a>
        </div>
    </div>
    <div class="footer-bottom">
        <p>¬© 2025 emwiki.com ‚Ä¢ made with ‚ù§ by xnite</p>
    </div>
</footer>

    <script src="https://emwiki.com/js/script.js"></script>
    <script>
    // Profile Page Handler
    class Catalog extends BaseApp {
        constructor() {
            super();
            this.loadTheme();
            this.userId = null;
            this.profileData = null;
            this.apiBase = 'https://emwiki.com/api';

            this.init();
        }

        async init() {
            // Get user ID from URL path (e.g., /profile/1527377658)
            const pathParts = window.location.pathname.split('/').filter(Boolean);

            if (pathParts.length >= 2 && pathParts[0] === 'profile') {
                this.userId = pathParts[1];
            }

            // If no user ID, show directory view
            if (!this.userId) {
                this.showDirectoryView();
                return;
            }

            // Clean up userId - remove .0 suffix if present
            this.userId = this.userId.replace(/\.0$/, '');

            await this.loadProfile();
        }

        async showDirectoryView() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('directory-view').style.display = 'block';
            document.title = 'Player Directory - EMwiki';

            // Setup search
            this.setupUserSearch();

            // Load initial users
            await this.loadUsers();
        }

        setupUserSearch() {
            const searchInput = document.getElementById('user-search-input');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();

                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        await this.searchUsers(query);
                    } else if (query.length === 0) {
                        await this.loadUsers();
                    }
                }, 300); // Debounce
            });
        }

        async loadUsers(limit = 50) {
            const container = document.getElementById('users-grid-container');
            container.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading users...</p>';

            try {
                // Use the search API with empty query to get all users
                const response = await fetch(`${this.apiBase}/auth/user/search?q=&limit=${limit}`);

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const data = await response.json();
                this.renderUsersGrid(data.users || []);
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<p class="no-users-message">Failed to load users. Please try again.</p>';
            }
        }

        async searchUsers(query) {
            const container = document.getElementById('users-grid-container');
            container.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center; color: rgba(255, 255, 255, 0.7);">Searching...</p>';

            try {
                const response = await fetch(`${this.apiBase}/auth/user/search?q=${encodeURIComponent(query)}`);

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                this.renderUsersGrid(data.users || []);
            } catch (error) {
                console.error('Error searching users:', error);
                container.innerHTML = '<p class="no-users-message">Search failed. Please try again.</p>';
            }
        }

        renderUsersGrid(users) {
            const container = document.getElementById('users-grid-container');

            if (!users || users.length === 0) {
                container.innerHTML = '<p class="no-users-message">No users found</p>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'users-grid';

            users.forEach(user => {
                const userCard = this.createUserCard(user);
                grid.appendChild(userCard);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        createUserCard(user) {
            const card = document.createElement('a');
            card.className = 'user-card';
            card.href = `/profile/${user.user_id}`;

            // Parse roles
            let roles = [];
            try {
                roles = user.role ? JSON.parse(user.role) : [];
            } catch (e) {
                roles = [];
            }

            // Filter out 'user' role and get special roles
            const specialRoles = roles.filter(r => r !== 'user');

            // Get stats (if available)
            const totalTrades = user.total_trades || 0;
            const avgRating = user.average_rating || 0;

            card.innerHTML = `
                <img src="${user.avatar_url || 'https://emwiki.com/imgs/placeholder.png'}"
                     alt="${this.escapeHtml(user.display_name)}"
                     class="user-card-avatar"><div style="flex: 1 1;max-width: 145px;">
                <h3 class="user-card-name">${this.escapeHtml(user.display_name)}</h3>
                <p class="user-card-username">@${this.escapeHtml(user.username)}</p></div>

                ${specialRoles.length > 0 ? `
                    <div class="user-card-roles">
                        ${specialRoles.map(role => `
                            <span class="user-card-role-badge role-${role}">${role.toUpperCase()}</span>
                        `).join('')}
                    </div>
                ` : ''}


            `;

            return card;
        }

        async loadProfile() {
            try {
                const response = await fetch(`${this.apiBase}/profile/${this.userId}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        this.showError('User not found');
                    } else {
                        this.showError('Failed to load profile');
                    }
                    return;
                }

                this.profileData = await response.json();
                this.renderProfile();
            } catch (error) {
                console.error('Error loading profile:', error);
                this.showError('Failed to load profile');
            }
        }

        showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'flex';
            document.getElementById('profile-content').style.display = 'none';
        }

        renderProfile() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';

            const { user, stats, reviews, recentTrades, donationData, galleryPosts, wishlist } = this.profileData;

            // Update page title
            document.title = `${user.displayName} - EMwiki`;

            // Render profile header
            this.renderProfileHeader(user, donationData);

            // Render stats
            this.renderStats(stats);

            // Render recent trades
            this.renderRecentTrades(recentTrades);

            // Render gallery posts
            this.renderGalleryPosts(galleryPosts);

            // Render wishlist
            this.renderWishlist(wishlist || []);

            // Render reviews
            this.renderReviews(reviews);

            // Setup review functionality
            this.setupReviewModal();
        }

        renderProfileHeader(user, donationData) {
            // Avatar
            const avatarImg = document.getElementById('profile-avatar');
            avatarImg.src = user.avatarUrl || 'https://emwiki.com/imgs/placeholder.png';
            avatarImg.alt = `${user.displayName}'s Avatar`;

            // Display name
            document.getElementById('profile-display-name').textContent = user.displayName;

            // Username
            document.getElementById('profile-username').textContent = `@${user.username}`;

            // Roles
            const rolesContainer = document.getElementById('profile-roles');
            rolesContainer.innerHTML = '';

            if (user.roles && Array.isArray(user.roles)) {
                // Filter out 'user' role and show special roles
                const specialRoles = user.roles.filter(role => role !== 'user');

                specialRoles.forEach(role => {
                    const badge = document.createElement('span');
                    badge.className = `role-badge role-${role}`;
                    badge.textContent = role.toUpperCase();
                    rolesContainer.appendChild(badge);
                });
            }

            // Joined date
            const joinedDate = new Date(user.createdAt);
            document.getElementById('profile-joined').innerHTML = `
            <strong>Joined:</strong> ${this.formatDate(joinedDate)}
        `;

            // Last online
            const lastOnline = new Date(user.lastOnline);
            const isOnline = Date.now() - user.lastOnline < 5 * 60 * 1000; // 5 minutes
            const onlineStatus = isOnline ? `<strong class="online-status">Online</strong>` : `<strong class="offline-status">Last seen: ${this.formatRelativeTime(lastOnline)}</strong>`;
            const profilepicborder = isOnline ? `4px solid #35df3c` : ``;

            document.getElementById('profile-last-online').innerHTML = onlineStatus;
            document.getElementById('profile-avatar').style.outline = profilepicborder;
        }

        renderStats(stats) {
            document.getElementById('stat-total-trades').textContent = stats.total_trades || 0;
            document.getElementById('stat-successful-trades').textContent = stats.successful_trades || 0;

            const rating = stats.average_rating || 0;
            document.getElementById('stat-rating').textContent = rating.toFixed(1);

            document.getElementById('stat-reviews').textContent = stats.total_reviews || 0;
        }

        renderRecentTrades(trades) {
            const container = document.getElementById('recent-trades-container');

            if (!trades || trades.length === 0) {
                container.innerHTML = '<p class="no-data-message">No recent trades</p>';
                return;
            }

            container.innerHTML = '';

            trades.forEach(trade => {
                const tradeCard = document.createElement('div');
                tradeCard.className = 'trade-card';

                const roleIcon = trade.role === 'seller' ? 'üì§' : 'üì•';
                const roleText = trade.role === 'seller' ? 'Sold' : 'Bought';

                tradeCard.innerHTML = `
                <div class="trade-icon">${roleIcon}</div>
                <div class="trade-info">
                    <div class="trade-item-name">${this.escapeHtml(trade.item_name)}</div>
                    <div class="trade-meta">${roleText} ‚Ä¢ ${this.formatRelativeTime(new Date(trade.completed_at))}</div>
                </div>
            `;

                container.appendChild(tradeCard);
            });
        }

        renderGalleryPosts(posts) {
            const container = document.getElementById('gallery-posts-container');

            if (!posts || posts.length === 0) {
                container.innerHTML = '<p class="no-data-message">No gallery posts yet</p>';
                return;
            }

            container.innerHTML = '';

            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'gallery-post-card';
                postCard.dataset.id = post.id;

                const mediaElement = post.media_type === 'video'
                    ? `<div class="gallery-post-media-wrapper">
                           <video class="gallery-post-media" src="${post.media_url}" poster="${post.thumbnail_url || ''}" muted preload="metadata"></video>
                           <div class="gallery-post-play-icon">
                               <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                   <path d="M8 5v14l11-7z"/>
                               </svg>
                           </div>
                       </div>`
                    : `<img class="gallery-post-media" src="${post.media_url}" alt="${this.escapeHtml(post.title)}" loading="lazy">`;

                const likesCount = post.likes_count || 0;
                const views = post.views || 0;

                postCard.innerHTML = `
                    ${mediaElement}
                    <div class="gallery-post-info">
                        <h4 class="gallery-post-title">${this.escapeHtml(post.title)}</h4>
                        <p class="gallery-post-stats">
                            <span class="gallery-post-stat">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                                ${likesCount}
                            </span>
                            <span class="gallery-post-stat">
                                <svg viewBox="0 -3 42 42" width="16" height="16" fill="currentColor">
                                    <path d="M15.3 20.1c0 3.1 2.6 5.7 5.7 5.7s5.7-2.6 5.7-5.7-2.6-5.7-5.7-5.7-5.7 2.6-5.7 5.7m8.1 12.3C30.1 30.9 40.5 22 40.5 22s-7.7-12-18-13.3c-.6-.1-2.6-.1-3-.1-10 1-18 13.7-18 13.7s8.7 8.6 17 9.9c.9.4 3.9.4 4.9.2M11.1 20.7c0-5.2 4.4-9.4 9.9-9.4s9.9 4.2 9.9 9.4S26.5 30 21 30s-9.9-4.2-9.9-9.3"></path>
                                </svg>
                                ${views}
                            </span>
                        </p>
                    </div>
                `;

                // Make clickable to open in gallery with direct link to post
                postCard.addEventListener('click', () => {
                    window.location.href = `/gallery#post-${post.id}`;
                });

                container.appendChild(postCard);
            });

            // Setup carousel navigation after posts are rendered
            this.setupGalleryCarousel();
        }

        setupGalleryCarousel() {
            const carousel = document.getElementById('gallery-posts-container');
            const leftArrow = document.querySelector('.gallery-arrow-left');
            const rightArrow = document.querySelector('.gallery-arrow-right');

            if (!carousel || !leftArrow || !rightArrow) return;

            // Only setup if there are actual posts
            if (carousel.children.length === 0 || carousel.querySelector('.no-data-message')) {
                leftArrow.disabled = true;
                rightArrow.disabled = true;
                return;
            }

            // Calculate scroll amount based on viewport width
            const getScrollAmount = () => {
                const vw = window.innerWidth;
                if (vw <= 768) {
                    return 200; // 180px card + 20px gap (mobile)
                }
                return  vw / 3; // 220px card + 20px gap (desktop)
            };

            // Update arrow states based on scroll position
            const updateArrowStates = () => {
                const maxScroll = carousel.scrollWidth - carousel.clientWidth;
                leftArrow.disabled = carousel.scrollLeft <= 0;
                rightArrow.disabled = carousel.scrollLeft >= maxScroll - 1; // -1 for rounding
            };

            // Initial state
            updateArrowStates();

            // Scroll left
            leftArrow.addEventListener('click', () => {
                carousel.scrollBy({
                    left: -getScrollAmount(),
                    behavior: 'smooth'
                });
            });

            // Scroll right
            rightArrow.addEventListener('click', () => {
                carousel.scrollBy({
                    left: getScrollAmount(),
                    behavior: 'smooth'
                });
            });

            // Update arrow states on scroll
            carousel.addEventListener('scroll', updateArrowStates);
        }

        async fetchItemByName(itemName) {
            // Try each category with the single item endpoint: /api/items/:category/:name
            const categories = ['gears', 'deaths', 'pets', 'effects', 'titles'];
            
            for (const category of categories) {
                try {
                    const response = await fetch(`${this.apiBase}/items/${category}/${encodeURIComponent(itemName)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.item && data.item.name === itemName) {
                            return { ...data.item, category };
                        }
                    }
                } catch (error) {
                    // Item not found in this category, continue to next
                }
            }
            
            // If not found by exact category/name, try search endpoint
            try {
                const response = await fetch(`${this.apiBase}/items/search?q=${encodeURIComponent(itemName)}&limit=20`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        // Find exact match
                        const exactMatch = data.items.find(item => item.name === itemName);
                        if (exactMatch) {
                            return exactMatch;
                        }
                    }
                }
            } catch (error) {
                console.error(`Error searching for item ${itemName}:`, error);
            }
            
            return null;
        }

        async renderWishlist(wishlistItemNames) {
            const container = document.getElementById('wishlist-container');

            if (!wishlistItemNames || wishlistItemNames.length === 0) {
                container.innerHTML = '';
                return;
            }

            // Show loading state
            container.innerHTML = '<p class="no-data-message">Loading wishlist items...</p>';

            // Fetch item details for all wishlist items
            const itemPromises = wishlistItemNames.map(itemName => this.fetchItemByName(itemName));
            const items = await Promise.all(itemPromises);

            // Filter out null results (items not found)
            const validItems = items.filter(item => item !== null);

            if (validItems.length === 0) {
                container.innerHTML = '';
                return;
            }

            // Clear container and render items using the same structure as catalog wishlist
            container.innerHTML = '';

            validItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<small class="item-name">${this.escapeHtml(item.name)}</small>`;

                if (item.img) {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function () {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = item.img.startsWith('http') ? item.img : `https://emwiki.com/${item.img}`;
                    img.onerror = function() {
                        // If image fails, try to show SVG or placeholder
                        if (item.svg) {
                            div.insertAdjacentHTML('beforeend', item.svg);
                        }
                    };
                    // Prevent right-click and drag
                    canvas.addEventListener('contextmenu', (e) => e.preventDefault());
                    canvas.addEventListener('dragstart', (e) => e.preventDefault());
                    canvas.addEventListener('selectstart', (e) => e.preventDefault());
                    canvas.style.userSelect = 'none';
                    canvas.style.webkitUserSelect = 'none';
                    div.appendChild(canvas);
                } else if (item.svg) {
                    div.insertAdjacentHTML('beforeend', item.svg);
                }

                // Add price if available
                if (item.price && item.price !== 'N/A' && item.price !== '0') {
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'item-price';
                    priceDiv.textContent = this.convertPrice ? this.convertPrice(this.formatPrice(item.price)) : item.price;
                    div.appendChild(priceDiv);
                } else if (item.price === '0') {
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'item-price';
                    priceDiv.style.opacity = '0';
                    priceDiv.style.height = '16px';
                    div.appendChild(priceDiv);
                }

                // Make clickable - navigate to catalog with item filter
                div.addEventListener('click', () => {
                    window.location.href = `/catalog?item=${encodeURIComponent(item.name)}`;
                });

                container.appendChild(div);
            });
        }

        formatPrice(price) {
            if (!price || price === 'N/A') return 'N/A';
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        convertPrice(price) {
            if (!price || price === 'N/A') return 'N/A';
            // Convert to abbreviated format if needed (e.g., 1000 -> 1K)
            const num = parseFloat(price.replace(/,/g, ''));
            if (isNaN(num)) return price;
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        renderReviews(reviews) {
            const container = document.getElementById('reviews-container');

            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<p class="no-data-message">No reviews yet</p>';
                return;
            }

            container.innerHTML = '';

            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';

                const stars = this.renderStars(review.rating);

                reviewCard.innerHTML = `
                <div class="review-header">
                    <div class="reviewer-info">
                        <img src="${review.reviewer_avatar || '/imgs/placeholder.png'}"
                             alt="${this.escapeHtml(review.reviewer_display_name)}"
                             class="reviewer-avatar">
                        <div>
                            <div class="reviewer-name">${this.escapeHtml(review.reviewer_display_name)}</div>
                            <div class="review-date">${this.formatRelativeTime(new Date(review.created_at))}</div>
                        </div>
                    </div>
                    <div class="review-rating">${stars}</div>
                </div>
                ${review.comment ? `<div class="review-comment">${this.escapeHtml(review.comment)}</div>` : ''}
            `;

                container.appendChild(reviewCard);
            });
        }

        renderStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let stars = '';
            for (let i = 0; i < fullStars; i++) {
                stars += '‚≠ê';
            }
            if (hasHalfStar) {
                stars += '‚≠ê';
            }
            for (let i = 0; i < emptyStars; i++) {
                stars += '‚òÜ';
            }

            return `${stars} (${rating}/5)`;
        }

        formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        formatRelativeTime(date) {
            const now = Date.now();
            const diff = now - date.getTime();

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);

            if (seconds < 60) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 30) return `${days}d ago`;
            if (months < 12) return `${months}mo ago`;
            return `${years}y ago`;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async getCurrentUserId() {
            // If Auth is already ready with user data, return it immediately
            if (window.Auth && window.Auth.user && window.Auth.user.userId) {
                return window.Auth.user.userId;
            }

            // Otherwise, wait for sessionReady event
            return new Promise((resolve) => {
                if (!window.Auth) {
                    resolve(null);
                    return;
                }

                const timeout = setTimeout(() => {
                    resolve(null);
                }, 5000); // 5 second timeout

                window.Auth.addEventListener('sessionReady', () => {
                    clearTimeout(timeout);
                    resolve(window.Auth.user ? window.Auth.user.userId : null);
                }, { once: true });
            });
        }

        async setupReviewModal() {
            const writeReviewBtn = document.getElementById('write-review-btn');
            const reviewModal = document.getElementById('review-modal');
            const reviewForm = document.getElementById('review-form');
            const cancelBtn = document.getElementById('cancel-review-btn');
            const modalClose = document.querySelector('.modal-close');
            const commentTextarea = document.getElementById('review-comment');
            const charCount = document.getElementById('comment-char-count');

            // Check if user is logged in
            const authToken = localStorage.getItem('auth_token');

            // Get current user ID to prevent self-review
            let currentUserId = null;

            if (authToken && window.Auth) {
                // Wait for Auth to be ready
                currentUserId = await this.getCurrentUserId();
            }

            // Show write review button if user is logged in and not viewing their own profile
            if (authToken && currentUserId && currentUserId !== Number(this.userId)) {
                writeReviewBtn.style.display = 'inline-block';
            }

            // Character counter
            commentTextarea.addEventListener('input', () => {
                charCount.textContent = commentTextarea.value.length;
            });

            // Open modal
            writeReviewBtn.addEventListener('click', () => {
                reviewModal.style.display = 'flex';
                reviewForm.reset();
                charCount.textContent = '0';
            });

            // Close modal
            const closeModal = () => {
                reviewModal.style.display = 'none';
            };

            cancelBtn.addEventListener('click', closeModal);
            modalClose.addEventListener('click', closeModal);

            // Close on overlay click
            reviewModal.querySelector('.modal-overlay').addEventListener('click', closeModal);

            // Handle form submission
            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.submitReview();
            });
        }

        async submitReview() {
            const authToken = localStorage.getItem('auth_token');
            if (!authToken) {
                alert('You must be logged in to write a review');
                return;
            }

            const rating = document.querySelector('input[name="rating"]:checked');
            if (!rating) {
                alert('Please select a rating');
                return;
            }

            const comment = document.getElementById('review-comment').value.trim();
            const submitBtn = document.getElementById('submit-review-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${this.apiBase}/profile/${this.userId}/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        rating: parseInt(rating.value),
                        comment: comment || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to submit review');
                }

                // Success - close modal and reload profile to show new review
                document.getElementById('review-modal').style.display = 'none';
                alert('Review submitted successfully!');

                // Reload the profile to show the new review
                await this.loadProfile();

            } catch (error) {
                console.error('Error submitting review:', error);
                alert(error.message || 'Failed to submit review. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Review';
            }
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        window.catalog = new Catalog();
    });


    </script>
</body>

</html>
