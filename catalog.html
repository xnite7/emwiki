<!DOCTYPE html>
<html lang="en">

<head>
        <style>
        @import url("https://emwiki.site/css/fonts.css");
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Catalogue - Unified Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@100..800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<link rel="preload" href="./css/style.css?version=3" as="style" onload="this.rel='stylesheet'">
    <noscript>
	<link rel="stylesheet" href="./css/style.css?version=3">
</noscript>
    <style>
        /* ============================================
           FILTER BAR STYLES
           ============================================ */
        .filter-container {
            position: sticky;
            top: 0;
            z-index: 900;
            background: linear-gradient(180deg,
                    rgba(0, 0, 0, 0.95) 0%,
                    rgba(0, 0, 0, 0.85) 50%,
                    rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(20px);
            padding: 20px 20px 30px;
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .category-pills {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .pill {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Playpen Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .pill::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--glow, rgba(255, 255, 255, 0.3));
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .pill:hover::before {
            width: 100px;
            height: 100px;
        }

        .pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--glow, rgba(255, 255, 255, 0.2));
            border-color: var(--glow, rgba(255, 255, 255, 0.5));
        }

        .pill.active {
            background: var(--glow, rgba(255, 255, 255, 0.2));
            border-color: var(--glow, #fff);
            box-shadow:
                0 0 20px var(--glow, rgba(255, 255, 255, 0.5)),
                inset 0 0 10px var(--glow, rgba(255, 255, 255, 0.2));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow:
                    0 0 20px var(--glow, rgba(255, 255, 255, 0.5)),
                    inset 0 0 10px var(--glow, rgba(255, 255, 255, 0.2));
            }

            50% {
                box-shadow:
                    0 0 30px var(--glow, rgba(255, 255, 255, 0.7)),
                    inset 0 0 15px var(--glow, rgba(255, 255, 255, 0.3));
            }
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-chip {
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Playpen Sans', sans-serif;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .filter-chip.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fff;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .sort-select {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 8px;
            font-family: 'Playpen Sans', sans-serif;
            cursor: pointer;
        }

        .sort-select option {
            background: #333;
            color: #fff;
        }

        .filter-stats {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-top: 10px;
        }

        /* ============================================
           CATEGORY TRANSITIONS
           ============================================ */
        body.category-transition {
            position: relative;
            overflow: hidden;
        }

        .morph-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 800;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .morph-overlay.active {
            opacity: 1;
        }

        .morph-particle {
            position: absolute;
            font-size: 30px;
            opacity: 0;
            animation: morphFloat 3s infinite;
        }

        @keyframes morphFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* ============================================
           ENHANCED ITEM STYLES
           ============================================ */
        .catalog-unified {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px;
            min-height: 400px;
            position: relative;
        }

        .item {
            opacity: 0;
            transform: scale(0.8);

        }


        .category-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--category-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        /* Loading skeleton */
        .skeleton-loader {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .skeleton-item {
            height: 200px;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0.1) 25%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .filter-container {
                padding: 15px 10px 20px;
            }

            .category-pills {
                gap: 5px;
            }

            .pill {
                padding: 6px 12px;
                font-size: 12px;
            }

            .catalog-unified {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
                padding: 10px;
            }
        }

        /* ============================================
           INTEGRATED FILTER BAR
           ============================================ */
        .filter-container {
            position: sticky;
            top: 0;
            z-index: 900;
            background: linear-gradient(180deg,
                    rgba(0, 0, 0, 0.95) 0%,
                    rgba(0, 0, 0, 0.85) 50%,
                    rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(20px);
            padding: 20px 20px 30px;
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }



        /* ============================================
           INTEGRATED MODAL STYLES (from your existing)
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

                /* ============================================
           NEW FILTER BAR STYLES
           ============================================ */
        .filter-container {
            position: sticky;
            top: 0;
            z-index: 900;
            background: linear-gradient(180deg,
                    rgba(0, 0, 0, 0.95) 0%,
                    rgba(0, 0, 0, 0.85) 50%,
                    rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(20px);
            padding: 20px 20px 30px;
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .category-pills {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .pill {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Playpen Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .pill::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--glow, rgba(255, 255, 255, 0.3));
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .pill:hover::before {
            width: 100px;
            height: 100px;
        }

        .pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--glow, rgba(255, 255, 255, 0.2));
            border-color: var(--glow, rgba(255, 255, 255, 0.5));
        }

        .pill.active {
            background: var(--glow, rgba(255, 255, 255, 0.2));
            border-color: var(--glow, #fff);
            box-shadow:
                0 0 20px var(--glow, rgba(255, 255, 255, 0.5)),
                inset 0 0 10px var(--glow, rgba(255, 255, 255, 0.2));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow:
                    0 0 20px var(--glow, rgba(255, 255, 255, 0.5)),
                    inset 0 0 10px var(--glow, rgba(255, 255, 255, 0.2));
            }
            50% {
                box-shadow:
                    0 0 30px var(--glow, rgba(255, 255, 255, 0.7)),
                    inset 0 0 15px var(--glow, rgba(255, 255, 255, 0.3));
            }
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-chip {
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Playpen Sans', sans-serif;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .filter-chip.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fff;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .sort-select {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 8px;
            font-family: 'Playpen Sans', sans-serif;
            cursor: pointer;
        }

        .sort-select option {
            background: #333;
            color: #fff;
        }

        .filter-stats {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-top: 10px;
        }

        /* ============================================
           VIRTUAL SCROLL CONTAINER
           ============================================ */
        .virtual-scroll-container {
            position: relative;
            overflow-y: auto;
            height: 80vh;
            max-height: 800px;
        }

        .virtual-scroll-viewport {
            position: relative;
            overflow: visible;
        }

        .virtual-scroll-spacer {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            pointer-events: none;
        }

        .virtual-items-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .morph-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 800;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .morph-overlay.active {
            opacity: 1;
        }

        .morph-particle {
            position: absolute;
            font-size: 30px;
            opacity: 0;
            animation: morphFloat 3s infinite;
        }

        @keyframes morphFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .filter-container {
                padding: 15px 10px 20px;
            }
            .category-pills {
                gap: 5px;
            }
            .pill {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
    
</head>

<body>
    <!-- Search Bar (your existing) -->
    <div id="search-wrapper">
        <input id="search-bar" type="text" placeholder="Search items..." autocomplete="off" />
        <div id="search-results"></div>
    </div>

    <!-- NEW Filter Bar -->
    <div class="filter-container" id="filterBar">
        <div class="category-pills">
            <button class="pill active" data-category="all">✨ All</button>
            <button class="pill" data-category="gears" style="--glow: rgb(91, 254, 106)">⚙️ Gears</button>
            <button class="pill" data-category="deaths" style="--glow: rgb(255, 122, 94)">💀 Deaths</button>
            <button class="pill" data-category="titles" style="--glow: rgb(201, 96, 254)">🏷️ Titles</button>
            <button class="pill" data-category="pets" style="--glow: rgb(55, 122, 250)">🐾 Pets</button>
            <button class="pill" data-category="effects" style="--glow: rgb(255, 177, 53)">✨ Effects</button>
        </div>

        <div class="quick-filters">
            <button class="filter-chip" data-filter="new">🆕 New</button>
            <button class="filter-chip" data-filter="tradable">💱 Tradable</button>
            <button class="filter-chip" data-filter="premium">👑 Premium</button>
            <button class="filter-chip" data-filter="retired">🚫 Retired</button>
            <button class="filter-chip" data-filter="weeklystar">⭐ Weekly</button>
            <button class="filter-chip" data-filter="favorites">❤️ Favorites</button>
        </div>

        <div class="sort-controls">
            <label style="color: #fff; font-size: 14px;">Sort by:</label>
            <select class="sort-select" id="sortSelect">
                <option value="alphabetical">A-Z</option>
                <option value="alphabetical-reverse">Z-A</option>
                <option value="price-high">Price: High to Low</option>
                <option value="price-low">Price: Low to High</option>
                <option value="rarity">Demand</option>
            </select>
        </div>

        <div class="filter-stats" id="filterStats">
            Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span> items
        </div>
    </div>

    <!-- Virtual Scroll Container -->
    <div class="virtual-scroll-container" id="virtualScrollContainer">
        <div class="virtual-scroll-viewport" id="virtualViewport">
            <div class="virtual-scroll-spacer" id="virtualSpacer"></div>
            <div class="virtual-items-container" id="virtualItems"></div>
        </div>
    </div>

    <!-- Morph Overlay -->
    <div class="morph-overlay" id="morphOverlay"></div>

    <!-- Hidden container for search results -->
    <div id="itemlist" style="display: none;"></div>

    <!-- Modal will be created by ModalSystem -->



    <script>
        const APP_CONFIG = {
            touch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            colors: {
                gears: "rgb(91, 254, 106)",
                deaths: "rgb(255, 122, 94)",
                titles: "rgb(201, 96, 254)",
                pets: "rgb(55, 122, 250)",
                effects: "rgb(255, 177, 53)"
            },
            modalColors: {
                pets: "rgb(39, 102, 221)",
                effects: "rgb(243, 164, 37)",
                deaths: "rgb(221, 89, 62)",
                titles: "rgb(154, 45, 209)",
                gears: "rgb(55, 205, 68)"
            },
            icons: {
                premium: "./imgs/prem.png",
                untradable: "https://i.imgur.com/WLjbELh.png",
                retired: "./imgs/Red_x.png",
                robux: "./imgs/cf8ZvY7.png",
                coins: "./imgs/Coin.webp",
                stars: "./imgs/WKeX5AS.png",
                visors: "./imgs/7IoLZCN.png",
                pumpkins: "./imgs/bHRBTrU.png",
                eggs: "./imgs/qMxjgQy.png",
                opals: "./imgs/wwMMAvr.png",
                baubles: "./imgs/bauble.png",
                tokens: "./imgs/Cy9r140.png"
            },
            tilt: {
                max: "10",
                speed: "500",
                perspective: "1800",
                glare: true,
                maxGlare: "0.1",
                scale: "1.03",
                reset: "true"
            }
        };

        // Your AppState class
        class AppState {
            constructor() {
                this.currentItem = null;
                this.items = [];
                this.favorites = this.loadFavorites();
                this.searchHistory = this.loadSearchHistory();
                this.isModalOpen = false;
                this.isSwiping = false;
                this.showingFavoritesOnly = false;
            }

            loadFavorites() {
                const match = document.cookie.match(/(?:^|; )favorites=([^;]*)/);
                return match ? decodeURIComponent(match[1]).split("|") : [];
            }

            saveFavorites() {
                const value = encodeURIComponent(this.favorites.join("|"));
                document.cookie = `favorites=${value}; path=/; max-age=31536000`;
            }

            toggleFavorite(name) {
                const index = this.favorites.indexOf(name);
                if (index > -1) {
                    this.favorites.splice(index, 1);
                } else {
                    this.favorites.push(name);
                }
                this.saveFavorites();
                return this.favorites.includes(name);
            }

            loadSearchHistory() {
                return JSON.parse(localStorage.getItem("searchHistory") || "[]");
            }

            saveSearchHistory(name) {
                this.searchHistory = this.searchHistory.filter(item => item !== name);
                this.searchHistory.unshift(name);
                if (this.searchHistory.length > 4) {
                    this.searchHistory = this.searchHistory.slice(0, 4);
                }
                localStorage.setItem("searchHistory", JSON.stringify(this.searchHistory));
            }
        }

        

        // ============================================
        // MODAL SYSTEM
        // ============================================
        class ModalSystem {
            constructor() {
                this.cache = null;
                this.init();
            }


            init() {
                this.createModalStructure();
                this.setupEventListeners();
            }

            createModalStructure() {
                const modal = document.createElement('div');
                modal.id = 'product-modal';
                modal.className = 'modal';

                const content = this.createModalContent();
                modal.appendChild(content);

                // Add navigation arrows
                const leftArrow = document.createElement("div");
                leftArrow.id = "modal-left-arrow";
                leftArrow.className = "modal-arrow";
                leftArrow.innerHTML = "←";
                modal.appendChild(leftArrow);

                const rightArrow = document.createElement("div");
                rightArrow.id = "modal-right-arrow";
                rightArrow.className = "modal-arrow";
                rightArrow.innerHTML = "→";
                modal.appendChild(rightArrow);

                document.body.appendChild(modal);

                // Cache references
                this.cache = {
                    modal: modal,
                    content: content,
                    title: content.querySelector('#modal-title'),
                    prc: content.querySelector('#modal-prc'),
                    description: content.querySelector('#modal-description'),
                    price: content.querySelector('#modal-price-value'),
                    popo: content.querySelector('#popo'),
                    retired: content.querySelector('#modal-retired'),
                    premium: content.querySelector('#modal-premium'),
                    untradable: content.querySelector('#modal-untradable'),
                    button: content.querySelector('#tour-button'),
                    leftArrow: leftArrow,
                    rightArrow: rightArrow
                };
            }

            createModalContent() {
                const content = document.createElement('div');
                content.id = 'modal-content';
                content.className = 'modal-content expand';

                // Apply tilt data attributes
                Object.entries(APP_CONFIG.tilt).forEach(([key, value]) => {
                    content.dataset[`tilt${key.charAt(0).toUpperCase() + key.slice(1)}`] = value;
                });

                const overlay2 = document.createElement('div');
                overlay2.className = 'inner-border-overlay';

                content.append(overlay2);


                const contentArea = this.createContentArea();
                const closeBtn = document.createElement('span');
                closeBtn.id = 'close-modal';
                closeBtn.className = 'close-btn';

                // Glare effects
                const glare1 = this.createGlareElement();
                const glare2 = this.createGlareElement();

                // Assemble
                [contentArea, closeBtn, glare1, glare2]
                    .forEach(el => content.appendChild(el));

                return content;
            }

            createContentArea() {
                const area = document.createElement('div');
                area.id = 'content-area';
                area.className = 'content-area';

                const overlay = document.createElement('div');
                overlay.className = 'gradient-overlay';

                const TPcontainer = document.createElement('div');
                TPcontainer.className = 'title-price-container';

                const title = document.createElement('h3');
                title.id = 'modal-title';
                title.className = 'modal-title';
                title.setAttribute('data-tilt-transform-element', '');

                const price = document.createElement('h3');
                price.id = 'modal-prc';
                price.className = 'modal-prc';

                TPcontainer.append(title, price);

                const priceImg = document.createElement('img');
                priceImg.id = 'modal-price-value';

                const description = document.createElement('p');
                description.id = 'modal-description';

                const priceDiv = document.createElement('div');
                priceDiv.id = 'popo';
                priceDiv.className = 'price';

                const priceText = document.createElement('p');
                priceText.textContent = '0';

                priceDiv.append(priceImg, priceText);

                const tourButton = document.createElement('button');
                tourButton.id = 'tour-button';
                tourButton.className = 'tour-button';
                tourButton.innerHTML = `
      Visit
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-bottom: -4px;scale: 0.9;stroke-width: 3px;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5l7 7-7 7"></path>
        <path d="M5 12h14"></path>
      </svg>
    `;

                const dock = document.createElement('div');
                dock.className = 'dock';

                const premium = document.createElement('img');
                premium.id = 'modal-premium';
                premium.className = 'modal-icon';
                premium.src = APP_CONFIG.icons.premium;

                const retired = document.createElement('h3');
                retired.id = 'modal-retired';
                retired.textContent = 'Retired';

                const untradable = document.createElement('img');
                untradable.id = 'modal-untradable';
                untradable.className = 'modal-icon';
                untradable.src = APP_CONFIG.icons.untradable;

                dock.append(premium, retired, untradable);

                area.append(overlay, TPcontainer, description, priceDiv, tourButton, dock);

                return area;
            }

            createGlareElement() {
                const wrap = document.createElement('div');
                wrap.className = 'js-tilt-glare';
                const inner = document.createElement('div');
                inner.className = 'js-tilt-glare-inner';
                wrap.appendChild(inner);
                return wrap;
            }

            setupEventListeners() {
                // Close modal
                window.addEventListener('click', (e) => {
                    if (e.target === this.cache.modal) this.close();
                });

                // Navigation
                this.cache.leftArrow.addEventListener('click', () => this.navigate('prev'));
                this.cache.rightArrow.addEventListener('click', () => this.navigate('next'));

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (!appState.isModalOpen) return;
                    if (e.key === 'ArrowLeft') this.navigate('prev');
                    if (e.key === 'ArrowRight') this.navigate('next');
                    if (e.key === 'Escape') this.close();
                });

                // Touch support
                if (APP_CONFIG.touch) {
                    this.setupTouchHandlers();
                }

                // Show arrows on hover
                this.cache.modal.addEventListener('mousemove', () => this.showArrows());
            }

            setupTouchHandlers() {
                let touchStartX = 0;
                let touchEndX = 0;

                this.cache.content.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touchStartX = e.changedTouches[0].screenX;
                }, false);

                this.cache.content.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    const delta = touchEndX - touchStartX;

                    if (Math.abs(delta) > 50) {
                        this.navigate(delta < 0 ? 'next' : 'prev');
                    }
                }, false);
            }

            open(item) {
                if (appState.isModalOpen) return;

                const itemElement = item.element || item;
                appState.currentItem = itemElement;
                appState.isModalOpen = true;

                // Mark item as showing
                document.querySelectorAll('.item').forEach(el => el.classList.remove('showing'));
                itemElement.classList.add('showing');

                document.body.classList.add('modal-open');
                //disable scrolling without overflowy = hidden

                // Populate modal content
                this.populateContent(item);

                // Show modal with animation
                this.cache.modal.style.display = 'flex';
                this.cache.modal.classList.add('show');

                // Apply smart title sizing
                this.optimizeTitleSize();

                // Update URL

                this.updateURL(item.name);

                // Update navigation arrows
                this.updateNavigationArrows();
            }

            populateContent(item) {
                const data = this.extractItemData(item.element || item);

                // Reset visibility
                ['retired', 'premium', 'untradable'].forEach(key => {
                    this.cache[key].style.visibility = 'hidden';
                });

                // Set content
                this.cache.title.textContent = data.title;
                this.cache.description.textContent = data.description;
                this.cache.prc.innerHTML = `<img src="./imgs/rap.png" style="filter: drop-shadow(0px 1px 5px #49444454);height:44px;float:left;">${data.price || 0}`;

                // Handle visibility
                this.cache.prc.style.display = 'flex'

                if (data.price === 'N/A' || data.price === '0' || data.price === '') {
                    this.cache.prc.style.display = 'none';
                }

                // Set badges
                if (data.isRetired) this.cache.retired.style.visibility = 'visible';
                if (data.isPremium) this.cache.premium.style.visibility = 'visible';
                if (data.isUntradable) this.cache.untradable.style.visibility = 'visible';

                // Set background color
                const categoryColor = APP_CONFIG.modalColors[data.category];
                if (categoryColor) {
                    this.cache.content.style.backgroundColor = categoryColor;
                }

                // Handle images
                this.handleModalImages(data);

                // Handle prices
                this.handleModalPrices(data);
            }

            extractItemData(element) {

                return {
                    title: element.getAttribute('data-title-name'),
                    description: element.getAttribute('description'),
                    price: element.getAttribute('price'),
                    priceCodeRarity: element.getAttribute('prc'),
                    image: element.dataset.image,
                    svg: element.querySelector('svg')?.outerHTML || '',
                    category: element.id,
                    isRetired: !!element.querySelector('.retired'),
                    isPremium: !!element.querySelector('.premium'),
                    isUntradable: !!element.querySelector('.untradable')
                };
            }

            handleModalImages(data) {
                // Remove existing canvas and SVG
                const existingCanvas = this.cache.content.querySelector('#content-area canvas');
                if (existingCanvas) existingCanvas.remove();

                const existingSvg = this.cache.content.querySelector('#content-area .modal-svg-title');
                if (existingSvg) existingSvg.remove();

                // Remove font elements
                this.cache.content.querySelectorAll('.font').forEach(el => el.remove());

                if (data.image) {
                    const canvas = document.createElement('canvas');
                    canvas.style.cssText = `
      width: 100%;
      margin: -11px 0 -11px;
      place-self: center;
      display: block;
      user-select: none;
      z-index: 99;
    `;

                    const contentArea = this.cache.content.querySelector('#content-area');
                    contentArea.insertBefore(canvas, this.cache.description);

                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.image;
                }
                // Handle SVG titles in modal
                else if (data.svg && data.category === 'titles') {
                    const svgContainer = document.createElement('div');
                    svgContainer.className = 'modal-svg-title';

                    svgContainer.innerHTML = data.svg;

                    Object.assign(svgContainer.style, {
                        width: '100%',
                        height: '-webkit-fill-available',
                        display: 'flex',
                        alignItems: 'center',
                        zIndex: '22',
                    });

                    // Scale up the SVG for modal display
                    const svg = svgContainer.querySelector('svg');
                    if (svg) {
                        svg.style.width = '100%';
                        svg.style.overflow = 'visible';
                        svg.style.textShadow = 'none';
                        svg.style.height = 'auto';
                        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                    }

                    const contentArea = this.cache.content.querySelector('#content-area');
                    contentArea.insertBefore(svgContainer, this.cache.description);
                }
                // Handle old format titles
                else if (data.category === 'titles') {
                    const itemElement = document.querySelector('.item.showing');
                    if (itemElement) {
                        const h3Element = itemElement.querySelector('#h3');
                        if (h3Element) {
                            const clone = h3Element.cloneNode(true);
                            Object.assign(clone.style, {
                                height: '100%',
                                paddingTop: '4px',
                                zoom: '2',
                                width: '-webkit-fill-available',
                                zIndex: '22',
                                margin: '31px 0px 46px 0px',
                                alignSelf: 'center',
                                position: 'relative',
                                alignContent: 'center'
                            });
                            clone.classList.add('font');

                            const contentArea = this.cache.content.querySelector('#content-area');
                            contentArea.insertBefore(clone, this.cache.description);
                        }
                    }
                }
            }

            handleModalPrices(data) {
                // Clear existing price elements
                this.cache.popo.parentElement.querySelectorAll('.price').forEach((el, idx) => {
                    if (idx > 0) el.remove();
                });

                const prices = data.priceCodeRarity.split('\n').filter((line, index, self) =>
                    self.findIndex(l => l.toLowerCase() === line.toLowerCase()) === index
                );

                // Set first price
                this.cache.price.src = './imgs/trs.png';
                const firstPriceText = this.cache.price.nextSibling;
                if (firstPriceText) {
                    firstPriceText.textContent = prices[0] || '';
                    Object.assign(firstPriceText.style, {
                        color: '#e1e1e1',
                        fontSize: '30px',
                        fontWeight: 400,
                        display: 'block'
                    });
                }

                // Add additional prices
                prices.slice(1).forEach(priceText => {
                    const newPriceDiv = this.cache.popo.cloneNode(true);
                    newPriceDiv.childNodes[1].textContent = priceText;
                    this.cache.popo.parentElement.appendChild(newPriceDiv);
                });

                // Style prices based on content
                this.stylePrices();
            }

            stylePrices() {
                this.cache.popo.parentElement.querySelectorAll('.price').forEach(priceEl => {
                    const [img, text] = priceEl.children;
                    if (!text || !text.textContent) {
                        priceEl.style.display = 'none';
                        return;
                    }
                    modalCache.button.style.display = '';
                    const content = text.textContent;
                    //clear style sheet
                    Object.assign(text.style, {
                        color: '',
                        fontWeight: '',
                        textShadow: '',
                        fontFamily: '',
                        fontSize: '',
                        textStroke: '',
                        webkitTextStroke: ''
                    });

                    // Apply special styling
                    if (content.includes('Tokens')) {
                        console.log(content);
                        Object.assign(text.style, {
                            fontWeight: 500,
                            textStroke: '1px rgb(255, 83, 219)',
                            webkitTextStroke: '1px rgb(255, 83, 219)'
                        });
                    }

                    if (content.includes('Robux')) {
                        text.style.fontWeight = '700';
                    }

                    // Set icon based on currency
                    Object.entries(APP_CONFIG.icons).forEach(([key, src]) => {
                        if (content.toLowerCase().includes(key.toLowerCase())) {
                            text.textContent = content.toLowerCase().replace(` ${key.toLowerCase()}`, '');
                            img.src = src;
                        }
                    });

                    // Special cases
                    if (content.includes('%')) {
                        Object.assign(text.style, {
                            color: 'rgb(193 68 255)',
                            fontWeight: 500,
                            textShadow: '0 0 6px rgb(199 0 255)'
                        });
                    } else if (content.includes('[EXPIRED]')) {
                        Object.assign(text.style, {
                            textShadow: '0 0 10px black',
                            fontFamily: 'monospace',
                            fontSize: '23px',
                            color: '#cd1f1f'
                        });
                    } else if (content.includes('[ACTIVE]')) {
                        Object.assign(text.style, {
                            fontFamily: 'monospace',
                            fontSize: '23px',
                            color: 'rgb(251 255 68)'
                        });
                    } else if (content.includes('Unobtainable')) {
                        img.src = './imgs/Red_x.png';
                        text.style.color = 'rgb(255 44 44)';
                    } else if (content.includes('www.')) {
                        modalCache.button.style.display = 'unset';
                        text.style.display = 'none';
                        modalCache.button.setAttribute('onclick', `window.open('${content.includes('http') ? '' : 'https://'}${content}', '_blank')`);

                    }

                    priceEl.style.display = text.textContent ? 'flex' : 'none';
                });
            }

            optimizeTitleSize() {
                requestAnimationFrame(() => {
                    const title = this.cache.title;
                    const prc = this.cache.prc;
                    if (!title || !prc) return;

                    // Fixed configuration - no more dependency on char/word count
                    const config = {
                        maxFontSize: 50,
                        minFontSize: 24,
                        padding: 25,
                    };

                    // Set initial styles with max font size
                    title.style.cssText = `
      font-size: ${config.maxFontSize}px;
      line-height: 1.15;
      font: 900 ${config.maxFontSize}px 'Source Sans Pro';
      text-shadow: 0px 1px 5px #49444499;
      z-index: 22;
      transform: translateZ(20px);
      text-align: left;
      transition: font-size 0.1s ease;
    `;

                    // Calculate available space
                    const container = title.parentElement;
                    const containerWidth = container.offsetWidth;
                    const prcWidth = prc.offsetWidth;
                    const availableWidth = containerWidth - prcWidth - config.padding;

                    // Binary search for optimal size based on actual width
                    let low = config.minFontSize;
                    let high = config.maxFontSize;
                    let optimal = config.minFontSize;

                    while (low <= high) {
                        const mid = Math.floor((low + high) / 2);
                        title.style.fontSize = `${mid}px`;

                        // Force reflow to get accurate measurements
                        title.offsetHeight;

                        if (title.offsetWidth <= availableWidth) {
                            optimal = mid;
                            low = mid + 1;
                        } else {
                            high = mid - 1;
                        }
                    }

                    // Apply the optimal font size
                    title.style.fontSize = `${optimal}px`;

                    // Width-based special handling for very short content
                    // If title takes up less than 40% of available width, enhance typography
                    if (title.offsetWidth < availableWidth * 0.4) {
                        title.style.fontWeight = '900';
                        title.style.letterSpacing = '-0.02em';
                    }

                    title.style.opacity = this.cache.content.querySelector('canvas') ? '1' : '0';
                });
            }

            navigate(direction) {
                if (appState.isSwiping) return;

                const current = document.querySelector('.item.showing');
                if (!current) return;

                const sibling = direction === 'next'
                    ? current.nextElementSibling
                    : current.previousElementSibling;

                if (!sibling || !sibling.classList.contains('item')) return;
                console.log(1);
                // Animate transition
                appState.isSwiping = true;
                this.cache.content.classList.add(direction === 'next' ? 'swipeLeft' : 'swipeRight');
                console.log(2);
                setTimeout(() => {
                    document.body.classList.remove('modal-open');
                    appState.isModalOpen = false;
                    sibling.click();
                    console.log(sibling);
                }, 140);

                setTimeout(() => {
                    this.cache.content.style.transition = 'left 0s ease';
                    this.cache.content.classList.remove('swipeLeft', 'swipeRight');
                    this.cache.content.classList.add(direction === 'next' ? 'swipeRight' : 'swipeLeft');
                }, 100);

                setTimeout(() => {
                    this.cache.content.style.transition = '';
                    this.cache.content.classList.remove('swipeLeft', 'swipeRight');
                    appState.isSwiping = false;
                }, 250);
            }

            updateNavigationArrows() {
                const current = document.querySelector('.item.showing');
                if (!current) return;

                this.cache.leftArrow.style.display = current.previousElementSibling ? 'block' : 'none';
                this.cache.rightArrow.style.display = current.nextElementSibling ? 'block' : 'none';
            }

            showArrows() {
                this.cache.leftArrow.classList.add('show');
                this.cache.rightArrow.classList.add('show');

                clearTimeout(this.arrowTimeout);
                this.arrowTimeout = setTimeout(() => {
                    this.cache.leftArrow.classList.remove('show');
                    this.cache.rightArrow.classList.remove('show');
                }, 2000);
            }

            updateURL(itemName) {
                const slug = itemName.toLowerCase().replace(/\s+/g, '-');
                const url = new URL(window.location);
                url.searchParams.set('item', slug);
                history.pushState(null, '', url.toString());
            }

            close() {
                appState.isModalOpen = false;
                appState.isSwiping = false;

                document.body.classList.remove('modal-open');
                this.cache.content.classList.remove('expand');
                this.cache.modal.classList.remove('show');

                document.documentElement.style.overflowY = 'scroll';

                // Clear URL
                const url = new URL(window.location);
                url.searchParams.delete('item');
                history.pushState(null, '', url.toString());
            }
        }

        // Initialize modal system
        const modalSystem = new ModalSystem();

        // Export for global access
        window.modalCache = modalSystem.cache;
        window.Modal = (event) => {
            const item = event.target.closest('.item');
            if (item) modalSystem.open({ element: item, name: item.getAttribute('data-title-name') });
        };

        // ============================================
        // ITEM CREATION & CATALOG SYSTEM
        // ============================================


        class ItemFactory {
            constructor() {
                this.itemCount = 0;
            }

            create(data, color) {
                const item = document.createElement('div');
                item.classList.add('item');
                item.id = this.getCategoryId(color);
                item.setAttribute('data-title-name', data.name);

                // Set outline for weekly star items
                if (data.weeklystar) {
                    this.setWeeklyStarOutline(item, data['price/code/rarity']);
                }

                // Add badges
                this.addBadges(item, data, color);

                // Add content
                this.addItemContent(item, data, color);

                // Add pricing
                this.addPricing(item, data);

                // Add hidden data
                this.addHiddenData(item, data);

                // Add favorite button
                this.addFavoriteButton(item, data.name);

                // Add staff class if applicable
                if (data.from?.toLowerCase().includes('staff item')) {
                    item.classList.add('staff');
                }


                return item;
            }

            getCategoryId(color) {
                const categoryMap = {
                    'rgb(55, 122, 250)': 'pets',
                    'rgb(255, 177, 53)': 'effects',
                    'rgb(255, 122, 94)': 'deaths',
                    'rgb(201, 96, 254)': 'titles',
                    'rgb(91, 254, 106)': 'gears'
                };
                return categoryMap[color] || 'item';
            }

            setWeeklyStarOutline(item, priceCode) {
                const outlineColors = {
                    '60': '#b31aff',
                    '30': '#ff2a00',
                    '15': '#fae351',
                    '5': '#e0e6df'
                };

                Object.entries(outlineColors).forEach(([num, color]) => {
                    if (priceCode?.toLowerCase().includes(num)) {
                        item.style.outlineColor = color;
                    }
                });
            }

            addBadges(item, data, color) {
                if (data.retired) {
                    const retired = document.createElement('img');
                    retired.className = 'retired';
                    retired.style.cssText = `
        display: none;
        width: 17%;
        height: auto;
        position: sticky;
        margin-right: -73%;
        margin-top: -18px;
      `;
                    retired.setAttribute('draggable', false);
                    item.appendChild(retired);
                }

                if (data.premium) {
                    const premium = document.createElement('img');
                    premium.className = 'premium';
                    premium.src = APP_CONFIG.icons.premium;
                    premium.style.cssText = `
        width: 17%;
        height: auto;
        position: sticky;
        margin-right: -73%;
        margin-top: -18px;
      `;
                    premium.setAttribute('draggable', false);
                    item.appendChild(premium);
                }

                if (data.tradable === false) {
                    const untradable = document.createElement('img');
                    untradable.className = 'untradable';
                    untradable.src = APP_CONFIG.icons.untradable;
                    untradable.style.cssText = `
        width: 17%;
        height: auto;
        position: absolute;
        z-index: 100;
        bottom: 5px;
        ${data.premium ? 'left: 5px;' : 'right: 5px;'}
      `;
                    untradable.setAttribute('draggable', false);
                    item.appendChild(untradable);

                    if (color === 'rgb(201, 96, 254)') {
                        item.style.order = '1';
                    }
                }

                if (data.new) {
                    const canvas = this.createNewBadge();
                    item.appendChild(canvas);
                }
            }

            createNewBadge() {
                const canvas = document.createElement('canvas');
                canvas.id = 'new-badge';
                canvas.style.cssText = `
      width: 50%;
      height: auto;
      position: absolute;
      top: 0;
      z-index: 9;
      left: 0;
      pointer-events: none;
    `;

                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = './imgs/new.png';

                return canvas;
            }

            addItemContent(item, data, color) {
                // Add image if exists
                if (data.img) {
                    const canvas = document.createElement('canvas');
                    item.dataset.image = data.img;
                    canvas.id = 'img';
                    canvas.style.cssText = `
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: 0 auto;
      user-select: none;
      pointer-events: none;
      ${data.new ? 'padding-top: 9px;' : ''}
      ${color === 'rgb(201, 96, 254)' ? 'position: absolute;' : ''}
    `;

                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function () {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.img;

                    item.appendChild(canvas);
                }

                // Handle SVG titles (new format)
                if (data.svg) {
                    item.innerHTML = data.svg;

                    // Ensure SVG scales properly
                    const svg = item.querySelector('svg');
                    if (svg) {
                        svg.style.width = '100%';
                        svg.style.height = 'auto';
                    }

                } else {
                    const name = this.createNameElement(data, color);
                    item.appendChild(name);
                }
            }

            createNameElement(data, color) {
                const name = document.createElement('div');
                name.id = 'h3';
                name.innerText = data.name;

                if (data.new) {
                    name.style.order = '-1';
                    name.style.paddingTop = '0px';
                }

                // Hide name if has image and is title
                if (data.svg) {
                    name.style.visibility = 'hidden';
                }

                return name;
            }

            addPricing(item, data) {
                const price = document.createElement('p');
                const formattedPrice = this.formatPrice(data.price);
                price.innerHTML = `<img src="./imgs/iZGLVYo.png" draggable="false">${formattedPrice}`;

                if (data.price === 'N/A' || data.price === '0' || data.price === '') price.style.display = 'none';

                item.appendChild(price);
            }

            formatPrice(price) {
                if (typeof price !== 'string' && typeof price !== 'number') return '';

                const num = parseInt(price, 10);
                if (num >= 1000) {
                    return (num / 1000).toString().replace(/\.0$/, '') + 'k';
                }
                return price.toString();
            }

            addHiddenData(item, data) {
                item.setAttribute('description', data.from.replace(/<br>/g, '\n') || '');
                item.setAttribute('prc', data['price/code/rarity'].replace(/<br>/g, '\n') || '');
                item.setAttribute('price', data.price || 'N/A');
            }

            addFavoriteButton(item, itemName) {
                const heartBtn = document.createElement('div');
                heartBtn.className = 'heart-button';
                heartBtn.style.cssText = `
      position: absolute;
      top: -7px;
      right: -11px;
      z-index: 999;
      height: fit-content;
      font-size: 28px;
      font-family: Twemoji;
      cursor: pointer;
      user-select: none;
      border-radius: 50%;
      padding: 2px 6px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: opacity 0.2s ease, transform 0.2s ease;
    `;

                const isFavorited = appState.favorites.includes(itemName);
                if (isFavorited) {
                    heartBtn.classList.add('favorited');
                }
                heartBtn.innerHTML = isFavorited ? '❤️' : '🤍';

                // Setup interaction
                if (APP_CONFIG.touch) {
                    this.setupTouchFavorite(item, heartBtn, itemName);
                } else {
                    this.setupClickFavorite(heartBtn, itemName);
                }

                item.appendChild(heartBtn);
            }

            setupTouchFavorite(item, button, itemName) {
                let touchTimer;
                let moved = false;
                let touchDownTime;

                item.addEventListener('touchstart', (e) => {
                    moved = false;
                    touchDownTime = Date.now();

                    touchTimer = setTimeout(() => {
                        e.stopPropagation();
                        e.preventDefault();

                        const isFavorited = appState.toggleFavorite(itemName);
                        button.innerHTML = isFavorited ? '❤️' : '🤍';
                        button.classList.toggle('favorited', isFavorited);
                        button.classList.add('heart-pulsing');

                        setTimeout(() => button.classList.remove('heart-pulsing'), 400);
                    }, 400);
                });

                item.addEventListener('touchmove', () => {
                    moved = true;
                    clearTimeout(touchTimer);
                });

                item.addEventListener('touchend', (e) => {
                    clearTimeout(touchTimer);

                    if (moved) return;

                    const duration = Date.now() - touchDownTime;
                    if (duration < 400) {
                        item.click();
                    }

                    e.stopPropagation();
                    e.preventDefault();
                });
            }

            setupClickFavorite(button, itemName) {
                button.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();

                    const isFavorited = appState.toggleFavorite(itemName);
                    button.innerHTML = isFavorited ? '❤️' : '🤍';
                    button.classList.toggle('favorited', isFavorited);
                    button.classList.add('heart-pulsing');

                    setTimeout(() => button.classList.remove('heart-pulsing'), 500);
                };

                button.addEventListener('mousedown', e => {
                    e.stopPropagation();
                    document.body.classList.add('pressing-heart');
                });

                button.addEventListener('mouseup', () => {
                    document.body.classList.remove('pressing-heart');
                });

                button.addEventListener('mouseleave', () => {
                    document.body.classList.remove('pressing-heart');
                });
            }
        }


        const itemFactory = new ItemFactory();



        class SearchSystem {
            constructor() {
                this.fuse = null;
                this.searchInput = null;
                this.resultsContainer = null;
                this.activeIndex = -1;
                this.itemList = [];
            }

            init(itemList, defaultColor) {
                this.itemList = itemList;
                this.searchInput = document.getElementById('search-bar');
                this.resultsContainer = document.getElementById('search-results');

                if (!this.searchInput || !this.resultsContainer) return;

                // Initialize Fuse.js
                this.fuse = new Fuse(itemList, {
                    keys: ['name'],
                    threshold: 0.3,
                });

                this.setupEventListeners();
            }

            setupEventListeners() {
                this.searchInput.addEventListener('input', () => this.handleSearch());
                this.searchInput.addEventListener('focus', () => this.handleSearch());
                this.searchInput.addEventListener('keydown', (e) => this.handleKeyNavigation(e));

                document.addEventListener('click', (e) => {
                    if (!this.searchInput.contains(e.target) && !this.resultsContainer.contains(e.target)) {
                        this.clearResults();
                    }
                });
            }

            handleSearch() {
                const query = this.searchInput.value.trim();
                this.clearResults();
                this.activeIndex = -1;

                if (!query) {
                    this.showSearchHistory();
                    return;
                }

                const results = this.fuse.search(query).slice(0, 6);
                this.displayResults(results);
            }

            displayResults(results) {
                const fragment = document.createDocumentFragment();

                results.forEach(result => {
                    const item = result.item;
                    const div = this.createResultItem(item);

                    div.addEventListener('click', () => {
                        this.selectItem(item);
                    });

                    fragment.appendChild(div);
                });

                this.resultsContainer.appendChild(fragment);
            }

            createResultItem(item, isHistory = false) {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.textContent = isHistory ? `↩ ${item.name}` : item.name;

                Object.assign(div.style, {
                    textShadow: '-2px -2px 0 #000, 0 -2px 0 #000, 2px -2px 0 #000, 2px 0 0 #000, 2px 2px 0 #000, 0 2px 0 #000, -2px 2px 0 #000, -2px 0 0 #000',
                    padding: '8px 14px',
                    cursor: 'pointer',
                    borderBottom: '1px solid #333',
                    whiteSpace: 'nowrap',
                    backgroundColor: item._color || APP_CONFIG.colors.gears
                });

                div.addEventListener('mouseenter', () => {
                    const rgb = this.parseColor(item._color);
                    if (rgb) {
                        div.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8)`;
                    } else {
                        div.style.backgroundColor = '#444';
                    }
                });

                div.addEventListener('mouseleave', () => {
                    div.style.backgroundColor = item._color || APP_CONFIG.colors.gears;
                });

                return div;
            }

            parseColor(color) {
                if (!color) return null;
                const match = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (match) {
                    return { r: match[1], g: match[2], b: match[3] };
                }
                return null;
            }

            showSearchHistory() {
                const fragment = document.createDocumentFragment();

                appState.searchHistory.forEach(name => {
                    const item = this.itemList.find(i => i.name === name);
                    if (!item) return;

                    const div = this.createResultItem(item, true);
                    div.addEventListener('click', () => {
                        this.selectItem(item);
                    });

                    fragment.appendChild(div);
                });

                this.resultsContainer.appendChild(fragment);
            }

            selectItem(item) {
                this.searchInput.value = item.name;
                this.clearResults();
                appState.saveSearchHistory(item.name);
                this.showSelectedItem(item);
            }

            showSelectedItem(item) {
                // Clear existing items
                document.querySelectorAll('#itemlist .item').forEach(el => el.remove());

                // Create and show new item
                const element = itemFactory.create(item, item._color);
                element.onclick = (event) => {
                    modalSystem.open({ element, name: item.name });
                };

                const itemList = document.getElementById('itemlist');
                if (itemList) {
                    itemList.appendChild(element);
                    element.click();
                }
            }

            handleKeyNavigation(e) {
                const items = this.resultsContainer.querySelectorAll('.search-item');

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.activeIndex = (this.activeIndex + 1) % items.length;
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.activeIndex = (this.activeIndex - 1 + items.length) % items.length;
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.searchInput.value.trim() === 'dev') {
                            window.location.href = 'https://emwiki.site/admin';
                            return;
                        }

                        if (this.activeIndex === -1 && items.length > 0) {
                            this.activeIndex = 0;
                        }
                        items[this.activeIndex].click();

                        break;
                    case 'Escape':
                        this.clearResults();
                        this.searchInput.blur();
                        return;
                    default:
                        return;
                }

                items.forEach((item, i) => {
                    item.classList.toggle('active', i === this.activeIndex);
                    if (i === this.activeIndex) {
                        item.style.filter = 'brightness(0.8)';
                    } else {
                        item.style.filter = '';
                    }
                });
            }

            clearResults() {
                this.resultsContainer.innerHTML = '';
                this.activeIndex = -1;
            }
        }

        // ============================================
        // NAVIGATION SYSTEM
        // ============================================

        class NavigationSystem {
            constructor() {
                this.navButtons = [
                    { id: 'gearstab', href: './gears', img: './imgs/AYUbTJv.png' },
                    { id: 'deathstab', href: './deaths', img: './imgs/fADZwOh.png' },
                    { id: 'petstab', href: './pets', img: './imgs/GHXB0nC.png' },
                    { id: 'effectstab', href: './effects', img: './imgs/l90cgxf.png' },
                    { id: 'titlestab', href: './titles', img: './imgs/ZOP8l9g.png' },
                    { id: 'cheststab', href: './chests', img: './imgs/XwkWVJJ.png' },
                    { id: 'scammerstab', href: './scammers', img: './imgs/SK5csOS.png' },
                    { id: 'gamenightstab', href: './gamenights', img: './imgs/gn.png' }
                ];
            }

            init() {
                this.insertNavButtons();
                this.setupRefreshButton();
            }

            insertNavButtons() {
                const nav = document.querySelector('nav');
                if (!nav) return;

                let current = location.pathname.split('/').pop();
                if (!current || current === '') current = 'index';

                nav.innerHTML = this.navButtons
                    .filter(btn => !btn.href.endsWith(current.replace('.html', '')))
                    .map(btn => `
        <a id="${btn.id}" href="${btn.href}">
          <img src="${btn.img}" style="max-width: -webkit-fill-available;" draggable="false" onmousedown="return false">
        </a>
      `).join('\n');
            }

            setupRefreshButton() {
                const refreshBtn = document.getElementById('refresh-button');
                if (!refreshBtn) return;

                refreshBtn.onclick = () => {
                    // Animate refresh icon
                    const icon = refreshBtn.children[0];
                    if (icon) {
                        icon.style.animation = '';
                        icon.style.webkitAnimation = '';

                        setTimeout(() => {
                            icon.style.animation = 'rotate 0.7s ease-in-out 0s 1 alternate';
                            icon.style.webkitAnimation = 'rotate 0.7s ease-in-out 0s 1 alternate';
                        }, 50);
                    }

                    // Refresh random grid
                    if (window._randomArr && window._randomCategoryColors) {
                        catalogManager.populateRandom(window._randomArr, window._randomCategoryColors);
                    }
                };
            }
        }

        // ============================================
        // INTRO ANIMATION SYSTEM
        // ============================================

        class IntroAnimationSystem {
            constructor() {
                this.hasShownToday = false;
            }

            init() {
                const today = new Date().toISOString().split('T')[0];
                const lastShown = localStorage.getItem('lastShownDate');
                this.hasShownToday = lastShown === today;

                if (this.hasShownToday) {
                    this.skipIntro();
                } else {
                    this.playIntro();
                    localStorage.setItem('lastShownDate', today);
                }

                this.setupRandomLogo();
            }

            skipIntro() {
                const intro = document.querySelector('.intro');
                const header = document.querySelector('.headersheet');
                const main = document.querySelector('main');

                if (!intro || !header || !main) return;

                window.scrollTo(0, 0);
                document.body.classList.add('fonts-loaded');

                intro.style.transition = '0.5s';
                intro.style.backdropFilter = 'blur(0px)';
                intro.style.filter = 'opacity(0) blur(9px)';
                intro.style.top = '-100vh';

                header.style.opacity = '1';
                main.style.scale = '1';
                main.style.filter = 'opacity(1)';

                document.documentElement.style.overflow = 'scroll';
                document.documentElement.style.overflowX = 'hidden';

                const parallaxBg = document.querySelector('.parallax-bg');
                if (parallaxBg) {
                    parallaxBg.style.transition = APP_CONFIG.touch
                        ? 'transform 0.1s ease-out, opacity 0.2s ease'
                        : 'none';
                    parallaxBg.style.backgroundSize = 'cover';
                }
            }

            playIntro() {
                const intro = document.querySelector('.intro');
                const logoSpans = document.querySelectorAll('.logo');
                const logo3 = document.querySelector('.logo3');
                const header = document.querySelector('.headersheet');
                const main = document.querySelector('main');
                const credit = document.querySelector('.credit');

                if (!intro || !header || !main) return;

                window.scrollTo(0, 0);

                document.fonts.ready.then(() => {
                    if (credit) credit.style.color = '#ffffffb0';

                    setTimeout(() => {
                        window.scrollTo(0, 0);

                        // Activate logos
                        logoSpans.forEach((span, idx) => {
                            setTimeout(() => {
                                span.classList.add('active');
                                if (logo3) logo3.classList.add('active');
                                document.body.classList.add('fonts-loaded');
                            }, (idx + 1) * 400);
                        });

                        if (credit) credit.style.color = '#000000b0';

                        // Fade logos
                        setTimeout(() => {
                            logoSpans.forEach((span, idx) => {
                                setTimeout(() => {
                                    span.classList.remove('active');
                                    span.classList.add('fade');
                                    if (logo3) {
                                        logo3.classList.remove('active');
                                        logo3.classList.add('fade');
                                    }
                                }, (idx + 1) * 20);
                            });
                        }, 2100);

                        // Complete animation
                        setTimeout(() => {
                            intro.style.transition = '0.5s';
                            intro.style.backdropFilter = 'blur(0px)';
                            intro.style.filter = 'opacity(0) blur(9px)';
                            document.documentElement.style.overflow = 'scroll';
                            document.documentElement.style.overflowX = 'hidden';
                            if (credit) credit.style.color = '#ffffffb0';
                        }, 2440);

                        setTimeout(() => {
                            intro.style.top = '-100vh';
                            header.style.opacity = '1';
                            main.style.scale = '1';
                            main.style.filter = 'opacity(1)';
                        }, 2800);

                        // Setup parallax
                        setTimeout(() => {
                            const parallaxBg = document.querySelector('.parallax-bg');
                            if (parallaxBg) {
                                parallaxBg.style.transition = APP_CONFIG.touch
                                    ? 'transform 0.1s ease-out, opacity 0.2s ease'
                                    : 'none';
                            }
                        }, 3700);
                    });
                });
            }

            setupRandomLogo() {
                const logos = [document.querySelector('.logo3'), document.querySelector('.logo4')];
                const random = Math.random();

                let imgSrc = './imgs/XRmpB1c.png';
                if (random > 0.97) imgSrc = './imgs/burrito.png';
                else if (random > 0.93) imgSrc = './imgs/tran.webp';
                else if (random > 0.87) imgSrc = './imgs/o7IJiwl.png';

                logos.forEach(logo => {
                    if (logo) logo.src = imgSrc;
                });

                localStorage.setItem('ranimg', imgSrc);
            }
        }

        // ============================================
        // UTILITIES
        // ============================================

        function slugify(text) {
            return text.toLowerCase().replace(/\s+/g, '-');
        }

        function openModalFromURL(itemList) {
            const params = new URLSearchParams(window.location.search);
            let itemSlug = params.get('item');
            if (!itemSlug) return;

            itemSlug = decodeURIComponent(decodeURIComponent(itemSlug));

            const foundItem = itemList.find(item => {
                const name = item.name || '';
                return slugify(name) === itemSlug;
            });

            if (foundItem) {
                // Use the integrated catalog's method
                if (window.integratedCatalog) {
                    window.integratedCatalog.showSelectedItem(foundItem);
                }
            }
        }

        async function fetchData() {
            try {
                const res = await fetch('https://emwiki.site/api/gist-version');
                if (!res.ok) throw new Error('Failed to fetch data');
                const data = await res.json();
                return JSON.parse(data.files?.['auto.json']?.content);
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }


        const searchSystem = new SearchSystem();
        const navigationSystem = new NavigationSystem();
        const introAnimation = new IntroAnimationSystem();


        // ============================================
        // FULLY INTEGRATED CATALOG SYSTEM
        // ============================================

class IntegratedCatalogSystem {
            constructor() {
                this.itemFactory = null;
                this.modalSystem = null;
                this.appState = null;
                this.searchSystem = null;
                
                this.virtualScroll = {
                    itemHeight: 220,
                    itemsPerRow: 5,
                    buffer: 5,
                    scrollTop: 0,
                    visibleStart: 0,
                    visibleEnd: 0
                };
                
                this.allItems = [];
                this.filteredItems = [];
                this.currentFilters = {
                    category: 'all',
                    tags: new Set(),
                    sortBy: 'newest',
                    searchQuery: ''
                };
                
                this.categoryColors = APP_CONFIG.colors;
            }
            
            async init(existingSystems) {
                // Store references to existing systems
                this.itemFactory = existingSystems.itemFactory;
                this.modalSystem = existingSystems.modalSystem;
                this.appState = existingSystems.appState;
                this.searchSystem = existingSystems.searchSystem;
                
                this.setupVirtualScroll();
                this.setupEventListeners();
                this.setupURLRouting();
                this.integrateSearch();
                
                await this.loadItems();
                this.handleInitialRoute();
            }
            
            setupEventListeners() {
                document.querySelectorAll('.pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        const category = e.target.dataset.category;
                        this.switchCategory(category);
                    });
                });
                
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        const filter = e.target.dataset.filter;
                        this.toggleFilter(filter);
                        e.target.classList.toggle('active');
                    });
                });
                
                const sortSelect = document.getElementById('sortSelect');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        this.currentFilters.sortBy = e.target.value;
                        this.applyFilters();
                    });
                }
            }
            
            setupURLRouting() {
                window.addEventListener('hashchange', () => this.handleRoute());
                window.addEventListener('popstate', () => this.handleRoute());
            }
            
            handleInitialRoute() {
                const hash = window.location.hash.slice(1);
                const params = new URLSearchParams(window.location.search);
                
                if (hash) {
                    this.switchCategory(hash, false);
                } else if (params.get('cat')) {
                    this.switchCategory(params.get('cat'), false);
                } else {
                    this.switchCategory('all', false);
                }
                
                if (params.get('filter')) {
                    const filters = params.get('filter').split(',');
                    filters.forEach(filter => {
                        this.currentFilters.tags.add(filter);
                        const chip = document.querySelector(`[data-filter="${filter}"]`);
                        if (chip) chip.classList.add('active');
                    });
                }
                
                this.applyFilters();
            }
            
            handleRoute() {
                const hash = window.location.hash.slice(1);
                if (hash && hash !== this.currentFilters.category) {
                    this.switchCategory(hash, false);
                }
            }
            
            async switchCategory(category, updateURL = true) {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                const pill = document.querySelector(`[data-category="${category}"]`);
                if (pill) pill.classList.add('active');
                
                await this.morphTransition(this.currentFilters.category, category);
                
                this.currentFilters.category = category;
                
                if (updateURL) {
                    window.location.hash = category;
                }
                
                this.applyFilters();
            }
            
            async morphTransition(fromCat, toCat) {
                if (fromCat === toCat) return;
                
                const overlay = document.getElementById('morphOverlay');
                if (!overlay) return;
                
                overlay.innerHTML = '';
                
                const particleEmojis = {
                    gears: ['⚙️', '🔧', '🔩'],
                    deaths: ['💀', '☠️', '👻'],
                    titles: ['🏷️', '📝', '✏️'],
                    pets: ['🐾', '🐕', '🐈'],
                    effects: ['✨', '💫', '🌟'],
                    all: ['✨', '🎮', '🎯']
                };
                
                const emojis = particleEmojis[toCat] || particleEmojis.all;
                
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'morph-particle';
                    particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 2 + 's';
                    particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                    overlay.appendChild(particle);
                }
                
                overlay.classList.add('active');
                
                if (toCat !== 'all') {
                    document.body.style.setProperty('--theme-color', this.categoryColors[toCat]);
                }
                
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 500);
            }
            
            toggleFilter(filterName) {
                if (this.currentFilters.tags.has(filterName)) {
                    this.currentFilters.tags.delete(filterName);
                } else {
                    this.currentFilters.tags.add(filterName);
                }
                
                this.updateURL();
                this.applyFilters();
            }
            
            updateURL() {
                const params = new URLSearchParams();
                
                if (this.currentFilters.tags.size > 0) {
                    params.set('filter', Array.from(this.currentFilters.tags).join(','));
                }
                
                const newURL = window.location.pathname +
                    (params.toString() ? '?' + params.toString() : '') +
                    window.location.hash;
                
                history.replaceState(null, '', newURL);
            }
            
            setupVirtualScroll() {
                const container = document.getElementById('virtualScrollContainer');
                if (!container) return;
                
                this.updateItemsPerRow();
                window.addEventListener('resize', () => this.updateItemsPerRow());
                
                let rafId = null;
                container.addEventListener('scroll', () => {
                    if (rafId) return;
                    rafId = requestAnimationFrame(() => {
                        this.handleVirtualScroll();
                        rafId = null;
                    });
                });
            }
            
            updateItemsPerRow() {
                const container = document.getElementById('virtualScrollContainer');
                if (!container) return;
                
                const containerWidth = container.clientWidth;
                const itemWidth = 150;
                const gap = 20;
                
                this.virtualScroll.itemsPerRow = Math.floor((containerWidth + gap) / (itemWidth + gap));
            }
            
            handleVirtualScroll() {
                const container = document.getElementById('virtualScrollContainer');
                if (!container) return;
                
                const scrollTop = container.scrollTop;
                const containerHeight = container.clientHeight;
                
                const rowHeight = this.virtualScroll.itemHeight;
                const startRow = Math.floor(scrollTop / rowHeight);
                const endRow = Math.ceil((scrollTop + containerHeight) / rowHeight);
                
                const bufferedStart = Math.max(0, startRow - this.virtualScroll.buffer);
                const bufferedEnd = Math.min(
                    Math.ceil(this.filteredItems.length / this.virtualScroll.itemsPerRow),
                    endRow + this.virtualScroll.buffer
                );
                
                this.virtualScroll.visibleStart = bufferedStart * this.virtualScroll.itemsPerRow;
                this.virtualScroll.visibleEnd = bufferedEnd * this.virtualScroll.itemsPerRow;
                
                this.renderVirtualItems();
            }
            
            renderVirtualItems() {
                const container = document.getElementById('virtualItems');
                if (!container) return;
                
                const fragment = document.createDocumentFragment();
                const start = this.virtualScroll.visibleStart;
                const end = Math.min(this.virtualScroll.visibleEnd, this.filteredItems.length);
                
                container.innerHTML = '';
                
                const grid = document.createElement('div');
                grid.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                    gap: 20px;
                    padding: 20px;
                `;
                
                for (let i = start; i < end; i++) {
                    const item = this.filteredItems[i];
                    const element = this.createIntegratedItem(item);
                    grid.appendChild(element);
                }
                
                const offsetTop = Math.floor(start / this.virtualScroll.itemsPerRow) * this.virtualScroll.itemHeight;
                container.style.transform = `translateY(${offsetTop}px)`;
                
                fragment.appendChild(grid);
                container.appendChild(fragment);
                
                const totalRows = Math.ceil(this.filteredItems.length / this.virtualScroll.itemsPerRow);
                const spacer = document.getElementById('virtualSpacer');
                if (spacer) {
                    spacer.style.height = `${totalRows * this.virtualScroll.itemHeight}px`;
                }
            }
            
            createIntegratedItem(itemData) {
                const element = this.itemFactory.create(itemData, itemData._color || this.categoryColors[itemData.category]);
                
                element.onclick = (event) => {
                    event.stopPropagation();
                    this.modalSystem.open({
                        element: element,
                        name: itemData.name
                    });
                };
                
                if (this.currentFilters.category === 'all') {
                    const badge = document.createElement('div');
                    badge.className = 'category-indicator';
                    badge.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        background: ${this.categoryColors[itemData.category]};
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    element.appendChild(badge);
                }
                
                return element;
            }
            
            integrateSearch() {
                const searchBar = document.getElementById('search-bar');
                if (!searchBar) return;
                
                searchBar.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    if (query) {
                        const results = this.searchSystem.fuse.search(query).slice(0, 50);
                        this.filteredItems = results.map(r => r.item);
                        this.handleVirtualScroll();
                    } else {
                        this.applyFilters();
                    }
                });
            }
            
            async loadItems() {
                try {
                    const data = await fetchData();
                    if (!data) return;
                    
                    this.allItems = [];
                    
                    Object.entries(this.categoryColors).forEach(([key, color]) => {
                        const categoryItems = data[key] || [];
                        categoryItems.forEach(item => {
                            this.allItems.push({
                                ...item,
                                category: key,
                                _color: color
                            });
                        });
                    });
                    
                    if (this.searchSystem) {
                        this.searchSystem.init(this.allItems, this.categoryColors.gears);
                    }
                    
                } catch (error) {
                    console.error('Failed to load items:', error);
                }
            }
            
            applyFilters() {
                let items = [...this.allItems];
                
                if (this.currentFilters.category !== 'all') {
                    items = items.filter(item => item.category === this.currentFilters.category);
                }
                
                this.currentFilters.tags.forEach(tag => {
                    items = items.filter(item => {
                        switch (tag) {
                            case 'new': return item.new === true;
                            case 'tradable': return item.tradable !== false;
                            case 'premium': return item.premium === true;
                            case 'retired': return item.retired === true;
                            case 'weeklystar': return item.weeklystar === true;
                            case 'weekly': return item.weekly === true;
                            case 'favorites': return this.appState?.favorites.includes(item.name);
                            default: return true;
                        }
                    });
                });
                
                items = this.sortItems(items, this.currentFilters.sortBy);
                
                this.filteredItems = items;
                
                const container = document.getElementById('virtualScrollContainer');
                if (container) {
                    container.scrollTop = 0;
                }
                
                this.handleVirtualScroll();
                this.updateStats();
            }
            
            sortItems(items, sortBy) {
                const sorted = [...items];
                
                switch (sortBy) {
                    case 'newest':
                        return sorted.filter(i => i.new).concat(sorted.filter(i => !i.new));
                    case 'oldest':
                        return sorted.reverse();
                    case 'alphabetical':
                        return sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    case 'alphabetical-reverse':
                        return sorted.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
                    case 'price-high':
                        return sorted.sort((a, b) => {
                            const priceA = parseInt(a.price) || 0;
                            const priceB = parseInt(b.price) || 0;
                            return priceB - priceA;
                        });
                    case 'price-low':
                        return sorted.sort((a, b) => {
                            const priceA = parseInt(a.price) || 0;
                            const priceB = parseInt(b.price) || 0;
                            return priceA - priceB;
                        });
                    case 'rarity':
                        const rarityOrder = { 'premium': 1, 'retired': 2, 'weeklystar': 3, 'new': 4 };
                        return sorted.sort((a, b) => {
                            const aRarity = Object.keys(rarityOrder).find(key => a[key]) || 'common';
                            const bRarity = Object.keys(rarityOrder).find(key => b[key]) || 'common';
                            return (rarityOrder[aRarity] || 999) - (rarityOrder[bRarity] || 999);
                        });
                    default:
                        return sorted;
                }
            }
            
            updateStats() {
                const visibleCount = document.getElementById('visibleCount');
                const totalCount = document.getElementById('totalCount');
                
                if (visibleCount) visibleCount.textContent = this.filteredItems.length;
                if (totalCount) totalCount.textContent = this.allItems.length;
            }
            
            showSelectedItem(item) {
                document.querySelectorAll('#itemlist .item').forEach(el => el.remove());
                
                const element = this.itemFactory.create(item, item._color);
                element.onclick = (event) => {
                    this.modalSystem.open({ element, name: item.name });
                };
                
                const itemList = document.getElementById('itemlist');
                if (itemList) {
                    itemList.appendChild(element);
                    element.click();
                }
            }
        }
        // ============================================
        // INITIALIZE WITH EXISTING SYSTEMS
        // ============================================

        // Wait for existing systems to load
        async function initializeApp() {
            try {
                // Initialize your existing systems FIRST
                const appState = new AppState();
                const modalSystem = new ModalSystem();
                const itemFactory = new ItemFactory();
                const searchSystem = new SearchSystem();
                const navigationSystem = new NavigationSystem();
                const introAnimation = new IntroAnimationSystem();
                
                // Store globally
                window.appState = appState;
                window.modalSystem = modalSystem;
                window.itemFactory = itemFactory;
                window.searchSystem = searchSystem;
                window.modalCache = modalSystem.cache;
                
                // Initialize navigation and intro
                navigationSystem.init();
                 introAnimation.init();
                
                // Create integrated catalog
                const integratedCatalog = new IntegratedCatalogSystem();
                window.integratedCatalog = integratedCatalog;
                
                // Initialize with existing systems
                await integratedCatalog.init({
                    itemFactory,
                    modalSystem,
                    appState,
                    searchSystem
                });
                
                // Handle URL params
                openModalFromURL(integratedCatalog.allItems);
                
                // Add touch class if needed
                if (APP_CONFIG.touch) {
                    document.body.classList.add('is-touch');
                }
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        }
        
        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

    </script>
</body>

</html>