<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="./imgs/favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue - EM Wiki</title>
    <link rel="stylesheet" href="./css/style.css">

    <!-- Popover compatibility for older browsers -->
    <script src="./js/popover-loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
</head>
<div class="bn">
    üõ†Ô∏è Site updated Nov 11 ‚Äî <a style="color: #33c5ff;" href="#patchnotes">See
        what's new</a> ‚Äî Gallery Update üé®üñå!
</div>

<body>
    <header>
        <a href="https://emwiki.com">
            <svg width="500" height="300" viewBox="451 471 100 39" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="eppp1" y1="1" x2="0">
                        <stop offset=".2" style="stop-color:#ff0" />
                        <stop offset="1" style="stop-color:#24ff5a" />
                    </linearGradient>
                    <linearGradient id="eppp2" y1="1" x2="0">
                        <stop offset="0" style="stop-color:#24ff5d" />
                        <stop offset="1" style="stop-color:#ff0" />
                    </linearGradient>
                </defs>
                <image id="cloud" x="461" y="459" href="https://emwiki.com/imgs/TWOKPhY.png" height="60" width="60"
                    style="filter:opacity(.6)" />
                <text x="489" y="503" text-anchor="middle" stroke="#000" stroke-width="2.3" paint-order="stroke"
                    stroke-linejoin="round" fill="url(#eppp1)"
                    style="animation:floatAnim 12s ease-in-out infinite;font:200 46px Slapstick">EM</text>
                <image id="epic-image" x="464" y="463" href="https://emwiki.com/imgs/epicfaces/kitta.png" height="60"
                    width="60"
                    style="scale:.48;transform:translate(846px,103px);rotate:20deg;transform-origin:center;animation:floatAnim2 15s ease-in-out 1s infinite alternate" />
                <image id="cloud" x="495" y="477" href="https://emwiki.com/imgs/8UUB0Gt.png" height="60" width="60"
                    style="filter:opacity(.86)" />
                <text x="516" y="514" text-anchor="middle" stroke="#000" stroke-width="2.3" paint-order="stroke"
                    stroke-linejoin="round" fill="url(#eppp2)"
                    style="animation:floatAnim 12s ease-in-out infinite;animation-delay:5.5s;font:200 16px Slapstick">wiki</text>
                <image id="cloud" x="445" y="487" href="https://emwiki.com/imgs/oYKd3nJ.png" height="28" width="42"
                    style="filter:opacity(.8)" />
            </svg>
        </a>

        <div class="nav-links">
            <a href="/catalog" class="nav-link active">Catalog</a>
            <a href="/trading" class="nav-link">Trading Hub</a>
            <a href="/forum" class="nav-link">Forum</a>
            <a href="/gallery" class="nav-link">Gallery</a>
            <a href="/scammers" class="nav-link">Scammers</a>
        </div>
    </header>

    <!-- Category Carousel -->
    <div class="category-carousel-container">
        <div class="category-carousel" id="categoryCarousel"></div>
        <div class="carousel-nav prev" onclick="catalog.prevCategory()"></div>
        <div class="carousel-nav next" onclick="catalog.nextCategory()"></div>
    </div>

    <!-- Controls Bar -->
    <div class="controls-bar">
        <div class="controls-row">
            <!-- Search with Recent Items -->
            <div class="search-container">
                <input id="search-bar" type="text" placeholder="Search items..." />
                <div id="recent-items" class="recent-items"></div>
            </div>
        </div>



        <div class="filters">
            <!-- Sort Dropdown -->
            <div class="sort-dropdown">
                <button class="dropdown-btn" onclick="catalog.toggleSort()">
                    <span>Sort:</span> <span id="sort-label">Categorical</span> ‚ñº
                </button>
                <div id="sort-menu" class="dropdown-content">
                    <small class="dropdown-item" data-sort="default">Categorical</small>
                    <small class="dropdown-item" data-sort="name-asc">Name: A ‚ûî Z</small>
                    <small class="dropdown-item" data-sort="name-desc">Name: Z ‚ûî A</small>
                    <small class="dropdown-item" data-sort="price-asc">Price: Low to High</small>
                    <small class="dropdown-item" data-sort="price-desc">Price: High to Low</small>
                    <small class="dropdown-item" data-sort="demand-desc">Demand: ‚≠ê‚≠ê‚≠ê ‚ûî ‚≠ê</small>
                    <small class="dropdown-item disabled" data-sort="date-desc">Newer First</small>
                    <small class="dropdown-item disabled" data-sort="date-asc">Older First</small>
                </div>
            </div>

            <!-- Stats Dashboard -->
            <button class="stats-btn" onclick="catalog.openStats()">My Lists</button>

            <!-- Filters Dropdown -->
            <div class="filters-dropdown">
                <button class="dropdown-btn" onclick="catalog.toggleFilters()">
                    <span>Filters:</span>
                    <span id="filters-label">None</span>
                    <span class="filter-count" id="filter-count" style="display: none;">0</span>
                    <span>‚ñº</span>
                </button>

                <div id="filters-menu" class="dropdown-content">
                    <div class="filter-page active" id="main-filters-page">
                        <div class="clear-filters-btn" onclick="catalog.clearAllFilters()">
                            <span style="color: #ff6b6b;">‚úï</span> Clear All Filters
                        </div>

                    <!-- State Filters -->
                    <div class="filter-group-label">Status</div>
                    <div class="dropdown-item" data-filter="new">
                        <div class="tag-checkbox"></div>
                        <span class="icon newest-icon"></span>
                        <small class="tag-label">New</small>
                        <small class="tag-count" id="count-new">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="untradable">
                        <div class="tag-checkbox"></div>
                        <span class="icon untradable-icon"></span>
                        <small class="tag-label">Untradable</small>
                        <small class="tag-count" id="count-untradable">0</small>
                    </div>

                    <div style="display: none;" class="dropdown-item" data-filter="favorites">
                        <div class="tag-checkbox"></div>
                        <span class="icon favorites-icon"></span>
                        <small class="tag-label">Favorites</small>
                        <small class="tag-count" id="count-favorites">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="unreleased">
                        <span class="icon unreleased-icon"></span>
                        <small class="tag-label">Unreleased</small>
                        <small class="tag-count" id="count-unreleased">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="removed">
                        <span class="icon removed-icon"></span>
                        <small class="tag-label">Removed</small>
                        <small class="tag-count" id="count-removed">0</small>
                    </div>

                    <!-- Shop Filters -->
                    <div class="filter-group-label">Shops</div>
                    <div class="dropdown-item" data-filter="weeklystar">
                        <span class="icon star-icon"></span>
                        <small class="tag-label">Star Shop</small>
                        <small class="tag-count" id="count-weeklystar">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="tokenshop">
                        <span class="icon token-icon"></span>
                        <small class="tag-label">Token Shop</small>
                        <small class="tag-count" id="count-tokenshop">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="coinshop">
                        <span class="icon coinshop-icon"></span>
                        <small class="tag-label">Coin Shop</small>
                        <small class="tag-count" id="count-coinshop">0</small>
                    </div>

                    <div class="dropdown-item sub-filter" data-filter="weekly">
                        <span class="icon weekly-icon"></span>
                        <small class="tag-label">Weekly Rotation</small>
                        <small class="tag-count" id="count-weekly">0</small>
                    </div>


                    <!-- Collection Submenu -->
                    <div class="filter-group-label">Collections</div>
                    <div class="dropdown-item" data-filter="gamenight">
                        <span class="icon gamenight-icon"></span>
                        <small class="tag-label">Gamenight</small>
                        <small class="tag-count" id="count-gamenight">0</small>
                    </div>

                    <div class="dropdown-item sub-filter" data-filter="retired">
                        <div class="tag-checkbox"></div>
                        <span class="icon retired-icon"></span>
                        <small class="tag-label">Retired</small>
                        <small class="tag-count" id="count-retired">0</small>
                    </div>

                    <div class="dropdown-item" data-filter="code">
                        <span class="icon code-icon"></span>
                        <small class="tag-label">Code</small>
                        <small class="tag-count" id="count-code">0</small>
                    </div>

                    <div class="submenu" onclick="catalog.toggleEvent()">
                        <small class="tag-label">Events</small><small>‚ñ∏</small>
                    </div>
                    <div class="submenu" onclick="catalog.toggleSeason()">
                        <small class="tag-label">Seasons</small><small>‚ñ∏</small>
                    </div>
                    <div class="submenu" onclick="catalog.toggleChestMenu()">
                        <small class="tag-label">Chests</small><small>‚ñ∏</small>
                    </div>
                    </div>

                   
                </div>
            </div>
            <div class="dropdown-content submenu" id="season-menu">
            </div>
            <div class="dropdown-content submenu" id="event-menu">
            </div>

            <div class="dropdown-content submenu" id="chest-menu">
                <div class="chest-item" data-data="itemcrate" onclick="catalog.selectChest('itemcrate')">
                    <img src="https://emwiki.com/imgs/lZXN7AA.png" alt="Item Crate">
                    <div class="chest-item-info">
                        <div class="chest-name">Item Crate</div>
                        <div class="chest-meta">
                            <span class="chest-timer">
                                <svg fill="#87ceeb"
                                    style="margin-right: 1px;margin-left: 3px;width: 12px;transform: translateY(2px);"
                                    viewBox="0 0 22.5 22.5" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11.188 22.5C5 22.5 0 17.5 0 11.312S5 .093 11.188.093s11.219 5.031 11.219 11.219S17.376 22.5 11.188 22.5m0-19.625c-4.625 0-8.375 3.813-8.375 8.438s3.75 8.375 8.375 8.375 8.438-3.75 8.438-8.375-3.813-8.438-8.438-8.438m3.031 12.718-3.969-2.906c-.281-.219-.563-.688-.563-1.063V5.28c0-.344.313-.625.688-.625h1.313c.344 0 .625.281.625.625v5c0 .375.281.844.563 1.063l2.906 2.094a.687.687 0 0 1 .125.938l-.781 1.063a.684.684 0 0 1-.906.156z" />
                                </svg> 15:00
                            </span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="luckychest" onclick="catalog.selectChest('luckychest')">
                    <img src="https://emwiki.com/imgs/WFdzb0V.png" alt="Lucky Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Lucky Chest</div>
                        <div class="chest-meta">
                            <span class="chest-timer"><svg fill="#87ceeb"
                                    style="margin-right: 1px;margin-left: 3px;width: 12px;transform: translateY(2px);"
                                    viewBox="0 0 22.5 22.5" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11.188 22.5C5 22.5 0 17.5 0 11.312S5 .093 11.188.093s11.219 5.031 11.219 11.219S17.376 22.5 11.188 22.5m0-19.625c-4.625 0-8.375 3.813-8.375 8.438s3.75 8.375 8.375 8.375 8.438-3.75 8.438-8.375-3.813-8.438-8.438-8.438m3.031 12.718-3.969-2.906c-.281-.219-.563-.688-.563-1.063V5.28c0-.344.313-.625.688-.625h1.313c.344 0 .625.281.625.625v5c0 .375.281.844.563 1.063l2.906 2.094a.687.687 0 0 1 .125.938l-.781 1.063a.684.684 0 0 1-.906.156z" />
                                </svg> 30:00</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="1hrplaytime" onclick="catalog.selectChest('1hrplaytime')">
                    <img src="https://emwiki.com/imgs/IBCeaLF.png" alt="1 Hour Playtime">
                    <div class="chest-item-info">
                        <div class="chest-name">1 Hour Playtime</div>
                        <div class="chest-meta">
                            <span class="chest-timer"><svg fill="#87ceeb"
                                    style="margin-right: 1px;margin-left: 3px;width: 12px;transform: translateY(2px);"
                                    viewBox="0 0 22.5 22.5" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11.188 22.5C5 22.5 0 17.5 0 11.312S5 .093 11.188.093s11.219 5.031 11.219 11.219S17.376 22.5 11.188 22.5m0-19.625c-4.625 0-8.375 3.813-8.375 8.438s3.75 8.375 8.375 8.375 8.438-3.75 8.438-8.375-3.813-8.438-8.438-8.438m3.031 12.718-3.969-2.906c-.281-.219-.563-.688-.563-1.063V5.28c0-.344.313-.625.688-.625h1.313c.344 0 .625.281.625.625v5c0 .375.281.844.563 1.063l2.906 2.094a.687.687 0 0 1 .125.938l-.781 1.063a.684.684 0 0 1-.906.156z" />
                                </svg> 1:00:00</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="mysterybag" onclick="catalog.selectChest('mysterybag')">
                    <img src="https://emwiki.com/imgs/mLNEYGn.png" alt="Mystery Bag">
                    <div class="chest-item-info">
                        <div class="chest-name">Mystery Bag</div>
                        <div class="chest-meta">Random rewards</div>
                    </div>
                </div>
                <div class="chest-item" data-data="typicalchest" onclick="catalog.selectChest('typicalchest')">
                    <img src="https://emwiki.com/imgs/bpigTac.png" alt="Typical Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Typical Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price"><img src="./imgs/Coin.webp"
                                    style="transform: translateY(2px);margin-right: 2px;margin-left: 3px;width: 12px;height: 12px;">
                                250</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="dailyrewards" onclick="catalog.selectChest('dailyrewards')">
                    <img src="https://emwiki.com/imgs/IBCeaLF.png" alt="Daily Rewards Secret Item">
                    <div class="chest-item-info">
                        <div class="chest-name">Daily Rewards Secret Item</div>
                        <div class="chest-meta">
                            <span class="chest-timer"><svg fill="#87ceeb"
                                    style="margin-right: 1px;margin-left: 3px;width: 12px;transform: translateY(2px);"
                                    viewBox="0 0 22.5 22.5" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M11.188 22.5C5 22.5 0 17.5 0 11.312S5 .093 11.188.093s11.219 5.031 11.219 11.219S17.376 22.5 11.188 22.5m0-19.625c-4.625 0-8.375 3.813-8.375 8.438s3.75 8.375 8.375 8.375 8.438-3.75 8.438-8.375-3.813-8.438-8.438-8.438m3.031 12.718-3.969-2.906c-.281-.219-.563-.688-.563-1.063V5.28c0-.344.313-.625.688-.625h1.313c.344 0 .625.281.625.625v5c0 .375.281.844.563 1.063l2.906 2.094a.687.687 0 0 1 .125.938l-.781 1.063a.684.684 0 0 1-.906.156z" />
                                </svg> 24H</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="premiumchest" onclick="catalog.selectChest('premiumchest')">
                    <img src="https://emwiki.com/imgs/vwb0OJv.png" alt="Premium Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Premium Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price"><svg
                                    style="margin-right: 3px;margin-left: 3px;width: 12px;transform: translateY(4px);"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.6 18">
                                    <path
                                        d="M6.251 6.993v3.999h4.025V6.99Zm-.156-4.689c1.917-1.213 2.507-1.154 4.484.034l3.37 2.027c.648.43 1.255.949 1.157 2.077v4.444c.009 1.578-.127 2.032-1.065 2.656l-3.492 2.052c-2.118 1.195-2.219 1.353-4.55.001l-3.28-1.913c-.886-.562-1.373-1.115-1.315-2.45V6.733c-.025-1.63.458-1.874 1.242-2.405Zm.395 1.298c1.287-.804 1.855-1.088 3.612.034l2.777 1.641c.568.423.954.838.96 1.652v3.952c-.007.705-.271 1.405-.9 1.77l-2.813 1.684c-1.786.942-1.799 1.004-3.127.287l-3.22-1.835c-.658-.474-1.038-.651-1.006-2.009V7.131c.005-1.044.193-1.432.991-1.952ZM5.605.944C7.71-.331 8.871-.345 11.011.985l4.062 2.444c.646.363 1.512 1.515 1.528 2.588v5.847c.003 1.055-.645 2.014-1.424 2.63l-4.178 2.501c-1.843 1.087-3.052 1.56-5.486.002l-3.928-2.348C.71 14.043-.006 13.267 0 11.695V6.272c.033-1.551.668-2.233 1.498-2.899Z"
                                        fill="#FFD700" fill-rule="evenodd"></path>
                                </svg> 99</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="steelchest" onclick="catalog.selectChest('steelchest')">
                    <img src="https://emwiki.com/imgs/joSfryH.png" alt="Steel Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Steel Chest</div>
                        <div class="chest-meta">Rare items</div>
                    </div>
                </div>
                <div class="chest-item" data-data="elusivebag" onclick="catalog.selectChest('elusivebag')">
                    <img src="https://emwiki.com/imgs/MmrUfl7.png" alt="Elusive Bag">
                    <div class="chest-item-info">
                        <div class="chest-name">Elusive Bag</div>
                        <div class="chest-meta">Ultra rare</div>
                    </div>
                </div>
                <div class="chest-item" data-data="legendarychest" onclick="catalog.selectChest('legendarychest')">
                    <img src="https://emwiki.com/imgs/9Fph277.png" alt="Legendary Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Legendary Chest</div>
                        <div class="chest-meta">Legendary items</div>
                    </div>
                </div>
                <div class="chest-item" data-data="epicchest" onclick="catalog.selectChest('epicchest')">
                    <img src="https://emwiki.com/imgs/Efwzbme.png" alt="Epic Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Epic Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price" style="
    					font-family: arimo;
    					font-weight: 500;
    					color: #fff;
    					/* -webkit-text-stroke: 1px rgb(255, 83, 219); */
    					text-shadow: -1.3px -1.3px 0 #ff53db, 0 -1.3px 0 #ff53db, 1.3px -1.3px 0 #ff53db, 1.3px 0 0 #ff53db, 1.3px 1.3px 0 #ff53db, 0 1.3px 0 #ff53db, -1.3px 1.3px 0 #ff53db, -1.3px 0 0 #ff53db;
    					"><img src="https://emwiki.com/imgs/Cy9r140.png"
                                    style="transform: translateY(2px);margin-right: 3px;margin-left: 3px;width: 12px;height: 12px;">500</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="birthdaychest" onclick="catalog.selectChest('birthdaychest')">
                    <img src="https://emwiki.com/imgs/61c1df478cf7c4297798fbafe4784899.png" alt="Birthday Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Birthday Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price"><svg
                                    style="margin-right: 3px;margin-left: 3px;width: 12px;transform: translateY(4px);"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.6 18">
                                    <path
                                        d="M6.251 6.993v3.999h4.025V6.99Zm-.156-4.689c1.917-1.213 2.507-1.154 4.484.034l3.37 2.027c.648.43 1.255.949 1.157 2.077v4.444c.009 1.578-.127 2.032-1.065 2.656l-3.492 2.052c-2.118 1.195-2.219 1.353-4.55.001l-3.28-1.913c-.886-.562-1.373-1.115-1.315-2.45V6.733c-.025-1.63.458-1.874 1.242-2.405Zm.395 1.298c1.287-.804 1.855-1.088 3.612.034l2.777 1.641c.568.423.954.838.96 1.652v3.952c-.007.705-.271 1.405-.9 1.77l-2.813 1.684c-1.786.942-1.799 1.004-3.127.287l-3.22-1.835c-.658-.474-1.038-.651-1.006-2.009V7.131c.005-1.044.193-1.432.991-1.952ZM5.605.944C7.71-.331 8.871-.345 11.011.985l4.062 2.444c.646.363 1.512 1.515 1.528 2.588v5.847c.003 1.055-.645 2.014-1.424 2.63l-4.178 2.501c-1.843 1.087-3.052 1.56-5.486.002l-3.928-2.348C.71 14.043-.006 13.267 0 11.695V6.272c.033-1.551.668-2.233 1.498-2.899Z"
                                        fill="#FFD700" fill-rule="evenodd"></path>
                                </svg> 99</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="halloweenchest" onclick="catalog.selectChest('halloweenchest')">
                    <img src="https://emwiki.com/imgs/40dcd6502c70ebe110dfcf8a6652cdc3.png" alt="Halloween Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Halloween Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price"><svg
                                    style="margin-right: 3px;margin-left: 3px;width: 12px;transform: translateY(4px);"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.6 18">
                                    <path
                                        d="M6.251 6.993v3.999h4.025V6.99Zm-.156-4.689c1.917-1.213 2.507-1.154 4.484.034l3.37 2.027c.648.43 1.255.949 1.157 2.077v4.444c.009 1.578-.127 2.032-1.065 2.656l-3.492 2.052c-2.118 1.195-2.219 1.353-4.55.001l-3.28-1.913c-.886-.562-1.373-1.115-1.315-2.45V6.733c-.025-1.63.458-1.874 1.242-2.405Zm.395 1.298c1.287-.804 1.855-1.088 3.612.034l2.777 1.641c.568.423.954.838.96 1.652v3.952c-.007.705-.271 1.405-.9 1.77l-2.813 1.684c-1.786.942-1.799 1.004-3.127.287l-3.22-1.835c-.658-.474-1.038-.651-1.006-2.009V7.131c.005-1.044.193-1.432.991-1.952ZM5.605.944C7.71-.331 8.871-.345 11.011.985l4.062 2.444c.646.363 1.512 1.515 1.528 2.588v5.847c.003 1.055-.645 2.014-1.424 2.63l-4.178 2.501c-1.843 1.087-3.052 1.56-5.486.002l-3.928-2.348C.71 14.043-.006 13.267 0 11.695V6.272c.033-1.551.668-2.233 1.498-2.899Z"
                                        fill="#FFD700" fill-rule="evenodd"></path>
                                </svg> 99</span>
                        </div>
                    </div>
                </div>
                <div class="chest-item" data-data="christmaschest" onclick="catalog.selectChest('christmaschest')">
                    <img src="https://emwiki.com/imgs/christchest.png" alt="Christmas Chest">
                    <div class="chest-item-info">
                        <div class="chest-name">Christmas Chest</div>
                        <div class="chest-meta">
                            <span class="chest-price"><svg
                                    style="margin-right: 3px;margin-left: 3px;width: 12px;transform: translateY(4px);"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.6 18">
                                    <path
                                        d="M6.251 6.993v3.999h4.025V6.99Zm-.156-4.689c1.917-1.213 2.507-1.154 4.484.034l3.37 2.027c.648.43 1.255.949 1.157 2.077v4.444c.009 1.578-.127 2.032-1.065 2.656l-3.492 2.052c-2.118 1.195-2.219 1.353-4.55.001l-3.28-1.913c-.886-.562-1.373-1.115-1.315-2.45V6.733c-.025-1.63.458-1.874 1.242-2.405Zm.395 1.298c1.287-.804 1.855-1.088 3.612.034l2.777 1.641c.568.423.954.838.96 1.652v3.952c-.007.705-.271 1.405-.9 1.77l-2.813 1.684c-1.786.942-1.799 1.004-3.127.287l-3.22-1.835c-.658-.474-1.038-.651-1.006-2.009V7.131c.005-1.044.193-1.432.991-1.952ZM5.605.944C7.71-.331 8.871-.345 11.011.985l4.062 2.444c.646.363 1.512 1.515 1.528 2.588v5.847c.003 1.055-.645 2.014-1.424 2.63l-4.178 2.501c-1.843 1.087-3.052 1.56-5.486.002l-3.928-2.348C.71 14.043-.006 13.267 0 11.695V6.272c.033-1.551.668-2.233 1.498-2.899Z"
                                        fill="#FFD700" fill-rule="evenodd"></path>
                                </svg> 99</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>



        <a class="chest-expand-toggle" onclick="catalog.toggleChestExpand()"><span class="icon-down"></span></a>
    </div>


    <!-- Stats -->
    <div class="stats">
        Showing <span id="showing">0</span><span id="total">0</span> items
    </div>

    <!-- Season Label -->
    <h1 id="favs-label">
    </h1>
    <h1 id="season-label">
    </h1>

    <!-- Catalog -->
    <div class="catalog-container">
        <div id="catalog" class="catalog-grid"></div>
        <div class="load-more">
            <button id="loadMore" class="load-button">
                <div class="loading-spinner"></div>
            </button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Browse</h4>
                <a href="/catalog">Catalog</a>
                <a href="/scammers">Scammers List</a>
                <a href="/admin">Admin Portal</a>
            </div>
            <div class="footer-section">
                <h4>Community</h4>
                <a href="/forum">Forum</a>
                <a href="/trading">Trading</a>
                <a href="/lookinglogo">Gallery</a>
                <a href="https://discord.com/invite/tg">Typical Games Discord</a>
            </div>
            <div class="footer-section">
                <h4>Contact</h4>
                <p>Found a bug? Reach out to <b>@xnite</b> on Discord!</p>
                <a href="https://docs.google.com/spreadsheets/d/11qKj8UTf2-x0Z7bNMuguEFKALCWI1v7QtkDbNlBzy9M">Original
                    Google Doc</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 emwiki.com ‚Ä¢ made with ‚ù§ by xnite</p>
        </div>
    </footer>

    <script src="./js/script.js"></script>
    <script>
        class Catalog extends BaseApp {
            constructor() {
                super();
                this.filtered = [];
                this.batchSize = 50;
                this.currentBatch = 0;
                this.loading = false;
                this.currentCategoryIndex = 0;
                this.sortBy = 'default';
                this.seasonFilter = 'all';
                this.chestFilter = 'all';
                this.seasons = new Set();
                this.events = new Set();
                this.eventFilter = 'all';
                this.filterRequestId = 0;

                this.categories = [
                    { id: 'all', name: 'All', img: './imgs/XwkWVJJ.png', color: '#667eea' },
                    { id: 'gears', name: 'Gears', img: './imgs/AYUbTJv.png', color: '#5bfe6a' },
                    { id: 'deaths', name: 'Deaths', img: './imgs/fADZwOh.png', color: '#ff7a5e' },
                    { id: 'pets', name: 'Pets', img: './imgs/GHXB0nC.png', color: '#377afa' },
                    { id: 'effects', name: 'Effects', img: './imgs/l90cgxf.png', color: '#ffb135' },
                    { id: 'titles', name: 'Titles', img: './imgs/ZOP8l9g.png', color: '#c960fe' }
                ];

                this.filters = {
                    category: 'all',
                    tags: new Set(),
                    search: ''
                };

                // Tag counts for display
                this.tagCounts = {
                    new: 0,
                    untradable: 0,
                    premium: 0,
                    retired: 0,
                    removed: 0,
                    weekly: 0,
                    weeklystar: 0,
                    tokenshop: 0,
                    favorites: 0,
                    gamenight: 0,
                    coinshop: 0,
                    unreleased: 0,
                    code: 0
                };



                this.chestMappings = {
                    'itemcrate': [],
                    'luckychest': [],
                    '1hrplaytime': [],
                    'mysterybag': [],
                    'dailyrewards': [],
                    'typicalchest': [],
                    'premiumchest': [],
                    'steelchest': [],
                    'elusivebag': [],
                    'legendarychest': [],
                    'epicchest': [],
                    'birthdaychest': [],
                    'halloweenchest': [],
                    'christmaschest': [],
                };

                this.init();
            }

            async init() {
                this.renderCategoryCarousel();
                await this.loadData();
                await this.loadPreferences();
                this.populateSeasonFilter();
                this.populateEventFilter();
                this.populateChests();
                this.setupEventListeners();

                this.handleURLParams();

                this.applyFilters();
                this.loadBatch();
                document.querySelector('.bn').style.display = 'none';
                this.updateTagCounts();
            }

            handleURLParams() {
                const url = new URL(window.location);
                const filterParam = url.searchParams.get('filter');
                const itemParam = url.searchParams.get('item');



                // Handle ?filter=new
                if (filterParam === 'new') {
                    this.filters.tags.add('new');
                    const newFilterElement = document.querySelector('.dropdown-item[data-filter="new"]');
                    if (newFilterElement) {
                        newFilterElement.classList.add('selected');
                    }
                    this.updateTagsLabel();
                } else if (filterParam === 'wishlist' || filterParam === 'favorites') {
                    this.filters.tags.add(filterParam);

                    if (filterParam === 'wishlist') {
                        document.getElementById('season-label').textContent = "‚òÖ Wishlist";
                    } else {
                        document.getElementById('season-label').textContent = "‚ô• Favorites";
                    }


                    // Update the filter checkbox if it exists
                    const checkbox = document.querySelector(`input[data-filter="${filterParam}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }

                // Handle ?item=slug - will open after data loads
                if (itemParam) {
                    const itemName = itemParam.replace(/-/g, ' ');
                    // We need to wait for the items to be displayed before opening the modal
                    setTimeout(() => {
                        const item = this.allItems.find(i =>
                            i.name.toLowerCase() === itemName.toLowerCase()
                        );
                        if (item) {
                            this.modal.open(item);
                        }
                    }, 500);
                }
            }


            toggleChestMenu() {
                const menu = document.getElementById('chest-menu');
                menu.classList.toggle('show');
                document.getElementById('season-menu').classList.remove('show');
                document.getElementById('event-menu').classList.remove('show');
            }





            renderCategoryCarousel() {
                const carousel = document.getElementById('categoryCarousel');

                // Create items only once
                if (!carousel.dataset.initialized) {
                    this.categories.forEach((cat, index) => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.dataset.category = cat.id;

                        if (cat.img) {
                            const img = document.createElement('img');
                            img.src = cat.img;
                            img.alt = cat.name;
                            item.appendChild(img);
                        }

                        const label = document.createElement('small');
                        label.textContent = cat.name;
                        item.appendChild(label);

                        item.onclick = () => this.selectCategory(index);

                        carousel.appendChild(item);
                    });

                    carousel.dataset.initialized = "true";
                }

                // Update positions & active state
                const items = carousel.querySelectorAll('.category-item');
                const total = this.categories.length;

                items.forEach((item, index) => {
                    let relativePos = index - this.currentCategoryIndex;

                    // Wrap relativePos to shortest path (-N/2 .. N/2)
                    if (relativePos > total / 2) {
                        relativePos -= total;
                    } else if (relativePos < -total / 2) {
                        relativePos += total;
                    }

                    item.dataset.pos = relativePos;

                    if (index === this.currentCategoryIndex) {
                        item.classList.add('active');
                        item.style.borderColor = this.categories[index].color;
                        item.style.background = `radial-gradient(${this.categories[index].color + '66'}, transparent)`;
                    } else {
                        item.classList.remove('active');
                        item.style.borderColor = '';
                        item.style.background = '';
                    }
                });

                return carousel;
            }

            selectCategory(index) {
                this.currentCategoryIndex = index;
                this.filters.category = this.categories[index].id;
                this.renderCategoryCarousel();
                this.applyFilters();
            }

            prevCategory() {
                if (this.currentCategoryIndex > 0) {
                    this.selectCategory(this.currentCategoryIndex - 1);
                } else {
                    this.selectCategory(this.categories.length - 1);
                }
            }

            nextCategory() {
                if (this.currentCategoryIndex < this.categories.length - 1) {
                    this.selectCategory(this.currentCategoryIndex + 1);
                } else {
                    this.selectCategory(0);
                }
            }

            async loadData() {
                try {
                    this.allItems = [];
                    const categories = ['gears', 'deaths', 'titles', 'pets', 'effects'];

                    // Load all categories in parallel
                    const categoryPromises = categories.map(async (cat) => {
                        let offset = 0;
                        const limit = 500;
                        let hasMore = true;
                        
                        while (hasMore) {
                            const url = new URL('https://emwiki.com/api/items');
                            url.searchParams.set('category', cat);
                            url.searchParams.set('limit', limit.toString());
                            url.searchParams.set('offset', offset.toString());
                            
                            const response = await fetch(url.toString());
                            if (!response.ok) throw new Error(`Failed to fetch ${cat} items`);
                            
                            const data = await response.json();
                            const items = data.items || [];
                            
                            items.forEach(item => {
                                // Extract ALL seasons from description
                                const seasons = [];
                                const eventNames = [];
                                if (item.from) {
                                    // Use matchAll with global flag to find all season mentions
                                    const seasonMatches = [...item.from.matchAll(/Season (\d+)/gi)];

                                    seasonMatches.forEach(match => {
                                        const seasonNum = parseInt(match[1]);
                                        if (!seasons.includes(seasonNum)) {
                                            seasons.push(seasonNum);
                                            this.seasons.add(seasonNum);
                                        }
                                    });
                                    // Extract event names with priority handling
                                    const eventPatterns = [
                                        /Art Contest\s*(?:\d{4})?/gi,  // Check Art Contest FIRST
                                        /Summer\s*(?:\d{4})?/gi,
                                        /Leaderboard\s*(?:\d{4})?/gi,
                                        /\bEaster\s*(?:\d{4})?/gi,
                                        /Valentine(?:'s)?\s*(?:\d{4})?/gi,
                                        /Halloween\s*(?:\d{4})?/gi,
                                        /Christmas\s*(?:\d{4})?/gi,
                                        /4th of July\s*(?:\d{4})?/gi,
                                        /10th Anniversary\s*(?:\d{4})?/gi,
                                        /1B Update\s*(?:\d{4})?/gi,
                                        /2B Update\s*(?:\d{4})?/gi,
                                        /Squid Game\s*(?:\d{4})?/gi,
                                    ];

                                    const fieldsToMatch = [item.name, item.from, item['price/code/rarity']];

                                    // Check if it's an Art Contest item first
                                    let isArtContest = false;
                                    fieldsToMatch.forEach(field => {
                                        if (field && /Art Contest/i.test(field)) {
                                            isArtContest = true;
                                        }
                                    });

                                    // If it's Art Contest, ONLY add Art Contest
                                    if (isArtContest) {
                                        if (!eventNames.includes('Art Contest')) {
                                            eventNames.push('Art Contest');
                                            this.events.add('Art Contest');
                                        }
                                    } else {
                                        // Otherwise, check all other patterns normally
                                        eventPatterns.forEach(pattern => {
                                            fieldsToMatch.forEach(field => {
                                                if (field) {
                                                    const matches = [...field.matchAll(pattern)];

                                                    matches.forEach(match => {
                                                        let eventName = match[0].replace(/\s*\d{4}/, '').trim();

                                                        const normalizeEvent = (name) => {
                                                            const normalizations = {
                                                                "valentine": "Valentine's",
                                                                "Valentine": "Valentine's",
                                                                "valentine's": "Valentine's",
                                                                "christmas": "Christmas"
                                                            };

                                                            const lower = name.toLowerCase();
                                                            return normalizations[lower] || name;
                                                        };

                                                        eventName = normalizeEvent(eventName);

                                                        if (!eventNames.includes(eventName)) {
                                                            eventNames.push(eventName);
                                                            this.events.add(eventName);
                                                        }
                                                    });
                                                }
                                            });
                                        });
                                    }
                                }

                                this.allItems.push({
                                    ...item,
                                    category: cat,
                                    seasons: seasons,
                                    events: eventNames
                                });
                            });
                            
                            hasMore = items.length === limit;
                            offset += limit;
                        }
                    });
                    
                    await Promise.all(categoryPromises);

                    document.getElementById('total').textContent = this.allItems.length;

                } catch (error) {
                    console.error('Failed to load data:', error);
                }
            }

            populateSeasonFilter() {
                const seasonMenu = document.getElementById('season-menu');
                const seasons = Array.from(this.seasons).sort((a, b) => b - a);
                seasons.forEach(season => {
                    const item = document.createElement('small');
                    item.className = 'dropdown-item';
                    item.dataset.data = season;
                    item.textContent = `Season ${season}`;
                    item.onclick = () => this.selectSeason(season);
                    seasonMenu.appendChild(item);
                });
            }

            populateEventFilter() {
                const eventMenu = document.getElementById('event-menu');
                const events = Array.from(this.events).sort((a, b) => {
                    const order = [
                        'Leaderboard', 'Art Contest',
                        'Summer', 'Valentine', 'Easter',
                        'Halloween', 'Christmas', '4th of July',
                        '1B Update', '2B Update', '10th Anniversary', 'Squid Game'
                    ];

                    const indexA = order.findIndex(event => a.toLowerCase().includes(event.toLowerCase()));
                    const indexB = order.findIndex(event => b.toLowerCase().includes(event.toLowerCase()));

                    // Both in priority list - sort by their order
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    // Only A in list - A comes first
                    if (indexA !== -1) return -1;
                    // Only B in list - B comes first
                    if (indexB !== -1) return 1;
                    // Neither in list - sort alphabetically
                    return a.localeCompare(b);
                });
                events.forEach(event => {
                    const item = document.createElement('small');
                    item.className = 'dropdown-item';
                    item.dataset.data = event;
                    item.textContent = event;
                    item.onclick = () => this.selectEvent(event);
                    eventMenu.appendChild(item);
                });
            }

            toggleChestExpand() {
                const sortDropdown = document.querySelector('.filters');
                const expandToggle = document.querySelector('.chest-expand-toggle .icon-down');

                sortDropdown.classList.toggle('collapsed');
                expandToggle.classList.toggle('flipped');
            }

            populateChests() {
                // Clear existing mappings
                for (let chest in this.chestMappings) {
                    this.chestMappings[chest] = [];
                }

                // Map items to chests based on their descriptions
                this.allItems.forEach(item => {
                    const from = (item.from || '').toLowerCase();
                    const name = item.name.toLowerCase();
                    let assignedChest = null;

                    // Check for specific chest mentions
                    if (from.includes('item crate')) {
                        assignedChest = 'itemcrate';
                    } else if (from.includes('lucky chest')) {
                        assignedChest = 'luckychest';
                    } else if (from.includes('mystery bag')) {
                        assignedChest = 'mysterybag';
                    } else if (from.includes('typical chest')) {
                        assignedChest = 'typicalchest';
                    } else if (from.includes('premium chest')) {
                        assignedChest = 'premiumchest';
                    } else if (from.includes('steel chest')) {
                        assignedChest = 'steelchest';
                    } else if (from.includes('elusive bag')) {
                        assignedChest = 'elusivebag';
                    } else if (from.includes('legendary chest')) {
                        assignedChest = 'legendarychest';
                    } else if (from.includes('epic chest')) {
                        assignedChest = 'epicchest';
                    } else if (from.includes('birthday chest')) {
                        assignedChest = 'birthdaychest';
                    } else if (from.includes('daily rewards')) {
                        assignedChest = 'dailyrewards';
                    } else if (from.includes('1hr playtime rewards')) {
                        assignedChest = '1hrplaytime';
                    } else if (from.includes('halloween chest')) {
                        assignedChest = 'halloweenchest';
                    } else if (from.includes('christmas chest')) {
                        assignedChest = 'christmaschest';
                    }
                    if (assignedChest) {
                        this.chestMappings[assignedChest].push(item.name);
                        item.chest = assignedChest;
                    } else {
                        item.chest = 'all';
                    }
                });
            }



            toggleEvent() {
                const menu = document.getElementById('event-menu');
                const trigger = document.querySelector('.submenu[onclick*="toggleEvent"]');

                menu.classList.toggle('show');

                document.getElementById('season-menu').classList.remove('show');
                document.getElementById('chest-menu').classList.remove('show');
            }

            toggleSeason() {
                const menu = document.getElementById('season-menu');
                const trigger = document.querySelector('.submenu[onclick*="toggleSeason"]');

                menu.classList.toggle('show');

                document.getElementById('chest-menu').classList.remove('show');
                document.getElementById('event-menu').classList.remove('show');

            }

            selectChest(chest) {
                // Clear other filters except untradable and new
                const untradableActive = this.filters.tags.has('untradable');
                const newActive = this.filters.tags.has('new');
                this.filters.tags.clear();
                if (untradableActive) {
                    this.filters.tags.add('untradable');
                }
                if (newActive) {
                    this.filters.tags.add('new');
                }

                // Hide retired filter since gamenight is being cleared
                const retiredItem = document.querySelector('.dropdown-item[data-filter="retired"]');
                retiredItem.classList.remove('show-retired');
                retiredItem.classList.remove('selected');

                // Clear season and event filters
                this.seasonFilter = 'all';
                this.eventFilter = 'all';
                this.chestFilter = chest;

                // Update visual states
                document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                    if (item.dataset.filter !== 'untradable' && item.dataset.filter !== 'new') {
                        item.classList.remove('selected');
                    }
                });

                document.querySelectorAll('.chest-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.data == chest);
                });

                const selectedChest = document.querySelector(`.chest-item[data-data="${chest}"] .chest-name`);
                document.getElementById('season-label').textContent = selectedChest.textContent === 'None' ? '' : `${selectedChest.textContent}`;
                document.getElementById('chest-menu').classList.remove('show');

                this.updateTagsLabel();
                this.applyFilters();
            }

            selectSeason(season) {
                // Clear other filters except untradable and new
                const untradableActive = this.filters.tags.has('untradable');
                const newActive = this.filters.tags.has('new');
                this.filters.tags.clear();
                if (untradableActive) {
                    this.filters.tags.add('untradable');
                }
                if (newActive) {
                    this.filters.tags.add('new');
                }

                // Hide retired filter since gamenight is being cleared
                const retiredItem = document.querySelector('.dropdown-item[data-filter="retired"]');
                retiredItem.classList.remove('show-retired');
                retiredItem.classList.remove('selected');

                // Clear event and chest filters
                this.chestFilter = 'all';
                this.eventFilter = 'all';
                this.seasonFilter = season;

                document.getElementById('season-label').textContent = season === 'all' ? '' : `Season ${season}`;

                // Update visual states
                document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                    if (item.dataset.filter !== 'untradable' && item.dataset.filter !== 'new') {
                        item.classList.remove('selected');
                    }
                });

                document.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.data == season);
                });

                this.updateTagsLabel();
                this.applyFilters();
            }

            selectEvent(event) {
                // Clear other filters except untradable and new
                const untradableActive = this.filters.tags.has('untradable');
                const newActive = this.filters.tags.has('new');
                this.filters.tags.clear();
                if (untradableActive) {
                    this.filters.tags.add('untradable');
                }
                if (newActive) {
                    this.filters.tags.add('new');
                }

                // Hide retired filter since gamenight is being cleared
                const retiredItem = document.querySelector('.dropdown-item[data-filter="retired"]');
                retiredItem.classList.remove('show-retired');
                retiredItem.classList.remove('selected');

                // Clear season and chest filters
                this.seasonFilter = 'all';
                this.chestFilter = 'all';
                this.eventFilter = event;

                document.getElementById('season-label').textContent = event === 'all' ? '' : `${event}`;

                // Update visual states
                document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                    if (item.dataset.filter !== 'untradable' && item.dataset.filter !== 'new') {
                        item.classList.remove('selected');
                    }
                });

                document.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.data == event);
                });

                this.updateTagsLabel();
                this.applyFilters();
            }

            selectTag(tagElement, tagName) {
                // Special handling for untradable and new - they can be multi-selected
                if (tagName === 'untradable' || tagName === 'new') {
                    tagElement.classList.toggle('selected');
                    if (this.filters.tags.has(tagName)) {
                        this.filters.tags.delete(tagName);
                    } else {
                        this.filters.tags.add(tagName);
                    }
                } else if (tagName === 'retired') {
                    // Retired can only be toggled if gamenight is active
                    if (this.filters.tags.has('gamenight')) {
                        tagElement.classList.toggle('selected');
                        if (this.filters.tags.has(tagName)) {
                            this.filters.tags.delete(tagName);
                        } else {
                            this.filters.tags.add(tagName);
                        }
                    }
                } else if (tagName === 'weekly') {
                    // Weekly Rotation can only be toggled if coinshop is active
                    if (this.filters.tags.has('coinshop')) {
                        tagElement.classList.toggle('selected');
                        if (this.filters.tags.has(tagName)) {
                            this.filters.tags.delete(tagName);
                        } else {
                            this.filters.tags.add(tagName);
                        }
                    }
                } else {
                    // For all other tags - single select only
                    const wasSelected = this.filters.tags.has(tagName);

                    // Clear all filters except untradable and new
                    const untradableActive = this.filters.tags.has('untradable');
                    const newActive = this.filters.tags.has('new');
                    this.filters.tags.clear();
                    if (untradableActive) {
                        this.filters.tags.add('untradable');
                    }
                    if (newActive) {
                        this.filters.tags.add('new');
                    }

                    // Clear season, event, and chest filters
                    this.seasonFilter = 'all';
                    this.eventFilter = 'all';
                    this.chestFilter = 'all';
                    document.getElementById('season-label').textContent = '';

                    // Remove all selected classes except for multi-selectable filters
                    document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                        if (item.dataset.filter !== 'untradable' && item.dataset.filter !== 'new') {
                            item.classList.remove('selected');
                        }
                    });

                    // Toggle the clicked tag
                    if (!wasSelected) {
                        tagElement.classList.add('selected');
                        this.filters.tags.add(tagName);
                    }

                    // Show/hide retired when gamenight is selected
                    const retiredItem = document.querySelector('.dropdown-item[data-filter="retired"]');
                    if (tagName === 'gamenight' && this.filters.tags.has('gamenight')) {
                        retiredItem.classList.add('show-retired');
                    } else if (!this.filters.tags.has('gamenight')) {
                        retiredItem.classList.remove('show-retired');
                        this.filters.tags.delete('retired');
                        retiredItem.classList.remove('selected');
                    }

                    // Show/hide weekly rotation when coinshop is selected
                    const weeklyItem = document.querySelector('.dropdown-item[data-filter="weekly"]');
                    if (tagName === 'coinshop' && this.filters.tags.has('coinshop')) {
                        weeklyItem.classList.add('show-weekly');
                    } else if (!this.filters.tags.has('coinshop')) {
                        weeklyItem.classList.remove('show-weekly');
                        this.filters.tags.delete('weekly');
                        weeklyItem.classList.remove('selected');
                    }
                }

                // Update dropdown items visual state
                document.querySelectorAll('.dropdown-item').forEach(item => {
                    if (item.dataset.filter === tagName) {
                        item.classList.toggle('selected', this.filters.tags.has(tagName));
                    } else if (item.dataset.data && (item.dataset.data !== this.seasonFilter && item.dataset.data !== this.eventFilter && item.dataset.data !== this.chestFilter)) {
                        item.classList.remove('active');
                    }
                });

                // Enable/disable date sorting based on code/gamenight filters
                const hasDateFilters = this.filters.tags.has('code') || this.filters.tags.has('gamenight');
                const dateOptions = document.querySelectorAll('[data-sort="date-desc"], [data-sort="date-asc"]');

                dateOptions.forEach(option => {
                    if (hasDateFilters) {
                        option.classList.remove('disabled');
                    } else {
                        option.classList.add('disabled');
                        if (this.sortBy === 'date-desc' || this.sortBy === 'date-asc') {
                            this.selectSort('default');
                        }
                    }
                });

                if ((tagName === 'code' || tagName === 'gamenight') &&
                    this.filters.tags.has(tagName) &&
                    this.sortBy === 'default') {
                    this.selectSort('date-desc');
                }

                this.updateTagsLabel();
                this.applyFilters();
            }

            clearAllFilters() {
                // Clear all tag filters
                this.filters.tags.clear();

                // Clear season, event, and chest filters
                this.seasonFilter = 'all';
                this.eventFilter = 'all';
                this.chestFilter = 'all';

                // Clear season label
                document.getElementById('season-label').textContent = '';

                // Remove all selected/active classes from filter items
                document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                    item.classList.remove('selected');
                });

                document.querySelectorAll('.chest-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Hide retired filter
                const retiredItem = document.querySelector('.dropdown-item[data-filter="retired"]');
                if (retiredItem) {
                    retiredItem.classList.remove('show-retired');
                    retiredItem.classList.remove('selected');
                }

                // Hide weekly rotation filter
                const weeklyItem = document.querySelector('.dropdown-item[data-filter="weekly"]');
                if (weeklyItem) {
                    weeklyItem.classList.remove('show-weekly');
                    weeklyItem.classList.remove('selected');
                }

                // Reset date sorting options to disabled
                const dateOptions = document.querySelectorAll('[data-sort="date-desc"], [data-sort="date-asc"]');
                dateOptions.forEach(option => {
                    option.classList.add('disabled');
                });

                // Reset to default sort if using date sort
                if (this.sortBy === 'date-desc' || this.sortBy === 'date-asc') {
                    this.selectSort('default');
                }

                // Close the dropdown
                document.getElementById('filters-menu').classList.remove('show');

                // Update UI and reapply filters
                this.updateTagsLabel();
                this.applyFilters();
            }

            toggleSort() {
                const menu = document.getElementById('sort-menu');
                const btn = document.querySelector('.sort-dropdown');

                document.querySelectorAll('.dropdown-content').forEach(d => {
                    if (d !== menu) d.classList.remove('show');
                });

                menu.classList.toggle('show');
            }



            toggleFilters() {
                const menu = document.getElementById('filters-menu');
                const btn = document.querySelector('.filters-dropdown');

                document.querySelectorAll('.dropdown-content').forEach(d => {
                    if (d !== menu) d.classList.remove('show');
                });

                menu.classList.toggle('show');
            }

            selectSort(sortType) {
                this.sortBy = sortType;
                const labels = {
                    'default': 'Categorical',
                    'price-asc': '$ ‚ûî $$$',
                    'price-desc': '$$$ ‚ûî $',
                    'name-asc': 'A ‚ûî Z',
                    'name-desc': 'Z ‚ûî A',
                    'demand-desc': '‚≠ê‚≠ê‚≠ê ‚ûî ‚≠ê',
                    'date-desc': 'Newer First',
                    'date-asc': 'Older First'
                };
                document.getElementById('sort-label').textContent = labels[sortType];

                document.querySelectorAll('#sort-menu .dropdown-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.sort === sortType);
                });

                document.getElementById('sort-menu').classList.toggle('show');
                this.applyFilters();
            }



            setupEventListeners() {


                // Tag menu items
                document.querySelectorAll('#filters-menu .dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectTag(item, item.dataset.filter);
                    });
                });

                window.addEventListener('resize', () => {
                    document.querySelectorAll('.dropdown-content.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                });

                // Close menus when clicking outside
                document.addEventListener('click', (e) => {

                    if (!e.target.closest('.sort-dropdown')) {
                        document.getElementById('sort-menu').classList.remove('show');
                    }
                    if (!e.target.closest('.filters-dropdown')) {
                        document.getElementById('filters-menu').classList.remove('show');
                        document.getElementById('season-menu').classList.remove('show');
                        document.getElementById('event-menu').classList.remove('show');
                        document.getElementById('chest-menu').classList.remove('show');
                    }
                    if (!e.target.closest('.submenu')) {
                        document.getElementById('season-menu').classList.remove('show');
                        document.getElementById('chest-menu').classList.remove('show');
                        document.getElementById('event-menu').classList.remove('show');
                    }
                });

                // Sort dropdown items
                document.querySelectorAll('#sort-menu .dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.selectSort(item.dataset.sort);
                    });
                });



                // Search with recent items
                const searchBar = document.getElementById('search-bar');
                let searchTimeout;

                searchBar.addEventListener('focus', () => {
                    //this.showRecentItems();
                });

                searchBar.addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('recent-items').classList.remove('show');
                    }, 200);
                });

                searchBar.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.filters.search = e.target.value.toLowerCase();
                        this.applyFilters();
                    }, 300);
                });

                document.getElementById('loadMore').addEventListener('click', () => {
                    this.loadBatch();
                });

                window.addEventListener('scroll', () => {
                    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                        this.loadBatch();
                    }
                });
                window.addEventListener('popstate', () => {
                    const url = new URL(window.location);
                    const itemParam = url.searchParams.get('item');
                    if (itemParam) {
                        const itemName = itemParam.replace(/-/g, ' ');
                        const item = this.allItems.find(i =>
                            i.name.toLowerCase() === itemName.toLowerCase()
                        );
                        if (item && !this.modal.isOpen) {
                            this.modal.open(item);
                        }
                    } else {
                        if (this.modal.isOpen) {
                            this.modal.elements.modal.classList.remove('active');
                            this.modal.isOpen = false;
                            document.body.style.overflow = '';
                        }
                    }
                });
            }

            updateTagCounts() {
                // Reset counts
                Object.keys(this.tagCounts).forEach(key => this.tagCounts[key] = 0);
                // Count items for each tag
                this.allItems.forEach(item => {
                    if (item.new) this.tagCounts.new++;
                    if (item.tradable === false) this.tagCounts.untradable++;
                    if (item.premium) this.tagCounts.premium++;
                    if (item.retired) this.tagCounts.retired++;
                    if (item.removed) this.tagCounts.removed++;
                    if (this.favorites.includes(item.name)) this.tagCounts.favorites++;

                    const from = (item.from || '').toLowerCase();
                    if (from.includes('gamenight') || from.includes('rodis')) this.tagCounts.gamenight++;
                    if (from.includes('coin shop')) this.tagCounts.coinshop++;
                    if (from.includes('token shop')) this.tagCounts.tokenshop++;
                    if (from.includes('unreleased') || from.includes('@zarabelle') || from.includes('@typicaltype')) {
                        this.tagCounts.unreleased++;
                    }

                    if (from.includes('code')) this.tagCounts.code++;
                    if (from.includes('weekly rotation')) this.tagCounts.weekly++;
                    if (from.includes('star shop')) this.tagCounts.weeklystar++;
                });

                // Update UI counts
                Object.keys(this.tagCounts).forEach(tag => {
                    const countEl = document.getElementById(`count-${tag}`);
                    if (countEl) {
                        countEl.textContent = this.tagCounts[tag];
                    }
                });
            }



            updateTagsLabel() {

                const selectedCount = this.filters.tags.size + (this.seasonFilter !== 'all' ? 1 : 0) + (this.eventFilter !== 'all' ? 1 : 0) + (this.chestFilter !== 'all' ? 1 : 0);
                const tagLabel = document.getElementById('filters-label');
                const tagCount = document.getElementById('filter-count');

                if (selectedCount === 0) {
                    tagLabel.textContent = 'None';
                    tagCount.style.display = 'none';
                } else {
                    const tagNames = Array.from(this.filters.tags);
                    tagLabel.textContent = '';
                    tagCount.textContent = selectedCount;
                    tagCount.style.display = 'inline-block';
                }
            }

            applyFilters() {
                // Increment request ID to cancel any pending batch loads
                this.filterRequestId++;
                const currentRequestId = this.filterRequestId;

                this.filtered = this.allItems.filter(item => {
                    // Chest filter
                    if (this.chestFilter !== 'all') {
                        const chestItems = this.chestMappings[this.chestFilter] || [];
                        if (!chestItems.includes(item.name) && item.chest !== this.chestFilter) {
                            return false;
                        }
                    }

                    // Category filter
                    if (this.filters.category !== 'all' && item.category !== this.filters.category) {
                        return false;
                    }

                    // Season filter
                    if (this.seasonFilter !== 'all' && item.seasons && !item.seasons.includes(this.seasonFilter)) {
                        return false;
                    }

                    // Event filter
                    if (this.eventFilter !== 'all' && item.events && !item.events.includes(this.eventFilter)) {
                        return false;
                    }

                    // Search filter
                    if (this.filters.search && !item.name.toLowerCase().includes(this.filters.search)) {
                        return false;
                    }

                    // Tag filters
                    for (let tag of this.filters.tags) {
                        switch (tag) {
                            case 'new':
                                if (!item.new) return false;
                                break;
                            case 'untradable':
                                if (item.tradable !== false) return false;
                                break;
                            case 'premium':
                                if (!item.premium) return false;
                                break;
                            case 'gamenight':
                                if (!item.from.toLowerCase().includes('gamenight') && !item.from.toLowerCase().includes('rodis')) return false;
                                break;
                            case 'coinshop':
                                if (!item.from.toLowerCase().includes('coin shop')) return false;
                                break;
                            case 'tokenshop':
                                if (!item.from.toLowerCase().includes('token shop')) return false;
                                break;
                            case 'weekly':
                                if (!item.from.toLowerCase().includes('weekly rotation')) return false;
                                break;
                            case 'weeklystar':
                                if (!item.from.toLowerCase().includes('star shop')) return false;
                                break;
                            case 'code':
                                if (!item.from.toLowerCase().includes('code')) return false;
                                break;
                            case 'unreleased':
                                if (!item.from.toLowerCase().includes('unreleased')) return false;
                                break;
                            case 'retired':
                                if (!item.retired) return false;
                                break;
                            case 'favorites':
                                if (!this.favorites.includes(item.name)) return false;
                                break;
                            case 'wishlist':
                                if (!this.wishlist.includes(item.name)) return false;
                                break;
                            case 'removed':
                                if (!item.removed) return false;
                                break;
                        }
                    }
                    return true;
                });

                this.sortItems();

                // Reset display
                this.currentBatch = 0;
                this.loading = false;
                this.modal.displayed = [];
                document.getElementById('catalog').innerHTML = '';

                // Load first batch
                this.loadBatch(currentRequestId);

                // Update chest label with item count
                if (this.chestFilter !== 'all') {
                    const chestCount = this.filtered.length;
                    const selectedChest = document.querySelector(`.chest-item[data-data="${this.chestFilter}"] .chest-name`);
                }
            }

            parsePrice(price) {


                if (!price || price.toLowerCase() === 'o/c') return Number.MAX_SAFE_INTEGER;
                const str = String(price).replace('+', '').toLowerCase();

                // Handle ranges like "5-10"
                if (str.includes('-')) {
                    const parts = str.split('-').map(p => {
                        p = p.trim();
                        if (p.endsWith('k')) return parseFloat(p) * 1000;
                        if (p.endsWith('m')) return parseFloat(p) * 1_000_000;
                        return parseFloat(p);
                    });
                    // Return average of range
                    return parts.reduce((a, b) => a + b, 0) / parts.length;
                }

                // Handle k/m suffixes
                if (str.endsWith('k')) return parseFloat(str) * 1000;
                if (str.endsWith('m')) return parseFloat(str) * 1_000_000;

                return parseFloat(str) || 0;
            }

            sortItems() {
                switch (this.sortBy) {
                    case 'date-desc': // Newer first
                        this.filtered.sort((a, b) => {
                            const parseDate = (from) => {
                                if (!from) return 0;

                                let pattern = this.filters.tags.has('code') ? /\b(?:code|Code)\s*(?:\()?([A-Za-z]+)\.?\s*(\d{4})\)?/gi : /\b(?:gamenight|Gamenight)\s*(?:\()?([A-Za-z]+)\.?\s*(\d{4})\)?/gi;
                                if (this.filters.tags.has('code') && this.filters.tags.has('gamenight')) {
                                    // If both tags are selected, match either
                                    pattern = /\b(?:code|Code|gamenight|Gamenight)\s*(?:\()?([A-Za-z]+)\.?\s*(\d{4})\)?/gi;
                                }
                                const matches = [...from.matchAll(pattern)];

                                if (matches.length === 0) return 0;

                                const months = {
                                    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                                    'jul': 6, 'aug': 7, 'sep': 8, 'sept': 8, 'oct': 9, 'nov': 10, 'dec': 11
                                };

                                const timestamps = matches.map(match => {
                                    const monthStr = match[1].toLowerCase();
                                    const month = months[monthStr];
                                    const year = parseInt(match[2]);

                                    if (month === undefined) return 0;
                                    return new Date(year, month).getTime();
                                });

                                return Math.max(...timestamps);
                            };

                            return parseDate(b.from) - parseDate(a.from);
                        });
                        break;

                    case 'date-asc': // Older first
                        this.filtered.sort((a, b) => {
                            const parseDate = (from) => {
                                if (!from) return 0;

                                const pattern = /\b(?:code|Code|gamenight|Gamenight)\s*(?:\()?([A-Za-z]+)\.?\s*(\d{4})\)?/gi;
                                const matches = [...from.matchAll(pattern)];

                                if (matches.length === 0) return 0;

                                const months = {
                                    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                                    'jul': 6, 'aug': 7, 'sep': 8, 'sept': 8, 'oct': 9, 'nov': 10, 'dec': 11
                                };

                                const timestamps = matches.map(match => {
                                    const monthStr = match[1].toLowerCase();
                                    const month = months[monthStr];
                                    const year = parseInt(match[2]);

                                    if (month === undefined) return 0;
                                    return new Date(year, month).getTime();
                                });

                                return Math.max(...timestamps);
                            };

                            return parseDate(a.from) - parseDate(b.from);
                        });
                        break;

                    case 'price-asc':
                        this.filtered.sort((a, b) => {
                            const priceA = this.parsePrice(a.price);
                            const priceB = this.parsePrice(b.price);
                            const valA = priceA === 0 ? Number.MAX_SAFE_INTEGER : priceA;
                            const valB = priceB === 0 ? Number.MAX_SAFE_INTEGER : priceB;
                            return valA - valB;
                        });
                        break;
                    case 'price-desc':
                        this.filtered.sort((a, b) => {
                            const priceA = this.parsePrice(a.price);
                            const priceB = this.parsePrice(b.price);
                            return priceB - priceA;
                        });
                        break;
                    case 'name-asc':
                        this.filtered.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        this.filtered.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'demand-desc':
                        this.filtered.sort((a, b) => {
                            const demandA = a.demand || 0;
                            const demandB = b.demand || 0;
                            return demandB - demandA;
                        });
                        break;
                    default:
                        // Keep original order
                        break;
                }
            }

            loadBatch(requestId) {
                if (this.loading) return;

                // If no requestId provided, use current one (for manual "Load More" clicks)
                if (requestId === undefined) {
                    requestId = this.filterRequestId;
                }

                const start = this.currentBatch * this.batchSize;
                const end = start + this.batchSize;
                const batch = this.filtered.slice(start, end);

                if (batch.length === 0) {
                    document.getElementById('loadMore').disabled = true;
                    document.getElementById('loadMore').textContent = 'No more items';
                    return;
                }

                this.loading = true;
                document.getElementById('loadMore').disabled = true;
                document.getElementById('loadMore').innerHTML = '<div class="loading-spinner"></div>';

                setTimeout(() => {
                    // Check if this request is still current
                    if (requestId !== this.filterRequestId) {
                        this.loading = false;
                        return; // Ignore this batch, a newer filter was applied
                    }

                    batch.forEach(item => {
                        document.getElementById('catalog').appendChild(this.createItemElement(item));
                    });


                    this.currentBatch++;
                    this.loading = false;

                    document.getElementById('showing').textContent = this.modal.displayed.length;

                    if (this.modal.displayed.length >= this.filtered.length) {
                        document.getElementById('loadMore').textContent = 'All items loaded';
                        document.getElementById('loadMore').disabled = true;
                    } else {
                        document.getElementById('loadMore').textContent = 'Load More Items';
                        document.getElementById('loadMore').disabled = false;
                    }
                }, 300);
            }

        }

        window.catalog = new Catalog();
    </script>

</body>

</html>