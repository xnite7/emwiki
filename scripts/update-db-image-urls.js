/**
 * Script to update D1 database with Cloudflare Images URLs
 * 
 * Usage:
 *   node scripts/update-db-image-urls.js [--dry-run]
 * 
 * This script:
 * 1. Reads image-url-mapping.json (created by upload script)
 * 2. Updates D1 database items table with new Cloudflare Images URLs
 * 3. Replaces old image paths with new Cloudflare Images URLs
 * 
 * Requires:
 * - image-url-mapping.json file (created by upload-images-to-cloudflare-images.js)
 * - Wrangler CLI configured with D1 database access
 * - D1 database binding named DBA
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const MAPPING_FILE = path.join(__dirname, '../image-url-mapping.json');
const SQL_FILE = path.join(__dirname, '../migrations/012_update_image_urls.sql');

// Parse command line arguments
const args = process.argv.slice(2);
const DRY_RUN = args.includes('--dry-run');

async function updateDatabaseUrls() {
    console.log('Starting database URL update...\n');

    // Check if mapping file exists
    if (!fs.existsSync(MAPPING_FILE)) {
        console.error(`Error: ${MAPPING_FILE} not found`);
        console.error('Please run upload-images-to-cloudflare-images.js first to create the mapping file.');
        process.exit(1);
    }

    // Read mapping file
    const mapping = JSON.parse(fs.readFileSync(MAPPING_FILE, 'utf8'));
    console.log(`Found ${Object.keys(mapping).length} image URL mappings\n`);

    // Generate SQL update statements
    const sqlStatements = [];
    sqlStatements.push('-- Update image URLs to Cloudflare Images URLs');
    sqlStatements.push('-- Generated by update-db-image-urls.js');
    sqlStatements.push('');

    let updateCount = 0;

    for (const [oldPath, newUrl] of Object.entries(mapping)) {
        // Normalize old path for SQL matching
        const normalizedOldPath = oldPath.replace(/\\/g, '/').replace(/^\.?\//, '');
        
        // Create SQL update statement
        // Use LIKE to match paths that contain the old path
        const sql = `UPDATE items SET img = '${newUrl.replace(/'/g, "''")}' WHERE img LIKE '%${normalizedOldPath.replace(/'/g, "''")}%' AND img NOT LIKE '%imagedelivery.net%' AND img NOT LIKE '%cloudflare-images.com%';`;
        sqlStatements.push(sql);
        updateCount++;
    }

    // Write SQL file
    const sqlContent = sqlStatements.join('\n');
    fs.writeFileSync(SQL_FILE, sqlContent);
    console.log(`✅ Generated SQL file: ${SQL_FILE}`);
    console.log(`   Contains ${updateCount} UPDATE statements\n`);

    if (DRY_RUN) {
        console.log('[DRY RUN] Would execute SQL file');
        console.log('\nTo execute manually:');
        console.log(`wrangler d1 execute DBA --file=${SQL_FILE}`);
        console.log('\nOr for local database:');
        console.log(`wrangler d1 execute DBA --local --file=${SQL_FILE}`);
    } else {
        console.log('Executing SQL file...');
        try {
            // Execute SQL file using wrangler
            const command = `wrangler d1 execute DBA --file=${SQL_FILE}`;
            execSync(command, {
                stdio: 'inherit',
                cwd: path.join(__dirname, '..')
            });
            console.log('\n✅ Database updated successfully!');
        } catch (error) {
            console.error('\n❌ Failed to update database:', error.message);
            console.error('\nYou can execute the SQL file manually:');
            console.error(`wrangler d1 execute DBA --file=${SQL_FILE}`);
            process.exit(1);
        }
    }

    console.log('\n=== Summary ===');
    console.log(`Updated ${updateCount} image URL mappings`);
    console.log(`SQL file: ${SQL_FILE}`);
}

// Run update
updateDatabaseUrls().catch(error => {
    console.error('Update failed:', error);
    process.exit(1);
});

