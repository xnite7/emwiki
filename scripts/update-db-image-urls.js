/**
 * Script to update D1 database with Cloudflare Images URLs
 * 
 * Usage:
 *   node scripts/update-db-image-urls.js [--dry-run]
 * 
 * This script:
 * 1. Reads image-url-mapping.json (created by upload script)
 * 2. Updates D1 database items table with new Cloudflare Images URLs
 * 3. Replaces old image paths with new Cloudflare Images URLs
 * 
 * Requires:
 * - image-url-mapping.json file (created by upload-images-to-cloudflare-images.js)
 * - Wrangler CLI configured with D1 database access
 * - D1 database binding named DBA
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const MAPPING_FILE = path.join(__dirname, '../image-url-mapping.json');
const SQL_FILE = path.join(__dirname, '../migrations/012_update_image_urls.sql');

// Parse command line arguments
const args = process.argv.slice(2);
const DRY_RUN = args.includes('--dry-run');

// D1 database ID - can be set via environment variable or .dev.vars
// To find your D1 database ID:
// 1. Go to Cloudflare Dashboard ‚Üí D1
// 2. Click on your database
// 3. Copy the Database ID from the URL or settings
const D1_DATABASE_ID = process.env.D1_DATABASE_ID || process.env.DBA_DATABASE_ID;
const D1_DATABASE_NAME = process.env.D1_DATABASE_NAME || 'DBA';

async function updateDatabaseUrls() {
    console.log('Starting database URL update...\n');

    // Check if mapping file exists
    if (!fs.existsSync(MAPPING_FILE)) {
        console.error(`Error: ${MAPPING_FILE} not found`);
        console.error('Please run upload-images-to-cloudflare-images.js first to create the mapping file.');
        process.exit(1);
    }

    // Read mapping file
    const mapping = JSON.parse(fs.readFileSync(MAPPING_FILE, 'utf8'));
    console.log(`Found ${Object.keys(mapping).length} image URL mappings\n`);

    // Generate SQL update statements
    const sqlStatements = [];
    sqlStatements.push('-- Update image URLs to Cloudflare Images URLs');
    sqlStatements.push('-- Generated by update-db-image-urls.js');
    sqlStatements.push('');

    let updateCount = 0;

    for (const [oldPath, newUrl] of Object.entries(mapping)) {
        // Normalize old path for SQL matching
        const normalizedOldPath = oldPath.replace(/\\/g, '/').replace(/^\.?\//, '');
        
        // Create SQL update statement
        // Use LIKE to match paths that contain the old path
        const sql = `UPDATE items SET img = '${newUrl.replace(/'/g, "''")}' WHERE img LIKE '%${normalizedOldPath.replace(/'/g, "''")}%' AND img NOT LIKE '%imagedelivery.net%' AND img NOT LIKE '%cloudflare-images.com%';`;
        sqlStatements.push(sql);
        updateCount++;
    }

    // Write SQL file
    const sqlContent = sqlStatements.join('\n');
    fs.writeFileSync(SQL_FILE, sqlContent);
    console.log(`‚úÖ Generated SQL file: ${SQL_FILE}`);
    console.log(`   Contains ${updateCount} UPDATE statements\n`);

    if (DRY_RUN) {
        console.log('[DRY RUN] Would execute SQL file');
        console.log('\nTo execute manually:');
        if (D1_DATABASE_ID) {
            console.log(`wrangler d1 execute ${D1_DATABASE_ID} --file=${SQL_FILE}`);
        } else {
            console.log(`wrangler d1 execute DBA --file=${SQL_FILE}`);
            console.log('\nOr if you have the database ID:');
            console.log(`wrangler d1 execute <database-id> --file=${SQL_FILE}`);
        }
        console.log('\nOr for local database:');
        console.log(`wrangler d1 execute DBA --local --file=${SQL_FILE}`);
        console.log('\nOr via Cloudflare Dashboard:');
        console.log('1. Go to Cloudflare Dashboard ‚Üí D1 ‚Üí Your Database');
        console.log('2. Click "Query" tab');
        console.log('3. Copy and paste the SQL from the file');
        console.log('4. Execute');
    } else {
        console.log('Executing SQL file...');
        try {
            let command;
            if (D1_DATABASE_ID) {
                // Use database ID directly
                command = `wrangler d1 execute ${D1_DATABASE_ID} --file=${SQL_FILE}`;
            } else {
                // Try with binding name
                command = `wrangler d1 execute ${D1_DATABASE_NAME} --file=${SQL_FILE}`;
            }
            
            execSync(command, {
                stdio: 'inherit',
                cwd: path.join(__dirname, '..')
            });
            console.log('\n‚úÖ Database updated successfully!');
        } catch (error) {
            console.error('\n‚ùå Failed to update database:', error.message);
            console.error('\nüìù Options to update database:');
            console.error('\n1. Via Wrangler (if you have database ID):');
            console.error(`   wrangler d1 execute <database-id> --file=${SQL_FILE}`);
            console.error('\n2. Via Cloudflare Dashboard:');
            console.error('   - Go to Cloudflare Dashboard ‚Üí D1 ‚Üí Your Database');
            console.error('   - Click "Query" tab');
            console.error('   - Copy SQL from:', SQL_FILE);
            console.error('   - Paste and execute');
            console.error('\n3. Via API (if you have API token):');
            console.error('   Use Cloudflare API to execute the SQL');
            console.error('\nSQL file location:', SQL_FILE);
            process.exit(1);
        }
    }

    console.log('\n=== Summary ===');
    console.log(`Updated ${updateCount} image URL mappings`);
    console.log(`SQL file: ${SQL_FILE}`);
}

// Run update
updateDatabaseUrls().catch(error => {
    console.error('Update failed:', error);
    process.exit(1);
});

