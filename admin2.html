<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Epic Catalogue - Admin Panel</title>
    <link rel="icon" href="./imgs/admin.png" />
    <style>
        :root {
            --bg: #0f1720;
            --bg2: #000000;
            --font: #f6f7fb;
            --ghost: rgba(255, 255, 255, 0.2);
            --shade: rgba(255, 255, 255, 0.04);
            --panel: #12171c;
            --muted: #9aa4ad;
            --accent: #37a6ff;
            --success: #6cd13a;
            --danger: #e14b4b;
            --card: #1b2228;
            --glass: rgba(255, 255, 255, 0.03);

        }

        [data-theme="light"] {
            --bg: #f6f7fb;
            --bg2: #dddddd;
            --font: #000;
            --ghost: rgba(0, 0, 0, 0.2);
            --shade: rgba(0, 0, 0, 0.04);
            --panel: #dbdbdb;
            --muted: #4b5563;
            --accent: #0b5cff;
            --card: #fbfbfb;
            --glass: rgba(0, 0, 0, 0.04);
        }

        body {
            margin: 0;
            font-family: Inter, Segoe UI, Arial;
            background: linear-gradient(180deg, var(--bg), #071018);
            color: var(--muted);
        }

        header {
            position: fixed;
            inset: 0 0 auto 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: linear-gradient(180deg, var(--bg), var(--bg2));
            z-index: 50
        }

        .rap::before {
            content: url('./imgs/rap_tag.png');
            padding-right: 45px;
            zoom: 0.3;
        }

        header h1 {
            margin: 0;
            gap: 11px;
            display: flex;
            align-items: center;
            color: var(--muted);
            font-weight: 700;
            font-size: 24px;
        }

        #top-controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        #settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--panel);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 18px var(--shade);
        }

        #settings-menu {
            position: fixed;
            right: 18px;
            top: 64px;
            background: linear-gradient(175deg, #43465361, #434653d1, #43465391);
            border: 1px solid #ffffff21;
            border-style: outset;
            backdrop-filter: blur(25px);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 40px var(--shade);
            display: none;
            min-width: 220px;
        }

        #settings-menu.show {
            display: block
        }

        select::-webkit-scrollbar {
            width: 8px;
            background: var(--panel);
        }

        #settings-menu label,
        #settings-menu button {
            display: block;
            font-variant: all-petite-caps;
            text-box: auto;
            margin-bottom: 8px;
        }

        select {
            background: var(--panel);
            color: var(--accent);
            border-radius: 8px;
            padding: 2px 6px;
            border: 1px solid var(--accent);
        }

        option {
            background: var(--card);
            color: var(--muted);
        }

        main {
            padding: 96px 20px 80px;
            gap: 23px;
            margin: 0 auto;
            display: flex;

            justify-content: space-evenly;
            flex-direction: row;
            align-items: flex-start;
            position: relative;
        }

        #quick-editor-spacer {
            min-width: 420px;

            height: 100%;

        }

        #main-content {
            flex: auto;
            display: flex;
            flex-direction: row;
            gap: 23px;
            flex-wrap: wrap;
        }

        #tutorial {
            display: none;
        }

        #tutorial p {
            margin: 4px;
        }

        #tutorial h1 {
            font-variant: all-small-caps;

            margin-bottom: 13px;
            text-shadow: -1px 4px 20px #ffffff;
        }

        .initial {
            pointer-events: none !important;
            display: none !important;
        }

        .initial * {
            pointer-events: none;
            opacity: 0;
            filter: blur(10px);
        }

        .initial .tag-left {
            filter: opacity(0.6) blur(10px) !important;
        }

        .initial #tutorial {
            opacity: 1;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 89%;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            filter: unset;
        }

        .initial #tutorial * {
            opacity: 1;
            filter: unset;
        }

        #quick-editor-content {
            pointer-events: all;
            position: fixed;
            width: min(400px, 100vw);
            max-width: 92vw;
            flex-wrap: wrap;
            height: auto;
            z-index: 9999;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
            color: var(--font);
            transition: left 320ms cubic-bezier(.2, .9, .2, 1), top 320ms cubic-bezier(.2, .9, .2, 1),
                transform 220ms cubic-bezier(.2, .9, .2, 1);
            touch-action: none;
            gap: 6px;
            user-select: none;
            overflow: visible;
            padding: 12px;
            background: #4254622e;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(60px);
        }




        #quick-editor-modal.show {
            transform: translateX(0);
        }

        #quick-editor-content img {
            max-width: 100%;
            max-height: 140px;
            object-fit: contain;
            filter: drop-shadow(2px 4px 12px #00000069);
            border-radius: 8px;
        }

        #quick-editor-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: transparent;
            border: none;
            font-size: 28px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 700;
        }

        #quick-editor-content label {
            scale: 1;
            display: block;
            font-size: 19px;
            margin-bottom: 8px;
        }

        @font-face {
            font-family: BuilderSans;
            font-weight: 500;
            src: url('https://emwiki.site/fonts/BuilderSans-Medium-500.woff2') format('woff2')
        }

        @font-face {
            font-family: BuilderSans;
            font-weight: 700;
            src: url('https://emwiki.site/fonts/BuilderSans-Bold-700.woff2') format('woff2')
        }

        #quick-editor-content input {

            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--ghost);
            background: transparent;
            color: var(--muted);
            font-size: 14px;
        }

        #quick-editor-price {
            font-family: 'BuilderSans' !important;
            color: #000000 !important;
            text-align: left !important;
            padding: 0px 0px !important;
            font-size: 26px !important;
        }

        .price-label {
            font-family: 'BuilderSans';
            font-size: 16px;
            font-weight: 1000;
            position: absolute;
            top: 8px;
            left: 8px;
            color: #ffffff94;
            background: #ffffff2e;
            padding: 1px 4px;
            border-radius: 6px;
            backdrop-filter: blur(5px) brightness(0.4);
        }

        .price-label::before {
            content: url(./imgs/iZGLVYo.png);
            display: inline-block;
            width: 221px;
            zoom: 0.069;
            opacity: 0.7;
            margin-right: 2px;
        }

        #quick-editor-price:focus {
            font-family: 'BuilderSans' !important;
            color: #000000 !important;
            text-align: left !important;
            padding: 0px 0px !important;
            font-size: 26px !important;
        }

        /*.price-area:focus-within {
            filter: drop-shadow(0px 0px 5px yellow);
        }*/

        #quick-editor-price::placeholder {
            color: #00000073 !important;
            text-align: left !important;
            padding: 0px 0px !important;
            font-size: 26px !important;
        }

        #quick-editor-price:autofill {
            background-color: light-dark(rgba(232, 240, 254, 0), rgba(70, 90, 126, 0)) !important;
        }


        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            width: -webkit-fill-available;
            max-width: 1100px;
            margin-bottom: 18px;
            box-shadow: 0 6px 24px var(--shade);
        }

        .section h2 {
            margin: 0 0 12px 0;
            color: var(--accent);
            font-variant: all-petite-caps;
            font-size: 35px;
            color: #f0f8ff24;
            user-select: none;
            margin-top: -20px;
            height: 42px;
            /* -webkit-text-stroke: 2px #0000001a; */
        }

        #settings-menu h2 {
            margin: -13px 0px 12px 0px;
            color: var(--ghost);
            font-variant: all-petite-caps;
            font-size: 35px;
            user-select: none;
            height: 42px;
            /* -webkit-text-stroke: 2px #0000001a; */
        }

        * {
            user-select: none;
        }

        .flex {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;

            margin-bottom: 8px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            min-width: -webkit-fill-available;
            min-height: 88%;
        }

        .panel {
            background: var(--panel);
            padding: 12px;
            border-radius: 10px
        }

        .item-card {
            outline: 1px solid #313131;
            background: linear-gradient(180deg, var(--shade), var(--glass));
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            height: 120px;
            width: 120px;
            scale: 1;
            cursor: grab;
            justify-content: flex-end;
        }

        .item-card img {
            max-width: 92px;
            max-height: 92px;
            object-fit: contain
        }

        .item-name {
            font-weight: 600;
            color: var(--font);
            white-space: nowrap;
            text-align: center;
            font-size: 13px
        }

        .inputs-row {
            display: flex;
            gap: 6px;
            width: 100%;
            align-items: stretch;
            flex-direction: column;
        }

        .inputs-row input,
        .inputs-row select {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--ghost);
            background: transparent;
            color: var(--muted)
        }



        @media(min-width:2500px) {
            #lists-section {
                max-width: 644px;
            }
        }

        @media(min-width:1173px) {

            #lists-section,
            #history-section {
                max-width: 1076px;
            }
        }

        @media(min-width:1300px) {

            #lists-section,
            #history-section {
                max-width: 953px;
            }
        }

        @media(min-width:1620px) {

            #lists-section,
            #history-section {
                max-width: 1077px;
            }

        }


        .small-btn {
            padding: 6px 8px;
            border-radius: 8px;
            border: none;

            background: var(--accent);
            color: var(--font);
            cursor: pointer;
            transition: filter 0.2s ease, scale 0.1s ease;
        }

        .ghost {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }



        .small-btn:hover {
            filter: brightness(0.9) saturate(1.5);
            scale: 1.1;
        }

        .ghost {
            background: transparent;
            border: 1px solid var(--ghost);

        }

        .ghost:hover {

            filter: brightness(0.8) saturate(1);
            scale: 1;
        }

        .tag {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--glass);
            color: var(--muted)
        }

        #save-btn {
            position: fixed;
            right: -129px;
            font-variant: all-petite-caps;
            font-size: 27px;
            word-spacing: 11px;
            text-shadow: 0 0 2px #44769f;
            letter-spacing: 0px;
            bottom: 18px;
            background: linear-gradient(137deg, #4e99c5, #28a97b);
            filter: saturate(0);
            border: none;
            padding: 12px 14px;
            border-bottom: 3px solid #225a74;
            border-top: 1px solid #ffffff6b;
            border-radius: 12px;
            color: #042;
            cursor: pointer;
            box-shadow: 0px 0px 8px 4px rgb(0 0 0);
            padding-left: 20px;
            padding-right: 30px;
            transition: all 0.3s ease, letter-spacing 1s ease;
        }

        input#search:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        #search {
            padding-left: 30px;
            /* Adjust based on icon size and desired spacing */
            width: 200px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;

        }

        #search~i {
            mask-image: url('data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M10%204a6%206%200%201%200%200%2012%206%206%200%200%200%200-12zm-8%206a8%208%200%201%201%2014.32%204.906l5.387%205.387a1%201%200%200%201-1.414%201.414l-5.387-5.387A8%208%200%200%201%202%2010z%22%2F%3E%3C%2Fsvg%3E');
            position: absolute;
            left: 8px;
            background: var(--ghost);
            /* Adjust for icon positioning */
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 16px;
        }

        #save-btn:hover {
            letter-spacing: 2px;
            filter: saturate(1.5);
            background: linear-gradient(137deg, #4e99c5, #28a97b);
            right: -8px;
        }

        #logout {
            background: linear-gradient(180deg, var(--danger), #890000);
            border: 1px solid #810000;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
        }

        .collapsible {
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.02);
            display: flex;
            justify-content: space-between;
            align-items: center
        }



        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .note {
            font-size: 12px;
            color: var(--muted);
        }


        @media(min-width:2100px) {
            #history-section {
                max-width: 450px;
            }
        }

        /*1076px*/
        @media(min-width:1300px) {
            .initial {
                display: flex !important;
            }
        }



        .history-item {
            white-space: break-spaces;
            background: #0b0f12;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: var(--muted);
            font-family: monospace
        }

        @media(max-width:720px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr))
            }

            header {
                padding: 10px
            }

            main {
                padding: 84px 12px
            }
        }

        .tag-pill {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            white-space: nowrap;
            border: 1px solid;
            border-radius: 999px;
            font-size: 0.85em;
        }

        .tag-option {
            display: block;
            width: 100%;
            background: transparent;
            border: none;
            padding: 5px;
            color: white;
            cursor: pointer;
            text-align: left;
        }

        .tag-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }

        /* Modal basics — keep your .hidden class logic */
        #quick-editor-modal {
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
        }

        /* The draggable panel */

        #quick-editor-content div label~button {
            float: right;
            margin-left: 8px;
            background: transparent;
            border: 0px;
            margin-bottom: 20px;
            color: #66daff;
            cursor: pointer;
            font-variant: all-small-caps;
            padding: 11px;
            transition: all 220ms cubic-bezier(.2, .9, .2, 1), font-size 220ms cubic-bezier(.2, .9, .2, 1);
        }


        #quick-editor-content div label~button::before {
            content: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='3 5 18 18' fill='rgb(102 218 255)'><path d='M19 15h-6v7h-3v-7H4v-3h6V6h3v6h6v2z'/></svg>");
            display: inline-block;
            width: 9px;
            margin-right: 2px;
        }

        .icon {
            width: 16px;
            height: 16px;
            margin: 0;
            float: left;
            margin-right: 7px;
            background: var(--font);

        }

        #quick-editor-content div label~button:hover {
            color: #24b8e9;
            letter-spacing: 1px;
        }



        /* A visible handle style so user knows they can drag */
        #quick-editor-title {
            cursor: grab;
            color: var(--muted);
            margin: 0 0 8px;
            padding: 6px 8px;
            display: inline-block;
            border-radius: 8px;
            background: linear-gradient(90deg, rgb(255 255 255 / 9%), transparent);
            font-size: 23px;
        }

        #quick-editor-title:active {
            cursor: grabbing;
        }

        /* while dragging remove transitions for immediate follow */
        #quick-editor-content.dragging {
            transition: none;
        }

        /* Close button sits on top-right of the content */
        #quick-editor-close {
            position: absolute;
            right: 17px;
            top: 12px;
            background: transparent;
            border: none;
            color: #ffffff91;
            font-size: 36px;
            cursor: pointer;
            transition: color 220ms cubic-bezier(.2, .9, .2, 1);
            user-select: none;
        }

        #quick-editor-close:hover {

            color: #ffffffe0;

        }

        /* Keep inprgba(255, 255, 255, 0.555)e */
        #quick-editor-content input,
        #quick-editor-content button {
            user-select: text;
        }

        #quick-editor-code {
            width: 95%;
            margin-top: 11px;
        }

        hr {
            height: 3px;
            background: linear-gradient(90deg, transparent, #ffffffb5, transparent);
            margin: 5px 0 12px;
            border: 0;
        }

        .price-tag {
            margin: 7px auto 5px;
            filter: invert(0.63);
            display: flex;
            align-items: center;
            height: 52px;
            background: none;
            user-select: none;
            font-family: Arial, sans-serif;
        }



        #quick-editor-content label {
            font-size: 22px;
            font-variant: all-petite-caps;
            font-weight: 500;
            color: #ffffff7a;
        }

        .quick-editor-body+hr+div label h1 {
            color: #ffffff7a;
            position: absolute;
            font-weight: 900;
            right: 0;
            top: 0;
            font-size: 14px;
            text-align: center;
            font-family: 'BuilderSans';
            border: 3px solid;
            float: right;
            border-radius: 100%;
            width: 18px;
            height: 18px;
            font-variant: normal;
            display: block;
            transition: color 0.2s ease;
        }

        .quick-editor-body+hr+div label h1:hover {
            color: #ffffffc4;
        }

        .quick-editor-body+hr+div label p {
            display: none;
            position: absolute;
            background: linear-gradient(179deg, #43474f8f, #3b3b3bc9);
            backdrop-filter: blur(14px);
            font: 400 15px 'Source Sans Pro';
            color: #858585;
            font-family: 'BuilderSans';
            padding: 11px;
            border-radius: 10px;
            margin-top: -95px;
            margin-left: 21px;
            filter: drop-shadow(2px 4px 3px black) drop-shadow(2px 4px 3px #333);
            border: 1px solid #555555;
            font-variant-caps: all-petite-caps;
            opacity: 1;
            transition: opacity 0.2s ease;

            @starting-style {
                opacity: 0;
            }
        }




        .quick-editor-body+hr+div label h1:hover~p {
            position: absolute;
            display: inline-block;
        }

        .prc-list {
            margin-bottom: -5px;
            padding-left: 16px;
            font-variant: contextual;
            font-size: 14px;
            font-weight: 400;
            margin-top: 11px;
        }

        .quick-editor-body {
            display: inline-flex;
            align-items: center;
            flex-wrap: wrap;
            flex-direction: row;
        }

        .desc-list {
            margin-bottom: -5px;
            padding-left: 16px;
            font-variant: contextual;
            font-size: 15px;
            font-weight: 400;
            margin-top: 11px;
        }

        .price-tag:has(.price-area:focus-within) {
            filter: invert(0);
        }

        /* Left part of the tag: fixed shape (excluding white part) */
        .tag-left {
            transition: all 0.2s ease;
            filter: opacity(0.6);
            flex-shrink: 0;
            width: 60px;
            height: 100%;
            background: url('./imgs/rap_tag.png') no-repeat center / contain;
        }




        /*.tag-left:has(+ .price-area:focus-within) {
                    filter: opacity(0.6) drop-shadow(0px 0px 5px yellow);
                    flex-shrink: 0;
                    width: 69px;
                    height: 100%;
                    background: url(./imgs/rap_tag.png) no-repeat center / contain;
                }/*

                /* Right part: white area that expands */
        .price-area {

            flex-grow: 1;
            height: 100%;
            background: linear-gradient(90deg, #ffffff99, #ffffff5e, #ffffff21);
            border-radius: 0 20px 20px 0;
            /* rounded right edges */
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            min-width: 50px;

        }

        .blur {

            animation: quick-editor-price-fade-out 0.5s ease forwards;
        }

        @keyframes quick-editor-price-fade-out {
            0% {
                filter: brightness(5);
            }



            100% {
                filter: brightness(1);
            }
        }


        /* When the input is focused, expand the right area */
        .price-area:focus-within {
            flex-grow: 2;
            width: 200px;
            /* Adjust as needed */

        }

        /* The input */
        .price-area input {
            width: 100%;
            font-size: 20px;
            font-weight: bold;
            border: none;
            outline: none;
            background: transparent;
            text-align: center;
            /* prevent input from shrinking */
            min-width: 1ch;
        }

        /* Optional: hide default input spinner for number */
        .price-area input::-webkit-inner-spin-button,
        .price-area input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #admin-online {
            cursor: default;
            user-select: none;
        }
    </style>
    <link rel="manifest" href="/dev.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>

<body data-theme="dark">
    <header>

        <h1><img src="./imgs/eng.png" style="width: 52px;">Epic Catalogue<strong style="
    font-variant-caps: all-petite-caps;
">Admin Panel</strong></h1>
        <div id="top-controls">
            <div class="tag" id="admin-online">connecting...</div>
            <div id="settings-btn">⚙</div>
        </div>
        <div id="settings-menu" aria-hidden="true">
            <h2>Settings</h2>
            <label>Theme
                <select id="theme-select">
                    <option value="dark">Dark</option>
                    <!--     <option value="light">Light</option> -->
                </select>
            </label>
            <label>Quick actions</label>
            <button id="download-json" class="small-btn ghost">
                <p class="icon"
                    style="mask-image: url('data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M12%202a1%201%200%200%201%201%201v10.586l2.293-2.293a1%201%200%200%201%201.414%201.414l-4%204a1%201%200%200%201-1.414%200l-4-4a1%201%200%201%201%201.414-1.414L11%2013.586V3a1%201%200%200%201%201-1zM5%2017a1%201%200%200%201%201%201v2h12v-2a1%201%200%201%201%202%200v2a2%202%200%200%201-2%202H6a2%202%200%200%201-2-2v-2a1%201%200%200%201%201-1z%22%2F%3E%3C%2Fsvg%3E');">
                </p>
                Download JSON
            </button>
            <button id="logout" title="Logout (clear admin key)">
                <p class="icon"
                    style="mask-image: url('data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M2%206a2%202%200%200%201%202-2h9a2%202%200%200%201%202%202v2a1%201%200%201%201-2%200V6H4v12h9v-2a1%201%200%201%201%202%200v2a2%202%200%200%201-2%202H4a2%202%200%200%201-2-2V6zm15.293%202.293a1%201%200%200%201%201.414%200l3%203a1%201%200%200%201%200%201.414l-3%203a1%201%200%200%201-1.414-1.414L18.586%2013H9a1%201%200%201%201%200-2h9.586l-1.293-1.293a1%201%200%200%201%200-1.414z%22%2F%3E%3C%2Fsvg%3E');">
                </p>
                Logout
            </button>
            <div style="height:8px"></div>
            <div class="note">Tip: edits modify the loaded list in memory. Click SAVE to publish to website.</div>
        </div>

    </header>

    <main>
        <div id="quick-editor-spacer" style="visibility: hidden;width: 424px;" class="initial"></div>
        <div id="main-content">
            <div class="section" id="lists-section">
                <h2>Shops</h2>
                <div style="display:flex;gap:12px;margin-bottom:28px;flex-wrap:wrap">
                    <div class="panel" style="flex:1;min-width:180px">
                        <div
                            style="font-weight:700;margin-bottom:8px;font-variant-caps: all-small-caps;margin-top: -10px;font-size: 20px;">
                            Weekly Shop</div>
                        <div id="weekly-items" class="grid"></div>
                    </div>
                    <div class="panel" style="flex:1;min-width:180px">
                        <div
                            style="font-weight:700;margin-bottom:8px;font-variant-caps: all-small-caps;margin-top: -10px;font-size: 20px;">
                            Star Shop</div>
                        <div id="weeklystar-items" class="grid"></div>
                    </div>
                </div>

                <div class="panel" style="margin-top:8px">
                    <div class="flex" style="margin-bottom:8px">
                        <input id="search" placeholder="Search items..."
                            style="flex:1;border-radius:8px;border:1px solid var(--ghost);background:transparent;color:var(--muted)">
                        <i class="icon"></i>
                        <select id="category-filter"
                            style="color: white;padding:8px;border-radius:8px;background:transparent;border:1px solid var(--ghost)">
                            <option value="all">All categories</option>

                        </select>
                        <button id="gamenight-toggle" class="small-btn ghost">🎮 Gamenight Only</button>
                        <select id="sort-select"
                            style="padding:8px;border-radius:8px;background:transparent;border:1px solid var(--ghost)">
                            <option value="default">Default</option>
                            <option value="az">A → Z</option>
                            <option value="za">Z → A</option>
                            <option value="high">$$$ → $</option>
                            <option value="low">$ → $$$</option>
                        </select>
                        <button class="small-btn" id="toggle-prices">Show prices</button>
                    </div>
                    <div id="all-items" class="grid"></div>
                    <div style="display:flex;justify-content:center;gap:8px;margin-top:12px;align-items:center">
                        <button id="prev-btn" class="small-btn ghost">◀ Prev</button>
                        <div id="page-count" class="note">Page 1 of 1</div>
                        <button id="next-btn" class="small-btn ghost">Next ▶</button>
                    </div>
                </div>
            </div>

            <div class="section" id="history-section">
                <h2>History</h2>
                <div id="history-list"></div>
            </div>
        </div>
    </main>

    <!-- Quick Editor Side Modal -->
    <div id="quick-editor-modal" class="hidden">
        <div id="quick-editor-content" class="initial">
            <div id='tutorial'>
                <h1>Quick Editor</h1>
                <p style="color: #f0f8ff;">Double Click a item to Start editing.</p>
                <p style="color: #f0f8ffc9;">Drag the panel to move it around.</p>
                <p style="color: #f0f8ff8f;">Use the "Save" button to apply changes.</p>
                <p style="color: #f0f8ff6e;">Click the "Close" button to hide.</p>
            </div>
            <button id="quick-editor-close" title="Close">&times;</button>
            <h2 id="quick-editor-title"></h2>
            <div class="quick-editor-body">
                <img id="quick-editor-img" src="" alt="" />


                <div class="price-tag">
                    <div class="tag-left"></div>
                    <div class="price-area">
                        <input id="quick-editor-price" style="caret-color: #ffffff30; border: 0px;" type="text"
                            placeholder="OwO" />
                    </div>
                </div>


                <div class="flag-row"
                    style="flex-wrap: wrap;margin-top: 50px;display: flex; gap: 6px; width: 100%; justify-content: center;">
                </div>

            </div>
            <hr>
            <div>
                <label style="margin-top: -9px;position: relative;z-index: 1;">Code / Rarity / Price↴<h1>?</h1>
                    <p>Coins,
                        Stars, %, Opals, Baubles, Tokens, Eggs, Pumpkins, Visors, Robux, Unobtainable
                    </p>
                    <ul class="prc-list">
                        <li>
                            <input id="quick-editor-prc-item" type="text" />
                        </li>
                    </ul>

                </label>
                <button style="padding-bottom: 8px;margin-bottom: 0px;" id="new-prc-btn">Code / Rarity /
                    Price</button>
            </div>

            <div style="margin-top: 21px;">
                <label style="margin-top: -31px;">Descriptions↴<br>
                    <ul class="desc-list">
                        <li>
                            <input id="quick-editor-description-item" type="text" />
                        </li>
                    </ul>

                </label>
                <button id="new-desc-btn">Text</button>
                <button id="new-gn-btn">Gamenight Date</button>
            </div>
        </div>
    </div>


    <button id="save-btn"><b>✔</b> Publish</button>

    <script>

        let ws;
        let backoff = 1000;

        function initWebSocket(adminName) {
            ws = new WebSocket(`wss://admin-tracker.xnite7.workers.dev?adminName=${encodeURIComponent(adminName)}`);
            ws.onopen = () => {

                backoff = 1000;
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "adminList") {
                    updateAdminOnline(data.admins);
                }
            };
            ws.onclose = (event) => {

                console.log(`WebSocket closed with code: ${event.code}, reason: ${event.reason}`);
                setTimeout(() => initWebSocket(adminName), backoff);
                backoff = Math.min(backoff * 2, 30000);
            };
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function updateAdminOnline(admins) {
            const onlineDiv = document.getElementById("admin-online");
            onlineDiv.textContent = admins.length ? `Online: ${admins.join(", ")}` : "No admins online";
            onlineDiv.classList.add("show");
        }

        function showWelcome(name) {
            const welcomeDiv = document.getElementById('welcome-message');
            welcomeDiv.textContent = `Welcome, ${name}.`;

            setTimeout(() => {
                welcomeDiv.style.opacity = '1';
            }, 100);
            setTimeout(() => {
                welcomeDiv.style.opacity = '0';

            }, 3000);
            setTimeout(() => {
                welcomeDiv.style.fontSize = '0px';
                initWebSocket(name);
            }, 3200);
        }


        const input = document.getElementById('quick-editor-price');
        const priceArea = document.querySelector('.price-tag');
        let gamenightOnly = false;
        // --- Admin keys (kept from original) ---
        const adminKeys = {
            '00cc75b3c354bd864d646cc1a790268c33916bd2a32b78b502151640596f7702': 'xnite',
            'd8d8c58d2c8c173f8de0ff61081d77210367d00eabcc76a04cf3d2d5b1cb3ab4': 'harvestmoon',
            '0fc6b5fe21bb973ec350831217401b643eee63a6c29c74fb4fe6606b28ba7f8b': 'ivan',
            '499b66dcc2946daa0c2ff49b05902dd1152d1a21208ca42fc2c9eb23281cb623': 'bagel',
            'b7a6aa6f564e2e8617ea4e3d443c781d5f890377a584b8d46491d2bcc33e5f36': 'wavetechnic'
        };

        async function computeHash(key) {
            const enc = new TextEncoder();
            const data = enc.encode(key);
            const h = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function getCookie(n) { const v = '; ' + document.cookie; const p = v.split('; ' + n + '='); return p.length === 2 ? p.pop().split(';').shift() : '' }
        function setCookie(n, v, d) { const date = new Date(); date.setTime(date.getTime() + (d * 24 * 60 * 60 * 1000)); document.cookie = n + '=' + v + '; expires=' + date.toUTCString() + '; path=/'; }
        function clearCookie(n) { document.cookie = n + '=; Max-Age=0; path=/'; }

        // UI refs
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const themeSelect = document.getElementById('theme-select');
        const downloadJson = document.getElementById('download-json');
        const logoutBtn = document.getElementById('logout');
        const adminOnline = document.getElementById('admin-online');

        settingsBtn.addEventListener('click', () => settingsMenu.classList.toggle('show'));
        themeSelect.addEventListener('change', () => document.body.setAttribute('data-theme', themeSelect.value));
        downloadJson.addEventListener('click', () => { const b = new Blob([JSON.stringify(jsData, null, 2)], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'auto.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u); });
        logoutBtn.addEventListener('click', () => { clearCookie('adminKey'); alert('Logged out. Reloading...'); location.reload(); });

        // Data holders
        let jsData = {};
        let allItems = [];

        // Pagination
        let filteredItems = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = window.innerWidth < 720 ? 9 : 14;


        var dragImgEl = document.createElement('span');
        dragImgEl.setAttribute('style', 'position: absolute; display: block; top: 0; left: 0; width: 0; height: 0;');
        document.body.appendChild(dragImgEl);

        // --- Prompt admin key (same logic) ---
        async function promptAdminKey() {
            const saved = getCookie('adminKey');
            if (saved) {
                const h = await computeHash(saved);
                if (adminKeys[h]) { showWelcome(adminKeys[h]); return; }
            }
            let tries = 0;
            while (true) {
                const entered = prompt('Enter admin key:');
                if (entered === null) { document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:40px">Access denied.</h2>'; throw new Error('login cancelled'); }
                const hash = await computeHash(entered);
                if (adminKeys[hash]) { setCookie('adminKey', entered, 30); showWelcome(adminKeys[hash]); break; } else { alert('Invalid key'); tries++; if (tries > 5) { alert('Too many tries'); location.reload(); return; } }
            }
        }
        function showWelcome(name) { const welcomeEl = document.getElementById('welcome'); if (welcomeEl) welcomeEl.remove(); adminOnline.textContent = `Online: ${name}`; }



        function renderAll() {
            const allEl = document.getElementById('all-items');
            allEl.innerHTML = '';
            currentPage = 1;
            // First handle weekly/star panels
            const weeklyEl = document.getElementById('weekly-items');
            const starEl = document.getElementById('weeklystar-items');
            weeklyEl.innerHTML = '';
            starEl.innerHTML = '';
            allItems.forEach(item => {
                if (item.weekly) weeklyEl.appendChild(makeItemCard(item));
                if (item.weeklystar) starEl.appendChild(makeItemCard(item));
            });

            // Start with all items
            let filtered = allItems.slice();

            // Apply category filter first
            const selectedCategory = document.getElementById('category-filter').value;
            if (selectedCategory !== 'all') {
                filtered = jsData[selectedCategory] ? jsData[selectedCategory].slice() : [];
            }

            // Apply gamenight filter
            if (gamenightOnly) {
                filtered = filtered.filter(i => (i.from && i.from.toLowerCase().includes("gamenight")));
            }

            // Apply search filter
            const searchQuery = document.getElementById('search').value.trim();
            if (searchQuery) {
                // Create new Fuse instance with currently filtered items
                const tempFuse = new Fuse(filtered, {
                    keys: ['name'],
                    threshold: 0.35
                });
                filtered = tempFuse.search(searchQuery).map(r => r.item);
            }

            // Apply sorting
            const sort = document.getElementById('sort-select').value;
            if (sort === 'az') filtered.sort((a, b) => a.name.localeCompare(b.name));
            else if (sort === 'za') filtered.sort((a, b) => b.name.localeCompare(a.name));
            else if (sort === 'high') filtered.sort((a, b) => (parseInt(b.price || 0) || 0) - (parseInt(a.price || 0) || 0));
            else if (sort === 'low') filtered.sort((a, b) => (parseInt(a.price || 0) || 0) - (parseInt(b.price || 0) || 0));

            // Update filteredItems for pagination
            filteredItems = filtered;

            // Render current page
            filtered.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE)
                .forEach(item => allEl.appendChild(makeItemCard(item)));

            // Update pagination
            const totalPages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
            document.getElementById('page-count').textContent = `Page ${currentPage} of ${totalPages}`;

            // Update pagination buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
        }


        let priceson = true;

        document.getElementById('toggle-prices').addEventListener('click', () => {
            const priceTags = document.querySelectorAll('.price-label');
            priceson = !priceson;
            if (!priceson) {
                document.getElementById('toggle-prices').classList.add('ghost');
                priceTags.forEach(tag => {
                    tag.classList.add('hidden');
                });
            } else {
                document.getElementById('toggle-prices').classList.remove('ghost');
                priceTags.forEach(tag => {
                    tag.classList.remove('hidden');
                });
            }
        });
        const quickEditorPrice = document.getElementById('quick-editor-price');

        //on clicked outside quickeditorprice unfocus
        document.addEventListener('click', (e) => {
            if (!quickEditorPrice.contains(e.target)) {
                quickEditorPrice.parentElement.classList.add('blur');
            }
        });
        quickEditorPrice.parentElement.addEventListener('animationend', () => {
            quickEditorPrice.parentElement.classList.remove('blur');
            quickEditorPrice.blur();
        });

        function findItemType(item) { for (const k in jsData) if (jsData[k].includes(item)) return k; return 'unknown'; }

        function makeItemCard(item) {
            const el = document.createElement('div'); el.className = 'item-card'; el.dataset.name = item.name;
            const img = document.createElement('img'); img.src = item.img || './imgs/trs.png'; img.alt = item.name; img.onerror = () => img.style.display = 'none';
            const name = document.createElement('div'); name.className = 'item-name'; name.textContent = item.name;
            el.appendChild(img); el.appendChild(name);

            if (img.src.includes('trs.png')) {
                el.style.justifyContent = 'center';
            }
            item.new ? el.style.zIndex = 0 : null

            // editable inputs: price, code, rarity
            const inputs = document.createElement('div'); inputs.style.width = '100%'; inputs.className = 'inputs-row';

            const priceIn = document.createElement('label'); priceIn.className = 'price-label'; priceIn.textContent = shortenThousands(item.price) || '';
            inputs.appendChild(priceIn);
            if (item.price <= 0 || item.price == 'N/A') {
                priceIn.style.display = 'none';
            }

            function shortenThousands(text) {
                text = String(text); // Force to string
                return text.replace(/\b\d{4,}\b/g, match => {
                    const num = parseInt(match, 10);
                    if (num >= 1000) {
                        return (num / 1000).toString().replace(/\.0$/, '') + 'k';
                    }
                    return match;
                });
            }

            el.appendChild(inputs);

            requestAnimationFrame(() => {
                name.style.fontSize = "13px";
                let fontsize = parseInt(window.getComputedStyle(name).fontSize, 10);

                while (name.offsetWidth > el.offsetWidth - 18 && fontsize > 8) {
                    fontsize -= 1;
                    name.style.fontSize = `${fontsize}px`;
                }
            });

            // click to open quick editor
            el.addEventListener('click', (e) => {
                e.preventDefault();
                // Add scale animation
                el.style.transition = 'all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)';
                el.style.transform = 'scale(0.9)';
                el.style.filter = 'opacity(0.5)'

                // Reset scale after animation
                setTimeout(() => {
                    el.style.transform = '';
                    el.style.filter = ''

                    // Remove transition after animation completes
                    setTimeout(() => {
                        el.style.transition = '';
                    }, 200);
                }, 200);
                openQuickEditor(item);

            });

            return el;
        }

        function renderListPanels() {
            const weeklyEl = document.getElementById('weekly-items'); const starEl = document.getElementById('weeklystar-items');
            weeklyEl.innerHTML = ''; starEl.innerHTML = '';
            for (const k in jsData) { jsData[k].forEach(i => { if (i.weekly) weeklyEl.appendChild(makeItemCard(i)); if (i.weeklystar) starEl.appendChild(makeItemCard(i)); }) }
        }

        // --- All items with pagination ---
        function renderAllItems() {
            const container = document.getElementById('all-items'); container.innerHTML = '';
            const start = (currentPage - 1) * ITEMS_PER_PAGE; const pageItems = filteredItems.slice(start, start + ITEMS_PER_PAGE);
            pageItems.forEach(i => container.appendChild(makeItemCard(i)));
            const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE));
            document.getElementById('page-count').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;

            if (currentPage === 1) {
                document.getElementById('prev-btn').style.opacity = '0.5';
            } else {
                document.getElementById('prev-btn').style.opacity = '1';
            }
            if (currentPage === totalPages) {
                document.getElementById('next-btn').style.opacity = '0.5';
            } else {
                document.getElementById('next-btn').style.opacity = '1';
            }

        }
        document.getElementById('prev-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderAllItems(); } });
        document.getElementById('next-btn').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(filteredItems.length / ITEMS_PER_PAGE)); if (currentPage < totalPages) { currentPage++; renderAllItems(); } });

        document.getElementById('search').addEventListener('input', () => {

            renderAll();
        });


        /* ========== EVENTS ========== */
        document.getElementById('gamenight-toggle').addEventListener('click', () => {
            gamenightOnly = !gamenightOnly;
            if (!gamenightOnly) {
                document.getElementById('gamenight-toggle').classList.add('ghost');
            } else {
                document.getElementById('gamenight-toggle').classList.remove('ghost');
            }
            renderAll();
        });

        // --- History ---
        async function loadHistory() {
            const el = document.getElementById('history-list'); el.innerHTML = 'Loading...';
            try {
                //only get top 6 and put a load more button by slicing the array
                const res = await fetch('https://emwiki.site/api/history');
                if (!res.ok) throw new Error('history fetch failed');
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    el.innerHTML = '<p>No history available.</p>';
                    return;
                }
                el.innerHTML = '';

                function renderHistoryItem(e) {
                    // Header: username + time
                    const header = document.createElement('div');
                    header.style.cssText = 'background: linear-gradient(rgb(34 34 34), rgb(8 8 8));padding: 7px;border-radius: 6px;margin-bottom: 1.2rem; font-weight:700; font-size:19px; margin-bottom:4px; display:flex; justify-content: space-between; align-items: baseline;';
                    header.textContent = e.username;
                    const timeDiv = document.createElement('div');
                    timeDiv.style.cssText = 'font-weight:900; font-size:14px; color:#666;';
                    timeDiv.textContent = new Date(e.timestamp).toLocaleString();
                    header.appendChild(timeDiv);



                    // Diff container
                    const h = document.createElement('div');
                    h.className = 'history-item';
                    h.style.cssText = `
                        font-family: monospace;
                        font-weight:400;
                        font-size:15px;
                        background:rgb(16 16 16);
                        padding:8px;
                        border-radius:14px;
                        max-width: 100%;
                        white-space: normal;
                        color: #ddd;
                    `;

                    h.appendChild(header);

                    const lines = e.diff?.split('\n') || [];
                    const changes = { weeklystar: [], weekly: [], new: [], price: [], from: [], retired: [], premium: [], tradable: [] };
                    for (const line of lines) {

                        const m = line.match(/^\[(.+?)\] (\w+): (.*) → (.*)$/);
                        if (!m) continue;
                        const [, item, fieldRaw, oldRaw, newRaw] = m;
                        const field = fieldRaw.toLowerCase();
                        const oldVal = oldRaw === 'undefined' || oldRaw === '' ? undefined : oldRaw;
                        const newVal = newRaw === 'undefined' || newRaw === '' ? undefined : newRaw;


                        if (['weeklystar', 'weekly', 'new', 'retired', 'premium', 'tradable'].includes(field)) {
                            if (newVal === 'true' || newVal === 'false') {
                                changes[field].push({ item, value: newVal === 'true' });
                            }
                        } else if (field === 'price') {
                            const parsePrice = v => (!v || v === 'undefined' ? "0" : v);
                            changes.price.push({
                                item,
                                oldPrice: parsePrice(oldRaw),
                                newPrice: parsePrice(newRaw)
                            });
                        } else if (field === 'from') {
                            changes.from.push({ item, oldDesc: oldVal, newDesc: newVal });
                        }
                    }

                    function createSection(title, items, format) {

                        if (!items.length) return null;
                        const sec = document.createElement('div');
                        const h4 = document.createElement('h4');
                        h4.textContent = title;
                        h4.style.margin = '8px 0 4px 0';
                        h4.style.fontWeight = '600';
                        h4.style.fontSize = '21px';
                        h4.style.color = '#9f9790';
                        h4.style.fontVariant = 'all-petite-caps';
                        sec.appendChild(h4);
                        sec.style.marginLeft = '18px';

                        const ul2 = document.createElement('ul');
                        ul2.style.cssText = 'margin:0 0 8px 16px; padding:0; list-style:none; font-size:14px; color:#ddd;';
                        for (const i of items) {
                            const li2 = document.createElement('li');
                            li2.style.marginBottom = '3px';
                            if (title == 'Description:') {

                                li2.style.marginBottom = '16px';
                            }

                            li2.innerHTML = format(i);
                            ul2.appendChild(li2);
                        }

                        sec.appendChild(ul2);
                        return sec;
                    }

                    const sections = [
                        ['Star shop:', changes.weeklystar, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong> `],
                        ['Weekly:', changes.weekly, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong>`],
                        ['New:', changes.new, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong> `],
                        ['Retired:', changes.retired, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong> `],
                        ['Premium:', changes.premium, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong> `],
                        ['Tradable:', changes.tradable, i => `${i.value ? '<span style="display:inline-block;width:1.2em;text-align:center;color:#6f6">✔</span>' : '<span style="display:inline-block;width:1.2em;text-align:center;color:#f66">🗙</span>'} <strong>[${i.item}]</strong> `],
                        ['Price:', changes.price, i => `<span style="display:inline-block;width:1.2em;text-align:center;color:#fa4;font-weight:bolder;">$</span> <strong>[${i.item}]</strong> <span style="color:#f66">${i.oldPrice}</span> → <span style="color:#6f6">${i.newPrice}</span>`],
                        ['Description:', changes.from, i => {
                            // split into lines

                            const oldLines = (i.oldDesc || "").split(/<br>|\n/).map(s => s.trim()).filter(Boolean);
                            const newLines = (i.newDesc || "").split(/<br>|\n/).map(s => s.trim()).filter(Boolean);

                            // zip longest length
                            const max = Math.max(oldLines.length, newLines.length);
                            let out = `<strong>[${i.item}]</strong><br>`;
                            for (let j = 0; j < max; j++) {
                                const oldL = oldLines[j];
                                const newL = newLines[j];
                                if (oldL === newL) {
                                    out += `&nbsp;&nbsp;⨽&nbsp;${oldL}<br>`;
                                } else if (oldL && newL) {
                                    out += `&nbsp;&nbsp;⨽&nbsp;<span style="color:#fa4">${oldL}</span> → <span style="color:#fa4">${newL}</span><br>`;
                                } else if (oldL && !newL) {
                                    out += `&nbsp;&nbsp;⨽&nbsp;<span style="color:#f66">${oldL} 🗙</span><br>`;
                                } else if (!oldL && newL) {
                                    out += `&nbsp;&nbsp;⨽&nbsp;<span style="color:#6f6">${newL} +</span><br>`;
                                }
                            }
                            return out;
                        }],

                    ];

                    let anySectionAdded = false;
                    for (const [title, items, fmt] of sections) {

                        const sectionEl = createSection(title, items, fmt);
                        if (sectionEl) {
                            h.appendChild(sectionEl);
                            anySectionAdded = true;
                        }
                    }

                    if (!anySectionAdded) {
                        h.textContent = e.diff || '(no diff available)';
                    }

                    el.appendChild(h);
                }

                for (const e of data) {
                    if (el.children.length >= 4) continue;
                    renderHistoryItem(e);
                }

                if (el.children.length >= 4) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.textContent = 'Load more history';
                    loadMoreBtn.className = 'small-btn ghost';
                    loadMoreBtn.onclick = () => {
                        el.innerHTML = '';
                        data.forEach(e => {
                            renderHistoryItem(e);
                        });
                    };
                    loadMoreBtn.style.marginTop = '8px';
                    el.appendChild(loadMoreBtn);
                }

            } catch (err) {
                el.innerHTML = 'Failed to load history: ' + err.message
                console.error(err);
            }
        }
        loadHistory();

        // --- Drag & drop with Sortable (clone from original) ---
        function setupDragDrop() {
            const FLAG_PANELS = { 'weekly-items': 'weekly', 'weeklystar-items': 'weeklystar' };

            // master list
            new Sortable(document.getElementById('all-items'), {
                group: { name: 'shared-flags', pull: 'clone', put: false },
                animation: 150,
                sort: false,
                onStart: evt => { evt.item.style.opacity = '0.25'; },
                onEnd: evt => { evt.item.style.opacity = ''; }
            });

            // helper to check duplicates
            function alreadyInList(toEl, dragEl) {
                const name = dragEl.dataset.name;
                return Array.from(toEl.children).some(el => el.dataset.name === name);
            }

            Object.entries(FLAG_PANELS).forEach(([id, key]) => {
                new Sortable(document.getElementById(id), {
                    group: {
                        name: 'shared-flags',
                        pull: 'clone',
                        put: (to, from, dragEl) => {
                            // prevent if already exists in this list
                            return !alreadyInList(to.el, dragEl);
                        }
                    },
                    animation: 150,
                    sort: false,
                    onAdd(evt) {
                        const name = evt.item.dataset.name;
                        for (const arr of Object.values(jsData)) {
                            const it = arr.find(x => x.name === name);
                            if (it) { it[key] = true; }
                            if (it === currentEditingItem) { openQuickEditor(it); }
                            renderAll();
                        }
                        renderListPanels();
                    },
                    onStart: evt => { evt.item.style.opacity = '0.25'; },
                    onEnd: evt => { evt.item.style.opacity = ''; }
                });
            });
        }


        // --- Save to Gist endpoint ---
        document.getElementById('save-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-btn'); btn.disabled = true; btn.textContent = 'Publish...';
            try {
                const saved = getCookie('adminKey'); let adminName = 'Unknown'; if (saved) { const h = await computeHash(saved); adminName = adminKeys[h] || adminName; }
                const res = await fetch('https://emwiki.site/api/update-gist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: jsData, username: adminName, version: '' }) });
                if (res.status === 409) { alert('Conflict detected — a newer version exists. Consider downloading and merging.'); btn.disabled = false; btn.innerHTML = '<b>✔</b> Publish'; return; }
                if (!res.ok) throw new Error('save failed'); alert('Saved successfully'); location.reload();
            } catch (err) { alert('Save error: ' + err.message); btn.disabled = false; btn.innerHTML = '<b>✔</b> Publish'; }
        });
        //descFiltered = allItems.filter(i => (!gamenightOnly || (i.from || '').toLowerCase().includes('gamenight')));
        // --- Helpers ---
        let currentEditingItem = null;


        function openQuickEditor(item) {
            currentEditingItem = item;
            const modal = document.getElementById('quick-editor-modal');
            document.getElementById('quick-editor-content').classList.remove('initial');
            document.getElementById('quick-editor-title').textContent = item.name;
            const imgEl = document.getElementById('quick-editor-img');
            if (item.img) {
                imgEl.src = item.img;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            document.getElementById('quick-editor-price').placeholder = "RAP";
            document.getElementById('quick-editor-price').value = item.price || '';

            document.getElementById('quick-editor-price').onchange = () => {
                currentEditingItem.price = document.getElementById('quick-editor-price').value.trim();
                renderAll();
            };

            const desccontainer = document.querySelector('.desc-list');
            desccontainer.innerHTML = '';
            const prccontainer = document.querySelector('.prc-list');
            prccontainer.innerHTML = '';


            const TAG_COLORS = { New: "#1abc9c", Weekly: "#3498db", Star: "#f1c40f", Retired: "#9b59b6", Premium: "#e67e22", Untradable: "#e74c3c" };
            let tags = Object.entries({ New: item.new, Weekly: item.weekly, Star: item.weeklystar, Retired: item.retired, Premium: item.premium, Untradable: !item.tradable })
                .filter(([k, v]) => v).map(([k]) => k);

            const flagRow = document.querySelector('.flag-row'), modalContent = document.getElementById('quick-editor-content');
            let tagMenu = null;

            const tagToProp = {
                New: "new",
                Weekly: "weekly",
                Star: "weeklystar",
                Retired: "retired",
                Premium: "premium",
                Untradable: "tradable"
            };

            const renderTags = () => {
                flagRow.querySelectorAll('.tag-pill').forEach(e => e.remove());
                tags.forEach(tag => {
                    const el = document.createElement('span');
                    Object.assign(el, { className: 'tag-pill', textContent: tag, style: `border-color:${TAG_COLORS[tag] || '#aaa'};background:${(TAG_COLORS[tag] || '#aaa')}33;color:${TAG_COLORS[tag] || '#aaa'}` });
                    const x = document.createElement('span'); x.textContent = ' ×'; x.style.cursor = 'pointer'; x.style.webkitTextStrokeWidth = 'medium';
                    x.onclick = () => { tags = tags.filter(t => t !== tag); renderTags(); if (tag === "Untradable") { currentEditingItem[tagToProp[tag]] = true; } else { currentEditingItem[tagToProp[tag]] = false; } renderListPanels(); renderAll(); };
                    el.appendChild(x); flagRow.appendChild(el);
                });
            };

            const openTagSelector = () => {
                if (tagMenu) tagMenu.remove();
                tagMenu = document.createElement('div');
                Object.assign(tagMenu.style, { position: 'absolute', background: '#1e293b', padding: '10px', border: '1px solid #555', borderRadius: '8px', zIndex: 1000 });
                Object.keys(TAG_COLORS).forEach(tag => {
                    const b = document.createElement('button'); b.textContent = tag; b.className = 'tag-option';
                    if (tags.includes(tag)) Object.assign(b.style, { background: TAG_COLORS[tag] + '36', color: '#5c5c5c' });
                    b.onclick = () => { if (!tags.includes(tag)) tags.push(tag); if (tag === "Untradable") { currentEditingItem[tagToProp[tag]] = false; } else { currentEditingItem[tagToProp[tag]] = true; } tagMenu.remove(); tagMenu = null; renderTags(); renderListPanels(); renderAll(); };
                    tagMenu.appendChild(b);
                });
                flagRow.appendChild(tagMenu);
            };

            flagRow.querySelectorAll('.tag-pill,.small-btn.ghost').forEach(e => e.remove());
            renderTags();
            const btn = document.createElement('button'); btn.className = 'small-btn ghost'; btn.textContent = 'Tags'; btn.style.marginTop = '-40px'; btn.style.fontVariant = 'all-petite-caps'; btn.style.position = "absolute"; btn.onclick = e => {
                e.stopPropagation();
                openTagSelector();
            };
            flagRow.appendChild(btn);

            // Close tag menu when clicking anywhere else in modal
            modalContent.addEventListener('click', e => {
                if (tagMenu && !tagMenu.contains(e.target) && !e.target.classList.contains('tag-option') && e.target !== btn) {
                    tagMenu.remove();
                    tagMenu = null;
                }
            });


            // Add a new input button
            document.getElementById('new-desc-btn').onclick = (e) => {

                createDesc('');
            };

            document.getElementById('new-gn-btn').onclick = () => {
                createDesc(`Gamenight (${formattedDate}. ${formattedYear})`, true);
            };

            document.getElementById('new-prc-btn').onclick = () => {
                createPrc('');
            };

            // flags
            function createDesc(value = '', date = false) {
                const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.']
                const s = new Set()
                const li = Object.assign(document.createElement('li'), { className: 'desc-item', style: 'display:flex;align-items:center;gap:6px;flex-wrap:wrap;background:#555;color:#fff;border-radius:6px;padding:5px 11px;margin-bottom:6px;cursor:grab;user-select:none' })
                const label = Object.assign(document.createElement('span'), { style: 'flex-grow:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;', textContent: value || 'Description...' })
                const input = Object.assign(document.createElement('input'), { type: 'text', value: value || '', style: 'flex-grow:1;display:none;border:none;border-radius:4px;padding:6px 8px' })
                const monthswrapper = Object.assign(document.createElement('div'), { style: 'cursor: initial;justify-content: space-evenly;display:none;flex-wrap:wrap;gap:4px;flex-grow:1' })
                const yearinput = Object.assign(document.createElement('input'), { min: 2016, max: new Date().getFullYear(), type: 'number', placeholder: 'Year', style: 'font-weight: 700;font-size: 15px;width:50px;display:none;border:none;border-radius:4px;padding:4px 6px' })
                const editButton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M16.293%203.293a1%201%200%200%201%201.414%200l3%203a1%201%200%200%201%200%201.414l-9%209A1%201%200%200%201%2011%2017H8a1%201%200%200%201-1-1v-3a1%201%200%200%201%20.293-.707l9-9zM9%2013.414V15h1.586l8-8L17%205.414l-8%208zM3%207a2%202%200%200%201%202-2h5a1%201%200%201%201%200%202H5v12h12v-5a1%201%200%201%201%202%200v5a2%202%200%200%201-2%202H5a2%202%200%200%201-2-2V7z%22%20%2F%3E%3C%2Fsvg%3E\');"></div>ᴇᴅɪᴛ', className: 'small-btn ghost' })
                const deleteButton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M7%204a2%202%200%200%201%202-2h6a2%202%200%200%201%202%202v2h4a1%201%200%201%201%200%202h-1.069l-.867%2012.142A2%202%200%200%201%2017.069%2022H6.93a2%202%200%200%201-1.995-1.858L4.07%208H3a1%201%200%200%201%200-2h4V4zm2%202h6V4H9v2zM6.074%208l.857%2012H17.07l.857-12H6.074zM10%2010a1%201%200%200%201%201%201v6a1%201%200%201%201-2%200v-6a1%201%200%200%201%201-1zm4%200a1%201%200%200%201%201%201v6a1%201%200%201%201-2%200v-6a1%201%200%200%201%201-1z%22%20%2F%3E%3C%2Fsvg%3E\');"></div>', style: 'padding: 6px 0px 6px 6px;background:#f66', className: 'small-btn' });
                const okbutton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20OFL.%20Made%20by%20govicons%3A%20https%3A%2F%2Fgithub.com%2F540co%2Fgovicons%20--%3E%3Csvg%20viewBox%3D%220%20-8%2072%2072%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M61.07%2C12.9%2C57%2C8.84a2.93%2C2.93%2C0%2C0%2C0-4.21%2C0L28.91%2C32.73%2C19.2%2C23A3%2C3%2C0%2C0%2C0%2C15%2C23l-4.06%2C4.07a2.93%2C2.93%2C0%2C0%2C0%2C0%2C4.21L26.81%2C47.16a2.84%2C2.84%2C0%2C0%2C0%2C2.1.89A2.87%2C2.87%2C0%2C0%2C0%2C31%2C47.16l30.05-30a2.93%2C2.93%2C0%2C0%2C0%2C0-4.21Z%22%2F%3E%3C%2Fsvg%3E\');"></div>', style: 'background: rgb(95 193 95);padding: 6px 0px 6px 6px;text-shadow: 0 0 5px #00000057;display:none;font-weight: 700;', className: 'small-btn' });

                months.forEach(month => {
                    const button = document.createElement('span');
                    button.textContent = month; button.style.cssText = 'padding:4px 8px;border-radius:4px;background:#777;cursor:pointer;user-select:none;transition:all .15s';
                    button.onclick = () => {
                        (s.has(month) ? s.delete(month) : s.add(month)),
                            button.style.background = s.has(month) ? 'var(--accent)' : '#777';
                        button.style.transform = 'scale(1.05)';
                        setTimeout(() => button.style.transform = '', 100);
                    };
                    monthswrapper.appendChild(button);
                });

                if (date) {
                    monthswrapper.append(yearinput, okbutton);
                    li.append(label, input, monthswrapper, editButton, deleteButton);
                } else {
                    li.append(label, input, yearinput, monthswrapper, editButton, deleteButton, okbutton);
                }

                desccontainer.appendChild(li); Sortable.create(desccontainer, { animation: 150, handle: '.desc-item', group: { name: 'desc', pull: false, put: false }, sort: true });

                li.ondragstart = e => { e.dataTransfer.setData('text/plain', item.name); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setDragImage(dragImgEl, 0, 0); li.style.opacity = '0.5'; }
                li.ondragend = () => { li.style.opacity = '1'; }

                if (date && /\(.+\)/.test(value)) { let [_, months, year] = value.match(/\((.+)\s(\d{4})\)/) || []; months && months.split(',').map(z => z.trim()).forEach(z => { s.add(z);[...monthswrapper.children].forEach(t => t.textContent == z && (t.style.background = 'var(--accent)')) }); yearinput.value = year || '' }

                const edit = () => { deleteButton.style.display = 'none'; okbutton.style.display = 'inline-block'; label.style.display = 'none'; editButton.style.display = 'none'; (date ? (monthswrapper.style.display = 'flex', yearinput.style.display = 'inline-block') : (input.style.display = 'inline-block', input.focus())) }

                const done = () => {
                    deleteButton.style.display = 'inline-block'; okbutton.style.display = 'none'; value = date ? `Gamenight (${[...s].join(', ')}${yearinput.value ? ' ' + yearinput.value : ''})` : (input.value.trim() || 'Description...'); label.textContent = value; label.style.display = 'inline';
                    input.style.display = monthswrapper.style.display = yearinput.style.display = 'none'; editButton.style.display = 'inline-block'
                    currentEditingItem.from = Array.from(document.querySelectorAll('.desc-item input')).map(input => input.value.trim()).filter(v => v).join('<br>') || currentEditingItem.from || '';
                };

                editButton.onclick = e => { e.stopPropagation(); edit() };
                label.ondblclick = edit;
                input.onblur = done;
                input.onkeydown = e => { if (e.key == 'Enter' || e.key == 'Escape') done() };
                deleteButton.onclick = () => {
                    li.remove();
                    currentEditingItem.from = Array.from(document.querySelectorAll('.desc-item input'))
                        .map(input => input.value.trim())
                        .filter(v => v)
                        .join('<br>') || '';
                };
                okbutton.onclick = () => done();
                updateWidth()
            }


            function createPrc(value = '') {
                const s = new Set()
                const li = Object.assign(document.createElement('li'), { className: 'prc-item', style: 'display:flex;align-items:center;gap:6px;flex-wrap:wrap;background:#555;color:#fff;border-radius:6px;padding:5px 11px;margin-bottom:6px;cursor:grab;user-select:none' })
                const icon = Object.assign(document.createElement('img'), { src: './imgs/trs.png', style: 'display:inline-block;width: 20px; height: 20px; margin-right: 6px; vertical-align: middle;' })
                const label = Object.assign(document.createElement('span'), { className: 'prc-label', style: 'flex-grow:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;', textContent: value || 'Price...' })
                const input = Object.assign(document.createElement('input'), { type: 'text', value: value || '', style: 'flex-grow:1;display:none;border:none;border-radius:4px;padding:6px 8px' })
                const editButton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M16.293%203.293a1%201%200%200%201%201.414%200l3%203a1%201%200%200%201%200%201.414l-9%209A1%201%200%200%201%2011%2017H8a1%201%200%200%201-1-1v-3a1%201%200%200%201%20.293-.707l9-9zM9%2013.414V15h1.586l8-8L17%205.414l-8%208zM3%207a2%202%200%200%201%202-2h5a1%201%200%201%201%200%202H5v12h12v-5a1%201%200%201%201%202%200v5a2%202%200%200%201-2%202H5a2%202%200%200%201-2-2V7z%22%20%2F%3E%3C%2Fsvg%3E\');"></div>ᴇᴅɪᴛ', className: 'small-btn ghost' })
                const deleteButton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20PD.%20Made%20by%20mono-company%3A%20https%3A%2F%2Fgithub.com%2Fmono-company%2Fmono-icons%20--%3E%3Csvg%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M7%204a2%202%200%200%201%202-2h6a2%202%200%200%201%202%202v2h4a1%201%200%201%201%200%202h-1.069l-.867%2012.142A2%202%200%200%201%2017.069%2022H6.93a2%202%200%200%201-1.995-1.858L4.07%208H3a1%201%200%200%201%200-2h4V4zm2%202h6V4H9v2zM6.074%208l.857%2012H17.07l.857-12H6.074zM10%2010a1%201%200%200%201%201%201v6a1%201%200%201%201-2%200v-6a1%201%200%200%201%201-1zm4%200a1%201%200%200%201%201%201v6a1%201%200%201%201-2%200v-6a1%201%200%200%201%201-1z%22%20%2F%3E%3C%2Fsvg%3E\');"></div>', style: 'padding: 6px 0px 6px 6px;background:#f66', className: 'small-btn' });
                const okbutton = Object.assign(document.createElement('button'), { innerHTML: '<div class="icon" style="mask-image: url(\'data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!--%20License%3A%20OFL.%20Made%20by%20govicons%3A%20https%3A%2F%2Fgithub.com%2F540co%2Fgovicons%20--%3E%3Csvg%20viewBox%3D%220%20-8%2072%2072%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M61.07%2C12.9%2C57%2C8.84a2.93%2C2.93%2C0%2C0%2C0-4.21%2C0L28.91%2C32.73%2C19.2%2C23A3%2C3%2C0%2C0%2C0%2C15%2C23l-4.06%2C4.07a2.93%2C2.93%2C0%2C0%2C0%2C0%2C4.21L26.81%2C47.16a2.84%2C2.84%2C0%2C0%2C0%2C2.1.89A2.87%2C2.87%2C0%2C0%2C0%2C31%2C47.16l30.05-30a2.93%2C2.93%2C0%2C0%2C0%2C0-4.21Z%22%2F%3E%3C%2Fsvg%3E\');"></div>', style: 'background: rgb(95 193 95);padding: 6px 0px 6px 6px;text-shadow: 0 0 5px #00000057;display:none;font-weight: 700;', className: 'small-btn' });

                function formatify() {
                    const text = input.value.trim();

                    icon.style.display = 'inline-block';
                    icon.src = `./imgs/trs.png`;

                    label.style.color = "#fff";
                    label.style.fontWeight = "normal";
                    label.style.textShadow = "";

                    if (text.includes("Tokens")) {
                        Object.assign(label.style, { fontWeight: 500, textStroke: "1px rgb(255, 83, 219)", webkitTextStroke: "1px rgb(255, 83, 219)" });
                    }
                    if (text.includes("Robux")) {
                        Object.assign(label.style, { fontWeight: 700 });
                    }

                    const iconMap = {
                        Robux: "./imgs/cf8ZvY7.png",
                        Coins: "./imgs/Coin.webp",
                        Stars: "./imgs/WKeX5AS.png",
                        Visors: "./imgs/7IoLZCN.png",
                        Pumpkins: "./imgs/bHRBTrU.png",
                        Eggs: "./imgs/qMxjgQy.png",
                        Opals: "./imgs/wwMMAvr.png",
                        Opal: "./imgs/wwMMAvr.png",
                        Baubles: "./imgs/bauble.png",
                        Bauble: "./imgs/bauble.png",
                        Tokens: "./imgs/Cy9r140.png",
                        Token: "./imgs/Cy9r140.png"
                    };

                    for (const [key, src] of Object.entries(iconMap)) {
                        if (text.includes(key)) {
                            label.textContent = text.replace(` ${key}`, "");
                            icon.src = `${src}`;
                            break;
                        }
                    }
                    Object.assign(label.style, { fontFamily: "BuilderSans" });
                    if (text.includes("%")) {
                        label.style.color = "rgb(193 68 255)";
                        label.style.fontWeight = 500;
                        label.style.textShadow = "0 0 6px rgb(199 0 255)";
                    } else if (text.includes("[EXPIRED]")) {
                        Object.assign(label.style, { textShadow: "0 0 10px black", fontSize: "16px", fontVariant: "unicase", fontFamily: "cursive", color: "rgb(255 31 31)" });
                    } else if (text.includes("[ACTIVE]")) {
                        Object.assign(label.style, { fontFamily: "cursive", color: "rgb(251 255 68)" });
                    } else if (text.includes("Unobtainable")) {
                        icon.src = `./imgs/Red_x.png`;
                        label.style.color = "rgb(255 44 44)";
                    }

                    if (icon.src.includes('trs.png')) {

                        icon.style.display = 'none';
                    }
                }
                formatify()

                input.oninput = () => formatify();


                li.append(icon, label, input, editButton, deleteButton, okbutton);


                prccontainer.appendChild(li); Sortable.create(prccontainer, { animation: 150, handle: '.prc-item', group: { name: 'desc', pull: false, put: false }, sort: true });

                li.ondragstart = e => { e.dataTransfer.setData('text/plain', item.name); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setDragImage(dragImgEl, 0, 0); li.style.opacity = '0.5'; }
                li.ondragend = () => { li.style.opacity = '1'; }

                const edit = () => { deleteButton.style.display = 'none'; okbutton.style.display = 'inline-block'; label.style.display = 'none'; editButton.style.display = 'none'; (input.style.display = 'inline-block', input.focus()) }

                const done = () => {
                    deleteButton.style.display = 'inline-block';
                    okbutton.style.display = 'none';
                    label.textContent = (input.value.trim() || 'Price...');
                    label.style.display = 'inline';
                    input.style.display = 'none';
                    editButton.style.display = 'inline-block'
                    formatify();


                    currentEditingItem['price/code/rarity'] = Array.from(document.querySelectorAll('.prc-item input')).map(input => input.value.trim()).filter(v => v).join('<br>') || currentEditingItem['price/code/rarity'] || '';
                };

                editButton.onclick = e => { e.stopPropagation(); edit() };
                label.ondblclick = edit; input.onblur = done;
                input.onkeydown = e => { if (e.key == 'Enter' || e.key == 'Escape') done() };
                deleteButton.onclick = () => {
                    li.remove();
                    currentEditingItem['price/code/rarity'] = Array.from(document.querySelectorAll('.prc-item input'))
                        .map(input => input.value.trim())
                        .filter(v => v)
                        .join('<br>') || '';
                };
                okbutton.onclick = () => done();
                updateWidth()





            }


            const descriptions = (item.from || '').split('<br>').map(x => x.trim()).filter(Boolean).forEach(v => createDesc(v, /\([A-Z][a-z]{2}\./.test(v)));
            const prc = (item['price/code/rarity'] || '').split('<br>').map(x => x.trim()).filter(Boolean).forEach(v => createPrc(v));



            const now = new Date();
            const month = { month: 'short' };
            const year = { year: 'numeric' };
            const formattedDate = now.toLocaleDateString('en-US', month);
            const formattedYear = now.toLocaleDateString('en-US', year);
            // Show the modal
            modal.classList.add('show');
            modal.classList.remove('hidden');
        }



        document.getElementById('quick-editor-close').addEventListener('click', () => {
            closeQuickEditor();
        });

        function closeQuickEditor() {
            const modal = document.getElementById('quick-editor-modal');
            modal.classList.remove('show');
            modal.classList.add('hidden');
            currentEditingItem = null;
        }





        document.getElementById('category-filter').addEventListener('change', function (e) {
            renderAll();
        });

        // --- Simple update checking (poll) ---
        async function checkUpdate() {
            try {
                const res = await fetch('https://emwiki.site/api/latest-version', { cache: 'no-store' });
                if (!res.ok) return; const txt = await res.text(); /* parse if needed */
            } catch (e) { }
        }
        function startUpdateCheck() { setInterval(checkUpdate, 15000); }


        (() => {
            const modal = document.getElementById('quick-editor-modal');
            const panel = document.getElementById('quick-editor-content');
            const handle = document.getElementById('quick-editor-title');
            const closeBtn = document.getElementById('quick-editor-close');

            const mainEl = document.querySelector('main');

            const WIDTH_THRESHOLD = 1300;

            // Remember original position so we can put it back
            const originalParent = panel.parentNode;

            // Move panel based on width

            if (!modal || !panel || !handle) return;

            // config
            const SNAP_MARGIN = 12;
            const STORAGE_KEY = 'quickEditorPosV1';

            // helpers
            const vw = () => window.innerWidth;
            const vh = () => window.innerHeight;
            const clamp = (v, a, b) => Math.max(a, Math.min(b, v));






            const centerPanel = () => {
                const w = panel.offsetWidth;
                setPanelPos(Math.round((vw() - w) / 2), Math.round(vh() * 0.1));
            };

            const setPanelPos = (left, top) => {
                // keep panel inside viewport (with margin)
                const W = panel.offsetWidth, H = panel.offsetHeight;
                const maxLeft = vw() - W - SNAP_MARGIN;
                const maxTop = vh() - H - SNAP_MARGIN;
                left = clamp(Math.round(left), SNAP_MARGIN, Math.max(SNAP_MARGIN, maxLeft));
                top = clamp(Math.round(top), SNAP_MARGIN, Math.max(SNAP_MARGIN, maxTop));

                panel.style.left = left + 'px';
                panel.style.top = top + 'px';
                panel.style.transform = 'none';
            };

            const savePosition = () => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        left: parseInt(panel.style.left || 0, 10),
                        top: parseInt(panel.style.top || 0, 10)
                    }));
                } catch { }
            };

            // pointer dragging
            let dragging = false;
            let startX = 0, startY = 0;
            let startLeft = 0, startTop = 0;

            // Use the whole panel as handle

            panel.addEventListener('pointerdown', onPointerDown);

            function onPointerDown(e) {
                //if parent of modal is main then do nothing
                if (panel.parentNode === mainEl) return;
                if (['INPUT', 'TEXTAREA', 'BUTTON', 'SELECT', 'SPAN', 'LI'].includes(e.target.tagName)) return;
                if (e.pointerType === 'mouse' && e.button !== 0) return;
                dragging = true;
                panel.classList.add('dragging');
                panel.setPointerCapture(e.pointerId);

                const rect = panel.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = rect.left;
                startTop = rect.top;

                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            function onPointerMove(e) {
                if (!dragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                setPanelPos(startLeft + dx, startTop + dy);
            }

            function onPointerUp(e) {
                if (!dragging) return;
                dragging = false;
                panel.classList.remove('dragging');

                const rect = panel.getBoundingClientRect();
                const leftDist = rect.left;
                const rightDist = vw() - (rect.left + rect.width);

                // Snap horizontally only, but to CORNERS vertically
                let finalLeft = leftDist < rightDist ? SNAP_MARGIN : vw() - rect.width - SNAP_MARGIN;

                // For corners: pick top or bottom based on closest
                const topDist = rect.top;
                const bottomDist = vh() - (rect.top + rect.height);
                let finalTop = topDist < bottomDist ? SNAP_MARGIN : vh() - rect.height - SNAP_MARGIN;

                // But if you want vertical to remain unchanged:
                // let finalTop = rect.top;

                setPanelPos(finalLeft, finalTop);
                savePosition();

                document.body.style.userSelect = '';
                try { panel.releasePointerCapture(e.pointerId); } catch { }
            }


            // attach pointer events

            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerup', onPointerUp);

            // keep inside on resize
            window.addEventListener('resize', () => {
                resizePanel()

            });
            const spacer = document.getElementById('quick-editor-spacer');
            function resizePanel() {
                if (vw() > WIDTH_THRESHOLD) {
                    mainEl.insertBefore(panel, mainEl.firstChild);
                    panel.style.position = 'fixed';
                    panel.style.left = spacer.offsetLeft + 'px';
                    panel.style.top = '96px';
                    panel.style.transform = 'none';
                    panel.style.boxShadow = '0 6px 24px var(--shade)';
                    closeBtn.style.display = 'none';
                    spacer.style.display = 'unset';
                    spacer.style.width = panel.offsetWidth + 'px';
                    //set spacer height to main's height
                    if (vh() < panel.offsetHeight + 96) {
                        panel.style.position = 'absolute';
                    }
                } else {
                    if (!modal.contains(panel)) {
                        modal.appendChild(panel);
                        panel.style.position = 'fixed';
                        closeBtn.style.display = 'unset'; // show close button in modal
                        panel.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.45)';
                        spacer.style.display = 'none';
                    }
                    // Keep it clamped inside view
                    const rect = panel.getBoundingClientRect();
                    const finalLeft = clamp(rect.left, SNAP_MARGIN, Math.max(SNAP_MARGIN, vw() - rect.width - SNAP_MARGIN));
                    const finalTop = clamp(rect.top, SNAP_MARGIN, Math.max(SNAP_MARGIN, vh() - rect.height - SNAP_MARGIN));
                    setPanelPos(finalLeft, finalTop);
                    savePosition();
                }
            }
            resizePanel()

            // optional: close button & Esc to close
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            }


            // init when visible
            const observer = new MutationObserver(() => {
                if (!modal.classList.contains('hidden')) {
                    // slight delay to ensure layout computed
                    requestAnimationFrame(() => resizePanel());
                }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['class'] });

            // initial restore if already visible
            if (!modal.classList.contains('hidden')) resizePanel();
        })();

        document.getElementById('sort-select').addEventListener('change', () => renderAll());


        // Create a hidden span for measuring text width
        const span = document.createElement('span');
        span.style.position = 'absolute';
        span.style.visibility = 'hidden';
        span.style.height = 'auto';
        span.style.width = 'auto';
        span.style.whiteSpace = 'nowrap';
        span.style.fontSize = getComputedStyle(input).fontSize;
        span.style.fontWeight = getComputedStyle(input).fontWeight;
        span.style.fontFamily = getComputedStyle(input).fontFamily;
        document.body.appendChild(span);

        function updateWidth() {
            span.textContent = input.value || input.placeholder;
            const width = span.offsetWidth + 94; // 20px padding for comfort
            priceArea.style.width = width + 'px';
        }

        input.addEventListener('input', updateWidth);
        updateWidth(); // init width on page load



        /* ========== INIT ========== */
        (async function init() {
            //await promptAdminKey();
            setupDragDrop();
            //startUpdateCheck();
            try {
                const res = await fetch('https://emwiki.site/api/gist-version', { cache: 'no-store' });
                const data = await res.json();
                const raw = data.files?.['auto.json']?.content;
                jsData = raw ? JSON.parse(raw) : {};
                allItems = Object.values(jsData).flat();

                // Add category options to select
                const sel = document.getElementById('category-filter');
                const keys = Object.keys(jsData);
                keys.forEach(k => sel.appendChild(new Option(k.charAt(0).toUpperCase() + k.slice(1), k)));

                renderAll();
            } catch (e) { console.error(e); alert('Failed to load data'); }
        })();

    </script>

</body>

</html>