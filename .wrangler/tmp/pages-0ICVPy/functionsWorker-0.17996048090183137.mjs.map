{
  "version": 3,
  "sources": ["../../../functions/api/forum/comments/%5B%5Bpath%5D%5D.js", "../../../functions/api/_utils/auth.js", "../../../functions/api/forum/posts/%5B%5Bpath%5D%5D.js", "../../../functions/api/trades/_utils/helpers.js", "../../../functions/api/trades/listings/%5B%5Bpath%5D%5D.js", "../../../functions/api/trades/messages/%5B%5Bpath%5D%5D.js", "../../../functions/api/trades/notifications/%5B%5Bpath%5D%5D.js", "../../../functions/api/trades/offers/%5B%5Bpath%5D%5D.js", "../../../functions/api/trades/reviews/%5B%5Bpath%5D%5D.js", "../../../functions/api/images/upload.js", "../../../functions/api/cron/refresh-avatars.js", "../../../functions/api/donations/webhook.js", "../../../functions/api/embed/%5Bitem%5D.js", "../../../functions/api/gallery/%5B%5Bpath%5D%5D.js", "../../../functions/api/auth/%5B%5Bpath%5D%5D.js", "../../../functions/api/demand/%5B%5Bpath%5D%5D.js", "../../../functions/api/images/%5B%5Bpath%5D%5D.js", "../../../functions/api/items/%5B%5Bpath%5D%5D.js", "../../../functions/api/profile/%5B%5Bpath%5D%5D.js", "../../../functions/api/admin-login.js", "../../../functions/api/check-session.js", "../../../functions/api/latest-version.js", "../../../functions/api/logout.js", "../../../functions/api/roblox-proxy.js", "../../../functions/api/upload.js", "../../../functions/api/donations.js", "../../../functions/api/history.js", "../../../functions/gallery/%5Bid%5D.js", "../../../functions/profile/%5BuserId%5D.js", "../../../functions/_middleware.js", "functionsRoutes-0.10531370690170583.mjs", "../bundle-Aa1sFN/middleware-loader.entry.ts", "../bundle-Aa1sFN/middleware-insertion-facade.js", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/pages-template-worker.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/path-to-regexp/src/index.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "C:\\Users\\ADMIN\\Desktop\\EpicCatalogue\\emwiki\\.wrangler\\tmp\\pages-0ICVPy\\functionsWorker-0.17996048090183137.mjs",
  "sourcesContent": ["// Forum Comments API - Handles forum comment operations\r\n\r\n// Helper to get user from session token\r\nasync function getUserFromToken(token, env) {\r\n  if (!token) return null;\r\n\r\n  const session = await env.DBA.prepare(\r\n    'SELECT user_id FROM sessions WHERE token = ? AND expires_at > ?'\r\n  ).bind(token, Date.now()).first();\r\n\r\n  if (!session) return null;\r\n\r\n  const user = await env.DBA.prepare(\r\n    'SELECT user_id, username, display_name, role FROM users WHERE user_id = ?'\r\n  ).bind(session.user_id).first();\r\n\r\n  return user;\r\n}\r\n\r\n// Check if user is admin or moderator\r\nfunction isAdmin(user) {\r\n  if (!user || !user.role) return false;\r\n  try {\r\n    const roles = JSON.parse(user.role);\r\n    return roles.includes('admin') || roles.includes('moderator');\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get like count for comments\r\nasync function getLikeCount(commentId, env) {\r\n  const result = await env.DBA.prepare(\r\n    'SELECT COUNT(*) as count FROM forum_likes WHERE comment_id = ?'\r\n  ).bind(commentId).first();\r\n\r\n  return result?.count || 0;\r\n}\r\n\r\n// POST /api/forum/comments\r\nasync function handlePost({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // POST /api/forum/comments/:id/like - Toggle like on comment\r\n  if (path.endsWith('/like')) {\r\n    const commentId = parseInt(path.split('/')[0]);\r\n\r\n    // Check if already liked\r\n    const existingLike = await env.DBA.prepare(\r\n      'SELECT id FROM forum_likes WHERE comment_id = ? AND user_id = ?'\r\n    ).bind(commentId, user.user_id).first();\r\n\r\n    if (existingLike) {\r\n      // Unlike\r\n      await env.DBA.prepare(\r\n        'DELETE FROM forum_likes WHERE comment_id = ? AND user_id = ?'\r\n      ).bind(commentId, user.user_id).run();\r\n\r\n      const likeCount = await getLikeCount(commentId, env);\r\n\r\n      return new Response(JSON.stringify({\r\n        liked: false,\r\n        like_count: likeCount\r\n      }), {\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    } else {\r\n      // Like\r\n      await env.DBA.prepare(\r\n        'INSERT INTO forum_likes (user_id, comment_id, created_at) VALUES (?, ?, ?)'\r\n      ).bind(user.user_id, commentId, Math.floor(Date.now() / 1000)).run();\r\n\r\n      const likeCount = await getLikeCount(commentId, env);\r\n\r\n      return new Response(JSON.stringify({\r\n        liked: true,\r\n        like_count: likeCount\r\n      }), {\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n  }\r\n\r\n  // POST /api/forum/comments - Create new comment\r\n  try {\r\n    const data = await request.json();\r\n    const { post_id, content, parent_comment_id } = data;\r\n\r\n    if (!post_id || !content) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Missing required fields: post_id, content'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Check if post exists and is not locked\r\n    const post = await env.DBA.prepare(\r\n      'SELECT * FROM forum_posts WHERE id = ? AND status = \"active\"'\r\n    ).bind(post_id).first();\r\n\r\n    if (!post) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Post not found or has been deleted'\r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    if (post.is_locked) {\r\n      return new Response(JSON.stringify({\r\n        error: 'This post is locked and cannot accept new comments'\r\n      }), {\r\n        status: 403,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    if (content.length > 2000) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Comment too long (max 2000 characters)'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Insert comment\r\n    const result = await env.DBA.prepare(\r\n      `INSERT INTO forum_comments (post_id, user_id, username, content, parent_comment_id, created_at)\r\n       VALUES (?, ?, ?, ?, ?, ?)`\r\n    ).bind(\r\n      post_id,\r\n      user.user_id,\r\n      user.display_name || user.username,\r\n      content,\r\n      parent_comment_id || null,\r\n      Math.floor(Date.now() / 1000)\r\n    ).run();\r\n\r\n    const commentId = result.meta.last_row_id;\r\n\r\n    // Get the created comment with user role\r\n    const comment = await env.DBA.prepare(\r\n      `SELECT c.*, u.role\r\n       FROM forum_comments c\r\n       LEFT JOIN users u ON c.user_id = u.user_id\r\n       WHERE c.id = ?`\r\n    ).bind(commentId).first();\r\n\r\n    // Add like count\r\n    comment.like_count = 0;\r\n    comment.user_has_liked = false;\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      comment,\r\n      message: 'Comment posted successfully!'\r\n    }), {\r\n      status: 201,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to create comment: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// PUT /api/forum/comments/:id\r\nasync function handlePut({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n  const commentId = parseInt(path);\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Get comment to check ownership\r\n  const comment = await env.DBA.prepare(\r\n    'SELECT * FROM forum_comments WHERE id = ?'\r\n  ).bind(commentId).first();\r\n\r\n  if (!comment) {\r\n    return new Response(JSON.stringify({ error: 'Comment not found' }), {\r\n      status: 404,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Check if user is the author or admin\r\n  if (comment.user_id !== user.user_id && !isAdmin(user)) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 403,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  try {\r\n    const data = await request.json();\r\n    const { content } = data;\r\n\r\n    if (!content) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Missing required field: content'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Update comment\r\n    await env.DBA.prepare(\r\n      `UPDATE forum_comments\r\n       SET content = ?, edited_at = ?\r\n       WHERE id = ?`\r\n    ).bind(content, Math.floor(Date.now() / 1000), commentId).run();\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      message: 'Comment updated successfully!'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to update comment: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// DELETE /api/forum/comments/:id\r\nasync function handleDelete({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n  const commentId = parseInt(path);\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Get comment to check ownership\r\n  const comment = await env.DBA.prepare(\r\n    'SELECT * FROM forum_comments WHERE id = ?'\r\n  ).bind(commentId).first();\r\n\r\n  if (!comment) {\r\n    return new Response(JSON.stringify({ error: 'Comment not found' }), {\r\n      status: 404,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Check if user is the author or admin\r\n  if (comment.user_id !== user.user_id && !isAdmin(user)) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 403,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Soft delete by setting status to 'deleted'\r\n    await env.DBA.prepare(\r\n      'UPDATE forum_comments SET status = \"deleted\" WHERE id = ?'\r\n    ).bind(commentId).run();\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      message: 'Comment deleted successfully!'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to delete comment: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// Main request handler\r\nexport async function onRequest(context) {\r\n  const { request, env, params } = context;\r\n\r\n  // CORS headers\r\n  const corsHeaders = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n  };\r\n\r\n  // Handle OPTIONS request\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    let response;\r\n\r\n    switch (request.method) {\r\n      case 'POST':\r\n        response = await handlePost({ request, env, params });\r\n        break;\r\n      case 'PUT':\r\n        response = await handlePut({ request, env, params });\r\n        break;\r\n      case 'DELETE':\r\n        response = await handleDelete({ request, env, params });\r\n        break;\r\n      default:\r\n        response = new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n          status: 405,\r\n          headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n\r\n    // Add CORS headers to response\r\n    const newHeaders = new Headers(response.headers);\r\n    Object.entries(corsHeaders).forEach(([key, value]) => {\r\n      newHeaders.set(key, value);\r\n    });\r\n\r\n    return new Response(response.body, {\r\n      status: response.status,\r\n      statusText: response.statusText,\r\n      headers: newHeaders\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ error: error.message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n", "export async function createSession(name, secret) {\r\n  const issued = Date.now();\r\n  const payload = { name, issued };\r\n  const encoded = btoa(JSON.stringify(payload));\r\n\r\n  const key = await crypto.subtle.importKey(\r\n    \"raw\",\r\n    new TextEncoder().encode(secret),\r\n    { name: \"HMAC\", hash: \"SHA-256\" },\r\n    false,\r\n    [\"sign\"]\r\n  );\r\n\r\n  const sigBuffer = await crypto.subtle.sign(\"HMAC\", key, new TextEncoder().encode(encoded));\r\n  const sigHex = [...new Uint8Array(sigBuffer)].map(b => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n\r\n  return `${encoded}.${sigHex}`;\r\n}\r\n\r\nexport async function verifySession(token, secret) {\r\n  const [encoded, sigHex] = token.split(\".\");\r\n  if (!encoded || !sigHex) return null;\r\n\r\n  const key = await crypto.subtle.importKey(\r\n    \"raw\",\r\n    new TextEncoder().encode(secret),\r\n    { name: \"HMAC\", hash: \"SHA-256\" },\r\n    false,\r\n    [\"sign\"]\r\n  );\r\n\r\n  const sigBuffer = await crypto.subtle.sign(\"HMAC\", key, new TextEncoder().encode(encoded));\r\n  const expectedHex = [...new Uint8Array(sigBuffer)].map(b => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n\r\n  if (expectedHex !== sigHex) return null;\r\n\r\n  return JSON.parse(atob(encoded));\r\n}\r\n", "// Forum Posts API - Handles forum post CRUD operations\r\nimport { verifySession } from '../../_utils/auth.js';\r\n\r\n// Helper to get user from session token\r\nasync function getUserFromToken(token, env) {\r\n  if (!token) return null;\r\n\r\n  const session = await env.DBA.prepare(\r\n    'SELECT user_id FROM sessions WHERE token = ? AND expires_at > ?'\r\n  ).bind(token, Date.now()).first();\r\n\r\n  if (!session) return null;\r\n\r\n  const user = await env.DBA.prepare(\r\n    'SELECT user_id, username, display_name, role FROM users WHERE user_id = ?'\r\n  ).bind(session.user_id).first();\r\n\r\n  return user;\r\n}\r\n\r\n// Check if user is admin or moderator\r\nfunction isAdmin(user) {\r\n  if (!user || !user.role) return false;\r\n  try {\r\n    const roles = JSON.parse(user.role);\r\n    return roles.includes('admin') || roles.includes('moderator');\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get comment count for posts\r\nasync function getCommentCount(postId, env) {\r\n  const result = await env.DBA.prepare(\r\n    'SELECT COUNT(*) as count FROM forum_comments WHERE post_id = ? AND status = \"active\"'\r\n  ).bind(postId).first();\r\n\r\n  return result?.count || 0;\r\n}\r\n\r\n// Helper to get like count for posts\r\nasync function getLikeCount(postId, env) {\r\n  const result = await env.DBA.prepare(\r\n    'SELECT COUNT(*) as count FROM forum_likes WHERE post_id = ?'\r\n  ).bind(postId).first();\r\n\r\n  return result?.count || 0;\r\n}\r\n\r\n// Helper to check if user liked a post\r\nasync function hasUserLiked(postId, userId, env) {\r\n  if (!userId) return false;\r\n\r\n  const result = await env.DBA.prepare(\r\n    'SELECT id FROM forum_likes WHERE post_id = ? AND user_id = ?'\r\n  ).bind(postId, userId).first();\r\n\r\n  return !!result;\r\n}\r\n\r\n// GET /api/forum/posts\r\nasync function handleGet({ request, env, params }) {\r\n  const url = new URL(request.url);\r\n  const path = params.path ? params.path.join('/') : '';\r\n\r\n  // Get auth token (optional for GET)\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = token ? await getUserFromToken(token, env) : null;\r\n\r\n  // GET /api/forum/posts/:id - Get single post with comments\r\n  if (path && path !== '' && !path.includes('/')) {\r\n    const postId = parseInt(path);\r\n\r\n    // Get post\r\n    const post = await env.DBA.prepare(\r\n      `SELECT p.*, u.role\r\n       FROM forum_posts p\r\n       LEFT JOIN users u ON p.user_id = u.user_id\r\n       WHERE p.id = ? AND p.status = 'active'`\r\n    ).bind(postId).first();\r\n\r\n    if (!post) {\r\n      return new Response(JSON.stringify({ error: 'Post not found' }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Get comments for this post\r\n    const comments = await env.DBA.prepare(\r\n      `SELECT c.*, u.role\r\n       FROM forum_comments c\r\n       LEFT JOIN users u ON c.user_id = u.user_id\r\n       WHERE c.post_id = ? AND c.status = 'active'\r\n       ORDER BY c.created_at ASC`\r\n    ).bind(postId).all();\r\n\r\n    // Add like counts and user liked status\r\n    post.like_count = await getLikeCount(postId, env);\r\n    post.user_has_liked = await hasUserLiked(postId, user?.user_id, env);\r\n\r\n    // Add like counts to comments\r\n    for (const comment of comments.results || []) {\r\n      comment.like_count = await getLikeCount(null, env, comment.id);\r\n      comment.user_has_liked = await hasUserLikedComment(comment.id, user?.user_id, env);\r\n    }\r\n\r\n    return new Response(JSON.stringify({\r\n      post,\r\n      comments: comments.results || []\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // GET /api/forum/posts - List all posts\r\n  const category = url.searchParams.get('category');\r\n  const limit = parseInt(url.searchParams.get('limit')) || 100;\r\n  const offset = parseInt(url.searchParams.get('offset')) || 0;\r\n\r\n  let query = `\r\n    SELECT p.*, u.role\r\n    FROM forum_posts p\r\n    LEFT JOIN users u ON p.user_id = u.user_id\r\n    WHERE p.status = 'active'\r\n  `;\r\n\r\n  const params_list = [];\r\n\r\n  if (category && category !== 'all') {\r\n    query += ' AND p.category = ?';\r\n    params_list.push(category);\r\n  }\r\n\r\n  query += ' ORDER BY p.is_pinned DESC, p.created_at DESC LIMIT ? OFFSET ?';\r\n  params_list.push(limit, offset);\r\n\r\n  const posts = await env.DBA.prepare(query).bind(...params_list).all();\r\n\r\n  // Add comment counts and like counts to each post\r\n  for (const post of posts.results || []) {\r\n    post.comment_count = await getCommentCount(post.id, env);\r\n    post.like_count = await getLikeCount(post.id, env);\r\n    post.user_has_liked = await hasUserLiked(post.id, user?.user_id, env);\r\n  }\r\n\r\n  return new Response(JSON.stringify({ posts: posts.results || [] }), {\r\n    headers: { 'Content-Type': 'application/json' }\r\n  });\r\n}\r\n\r\n// POST /api/forum/posts\r\nasync function handlePost({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // POST /api/forum/posts/:id/like - Toggle like on post\r\n  if (path.endsWith('/like')) {\r\n    const postId = parseInt(path.split('/')[0]);\r\n\r\n    // Check if already liked\r\n    const existingLike = await env.DBA.prepare(\r\n      'SELECT id FROM forum_likes WHERE post_id = ? AND user_id = ?'\r\n    ).bind(postId, user.user_id).first();\r\n\r\n    if (existingLike) {\r\n      // Unlike\r\n      await env.DBA.prepare(\r\n        'DELETE FROM forum_likes WHERE post_id = ? AND user_id = ?'\r\n      ).bind(postId, user.user_id).run();\r\n\r\n      const likeCount = await getLikeCount(postId, env);\r\n\r\n      return new Response(JSON.stringify({\r\n        liked: false,\r\n        like_count: likeCount\r\n      }), {\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    } else {\r\n      // Like\r\n      await env.DBA.prepare(\r\n        'INSERT INTO forum_likes (user_id, post_id, created_at) VALUES (?, ?, ?)'\r\n      ).bind(user.user_id, postId, Math.floor(Date.now() / 1000)).run();\r\n\r\n      const likeCount = await getLikeCount(postId, env);\r\n\r\n      return new Response(JSON.stringify({\r\n        liked: true,\r\n        like_count: likeCount\r\n      }), {\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n  }\r\n\r\n  // POST /api/forum/posts/:id/view - Increment view count\r\n  if (path.endsWith('/view')) {\r\n    const postId = parseInt(path.split('/')[0]);\r\n\r\n    await env.DBA.prepare(\r\n      'UPDATE forum_posts SET views = views + 1 WHERE id = ?'\r\n    ).bind(postId).run();\r\n\r\n    return new Response(JSON.stringify({ success: true }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // POST /api/forum/posts - Create new post\r\n  try {\r\n    const data = await request.json();\r\n    const { category, title, content } = data;\r\n\r\n    if (!category || !title || !content) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Missing required fields: category, title, content'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    const validCategories = ['general', 'trading', 'updates', 'guides', 'feedback', 'off-topic'];\r\n    if (!validCategories.includes(category)) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Invalid category'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    if (title.length > 200) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Title too long (max 200 characters)'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    if (content.length > 5000) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Content too long (max 5000 characters)'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Insert post\r\n    const result = await env.DBA.prepare(\r\n      `INSERT INTO forum_posts (user_id, username, title, content, category, created_at)\r\n       VALUES (?, ?, ?, ?, ?, ?)`\r\n    ).bind(\r\n      user.user_id,\r\n      user.display_name || user.username,\r\n      title,\r\n      content,\r\n      category,\r\n      Math.floor(Date.now() / 1000)\r\n    ).run();\r\n\r\n    const postId = result.meta.last_row_id;\r\n\r\n    // Get the created post\r\n    const post = await env.DBA.prepare(\r\n      'SELECT * FROM forum_posts WHERE id = ?'\r\n    ).bind(postId).first();\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      post,\r\n      message: 'Post created successfully!'\r\n    }), {\r\n      status: 201,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to create post: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// PUT /api/forum/posts/:id\r\nasync function handlePut({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n  const postId = parseInt(path);\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Get post to check ownership\r\n  const post = await env.DBA.prepare(\r\n    'SELECT * FROM forum_posts WHERE id = ?'\r\n  ).bind(postId).first();\r\n\r\n  if (!post) {\r\n    return new Response(JSON.stringify({ error: 'Post not found' }), {\r\n      status: 404,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Check if user is the author or admin\r\n  if (post.user_id !== user.user_id && !isAdmin(user)) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 403,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  try {\r\n    const data = await request.json();\r\n    const { title, content } = data;\r\n\r\n    if (!title || !content) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Missing required fields: title, content'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Update post\r\n    await env.DBA.prepare(\r\n      `UPDATE forum_posts\r\n       SET title = ?, content = ?, edited_at = ?\r\n       WHERE id = ?`\r\n    ).bind(title, content, Math.floor(Date.now() / 1000), postId).run();\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      message: 'Post updated successfully!'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to update post: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// DELETE /api/forum/posts/:id\r\nasync function handleDelete({ request, env, params }) {\r\n  const path = params.path ? params.path.join('/') : '';\r\n  const postId = parseInt(path);\r\n\r\n  // Get auth token\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  const user = await getUserFromToken(token, env);\r\n\r\n  if (!user) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Get post to check ownership\r\n  const post = await env.DBA.prepare(\r\n    'SELECT * FROM forum_posts WHERE id = ?'\r\n  ).bind(postId).first();\r\n\r\n  if (!post) {\r\n    return new Response(JSON.stringify({ error: 'Post not found' }), {\r\n      status: 404,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  // Check if user is the author or admin\r\n  if (post.user_id !== user.user_id && !isAdmin(user)) {\r\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n      status: 403,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Soft delete by setting status to 'deleted'\r\n    await env.DBA.prepare(\r\n      'UPDATE forum_posts SET status = \"deleted\" WHERE id = ?'\r\n    ).bind(postId).run();\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      message: 'Post deleted successfully!'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: 'Failed to delete post: ' + err.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// Helper for comment likes\r\nasync function hasUserLikedComment(commentId, userId, env) {\r\n  if (!userId) return false;\r\n\r\n  const result = await env.DBA.prepare(\r\n    'SELECT id FROM forum_likes WHERE comment_id = ? AND user_id = ?'\r\n  ).bind(commentId, userId).first();\r\n\r\n  return !!result;\r\n}\r\n\r\n// Main request handler\r\nexport async function onRequest(context) {\r\n  const { request, env, params } = context;\r\n\r\n  // CORS headers\r\n  const corsHeaders = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n  };\r\n\r\n  // Handle OPTIONS request\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    let response;\r\n\r\n    switch (request.method) {\r\n      case 'GET':\r\n        response = await handleGet({ request, env, params });\r\n        break;\r\n      case 'POST':\r\n        response = await handlePost({ request, env, params });\r\n        break;\r\n      case 'PUT':\r\n        response = await handlePut({ request, env, params });\r\n        break;\r\n      case 'DELETE':\r\n        response = await handleDelete({ request, env, params });\r\n        break;\r\n      default:\r\n        response = new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n          status: 405,\r\n          headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n\r\n    // Add CORS headers to response\r\n    const newHeaders = new Headers(response.headers);\r\n    Object.entries(corsHeaders).forEach(([key, value]) => {\r\n      newHeaders.set(key, value);\r\n    });\r\n\r\n    return new Response(response.body, {\r\n      status: response.status,\r\n      statusText: response.statusText,\r\n      headers: newHeaders\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ error: error.message }), {\r\n      status: 500,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n", "import { verifySession } from '../../_utils/auth.js';\r\n\r\n// Authenticate user from request\r\nexport async function authenticateUser(request, env) {\r\n    const authHeader = request.headers.get('Authorization');\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n        return null;\r\n    }\r\n\r\n    const token = authHeader.substring(7);\r\n    const session = await verifySession(token, env.SESSION_SECRET);\r\n\r\n    if (!session) {\r\n        return null;\r\n    }\r\n\r\n    // Get user from database\r\n    const user = await env.DBA.prepare(\r\n        'SELECT user_id, username, display_name, avatar_url, roles FROM users WHERE user_id = ?'\r\n    ).bind(session.name).first();\r\n\r\n    return user;\r\n}\r\n\r\n// Check if user is authorized (authenticated and not banned)\r\nexport function isAuthorized(user) {\r\n    if (!user) return false;\r\n\r\n    const roles = typeof user.roles === 'string' ? JSON.parse(user.roles) : user.roles;\r\n    return !roles.includes('scammer');\r\n}\r\n\r\n// Standard error response\r\nexport function errorResponse(message, status = 400) {\r\n    return new Response(JSON.stringify({ error: message }), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n// Standard success response\r\nexport function successResponse(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n// Validate required fields\r\nexport function validateFields(data, requiredFields) {\r\n    const missing = requiredFields.filter(field => !data[field]);\r\n    if (missing.length > 0) {\r\n        return `Missing required fields: ${missing.join(', ')}`;\r\n    }\r\n    return null;\r\n}\r\n\r\n// Create notification\r\nexport async function createNotification(env, userId, type, title, message, link = null) {\r\n    await env.DBA.prepare(\r\n        'INSERT INTO trade_notifications (user_id, type, title, message, link, created_at) VALUES (?, ?, ?, ?, ?, ?)'\r\n    ).bind(userId, type, title, message, link, Date.now()).run();\r\n}\r\n\r\n// Update user trade stats\r\nexport async function updateUserStats(env, userId) {\r\n    const stats = await env.DBA.prepare(`\r\n        SELECT\r\n            COUNT(*) as total_trades,\r\n            SUM(CASE WHEN seller_id = ? OR buyer_id = ? THEN 1 ELSE 0 END) as successful_trades\r\n        FROM completed_trades\r\n        WHERE seller_id = ? OR buyer_id = ?\r\n    `).bind(userId, userId, userId, userId).first();\r\n\r\n    const reviews = await env.DBA.prepare(`\r\n        SELECT\r\n            AVG(rating) as avg_rating,\r\n            COUNT(*) as review_count\r\n        FROM trade_reviews\r\n        WHERE reviewed_user_id = ?\r\n    `).bind(userId).first();\r\n\r\n    await env.DBA.prepare(`\r\n        INSERT INTO user_trade_stats (user_id, total_trades, successful_trades, average_rating, total_reviews, last_trade_at)\r\n        VALUES (?, ?, ?, ?, ?, ?)\r\n        ON CONFLICT(user_id) DO UPDATE SET\r\n            total_trades = excluded.total_trades,\r\n            successful_trades = excluded.successful_trades,\r\n            average_rating = excluded.average_rating,\r\n            total_reviews = excluded.total_reviews,\r\n            last_trade_at = excluded.last_trade_at\r\n    `).bind(\r\n        userId,\r\n        stats.total_trades || 0,\r\n        stats.successful_trades || 0,\r\n        reviews.avg_rating || 0,\r\n        reviews.review_count || 0,\r\n        Date.now()\r\n    ).run();\r\n}\r\n\r\n// Get user with stats\r\nexport async function getUserWithStats(env, userId) {\r\n    const user = await env.DBA.prepare(`\r\n        SELECT\r\n            u.user_id,\r\n            u.username,\r\n            u.display_name,\r\n            u.avatar_url,\r\n            u.roles,\r\n            uts.total_trades,\r\n            uts.successful_trades,\r\n            uts.average_rating,\r\n            uts.total_reviews,\r\n            uts.last_trade_at\r\n        FROM users u\r\n        LEFT JOIN user_trade_stats uts ON u.user_id = uts.user_id\r\n        WHERE u.user_id = ?\r\n    `).bind(userId).first();\r\n\r\n    if (user) {\r\n        user.roles = typeof user.roles === 'string' ? JSON.parse(user.roles) : user.roles;\r\n    }\r\n\r\n    return user;\r\n}\r\n\r\n// Parse pagination parameters\r\nexport function parsePagination(url) {\r\n    const params = new URL(url).searchParams;\r\n    const limit = Math.min(parseInt(params.get('limit') || '20'), 100);\r\n    const offset = parseInt(params.get('offset') || '0');\r\n    return { limit, offset };\r\n}\r\n\r\n// Parse sort parameters\r\nexport function parseSort(url, allowedFields, defaultField = 'created_at', defaultOrder = 'DESC') {\r\n    const params = new URL(url).searchParams;\r\n    const sortBy = params.get('sort') || defaultField;\r\n    const sortOrder = params.get('order')?.toUpperCase() === 'ASC' ? 'ASC' : 'DESC';\r\n\r\n    // Validate sort field\r\n    if (!allowedFields.includes(sortBy)) {\r\n        return { sortBy: defaultField, sortOrder: defaultOrder };\r\n    }\r\n\r\n    return { sortBy, sortOrder };\r\n}\r\n", "import {\n    authenticateUser,\n    isAuthorized,\n    errorResponse,\n    successResponse,\n    validateFields,\n    parsePagination,\n    parseSort,\n    getUserWithStats\n} from '../_utils/helpers.js';\n\n// Handle GET requests\nasync function handleGet(request, env, path) {\n    const url = new URL(request.url);\n\n    // GET /api/trades/listings - List all active listings\n    if (!path || path === '') {\n        const { limit, offset } = parsePagination(url);\n        const { sortBy, sortOrder } = parseSort(url, ['created_at', 'updated_at', 'views'], 'created_at', 'DESC');\n\n        const params = url.searchParams;\n        const category = params.get('category');\n        const userId = params.get('user_id');\n        const status = params.get('status') || 'active';\n        const search = params.get('search');\n\n        let query = 'SELECT * FROM trade_listings WHERE 1=1';\n        const bindings = [];\n\n        if (status) {\n            query += ' AND status = ?';\n            bindings.push(status);\n        }\n\n        if (category && category !== 'all') {\n            query += ' AND category = ?';\n            bindings.push(category);\n        }\n\n        if (userId) {\n            query += ' AND user_id = ?';\n            bindings.push(userId);\n        }\n\n        if (search) {\n            query += ' AND (title LIKE ? OR description LIKE ?)';\n            bindings.push(`%${search}%`, `%${search}%`);\n        }\n\n        query += ` ORDER BY ${sortBy} ${sortOrder} LIMIT ? OFFSET ?`;\n        bindings.push(limit, offset);\n\n        const { results } = await env.DBA.prepare(query).bind(...bindings).all();\n\n        // Get user info for each listing\n        const listings = await Promise.all(results.map(async (listing) => {\n            const user = await getUserWithStats(env, listing.user_id);\n            return {\n                ...listing,\n                offering_items: JSON.parse(listing.offering_items),\n                seeking_items: listing.seeking_items ? JSON.parse(listing.seeking_items) : null,\n                user: {\n                    user_id: user.user_id,\n                    username: user.username,\n                    display_name: user.display_name,\n                    avatar_url: user.avatar_url,\n                    average_rating: user.average_rating || 0,\n                    total_trades: user.total_trades || 0\n                }\n            };\n        }));\n\n        return successResponse({ listings, limit, offset });\n    }\n\n    // GET /api/trades/listings/:id - Get specific listing\n    const listingId = path.split('/')[0];\n    if (listingId) {\n        const listing = await env.DBA.prepare(\n            'SELECT * FROM trade_listings WHERE id = ?'\n        ).bind(listingId).first();\n\n        if (!listing) {\n            return errorResponse('Listing not found', 404);\n        }\n\n        // Increment view count\n        await env.DBA.prepare(\n            'UPDATE trade_listings SET views = views + 1 WHERE id = ?'\n        ).bind(listingId).run();\n\n        // Get user info\n        const user = await getUserWithStats(env, listing.user_id);\n\n        // Get offer count\n        const offerCount = await env.DBA.prepare(\n            'SELECT COUNT(*) as count FROM trade_offers WHERE listing_id = ?'\n        ).bind(listingId).first();\n\n        return successResponse({\n            ...listing,\n            offering_items: JSON.parse(listing.offering_items),\n            seeking_items: listing.seeking_items ? JSON.parse(listing.seeking_items) : null,\n            views: listing.views + 1,\n            offer_count: offerCount.count,\n            user: {\n                user_id: user.user_id,\n                username: user.username,\n                display_name: user.display_name,\n                avatar_url: user.avatar_url,\n                average_rating: user.average_rating || 0,\n                total_trades: user.total_trades || 0,\n                total_reviews: user.total_reviews || 0\n            }\n        });\n    }\n\n    return errorResponse('Invalid request', 400);\n}\n\n// Handle POST requests\nasync function handlePost(request, env, path, user) {\n    if (!user || !isAuthorized(user)) {\n        return errorResponse('Unauthorized', 401);\n    }\n\n    // POST /api/trades/listings - Create new listing\n    if (!path || path === '') {\n        const data = await request.json();\n\n        const error = validateFields(data, ['offering_items']);\n        if (error) {\n            return errorResponse(error);\n        }\n\n        const {\n            title,\n            description,\n            category = 'other',\n            offering_items,\n            seeking_items,\n            expires_in_days = 30\n        } = data;\n\n        // Validate offering_items is an array\n        if (!Array.isArray(offering_items) || offering_items.length === 0) {\n            return errorResponse('offering_items must be a non-empty array');\n        }\n\n        // Validate item types and robux amounts\n        const validateItems = (items, fieldName) => {\n            for (const item of items) {\n                if (item.type === 'robux') {\n                    const amount = parseInt(item.amount);\n                    if (isNaN(amount) || amount < 0 || amount > 1000000) {\n                        return `Invalid robux amount in ${fieldName}: must be between 0 and 1,000,000`;\n                    }\n                } else if (item.type === 'other-game') {\n                    if (!item.game_name || !item.item_name) {\n                        return `Invalid other-game item in ${fieldName}: game_name and item_name are required`;\n                    }\n                } else if (item.type === 'game-item') {\n                    if (!item.item_name) {\n                        return `Invalid game-item in ${fieldName}: item_name is required`;\n                    }\n                }\n            }\n            return null;\n        };\n\n        const offeringError = validateItems(offering_items, 'offering_items');\n        if (offeringError) {\n            return errorResponse(offeringError);\n        }\n\n        if (seeking_items && Array.isArray(seeking_items)) {\n            const seekingError = validateItems(seeking_items, 'seeking_items');\n            if (seekingError) {\n                return errorResponse(seekingError);\n            }\n        }\n\n        // Generate auto title if not provided\n        let finalTitle = title;\n        if (!finalTitle) {\n            const firstOffering = offering_items[0];\n            let offeringText = '';\n            if (firstOffering.type === 'robux') {\n                offeringText = `${firstOffering.amount} R$`;\n            } else if (firstOffering.type === 'other-game') {\n                offeringText = `${firstOffering.game_name} ${firstOffering.item_name}`;\n            } else {\n                offeringText = firstOffering.item_name;\n            }\n            if (offering_items.length > 1) {\n                offeringText += ` + ${offering_items.length - 1} more`;\n            }\n            \n            if (seeking_items && seeking_items.length > 0) {\n                const firstSeeking = seeking_items[0];\n                let seekingText = '';\n                if (firstSeeking.type === 'robux') {\n                    seekingText = `${firstSeeking.amount} R$`;\n                } else if (firstSeeking.type === 'other-game') {\n                    seekingText = `${firstSeeking.game_name} ${firstSeeking.item_name}`;\n                } else {\n                    seekingText = firstSeeking.item_name;\n                }\n                if (seeking_items.length > 1) {\n                    seekingText += ` + ${seeking_items.length - 1} more`;\n                }\n                finalTitle = `Trading ${offeringText} for ${seekingText}`;\n            } else {\n                finalTitle = `Trading ${offeringText}`;\n            }\n        }\n\n        const now = Date.now();\n        const expiresAt = now + (expires_in_days * 24 * 60 * 60 * 1000);\n\n        const result = await env.DBA.prepare(\n            `INSERT INTO trade_listings\n            (user_id, title, description, category, status, offering_items, seeking_items, created_at, updated_at, expires_at)\n            VALUES (?, ?, ?, ?, 'active', ?, ?, ?, ?, ?)`\n        ).bind(\n            user.user_id,\n            finalTitle,\n            description || null,\n            category,\n            JSON.stringify(offering_items),\n            seeking_items ? JSON.stringify(seeking_items) : null,\n            now,\n            now,\n            expiresAt\n        ).run();\n\n        return successResponse({\n            id: result.meta.last_row_id,\n            message: 'Listing created successfully'\n        }, 201);\n    }\n\n    return errorResponse('Invalid request', 400);\n}\n\n// Handle PUT/PATCH requests\nasync function handlePut(request, env, path, user) {\n    if (!user || !isAuthorized(user)) {\n        return errorResponse('Unauthorized', 401);\n    }\n\n    const listingId = path.split('/')[0];\n    if (!listingId) {\n        return errorResponse('Listing ID required', 400);\n    }\n\n    // Check ownership\n    const listing = await env.DBA.prepare(\n        'SELECT * FROM trade_listings WHERE id = ?'\n    ).bind(listingId).first();\n\n    if (!listing) {\n        return errorResponse('Listing not found', 404);\n    }\n\n    if (listing.user_id !== user.user_id) {\n        return errorResponse('You can only edit your own listings', 403);\n    }\n\n    const data = await request.json();\n    const {\n        title,\n        description,\n        category,\n        offering_items,\n        seeking_items,\n        status\n    } = data;\n\n    // Build update query dynamically\n    const updates = [];\n    const bindings = [];\n\n    if (title !== undefined) {\n        updates.push('title = ?');\n        bindings.push(title);\n    }\n    if (description !== undefined) {\n        updates.push('description = ?');\n        bindings.push(description);\n    }\n    if (category !== undefined) {\n        updates.push('category = ?');\n        bindings.push(category);\n    }\n    if (offering_items !== undefined) {\n        updates.push('offering_items = ?');\n        bindings.push(JSON.stringify(offering_items));\n    }\n    if (seeking_items !== undefined) {\n        updates.push('seeking_items = ?');\n        bindings.push(JSON.stringify(seeking_items));\n    }\n    if (status !== undefined && ['active', 'cancelled', 'completed'].includes(status)) {\n        updates.push('status = ?');\n        bindings.push(status);\n    }\n\n    if (updates.length === 0) {\n        return errorResponse('No fields to update');\n    }\n\n    updates.push('updated_at = ?');\n    bindings.push(Date.now());\n    bindings.push(listingId);\n\n    await env.DBA.prepare(\n        `UPDATE trade_listings SET ${updates.join(', ')} WHERE id = ?`\n    ).bind(...bindings).run();\n\n    return successResponse({ message: 'Listing updated successfully' });\n}\n\n// Handle DELETE requests\nasync function handleDelete(request, env, path, user) {\n    if (!user || !isAuthorized(user)) {\n        return errorResponse('Unauthorized', 401);\n    }\n\n    const listingId = path.split('/')[0];\n    if (!listingId) {\n        return errorResponse('Listing ID required', 400);\n    }\n\n    // Check ownership\n    const listing = await env.DBA.prepare(\n        'SELECT * FROM trade_listings WHERE id = ?'\n    ).bind(listingId).first();\n\n    if (!listing) {\n        return errorResponse('Listing not found', 404);\n    }\n\n    if (listing.user_id !== user.user_id) {\n        return errorResponse('You can only delete your own listings', 403);\n    }\n\n    // Soft delete by setting status to cancelled\n    await env.DBA.prepare(\n        'UPDATE trade_listings SET status = ?, updated_at = ? WHERE id = ?'\n    ).bind('cancelled', Date.now(), listingId).run();\n\n    return successResponse({ message: 'Listing deleted successfully' });\n}\n\n// Main handler\nexport async function onRequest(context) {\n    const { request, env } = context;\n    const url = new URL(request.url);\n    const pathParts = url.pathname.split('/api/trades/listings/').filter(Boolean);\n    const path = pathParts[0] || '';\n\n    // CORS headers\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    };\n\n    // Handle OPTIONS request\n    if (request.method === 'OPTIONS') {\n        return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n        let user = null;\n        if (request.method !== 'GET') {\n            user = await authenticateUser(request, env);\n        }\n\n        let response;\n        switch (request.method) {\n            case 'GET':\n                response = await handleGet(request, env, path);\n                break;\n            case 'POST':\n                response = await handlePost(request, env, path, user);\n                break;\n            case 'PUT':\n            case 'PATCH':\n                response = await handlePut(request, env, path, user);\n                break;\n            case 'DELETE':\n                response = await handleDelete(request, env, path, user);\n                break;\n            default:\n                response = errorResponse('Method not allowed', 405);\n        }\n\n        // Add CORS headers to response\n        const headers = new Headers(response.headers);\n        Object.entries(corsHeaders).forEach(([key, value]) => {\n            headers.set(key, value);\n        });\n\n        return new Response(response.body, {\n            status: response.status,\n            headers\n        });\n    } catch (error) {\n        console.error('Trade listings error:', error);\n        return new Response(JSON.stringify({ error: 'Internal server error' }), {\n            status: 500,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n}\n", "import {\r\n    authenticateUser,\r\n    isAuthorized,\r\n    errorResponse,\r\n    successResponse,\r\n    validateFields,\r\n    createNotification,\r\n    getUserWithStats\r\n} from '../_utils/helpers.js';\r\n\r\n// Handle GET requests\r\nasync function handleGet(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const url = new URL(request.url);\r\n\r\n    // GET /api/trades/messages - List user's conversations\r\n    if (!path || path === '') {\r\n        const listingId = url.searchParams.get('listing_id');\r\n        const offerId = url.searchParams.get('offer_id');\r\n        const withUserId = url.searchParams.get('with_user_id');\r\n\r\n        let query = 'SELECT * FROM trade_messages WHERE (from_user_id = ? OR to_user_id = ?)';\r\n        const bindings = [user.user_id, user.user_id];\r\n\r\n        if (listingId) {\r\n            query += ' AND listing_id = ?';\r\n            bindings.push(listingId);\r\n        }\r\n\r\n        if (offerId) {\r\n            query += ' AND offer_id = ?';\r\n            bindings.push(offerId);\r\n        }\r\n\r\n        if (withUserId) {\r\n            query += ' AND (from_user_id = ? OR to_user_id = ?)';\r\n            bindings.push(withUserId, withUserId);\r\n        }\r\n\r\n        query += ' ORDER BY created_at ASC';\r\n\r\n        const { results } = await env.DBA.prepare(query).bind(...bindings).all();\r\n\r\n        // Get user info for each message\r\n        const messages = await Promise.all(results.map(async (msg) => {\r\n            const fromUser = await getUserWithStats(env, msg.from_user_id);\r\n            const toUser = await getUserWithStats(env, msg.to_user_id);\r\n\r\n            return {\r\n                ...msg,\r\n                from_user: {\r\n                    user_id: fromUser.user_id,\r\n                    username: fromUser.username,\r\n                    display_name: fromUser.display_name,\r\n                    avatar_url: fromUser.avatar_url\r\n                },\r\n                to_user: {\r\n                    user_id: toUser.user_id,\r\n                    username: toUser.username,\r\n                    display_name: toUser.display_name,\r\n                    avatar_url: toUser.avatar_url\r\n                }\r\n            };\r\n        }));\r\n\r\n        // Mark messages as read that were sent to this user\r\n        if (messages.length > 0) {\r\n            const messageIds = messages\r\n                .filter(m => m.to_user_id === user.user_id && !m.read)\r\n                .map(m => m.id);\r\n\r\n            if (messageIds.length > 0) {\r\n                await env.DBA.prepare(\r\n                    `UPDATE trade_messages SET read = 1 WHERE id IN (${messageIds.join(',')})`\r\n                ).run();\r\n            }\r\n        }\r\n\r\n        return successResponse({ messages });\r\n    }\r\n\r\n    // GET /api/trades/messages/unread - Get unread message count\r\n    if (path === 'unread') {\r\n        const result = await env.DBA.prepare(\r\n            'SELECT COUNT(*) as count FROM trade_messages WHERE to_user_id = ? AND read = 0'\r\n        ).bind(user.user_id).first();\r\n\r\n        return successResponse({ unread_count: result.count });\r\n    }\r\n\r\n    // GET /api/trades/messages/conversations - Get list of conversations\r\n    if (path === 'conversations') {\r\n        // Get unique conversations with last message\r\n        const { results } = await env.DBA.prepare(`\r\n            SELECT\r\n                CASE\r\n                    WHEN from_user_id = ? THEN to_user_id\r\n                    ELSE from_user_id\r\n                END as other_user_id,\r\n                listing_id,\r\n                offer_id,\r\n                MAX(created_at) as last_message_at,\r\n                COUNT(CASE WHEN to_user_id = ? AND read = 0 THEN 1 END) as unread_count\r\n            FROM trade_messages\r\n            WHERE from_user_id = ? OR to_user_id = ?\r\n            GROUP BY other_user_id, listing_id, offer_id\r\n            ORDER BY last_message_at DESC\r\n        `).bind(user.user_id, user.user_id, user.user_id, user.user_id).all();\r\n\r\n        // Get details for each conversation\r\n        const conversations = await Promise.all(results.map(async (conv) => {\r\n            const otherUser = await getUserWithStats(env, conv.other_user_id);\r\n\r\n            let listingTitle = null;\r\n            if (conv.listing_id) {\r\n                const listing = await env.DBA.prepare(\r\n                    'SELECT title FROM trade_listings WHERE id = ?'\r\n                ).bind(conv.listing_id).first();\r\n                listingTitle = listing?.title;\r\n            }\r\n\r\n            return {\r\n                other_user: {\r\n                    user_id: otherUser.user_id,\r\n                    username: otherUser.username,\r\n                    display_name: otherUser.display_name,\r\n                    avatar_url: otherUser.avatar_url,\r\n                    average_rating: otherUser.average_rating || 0\r\n                },\r\n                listing_id: conv.listing_id,\r\n                listing_title: listingTitle,\r\n                offer_id: conv.offer_id,\r\n                last_message_at: conv.last_message_at,\r\n                unread_count: conv.unread_count\r\n            };\r\n        }));\r\n\r\n        return successResponse({ conversations });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle POST requests\r\nasync function handlePost(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    // POST /api/trades/messages - Send a message\r\n    if (!path || path === '') {\r\n        const data = await request.json();\r\n\r\n        const error = validateFields(data, ['to_user_id', 'message']);\r\n        if (error) {\r\n            return errorResponse(error);\r\n        }\r\n\r\n        const { to_user_id, message, listing_id, offer_id } = data;\r\n\r\n        // Can't send message to self\r\n        if (to_user_id === user.user_id) {\r\n            return errorResponse('Cannot send message to yourself', 400);\r\n        }\r\n\r\n        // Verify recipient exists\r\n        const recipient = await env.DBA.prepare(\r\n            'SELECT user_id FROM users WHERE user_id = ?'\r\n        ).bind(to_user_id).first();\r\n\r\n        if (!recipient) {\r\n            return errorResponse('Recipient not found', 404);\r\n        }\r\n\r\n        // If listing_id is provided, verify the users are involved in the listing\r\n        if (listing_id) {\r\n            const listing = await env.DBA.prepare(\r\n                'SELECT user_id FROM trade_listings WHERE id = ?'\r\n            ).bind(listing_id).first();\r\n\r\n            if (!listing) {\r\n                return errorResponse('Listing not found', 404);\r\n            }\r\n\r\n            // Check if user is listing owner or has made an offer\r\n            const isListingOwner = listing.user_id === user.user_id;\r\n            const hasOffer = await env.DBA.prepare(\r\n                'SELECT id FROM trade_offers WHERE listing_id = ? AND (from_user_id = ? OR to_user_id = ?)'\r\n            ).bind(listing_id, user.user_id, user.user_id).first();\r\n\r\n            if (!isListingOwner && !hasOffer) {\r\n                return errorResponse('You are not involved in this listing', 403);\r\n            }\r\n        }\r\n\r\n        const now = Date.now();\r\n\r\n        const result = await env.DBA.prepare(\r\n            `INSERT INTO trade_messages\r\n            (listing_id, offer_id, from_user_id, to_user_id, message, created_at)\r\n            VALUES (?, ?, ?, ?, ?, ?)`\r\n        ).bind(\r\n            listing_id || null,\r\n            offer_id || null,\r\n            user.user_id,\r\n            to_user_id,\r\n            message,\r\n            now\r\n        ).run();\r\n\r\n        // Create notification for recipient\r\n        await createNotification(\r\n            env,\r\n            to_user_id,\r\n            'new_message',\r\n            'New Message',\r\n            `${user.username} sent you a message`,\r\n            listing_id ? `/trading/${listing_id}` : '/messages'\r\n        );\r\n\r\n        return successResponse({\r\n            id: result.meta.last_row_id,\r\n            message: 'Message sent successfully'\r\n        }, 201);\r\n    }\r\n\r\n    // POST /api/trades/messages/:id/read - Mark message as read\r\n    const parts = path.split('/');\r\n    const messageId = parts[0];\r\n    const action = parts[1];\r\n\r\n    if (messageId && action === 'read') {\r\n        const message = await env.DBA.prepare(\r\n            'SELECT * FROM trade_messages WHERE id = ?'\r\n        ).bind(messageId).first();\r\n\r\n        if (!message) {\r\n            return errorResponse('Message not found', 404);\r\n        }\r\n\r\n        // Must be the recipient\r\n        if (message.to_user_id !== user.user_id) {\r\n            return errorResponse('You can only mark your own messages as read', 403);\r\n        }\r\n\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_messages SET read = 1 WHERE id = ?'\r\n        ).bind(messageId).run();\r\n\r\n        return successResponse({ message: 'Message marked as read' });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Main handler\r\nexport async function onRequest(context) {\r\n    const { request, env } = context;\r\n    const url = new URL(request.url);\r\n    const pathParts = url.pathname.split('/api/trades/messages/').filter(Boolean);\r\n    const path = pathParts[0] || '';\r\n\r\n    // CORS headers\r\n    const corsHeaders = {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n    };\r\n\r\n    // Handle OPTIONS request\r\n    if (request.method === 'OPTIONS') {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        const user = await authenticateUser(request, env);\r\n\r\n        let response;\r\n        switch (request.method) {\r\n            case 'GET':\r\n                response = await handleGet(request, env, path, user);\r\n                break;\r\n            case 'POST':\r\n                response = await handlePost(request, env, path, user);\r\n                break;\r\n            default:\r\n                response = errorResponse('Method not allowed', 405);\r\n        }\r\n\r\n        // Add CORS headers to response\r\n        const headers = new Headers(response.headers);\r\n        Object.entries(corsHeaders).forEach(([key, value]) => {\r\n            headers.set(key, value);\r\n        });\r\n\r\n        return new Response(response.body, {\r\n            status: response.status,\r\n            headers\r\n        });\r\n    } catch (error) {\r\n        console.error('Trade messages error:', error);\r\n        return new Response(JSON.stringify({ error: 'Internal server error' }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n", "import {\r\n    authenticateUser,\r\n    isAuthorized,\r\n    errorResponse,\r\n    successResponse\r\n} from '../_utils/helpers.js';\r\n\r\n// Handle GET requests\r\nasync function handleGet(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const url = new URL(request.url);\r\n\r\n    // GET /api/trades/notifications - Get user's notifications\r\n    if (!path || path === '') {\r\n        const unreadOnly = url.searchParams.get('unread_only') === 'true';\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n        const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n        let query = 'SELECT * FROM trade_notifications WHERE user_id = ?';\r\n        const bindings = [user.user_id];\r\n\r\n        if (unreadOnly) {\r\n            query += ' AND read = 0';\r\n        }\r\n\r\n        query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\r\n        bindings.push(limit, offset);\r\n\r\n        const { results: notifications } = await env.DBA.prepare(query).bind(...bindings).all();\r\n\r\n        return successResponse({ notifications, limit, offset });\r\n    }\r\n\r\n    // GET /api/trades/notifications/unread-count - Get unread count\r\n    if (path === 'unread-count') {\r\n        const result = await env.DBA.prepare(\r\n            'SELECT COUNT(*) as count FROM trade_notifications WHERE user_id = ? AND read = 0'\r\n        ).bind(user.user_id).first();\r\n\r\n        return successResponse({ unread_count: result.count });\r\n    }\r\n\r\n    // GET /api/trades/notifications/:id - Get specific notification\r\n    const notificationId = path.split('/')[0];\r\n    if (notificationId) {\r\n        const notification = await env.DBA.prepare(\r\n            'SELECT * FROM trade_notifications WHERE id = ?'\r\n        ).bind(notificationId).first();\r\n\r\n        if (!notification) {\r\n            return errorResponse('Notification not found', 404);\r\n        }\r\n\r\n        // Can only view own notifications\r\n        if (notification.user_id !== user.user_id) {\r\n            return errorResponse('Unauthorized to view this notification', 403);\r\n        }\r\n\r\n        return successResponse({ notification });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle POST requests\r\nasync function handlePost(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    // POST /api/trades/notifications/:id/read - Mark notification as read\r\n    const parts = path.split('/');\r\n    const notificationId = parts[0];\r\n    const action = parts[1];\r\n\r\n    if (notificationId && action === 'read') {\r\n        const notification = await env.DBA.prepare(\r\n            'SELECT * FROM trade_notifications WHERE id = ?'\r\n        ).bind(notificationId).first();\r\n\r\n        if (!notification) {\r\n            return errorResponse('Notification not found', 404);\r\n        }\r\n\r\n        // Can only mark own notifications as read\r\n        if (notification.user_id !== user.user_id) {\r\n            return errorResponse('Unauthorized', 403);\r\n        }\r\n\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_notifications SET read = 1 WHERE id = ?'\r\n        ).bind(notificationId).run();\r\n\r\n        return successResponse({ message: 'Notification marked as read' });\r\n    }\r\n\r\n    // POST /api/trades/notifications/read-all - Mark all as read\r\n    if (path === 'read-all') {\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_notifications SET read = 1 WHERE user_id = ? AND read = 0'\r\n        ).bind(user.user_id).run();\r\n\r\n        return successResponse({ message: 'All notifications marked as read' });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle DELETE requests\r\nasync function handleDelete(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    // DELETE /api/trades/notifications/:id - Delete notification\r\n    const notificationId = path.split('/')[0];\r\n    if (!notificationId) {\r\n        return errorResponse('Notification ID required', 400);\r\n    }\r\n\r\n    const notification = await env.DBA.prepare(\r\n        'SELECT * FROM trade_notifications WHERE id = ?'\r\n    ).bind(notificationId).first();\r\n\r\n    if (!notification) {\r\n        return errorResponse('Notification not found', 404);\r\n    }\r\n\r\n    // Can only delete own notifications\r\n    if (notification.user_id !== user.user_id) {\r\n        return errorResponse('Unauthorized', 403);\r\n    }\r\n\r\n    await env.DBA.prepare(\r\n        'DELETE FROM trade_notifications WHERE id = ?'\r\n    ).bind(notificationId).run();\r\n\r\n    return successResponse({ message: 'Notification deleted' });\r\n}\r\n\r\n// Main handler\r\nexport async function onRequest(context) {\r\n    const { request, env } = context;\r\n    const url = new URL(request.url);\r\n    const pathParts = url.pathname.split('/api/trades/notifications/').filter(Boolean);\r\n    const path = pathParts[0] || '';\r\n\r\n    // CORS headers\r\n    const corsHeaders = {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n    };\r\n\r\n    // Handle OPTIONS request\r\n    if (request.method === 'OPTIONS') {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        const user = await authenticateUser(request, env);\r\n\r\n        let response;\r\n        switch (request.method) {\r\n            case 'GET':\r\n                response = await handleGet(request, env, path, user);\r\n                break;\r\n            case 'POST':\r\n                response = await handlePost(request, env, path, user);\r\n                break;\r\n            case 'DELETE':\r\n                response = await handleDelete(request, env, path, user);\r\n                break;\r\n            default:\r\n                response = errorResponse('Method not allowed', 405);\r\n        }\r\n\r\n        // Add CORS headers to response\r\n        const headers = new Headers(response.headers);\r\n        Object.entries(corsHeaders).forEach(([key, value]) => {\r\n            headers.set(key, value);\r\n        });\r\n\r\n        return new Response(response.body, {\r\n            status: response.status,\r\n            headers\r\n        });\r\n    } catch (error) {\r\n        console.error('Trade notifications error:', error);\r\n        return new Response(JSON.stringify({ error: 'Internal server error' }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n", "import {\r\n    authenticateUser,\r\n    isAuthorized,\r\n    errorResponse,\r\n    successResponse,\r\n    validateFields,\r\n    createNotification,\r\n    updateUserStats,\r\n    getUserWithStats\r\n} from '../_utils/helpers.js';\r\n\r\n// Handle GET requests\r\nasync function handleGet(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const url = new URL(request.url);\r\n\r\n    // GET /api/trades/offers - List user's offers (sent and received)\r\n    if (!path || path === '') {\r\n        const type = url.searchParams.get('type') || 'all'; // all, sent, received\r\n        const status = url.searchParams.get('status'); // pending, accepted, rejected, cancelled, completed\r\n\r\n        let query = 'SELECT o.*, l.title as listing_title FROM trade_offers o JOIN trade_listings l ON o.listing_id = l.id WHERE 1=1';\r\n        const bindings = [];\r\n\r\n        if (type === 'sent') {\r\n            query += ' AND o.from_user_id = ?';\r\n            bindings.push(user.user_id);\r\n        } else if (type === 'received') {\r\n            query += ' AND o.to_user_id = ?';\r\n            bindings.push(user.user_id);\r\n        } else {\r\n            query += ' AND (o.from_user_id = ? OR o.to_user_id = ?)';\r\n            bindings.push(user.user_id, user.user_id);\r\n        }\r\n\r\n        if (status) {\r\n            query += ' AND o.status = ?';\r\n            bindings.push(status);\r\n        }\r\n\r\n        query += ' ORDER BY o.created_at DESC';\r\n\r\n        const { results } = await env.DBA.prepare(query).bind(...bindings).all();\r\n\r\n        // Get user info for each offer\r\n        const offers = await Promise.all(results.map(async (offer) => {\r\n            const fromUser = await getUserWithStats(env, offer.from_user_id);\r\n            const toUser = await getUserWithStats(env, offer.to_user_id);\r\n\r\n            return {\r\n                ...offer,\r\n                offered_items: JSON.parse(offer.offered_items),\r\n                from_user: {\r\n                    user_id: fromUser.user_id,\r\n                    username: fromUser.username,\r\n                    display_name: fromUser.display_name,\r\n                    avatar_url: fromUser.avatar_url,\r\n                    average_rating: fromUser.average_rating || 0\r\n                },\r\n                to_user: {\r\n                    user_id: toUser.user_id,\r\n                    username: toUser.username,\r\n                    display_name: toUser.display_name,\r\n                    avatar_url: toUser.avatar_url,\r\n                    average_rating: toUser.average_rating || 0\r\n                }\r\n            };\r\n        }));\r\n\r\n        return successResponse({ offers });\r\n    }\r\n\r\n    // GET /api/trades/offers/:id - Get specific offer\r\n    const offerId = path.split('/')[0];\r\n    if (offerId) {\r\n        const offer = await env.DBA.prepare(\r\n            'SELECT o.*, l.title as listing_title, l.offering_items as listing_items FROM trade_offers o JOIN trade_listings l ON o.listing_id = l.id WHERE o.id = ?'\r\n        ).bind(offerId).first();\r\n\r\n        if (!offer) {\r\n            return errorResponse('Offer not found', 404);\r\n        }\r\n\r\n        // Check authorization - must be sender or receiver\r\n        if (offer.from_user_id !== user.user_id && offer.to_user_id !== user.user_id) {\r\n            return errorResponse('Unauthorized to view this offer', 403);\r\n        }\r\n\r\n        const fromUser = await getUserWithStats(env, offer.from_user_id);\r\n        const toUser = await getUserWithStats(env, offer.to_user_id);\r\n\r\n        return successResponse({\r\n            ...offer,\r\n            offered_items: JSON.parse(offer.offered_items),\r\n            listing_items: JSON.parse(offer.listing_items),\r\n            from_user: {\r\n                user_id: fromUser.user_id,\r\n                username: fromUser.username,\r\n                display_name: fromUser.display_name,\r\n                avatar_url: fromUser.avatar_url,\r\n                average_rating: fromUser.average_rating || 0,\r\n                total_trades: fromUser.total_trades || 0\r\n            },\r\n            to_user: {\r\n                user_id: toUser.user_id,\r\n                username: toUser.username,\r\n                display_name: toUser.display_name,\r\n                avatar_url: toUser.avatar_url,\r\n                average_rating: toUser.average_rating || 0,\r\n                total_trades: toUser.total_trades || 0\r\n            }\r\n        });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle POST requests\r\nasync function handlePost(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    // POST /api/trades/offers - Create new offer\r\n    if (!path || path === '') {\r\n        const data = await request.json();\r\n\r\n        const error = validateFields(data, ['listing_id', 'offered_items']);\r\n        if (error) {\r\n            return errorResponse(error);\r\n        }\r\n\r\n        const { listing_id, offered_items, message } = data;\r\n\r\n        // Get listing\r\n        const listing = await env.DBA.prepare(\r\n            'SELECT * FROM trade_listings WHERE id = ? AND status = ?'\r\n        ).bind(listing_id, 'active').first();\r\n\r\n        if (!listing) {\r\n            return errorResponse('Listing not found or not active', 404);\r\n        }\r\n\r\n        // Can't make offer on own listing\r\n        if (listing.user_id === user.user_id) {\r\n            return errorResponse('Cannot make offer on your own listing', 400);\r\n        }\r\n\r\n        // Validate offered_items is an array\r\n        if (!Array.isArray(offered_items) || offered_items.length === 0) {\r\n            return errorResponse('offered_items must be a non-empty array');\r\n        }\r\n\r\n        const now = Date.now();\r\n\r\n        const result = await env.DBA.prepare(\r\n            `INSERT INTO trade_offers\r\n            (listing_id, from_user_id, to_user_id, offered_items, message, status, created_at, updated_at)\r\n            VALUES (?, ?, ?, ?, ?, 'pending', ?, ?)`\r\n        ).bind(\r\n            listing_id,\r\n            user.user_id,\r\n            listing.user_id,\r\n            JSON.stringify(offered_items),\r\n            message || null,\r\n            now,\r\n            now\r\n        ).run();\r\n\r\n        // Create notification for listing owner\r\n        await createNotification(\r\n            env,\r\n            listing.user_id,\r\n            'new_offer',\r\n            'New Trade Offer',\r\n            `${user.username} made an offer on your listing: ${listing.title}`,\r\n            `/trading/${listing_id}`\r\n        );\r\n\r\n        return successResponse({\r\n            id: result.meta.last_row_id,\r\n            message: 'Offer created successfully'\r\n        }, 201);\r\n    }\r\n\r\n    // POST /api/trades/offers/:id/accept - Accept an offer\r\n    const parts = path.split('/');\r\n    const offerId = parts[0];\r\n    const action = parts[1];\r\n\r\n    if (offerId && action === 'accept') {\r\n        const offer = await env.DBA.prepare(\r\n            'SELECT o.*, l.offering_items as listing_items FROM trade_offers o JOIN trade_listings l ON o.listing_id = l.id WHERE o.id = ?'\r\n        ).bind(offerId).first();\r\n\r\n        if (!offer) {\r\n            return errorResponse('Offer not found', 404);\r\n        }\r\n\r\n        // Must be the listing owner\r\n        if (offer.to_user_id !== user.user_id) {\r\n            return errorResponse('Only the listing owner can accept offers', 403);\r\n        }\r\n\r\n        // Offer must be pending\r\n        if (offer.status !== 'pending') {\r\n            return errorResponse('Offer is not pending', 400);\r\n        }\r\n\r\n        const now = Date.now();\r\n\r\n        // Update offer status\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_offers SET status = ?, updated_at = ? WHERE id = ?'\r\n        ).bind('accepted', now, offerId).run();\r\n\r\n        // Update listing status\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_listings SET status = ?, updated_at = ? WHERE id = ?'\r\n        ).bind('completed', now, offer.listing_id).run();\r\n\r\n        // Create completed trade record\r\n        const tradeResult = await env.DBA.prepare(\r\n            `INSERT INTO completed_trades\r\n            (listing_id, offer_id, seller_id, buyer_id, seller_items, buyer_items, completed_at)\r\n            VALUES (?, ?, ?, ?, ?, ?, ?)`\r\n        ).bind(\r\n            offer.listing_id,\r\n            offerId,\r\n            offer.to_user_id,\r\n            offer.from_user_id,\r\n            offer.listing_items,\r\n            offer.offered_items,\r\n            now\r\n        ).run();\r\n\r\n        // Update stats for both users\r\n        await updateUserStats(env, offer.to_user_id);\r\n        await updateUserStats(env, offer.from_user_id);\r\n\r\n        // Create notification for offer sender\r\n        await createNotification(\r\n            env,\r\n            offer.from_user_id,\r\n            'offer_accepted',\r\n            'Offer Accepted!',\r\n            'Your trade offer was accepted!',\r\n            `/trades/completed/${tradeResult.meta.last_row_id}`\r\n        );\r\n\r\n        // Reject all other pending offers on this listing\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_offers SET status = ?, updated_at = ? WHERE listing_id = ? AND id != ? AND status = ?'\r\n        ).bind('rejected', now, offer.listing_id, offerId, 'pending').run();\r\n\r\n        return successResponse({\r\n            trade_id: tradeResult.meta.last_row_id,\r\n            message: 'Offer accepted successfully'\r\n        });\r\n    }\r\n\r\n    // POST /api/trades/offers/:id/reject - Reject an offer\r\n    if (offerId && action === 'reject') {\r\n        const offer = await env.DBA.prepare(\r\n            'SELECT * FROM trade_offers WHERE id = ?'\r\n        ).bind(offerId).first();\r\n\r\n        if (!offer) {\r\n            return errorResponse('Offer not found', 404);\r\n        }\r\n\r\n        // Must be the listing owner\r\n        if (offer.to_user_id !== user.user_id) {\r\n            return errorResponse('Only the listing owner can reject offers', 403);\r\n        }\r\n\r\n        // Update offer status\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_offers SET status = ?, updated_at = ? WHERE id = ?'\r\n        ).bind('rejected', Date.now(), offerId).run();\r\n\r\n        // Create notification\r\n        await createNotification(\r\n            env,\r\n            offer.from_user_id,\r\n            'offer_rejected',\r\n            'Offer Rejected',\r\n            'Your trade offer was rejected',\r\n            `/trading/${offer.listing_id}`\r\n        );\r\n\r\n        return successResponse({ message: 'Offer rejected successfully' });\r\n    }\r\n\r\n    // POST /api/trades/offers/:id/cancel - Cancel own offer\r\n    if (offerId && action === 'cancel') {\r\n        const offer = await env.DBA.prepare(\r\n            'SELECT * FROM trade_offers WHERE id = ?'\r\n        ).bind(offerId).first();\r\n\r\n        if (!offer) {\r\n            return errorResponse('Offer not found', 404);\r\n        }\r\n\r\n        // Must be the offer sender\r\n        if (offer.from_user_id !== user.user_id) {\r\n            return errorResponse('You can only cancel your own offers', 403);\r\n        }\r\n\r\n        // Can only cancel pending offers\r\n        if (offer.status !== 'pending') {\r\n            return errorResponse('Can only cancel pending offers', 400);\r\n        }\r\n\r\n        // Update offer status\r\n        await env.DBA.prepare(\r\n            'UPDATE trade_offers SET status = ?, updated_at = ? WHERE id = ?'\r\n        ).bind('cancelled', Date.now(), offerId).run();\r\n\r\n        return successResponse({ message: 'Offer cancelled successfully' });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Main handler\r\nexport async function onRequest(context) {\r\n    const { request, env } = context;\r\n    const url = new URL(request.url);\r\n    const pathParts = url.pathname.split('/api/trades/offers/').filter(Boolean);\r\n    const path = pathParts[0] || '';\r\n\r\n    // CORS headers\r\n    const corsHeaders = {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n    };\r\n\r\n    // Handle OPTIONS request\r\n    if (request.method === 'OPTIONS') {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        const user = await authenticateUser(request, env);\r\n\r\n        let response;\r\n        switch (request.method) {\r\n            case 'GET':\r\n                response = await handleGet(request, env, path, user);\r\n                break;\r\n            case 'POST':\r\n                response = await handlePost(request, env, path, user);\r\n                break;\r\n            default:\r\n                response = errorResponse('Method not allowed', 405);\r\n        }\r\n\r\n        // Add CORS headers to response\r\n        const headers = new Headers(response.headers);\r\n        Object.entries(corsHeaders).forEach(([key, value]) => {\r\n            headers.set(key, value);\r\n        });\r\n\r\n        return new Response(response.body, {\r\n            status: response.status,\r\n            headers\r\n        });\r\n    } catch (error) {\r\n        console.error('Trade offers error:', error);\r\n        return new Response(JSON.stringify({ error: 'Internal server error' }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n", "import {\r\n    authenticateUser,\r\n    isAuthorized,\r\n    errorResponse,\r\n    successResponse,\r\n    validateFields,\r\n    createNotification,\r\n    updateUserStats,\r\n    getUserWithStats\r\n} from '../_utils/helpers.js';\r\n\r\n// Handle GET requests\r\nasync function handleGet(request, env, path) {\r\n    const url = new URL(request.url);\r\n\r\n    // GET /api/trades/reviews - Get reviews for a user\r\n    if (!path || path === '') {\r\n        const userId = url.searchParams.get('user_id');\r\n\r\n        if (!userId) {\r\n            return errorResponse('user_id parameter required');\r\n        }\r\n\r\n        const { results: reviews } = await env.DBA.prepare(`\r\n            SELECT\r\n                r.*,\r\n                u.username as reviewer_username,\r\n                u.display_name as reviewer_display_name,\r\n                u.avatar_url as reviewer_avatar\r\n            FROM trade_reviews r\r\n            JOIN users u ON r.reviewer_id = u.user_id\r\n            WHERE r.reviewed_user_id = ?\r\n            ORDER BY r.created_at DESC\r\n        `).bind(userId).all();\r\n\r\n        // Get user stats\r\n        const stats = await env.DBA.prepare(\r\n            'SELECT * FROM user_trade_stats WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        return successResponse({\r\n            reviews,\r\n            stats: stats || {\r\n                total_trades: 0,\r\n                successful_trades: 0,\r\n                average_rating: 0,\r\n                total_reviews: 0\r\n            }\r\n        });\r\n    }\r\n\r\n    // GET /api/trades/reviews/:id - Get specific review\r\n    const reviewId = path.split('/')[0];\r\n    if (reviewId) {\r\n        const review = await env.DBA.prepare(`\r\n            SELECT\r\n                r.*,\r\n                u1.username as reviewer_username,\r\n                u1.display_name as reviewer_display_name,\r\n                u1.avatar_url as reviewer_avatar,\r\n                u2.username as reviewed_username,\r\n                u2.display_name as reviewed_display_name,\r\n                u2.avatar_url as reviewed_avatar\r\n            FROM trade_reviews r\r\n            JOIN users u1 ON r.reviewer_id = u1.user_id\r\n            JOIN users u2 ON r.reviewed_user_id = u2.user_id\r\n            WHERE r.id = ?\r\n        `).bind(reviewId).first();\r\n\r\n        if (!review) {\r\n            return errorResponse('Review not found', 404);\r\n        }\r\n\r\n        return successResponse({ review });\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle POST requests\r\nasync function handlePost(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    // POST /api/trades/reviews - Create a review\r\n    if (!path || path === '') {\r\n        const data = await request.json();\r\n\r\n        const error = validateFields(data, ['trade_id', 'rating']);\r\n        if (error) {\r\n            return errorResponse(error);\r\n        }\r\n\r\n        const { trade_id, rating, comment } = data;\r\n\r\n        // Validate rating\r\n        if (rating < 1 || rating > 5) {\r\n            return errorResponse('Rating must be between 1 and 5');\r\n        }\r\n\r\n        // Get the completed trade\r\n        const trade = await env.DBA.prepare(\r\n            'SELECT * FROM completed_trades WHERE id = ?'\r\n        ).bind(trade_id).first();\r\n\r\n        if (!trade) {\r\n            return errorResponse('Trade not found', 404);\r\n        }\r\n\r\n        // Verify user was part of the trade\r\n        if (trade.seller_id !== user.user_id && trade.buyer_id !== user.user_id) {\r\n            return errorResponse('You were not part of this trade', 403);\r\n        }\r\n\r\n        // Determine who is being reviewed\r\n        const reviewedUserId = trade.seller_id === user.user_id ? trade.buyer_id : trade.seller_id;\r\n\r\n        // Check if user already reviewed this trade\r\n        const existingReview = await env.DBA.prepare(\r\n            'SELECT id FROM trade_reviews WHERE trade_id = ? AND reviewer_id = ?'\r\n        ).bind(trade_id, user.user_id).first();\r\n\r\n        if (existingReview) {\r\n            return errorResponse('You have already reviewed this trade', 400);\r\n        }\r\n\r\n        const now = Date.now();\r\n\r\n        const result = await env.DBA.prepare(\r\n            `INSERT INTO trade_reviews\r\n            (trade_id, reviewer_id, reviewed_user_id, rating, comment, created_at)\r\n            VALUES (?, ?, ?, ?, ?, ?)`\r\n        ).bind(\r\n            trade_id,\r\n            user.user_id,\r\n            reviewedUserId,\r\n            rating,\r\n            comment || null,\r\n            now\r\n        ).run();\r\n\r\n        // Update user stats\r\n        await updateUserStats(env, reviewedUserId);\r\n\r\n        // Create notification\r\n        const ratingText = rating === 5 ? 'excellent' :\r\n                          rating === 4 ? 'good' :\r\n                          rating === 3 ? 'okay' :\r\n                          rating === 2 ? 'poor' : 'bad';\r\n\r\n        await createNotification(\r\n            env,\r\n            reviewedUserId,\r\n            'review_received',\r\n            'New Review',\r\n            `${user.username} gave you a ${ratingText} review (${rating}/5 stars)`,\r\n            `/profile/${reviewedUserId}`\r\n        );\r\n\r\n        return successResponse({\r\n            id: result.meta.last_row_id,\r\n            message: 'Review submitted successfully'\r\n        }, 201);\r\n    }\r\n\r\n    return errorResponse('Invalid request', 400);\r\n}\r\n\r\n// Handle PUT/PATCH requests\r\nasync function handlePut(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const reviewId = path.split('/')[0];\r\n    if (!reviewId) {\r\n        return errorResponse('Review ID required', 400);\r\n    }\r\n\r\n    const review = await env.DBA.prepare(\r\n        'SELECT * FROM trade_reviews WHERE id = ?'\r\n    ).bind(reviewId).first();\r\n\r\n    if (!review) {\r\n        return errorResponse('Review not found', 404);\r\n    }\r\n\r\n    // Can only edit own reviews\r\n    if (review.reviewer_id !== user.user_id) {\r\n        return errorResponse('You can only edit your own reviews', 403);\r\n    }\r\n\r\n    const data = await request.json();\r\n    const { rating, comment } = data;\r\n\r\n    // Build update query\r\n    const updates = [];\r\n    const bindings = [];\r\n\r\n    if (rating !== undefined) {\r\n        if (rating < 1 || rating > 5) {\r\n            return errorResponse('Rating must be between 1 and 5');\r\n        }\r\n        updates.push('rating = ?');\r\n        bindings.push(rating);\r\n    }\r\n\r\n    if (comment !== undefined) {\r\n        updates.push('comment = ?');\r\n        bindings.push(comment);\r\n    }\r\n\r\n    if (updates.length === 0) {\r\n        return errorResponse('No fields to update');\r\n    }\r\n\r\n    bindings.push(reviewId);\r\n\r\n    await env.DBA.prepare(\r\n        `UPDATE trade_reviews SET ${updates.join(', ')} WHERE id = ?`\r\n    ).bind(...bindings).run();\r\n\r\n    // Update user stats\r\n    await updateUserStats(env, review.reviewed_user_id);\r\n\r\n    return successResponse({ message: 'Review updated successfully' });\r\n}\r\n\r\n// Handle DELETE requests\r\nasync function handleDelete(request, env, path, user) {\r\n    if (!user || !isAuthorized(user)) {\r\n        return errorResponse('Unauthorized', 401);\r\n    }\r\n\r\n    const reviewId = path.split('/')[0];\r\n    if (!reviewId) {\r\n        return errorResponse('Review ID required', 400);\r\n    }\r\n\r\n    const review = await env.DBA.prepare(\r\n        'SELECT * FROM trade_reviews WHERE id = ?'\r\n    ).bind(reviewId).first();\r\n\r\n    if (!review) {\r\n        return errorResponse('Review not found', 404);\r\n    }\r\n\r\n    // Can only delete own reviews (or admin/moderator)\r\n    const roles = typeof user.roles === 'string' ? JSON.parse(user.roles) : user.roles;\r\n    const isAdminOrMod = roles.includes('admin') || roles.includes('moderator');\r\n\r\n    if (review.reviewer_id !== user.user_id && !isAdminOrMod) {\r\n        return errorResponse('You can only delete your own reviews', 403);\r\n    }\r\n\r\n    const reviewedUserId = review.reviewed_user_id;\r\n\r\n    await env.DBA.prepare(\r\n        'DELETE FROM trade_reviews WHERE id = ?'\r\n    ).bind(reviewId).run();\r\n\r\n    // Update user stats\r\n    await updateUserStats(env, reviewedUserId);\r\n\r\n    return successResponse({ message: 'Review deleted successfully' });\r\n}\r\n\r\n// Main handler\r\nexport async function onRequest(context) {\r\n    const { request, env } = context;\r\n    const url = new URL(request.url);\r\n    const pathParts = url.pathname.split('/api/trades/reviews/').filter(Boolean);\r\n    const path = pathParts[0] || '';\r\n\r\n    // CORS headers\r\n    const corsHeaders = {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n    };\r\n\r\n    // Handle OPTIONS request\r\n    if (request.method === 'OPTIONS') {\r\n        return new Response(null, { headers: corsHeaders });\r\n    }\r\n\r\n    try {\r\n        let user = null;\r\n        if (request.method !== 'GET') {\r\n            user = await authenticateUser(request, env);\r\n        }\r\n\r\n        let response;\r\n        switch (request.method) {\r\n            case 'GET':\r\n                response = await handleGet(request, env, path);\r\n                break;\r\n            case 'POST':\r\n                response = await handlePost(request, env, path, user);\r\n                break;\r\n            case 'PUT':\r\n            case 'PATCH':\r\n                response = await handlePut(request, env, path, user);\r\n                break;\r\n            case 'DELETE':\r\n                response = await handleDelete(request, env, path, user);\r\n                break;\r\n            default:\r\n                response = errorResponse('Method not allowed', 405);\r\n        }\r\n\r\n        // Add CORS headers to response\r\n        const headers = new Headers(response.headers);\r\n        Object.entries(corsHeaders).forEach(([key, value]) => {\r\n            headers.set(key, value);\r\n        });\r\n\r\n        return new Response(response.body, {\r\n            status: response.status,\r\n            headers\r\n        });\r\n    } catch (error) {\r\n        console.error('Trade reviews error:', error);\r\n        return new Response(JSON.stringify({ error: 'Internal server error' }), {\r\n            status: 500,\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n", "/**\n * Cloudflare Images upload endpoint\n *\n * Uploads images to Cloudflare Images and returns the optimized URL\n *\n * POST /api/images/upload\n * Body: FormData with 'file' field\n * Requires: Bearer token with admin/moderator role\n *\n * Returns: { url: string, id: string, variants: string[] }\n */\n\nexport async function onRequestPost({ request, env }) {\n  try {\n    // Verify admin/moderator session from Bearer token\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n      return new Response(JSON.stringify({ error: 'Unauthorized - No token provided' }), {\n        status: 401,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Verify session against database\n    const session = await env.DBA.prepare(`\n      SELECT s.*, u.role FROM sessions s\n      JOIN users u ON s.user_id = u.user_id\n      WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    if (!session) {\n      return new Response(JSON.stringify({ error: 'Unauthorized - Invalid session' }), {\n        status: 401,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Check if user has admin or moderator role\n    let userRoles;\n    try {\n      userRoles = session.role ? JSON.parse(session.role) : ['user'];\n    } catch (e) {\n      userRoles = ['user'];\n    }\n\n    if (!userRoles.includes('admin') && !userRoles.includes('moderator')) {\n      return new Response(JSON.stringify({ error: 'Insufficient permissions' }), {\n        status: 403,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const formData = await request.formData();\n    const file = formData.get('file');\n\n    if (!file) {\n      return new Response(JSON.stringify({ error: 'No file provided' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Check file type\n    if (!file.type.startsWith('image/')) {\n      return new Response(JSON.stringify({ error: 'File must be an image' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Check file size (Cloudflare Images limit is 10MB)\n    if (file.size > 10 * 1024 * 1024) {\n      return new Response(JSON.stringify({ error: 'File size must be less than 10MB' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Get Cloudflare Images credentials from environment\n    const accountId = env.CF_ACCOUNT_ID || 'd9fecb3357660ea0fcfee5b23d5dd2f6';\n    const accountHash = env.CF_ACCOUNT_HASH || 'I2Jsf9fuZwSztWJZaX0DJA';\n    const apiToken = env.CF_IMAGES_API_TOKEN;\n\n    if (!accountId || !apiToken) {\n      return new Response(JSON.stringify({\n        error: 'Cloudflare Images not configured. Please set CF_ACCOUNT_ID and CF_IMAGES_API_TOKEN environment variables.'\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Prepare form data for Cloudflare Images API\n    const cfFormData = new FormData();\n    cfFormData.append('file', file);\n\n    // Upload to Cloudflare Images\n    const response = await fetch(\n      `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${apiToken}`\n        },\n        body: cfFormData\n      }\n    );\n\n    if (!response.ok) {\n      const errorData = await response.text();\n      console.error('Cloudflare Images API error:', errorData);\n      return new Response(JSON.stringify({\n        error: 'Failed to upload image to Cloudflare Images',\n        details: errorData\n      }), {\n        status: response.status,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const data = await response.json();\n\n    if (!data.success) {\n      return new Response(JSON.stringify({\n        error: 'Upload failed',\n        details: data.errors\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Return the image URL (use account hash to construct URL)\n    const imageId = data.result.id;\n    const variants = data.result.variants || [];\n    const publicVariant = variants.find(v => v.includes('/public')) || variants[0] || '';\n\n    // Construct URL using account hash\n    const imageUrl = publicVariant || `https://imagedelivery.net/${accountHash}/${imageId}/public`;\n\n    return new Response(JSON.stringify({\n      success: true,\n      id: imageId,\n      url: imageUrl,\n      variants: variants\n    }), {\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n      }\n    });\n\n  } catch (error) {\n    console.error('Image upload error:', error);\n    return new Response(JSON.stringify({\n      error: 'Upload failed: ' + error.message\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n}\n\n// Handle CORS preflight\nexport async function onRequestOptions() {\n  return new Response(null, {\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n    }\n  });\n}\n", "/**\r\n * Avatar & Profile Refresh API\r\n * \r\n * Refreshes stale user avatars and display names from Roblox.\r\n * Should be called periodically by a scheduled worker or external cron.\r\n * \r\n * - Processes users whose data is older than 24 hours\r\n * - Batches updates to avoid rate limiting (max 20 users per call)\r\n * - Staggers which users get updated to spread load throughout the day\r\n */\r\n\r\nexport async function onRequest(context) {\r\n    const { request, env } = context;\r\n    const url = new URL(request.url);\r\n    \r\n    // Optional secret key for security (set CRON_SECRET in env vars)\r\n    const providedSecret = url.searchParams.get('secret') || request.headers.get('X-Cron-Secret');\r\n    if (env.CRON_SECRET && providedSecret !== env.CRON_SECRET) {\r\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n            status: 401,\r\n            headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n    \r\n    // Batch size - how many users to update per call\r\n    const batchSize = parseInt(url.searchParams.get('batch') || '20');\r\n    const maxBatch = Math.min(batchSize, 50); // Cap at 50 to avoid timeouts\r\n    \r\n    // Find users with stale data (older than 24 hours)\r\n    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);\r\n    \r\n    // Get users with oldest cached data first\r\n    // Also include users who have never had their avatar cached\r\n    const { results: staleUsers } = await env.DBA.prepare(`\r\n        SELECT user_id, username, display_name, avatar_url, avatar_cached_at\r\n        FROM users\r\n        WHERE avatar_cached_at IS NULL \r\n           OR avatar_cached_at < ?\r\n        ORDER BY avatar_cached_at ASC NULLS FIRST\r\n        LIMIT ?\r\n    `).bind(oneDayAgo, maxBatch).all();\r\n    \r\n    if (!staleUsers || staleUsers.length === 0) {\r\n        return new Response(JSON.stringify({ \r\n            success: true, \r\n            message: 'No stale users to refresh',\r\n            updated: 0 \r\n        }), {\r\n            headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n    \r\n    const results = {\r\n        updated: 0,\r\n        failed: 0,\r\n        skipped: 0,\r\n        details: []\r\n    };\r\n    \r\n    // Process users in parallel but with controlled concurrency\r\n    const userIds = staleUsers.map(u => u.user_id);\r\n    \r\n    // Fetch avatars in bulk from Roblox (they support up to 100 at once)\r\n    let avatarMap = {};\r\n    try {\r\n        const avatarResponse = await fetch(\r\n            `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userIds.join(',')}&size=150x150&format=Png`\r\n        );\r\n        if (avatarResponse.ok) {\r\n            const avatarData = await avatarResponse.json();\r\n            for (const item of avatarData.data || []) {\r\n                avatarMap[item.targetId] = item.imageUrl;\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error('Failed to fetch avatars in bulk:', e);\r\n    }\r\n    \r\n    // Fetch user info in bulk from Roblox\r\n    let userInfoMap = {};\r\n    try {\r\n        const userInfoResponse = await fetch('https://users.roblox.com/v1/users', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ userIds: userIds.map(id => parseInt(id)) })\r\n        });\r\n        if (userInfoResponse.ok) {\r\n            const userInfoData = await userInfoResponse.json();\r\n            for (const user of userInfoData.data || []) {\r\n                userInfoMap[user.id] = {\r\n                    username: user.name,\r\n                    displayName: user.displayName\r\n                };\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error('Failed to fetch user info in bulk:', e);\r\n    }\r\n    \r\n    // Update each user\r\n    const now = Date.now();\r\n    for (const user of staleUsers) {\r\n        const userId = user.user_id;\r\n        const newAvatar = avatarMap[userId];\r\n        const newInfo = userInfoMap[userId];\r\n        \r\n        // Skip if we couldn't get any new data\r\n        if (!newAvatar && !newInfo) {\r\n            results.skipped++;\r\n            results.details.push({ userId, status: 'skipped', reason: 'No data from Roblox' });\r\n            continue;\r\n        }\r\n        \r\n        try {\r\n            // Update with whatever new data we have\r\n            await env.DBA.prepare(`\r\n                UPDATE users SET\r\n                    avatar_url = COALESCE(?, avatar_url),\r\n                    avatar_cached_at = ?,\r\n                    username = COALESCE(?, username),\r\n                    display_name = COALESCE(?, display_name)\r\n                WHERE user_id = ?\r\n            `).bind(\r\n                newAvatar || null,\r\n                now,\r\n                newInfo?.username || null,\r\n                newInfo?.displayName || null,\r\n                userId\r\n            ).run();\r\n            \r\n            results.updated++;\r\n            results.details.push({ \r\n                userId, \r\n                status: 'updated',\r\n                oldUsername: user.username,\r\n                newUsername: newInfo?.username,\r\n                oldDisplayName: user.display_name,\r\n                newDisplayName: newInfo?.displayName,\r\n                avatarUpdated: !!newAvatar\r\n            });\r\n        } catch (e) {\r\n            results.failed++;\r\n            results.details.push({ userId, status: 'failed', error: e.message });\r\n        }\r\n    }\r\n    \r\n    // Count remaining stale users for reporting\r\n    const { count } = await env.DBA.prepare(`\r\n        SELECT COUNT(*) as count FROM users\r\n        WHERE avatar_cached_at IS NULL OR avatar_cached_at < ?\r\n    `).bind(oneDayAgo).first();\r\n    \r\n    return new Response(JSON.stringify({\r\n        success: true,\r\n        message: `Refreshed ${results.updated} users`,\r\n        ...results,\r\n        remainingStale: count\r\n    }), {\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n", "/**\r\n * ============================================================================\r\n * DONATIONS WEBHOOK - Handles webhook requests from Roblox game\r\n * ============================================================================\r\n * \r\n * Endpoint: POST /api/donations/webhook\r\n * \r\n * This endpoint receives transaction data from the Roblox game via webhook.\r\n * Also accessible via POST /api/donations?webhook=true\r\n * ============================================================================\r\n */\r\n\r\n/**\r\n * Replace aggregated totals for a user\r\n */\r\nasync function replaceUserTotals(kv, userId, totalSpent, purchases) {\r\n  const userIdStr = String(userId);\r\n  const purchaseKey = `purchase:${userIdStr}`;\r\n  \r\n  await kv.put(purchaseKey, JSON.stringify({\r\n    userId: parseInt(userIdStr),\r\n    totalSpent,\r\n    purchases\r\n  }));\r\n\r\n  return { totalSpent, purchases };\r\n}\r\n\r\n/**\r\n * Process webhook transactions (handles both game format and full Roblox API format)\r\n * Game format: {userId, productId, price}\r\n * API format: {transactionType: 'Sale', agent: {id}, currency: {amount}, ...}\r\n */\r\nasync function processGameWebhookTransactions(kv, transactions) {\r\n  const processed = [];\r\n  const seenTokens = new Set();\r\n\r\n  for (const tx of transactions) {\r\n    let userId, price;\r\n\r\n    // Check if it's the game format (simple: {userId, productId, price})\r\n    if (tx.userId !== undefined && tx.price !== undefined) {\r\n      userId = tx.userId;\r\n      price = tx.price;\r\n      \r\n      // Validate\r\n      if (!userId || price <= 0) continue;\r\n    }\r\n    // Check if it's the full Roblox API format\r\n    else if (tx.transactionType === 'Sale' && tx.currency?.type === 'Robux') {\r\n      // Skip if already processed (check by purchaseToken)\r\n      if (tx.purchaseToken && seenTokens.has(tx.purchaseToken)) {\r\n        continue;\r\n      }\r\n      if (tx.purchaseToken) {\r\n        seenTokens.add(tx.purchaseToken);\r\n      }\r\n\r\n      // Extract user ID from agent (the buyer)\r\n      userId = tx.agent?.id;\r\n      if (!userId) continue;\r\n\r\n      // Extract price (in Robux, before Roblox takes their cut)\r\n      price = tx.currency?.amount || 0;\r\n      if (price <= 0) continue;\r\n    } else {\r\n      // Unknown format, skip\r\n      continue;\r\n    }\r\n\r\n    // Increment totals for this user\r\n    const userIdStr = String(userId);\r\n    const purchaseKey = `purchase:${userIdStr}`;\r\n    const existing = await kv.get(purchaseKey);\r\n    \r\n    let totalSpent = price;\r\n    let purchases = 1;\r\n    \r\n    if (existing) {\r\n      try {\r\n        const data = JSON.parse(existing);\r\n        totalSpent = (data.totalSpent || 0) + price;\r\n        purchases = (data.purchases || 0) + 1;\r\n      } catch (e) {\r\n        console.error('Failed to parse existing purchase data:', e);\r\n      }\r\n    }\r\n\r\n    await replaceUserTotals(kv, userId, totalSpent, purchases);\r\n\r\n    processed.push({\r\n      userId: userIdStr,\r\n      price,\r\n      totalSpent,\r\n      purchases\r\n    });\r\n  }\r\n\r\n  return processed;\r\n}\r\n\r\nexport async function onRequest(context) {\r\n  const { request, env } = context;\r\n  const kv = env.DONATIONS_KV;\r\n\r\n  const corsHeaders = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n  };\r\n\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, { status: 204, headers: corsHeaders });\r\n  }\r\n\r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n\r\n  try {\r\n    const data = await request.json();\r\n\r\n    // Support multiple formats:\r\n    // 1. Game format: {userId, productId, price}\r\n    // 2. Full Roblox API format: {transactionType: 'Sale', agent: {id}, currency: {amount}, ...}\r\n    // 3. Array of either format\r\n    let transactions = [];\r\n    \r\n    if (Array.isArray(data)) {\r\n      transactions = data;\r\n    } else if (data.transactions && Array.isArray(data.transactions)) {\r\n      transactions = data.transactions;\r\n    } else if (data.userId && data.price !== undefined) {\r\n      // Game format: simple {userId, productId, price}\r\n      transactions = [data];\r\n    } else if (data.transactionType === 'Sale') {\r\n      // Full Roblox API format\r\n      transactions = [data];\r\n    } else {\r\n      return new Response(JSON.stringify({ error: 'Invalid webhook format' }), {\r\n        status: 400,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    }\r\n\r\n    // Process transactions (handles both formats)\r\n    const processed = await processGameWebhookTransactions(kv, transactions);\r\n\r\n    return new Response(JSON.stringify({\r\n      status: 'ok',\r\n      processed: processed.length,\r\n      transactions: processed\r\n    }), {\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.error('Webhook processing error:', e);\r\n    return new Response(JSON.stringify({ error: e.message }), {\r\n      status: 500,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  }\r\n}\r\n", "export async function onRequest(context) {\r\n  const { params, request, env } = context;\r\n  const item = params.item;\r\n  const base = 'https://emwiki.com'; // your site URL\r\n\r\n  // Helper: simple bot detection\r\n  function isBot(ua) {\r\n    return /bot|crawler|spider|facebookexternalhit|twitterbot|slackbot/i.test(ua);\r\n  }\r\n\r\n  // Redirect normal users to your main frontend page\r\n  if (!isBot(request.headers.get('user-agent') || '')) {\r\n    return Response.redirect(`${base}/?item=${encodeURIComponent(item)}`, 302);\r\n  }\r\n\r\n  try {\r\n    // Fetch item from D1 database directly\r\n    const categories = ['gears', 'deaths', 'titles', 'pets', 'effects'];\r\n    let match = null;\r\n    \r\n    // Normalize item name for lookup (convert hyphens to spaces for database lookup)\r\n    const normalizedItemName = item.toLowerCase().replace(/-/g, ' ').trim();\r\n    \r\n    // Try to find the item in each category\r\n    for (const category of categories) {\r\n      const result = await env.DBA.prepare(`\r\n        SELECT name, \"from\"\r\n        FROM items\r\n        WHERE category = ? AND LOWER(REPLACE(name, '-', ' ')) = ?\r\n        LIMIT 1\r\n      `).bind(category, normalizedItemName).first();\r\n      \r\n      if (result) {\r\n        match = result;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    // If not found, try fuzzy search\r\n    if (!match) {\r\n      for (const category of categories) {\r\n        const results = await env.DBA.prepare(`\r\n          SELECT name, \"from\"\r\n          FROM items\r\n          WHERE category = ? AND name LIKE ?\r\n          LIMIT 5\r\n        `).bind(category, `%${normalizedItemName}%`).all();\r\n        \r\n        if (results.results && results.results.length > 0) {\r\n          const found = results.results.find(i =>\r\n            (i?.name || '').toLowerCase().replace(/\\s+/g, '-') === item.toLowerCase()\r\n          );\r\n          if (found) {\r\n            match = found;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (!match) throw new Error(\"Item not found\");\r\n\r\n    // Sanitize and prepare strings for HTML meta tags\r\n    const title = escapeHtml(match.name || \"EMWiki Item\");\r\n    const descriptionRaw = match.from || \"\";\r\n    const descriptionText = descriptionRaw.replace(/<br\\s*\\/?>(\\s*)?/gi, '\\n');\r\n\r\n    // Your image URL points to the Worker (deployed separately)\r\n    const imageUrl = `https://images-eight-theta.vercel.app/api/image?item=${encodeURIComponent(item)}`;\r\n\r\n    return new Response(`<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n<meta charset=\"UTF-8\" />\r\n<meta name=\"viewport\" content=\"width=600, initial-scale=1\" />\r\n<title>${title} - EMWiki Preview</title>\r\n\r\n<meta property=\"og:title\" content=\"${title} - EMwiki\" />\r\n<meta property=\"og:image\" content=\"${imageUrl}\" />\r\n<meta property=\"og:url\" content=\"${base}/?item=${encodeURIComponent(item)}\" />\r\n<meta name=\"twitter:card\" content=\"summary_large_image\" />\r\n</head>\r\n<body></body>\r\n</html>`, {\r\n      headers: { \"Content-Type\": \"text/html\" }\r\n    });\r\n\r\n  } catch (e) {\r\n    return new Response(`Error: ${e.message}`, { status: 404 });\r\n  }\r\n}\r\n\r\n// Simple helper to escape HTML special chars\r\nfunction escapeHtml(text) {\r\n  return text\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#039;\");\r\n}\r\n", "// Gallery API - Handles media submissions and moderation\nimport { verifySession } from '../_utils/auth.js';\n\n// CORS headers helper\nconst CORS_HEADERS = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n  'Access-Control-Max-Age': '86400',\n};\n\n// Helper to determine media type from URL\nfunction getMediaType(url) {\n  if (!url) return 'image';\n\n  // Check for Cloudflare Stream URLs (videos)\n  if (url.includes('cloudflarestream.com') ||\n      url.includes('videodelivery.net') ||\n      url.includes('.m3u8')) {\n    return 'video';\n  }\n\n  // Check file extension\n  const ext = url.split('.').pop().toLowerCase().split('?')[0]; // Handle query params\n  const videoExts = ['mp4', 'webm', 'mov', 'avi', 'mkv'];\n  return videoExts.includes(ext) ? 'video' : 'image';\n}\n\n// Helper to safely parse likes JSON with fallback to empty array\nfunction parseLikes(likesStr) {\n  if (!likesStr) return [];\n  try {\n    const parsed = JSON.parse(likesStr);\n    return Array.isArray(parsed) ? parsed : [];\n  } catch {\n    console.error('Failed to parse likes JSON:', likesStr);\n    return [];\n  }\n}\n\n// Helper to get user from session token\nasync function getUserFromToken(token, env) {\n  if (!token) return null;\n\n  const session = await env.DBA.prepare(\n    'SELECT user_id FROM sessions WHERE token = ? AND expires_at > ?'\n  ).bind(token, Date.now()).first();\n\n  if (!session) return null;\n\n  const user = await env.DBA.prepare(\n    'SELECT user_id, username, display_name, role FROM users WHERE user_id = ?'\n  ).bind(session.user_id).first();\n\n  return user;\n}\n\n// Check if user is admin\nfunction isAdmin(user) {\n  if (!user || !user.role) return false;\n  try {\n    const roles = JSON.parse(user.role);\n    return roles.includes('admin') || roles.includes('moderator');\n  } catch {\n    return false;\n  }\n}\n\n// Check if user should have submissions auto-approved (VIP, admin, or moderator)\nfunction shouldAutoApprove(user) {\n  if (!user || !user.role) return false;\n  try {\n    const roles = JSON.parse(user.role);\n    return roles.includes('vip') || roles.includes('admin') || roles.includes('moderator') || roles.includes('mod');\n  } catch {\n    return false;\n  }\n}\n\n// GET /api/gallery - List gallery items\nasync function handleGet({ request, env, params }) {\n  const url = new URL(request.url);\n  const path = params.path ? params.path.join('/') : '';\n\n  // Get auth token - only fetch user if token exists (saves 2 DB queries for public requests)\n  const authHeader = request.headers.get('Authorization');\n  const token = authHeader?.replace('Bearer ', '').trim();\n  // Defer user lookup until actually needed, cache result\n  let userCache = { fetched: false, user: null };\n  const getUser = async () => {\n    if (!userCache.fetched && token) {\n      userCache.user = await getUserFromToken(token, env);\n      userCache.fetched = true;\n    }\n    return userCache.user;\n  };\n\n  // GET /api/gallery/pending - Get pending items (admin only)\n  if (path === 'pending') {\n    //if (!user || !isAdmin(user)) {\n    //return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n    //status: 403,\n    //headers: { 'Content-Type': 'application/json',\n    //...CORS_HEADERS }\n    //});\n    //}\n\n    const items = await env.DBA.prepare(\n      `SELECT g.id, g.user_id, u.username, g.title, g.description, g.media_url, g.thumbnail_url,\n              g.status, g.created_at, g.views, g.likes, u.avatar_url, u.role\n       FROM gallery_items g\n       LEFT JOIN users u ON g.user_id = u.user_id\n       WHERE g.status = 2\n       ORDER BY g.created_at DESC`\n    ).all();\n\n    // Parse JSON fields and add computed fields\n    const processedItems = (items.results || []).map(item => {\n      const likes = parseLikes(item.likes);\n      const mediaType = getMediaType(item.media_url);\n      return {\n        ...item,\n        username: item.username || 'Unknown',\n        media_type: mediaType,\n        views: item.views || 0,\n        likes_count: likes.length,\n        status: 'pending' // For backwards compatibility\n      };\n    });\n\n    return new Response(JSON.stringify({ items: processedItems }), {\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // GET /api/gallery/my-submissions - Get user's own submissions\n  if (path === 'my-submissions') {\n    const currentUser = await getUser();\n    if (!currentUser) {\n      return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n        status: 401,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n\n    const items = await env.DBA.prepare(\n      `SELECT g.id, g.title, g.description, g.media_url, g.thumbnail_url, g.status,\n              g.created_at, g.views, g.likes, g.rejection_reason, u.avatar_url, u.role\n       FROM gallery_items g\n       LEFT JOIN users u ON g.user_id = u.user_id\n       WHERE g.user_id = ?\n       ORDER BY g.created_at DESC`\n    ).bind(currentUser.user_id).all();\n\n    // Parse JSON fields and add computed fields\n    const processedItems = (items.results || []).map(item => {\n      const likes = parseLikes(item.likes);\n      const mediaType = getMediaType(item.media_url);\n      const statusText = item.status === 1 ? 'approved' : item.status === 0 ? 'rejected' : 'pending';\n      return {\n        ...item,\n        media_type: mediaType,\n        views: item.views || 0,\n        likes_count: likes.length,\n        status: statusText // For backwards compatibility\n      };\n    });\n\n    return new Response(JSON.stringify({ items: processedItems }), {\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // GET /api/gallery/:id - Get single gallery item and increment views\n  if (path && path.match(/^\\d+$/)) {\n    const itemId = parseInt(path, 10);\n\n    try {\n      // Get item first\n      const item = await env.DBA.prepare(\n        `SELECT g.id, g.user_id, u.username, g.title, g.description, g.media_url, g.thumbnail_url,\n                g.created_at, g.views, g.likes, u.avatar_url, u.role\n         FROM gallery_items g\n         LEFT JOIN users u ON g.user_id = u.user_id\n         WHERE g.id = ? AND g.status = 1`\n      ).bind(itemId).first();\n\n      if (!item) {\n        return new Response(JSON.stringify({ error: 'Item not found' }), {\n          status: 404,\n          headers: {\n            'Content-Type': 'application/json',\n            ...CORS_HEADERS\n          }\n        });\n      }\n\n      // Increment views (don't await to speed up response)\n      env.DBA.prepare(\n        'UPDATE gallery_items SET views = views + 1 WHERE id = ?'\n      ).bind(itemId).run().catch(err => console.error('View increment failed:', err));\n\n      // Parse likes array\n      const likes = parseLikes(item.likes);\n\n      // Check if current user liked this item (only fetch user if token exists)\n      const currentUser = await getUser();\n      const userLiked = currentUser ? likes.includes(currentUser.user_id) : false;\n      const mediaType = getMediaType(item.media_url);\n\n      const processedItem = {\n        ...item,\n        username: item.username || 'Unknown',\n        media_type: mediaType,\n        views: (item.views || 0) + 1,\n        likes_count: likes.length,\n        user_liked: userLiked\n      };\n\n      return new Response(JSON.stringify({ item: processedItem }), {\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    } catch (error) {\n      console.error('Error fetching gallery item:', error.message, error.stack);\n      return new Response(JSON.stringify({ \n        error: 'Failed to fetch item',\n        details: error.message \n      }), {\n        status: 500,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n  }\n\n  // GET /api/gallery - Get approved items (public)\n  const limit = parseInt(url.searchParams.get('limit')) || 50;\n  const offset = parseInt(url.searchParams.get('offset')) || 0;\n  const sortBy = url.searchParams.get('sort') || 'likes'; // 'likes' or 'newest'\n\n  // Get total count of approved items\n  const countResult = await env.DBA.prepare(\n    'SELECT COUNT(*) as total FROM gallery_items WHERE status = 1'\n  ).first();\n  const total = countResult?.total || 0;\n\n  // Get user info only if token exists (skip 2 DB queries for unauthenticated requests)\n  const currentUser = await getUser();\n\n  // For likes sorting, we need to fetch all items, sort them, then paginate\n  // For newest sorting, we can sort in SQL and paginate efficiently\n  let processedItems;\n\n  if (sortBy === 'likes') {\n    // Use likes_count column for efficient SQL-based sorting and pagination\n    const items = await env.DBA.prepare(\n      `SELECT g.id, g.user_id, u.username, g.title, g.description, g.media_url, g.thumbnail_url,\n              g.created_at, g.views, g.likes, g.likes_count, u.avatar_url, u.role\n       FROM gallery_items g\n       LEFT JOIN users u ON g.user_id = u.user_id\n       WHERE g.status = 1\n       ORDER BY g.likes_count DESC, g.created_at DESC\n       LIMIT ? OFFSET ?`\n    ).bind(limit, offset).all();\n\n    // Process items\n    processedItems = (items.results || []).map(item => {\n      const likes = parseLikes(item.likes);\n      const mediaType = getMediaType(item.media_url);\n      const userLiked = currentUser ? likes.includes(currentUser.user_id) : false;\n\n      return {\n        ...item,\n        username: item.username || 'Unknown',\n        media_type: mediaType,\n        views: item.views || 0,\n        likes_count: item.likes_count || likes.length,\n        user_liked: userLiked\n      };\n    });\n  } else {\n    // For newest, we can paginate in SQL efficiently\n    const items = await env.DBA.prepare(\n      `SELECT g.id, g.user_id, u.username, g.title, g.description, g.media_url, g.thumbnail_url,\n              g.created_at, g.views, g.likes, u.avatar_url, u.role\n       FROM gallery_items g\n       LEFT JOIN users u ON g.user_id = u.user_id\n       WHERE g.status = 1\n       ORDER BY g.created_at DESC\n       LIMIT ? OFFSET ?`\n    ).bind(limit, offset).all();\n\n    // Process items\n    processedItems = (items.results || []).map(item => {\n      const likes = parseLikes(item.likes);\n      const mediaType = getMediaType(item.media_url);\n      const userLiked = currentUser ? likes.includes(currentUser.user_id) : false;\n\n      return {\n        ...item,\n        username: item.username || 'Unknown',\n        media_type: mediaType,\n        views: item.views || 0,\n        likes_count: likes.length,\n        user_liked: userLiked\n      };\n    });\n  }\n\n  return new Response(JSON.stringify({ items: processedItems, total }), {\n    headers: {\n      'Content-Type': 'application/json',\n      ...CORS_HEADERS\n    }\n  });\n}\n\n// POST /api/gallery - Submit new media\nasync function handlePost({ request, env, params }) {\n  const path = params.path ? params.path.join('/') : '';\n\n  // Get auth token\n  const authHeader = request.headers.get('Authorization');\n  const token = authHeader?.replace('Bearer ', '');\n  const user = await getUserFromToken(token, env);\n\n  if (!user) {\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n      status: 401,\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // POST /api/gallery/upload - Upload media file to Cloudflare Images/Stream\n  if (path === 'upload') {\n    try {\n      const formData = await request.formData();\n      const file = formData.get('file');\n\n      if (!file) {\n        return new Response(JSON.stringify({ error: 'No file uploaded' }), {\n          status: 400,\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n      }\n\n      // Validate file type\n      const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\n      const validVideoTypes = ['video/mp4', 'video/webm', 'video/quicktime'];\n      const isImage = validImageTypes.includes(file.type);\n      const isVideo = validVideoTypes.includes(file.type);\n\n      if (!isImage && !isVideo) {\n        return new Response(JSON.stringify({\n          error: 'Invalid file type. Only images (JPEG, PNG, GIF, WebP) and videos (MP4, WebM, MOV) are allowed.'\n        }), {\n          status: 400,\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n      }\n\n      // Validate file size (max 100MB for videos, 10MB for images)\n      const maxSize = isVideo ? 100 * 1024 * 1024 : 10 * 1024 * 1024;\n      if (file.size > maxSize) {\n        return new Response(JSON.stringify({\n          error: `File too large. Maximum size is ${isVideo ? '100MB' : '10MB'}.`\n        }), {\n          status: 400,\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n      }\n\n      const accountId = env.CLOUDFLARE_ACCOUNT_ID;\n      const apiToken = env.CLOUDFLARE_STREAM_TOKEN;\n\n      if (!accountId || !apiToken) {\n        return new Response(JSON.stringify({\n          error: 'Cloudflare credentials not configured'\n        }), {\n          status: 500,\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n      }\n\n      // Generate unique ID for the upload\n      const customId = `gallery-${user.user_id}-${Date.now()}-${Math.random().toString(36).substring(7)}`;\n\n      if (isImage) {\n        // Upload to Cloudflare Images\n        const uploadForm = new FormData();\n        uploadForm.append('file', file, file.name);\n        uploadForm.append('id', customId);\n        uploadForm.append('metadata', JSON.stringify({\n          user_id: user.user_id,\n          username: user.username,\n          uploaded_at: Date.now()\n        }));\n\n        const uploadRes = await fetch(\n          `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1`,\n          {\n            method: 'POST',\n            headers: { Authorization: `Bearer ${apiToken}` },\n            body: uploadForm\n          }\n        );\n\n        if (!uploadRes.ok) {\n          const error = await uploadRes.text();\n          throw new Error(`Images upload failed: ${error}`);\n        }\n\n        const result = await uploadRes.json();\n        if (!result.success) {\n          throw new Error(result.errors?.[0]?.message || 'Upload failed');\n        }\n\n        // Return the public variant URL\n        const url = result.result.variants[0];\n        return new Response(JSON.stringify({ \n          url, \n          type: file.type,\n          cf_id: customId,\n          provider: 'cloudflare-images'\n        }), {\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n\n      } else {\n        // Upload to Cloudflare Stream\n        const streamToken = env.CLOUDFLARE_STREAM_TOKEN || apiToken;\n        \n        // Use TUS upload for larger files, direct upload for smaller\n        const uploadForm = new FormData();\n        uploadForm.append('file', file, file.name);\n        uploadForm.append('meta', JSON.stringify({\n          name: customId,\n          user_id: user.user_id,\n          username: user.username\n        }));\n\n        const uploadRes = await fetch(\n          `https://api.cloudflare.com/client/v4/accounts/${accountId}/stream`,\n          {\n            method: 'POST',\n            headers: { Authorization: `Bearer ${streamToken}` },\n            body: uploadForm\n          }\n        );\n\n        if (!uploadRes.ok) {\n          const error = await uploadRes.text();\n          throw new Error(`Stream upload failed: ${error}`);\n        }\n\n        const result = await uploadRes.json();\n        if (!result.success) {\n          throw new Error(result.errors?.[0]?.message || 'Upload failed');\n        }\n\n        const streamUid = result.result.uid;\n        // Return the HLS manifest URL for direct video playback\n        // Also store stream_uid for iframe embedding if needed\n        const url = result.result.playback?.hls || `https://customer-${accountId}.cloudflarestream.com/${streamUid}/manifest/video.m3u8`;\n        \n        return new Response(JSON.stringify({ \n          url,  // HLS manifest for video players\n          type: file.type,\n          stream_uid: streamUid,\n          iframe_url: `https://iframe.videodelivery.net/${streamUid}`,\n          provider: 'cloudflare-stream'\n        }), {\n          headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n        });\n      }\n    } catch (err) {\n      console.error('Gallery upload error:', err);\n      return new Response(JSON.stringify({ error: 'Upload failed: ' + err.message }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n      });\n    }\n  }\n\n  // POST /api/gallery/submit - Submit gallery item\n  if (path === 'submit') {\n    try {\n      const data = await request.json();\n      const { title, description, media_url, thumbnail_url } = data;\n\n      if (!title || !media_url) {\n        return new Response(JSON.stringify({\n          error: 'Missing required fields: title, media_url'\n        }), {\n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n            ...CORS_HEADERS\n          }\n        });\n      }\n\n      // Determine status based on user roles (VIP, admin, mod get auto-approved)\n      // 0=rejected, 1=approved, 2=pending\n      const status = shouldAutoApprove(user) ? 1 : 2;\n      const autoApproved = status === 1;\n\n      // Insert into database with thumbnail_url\n      const result = await env.DBA.prepare(\n        `INSERT INTO gallery_items (user_id, title, description, media_url, thumbnail_url, status, created_at, views, likes)\n         VALUES (?, ?, ?, ?, ?, ?, ?, '[]', '[]')`\n      ).bind(\n        user.user_id,\n        title,\n        description || '',\n        media_url,\n        thumbnail_url || null,\n        status,\n        Date.now()\n      ).run();\n\n      return new Response(JSON.stringify({\n        success: true,\n        id: result.meta.last_row_id,\n        message: autoApproved\n          ? 'Submission approved! Your art is now live in the gallery.'\n          : 'Submission received! It will be reviewed by admins before appearing in the gallery.'\n      }), {\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    } catch (err) {\n      return new Response(JSON.stringify({ error: 'Submission failed: ' + err.message }), {\n        status: 500,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n  }\n\n \n\n  // POST /api/gallery/moderate/:id - Moderate item (admin only)\n  if (path.startsWith('moderate/')) {\n    if (!isAdmin(user)) {\n      return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n        status: 403,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n\n    const itemId = path.split('/')[1];\n    const data = await request.json();\n    const { action, reason } = data; // action: 'approve' or 'reject'\n\n    if (!action || !['approve', 'reject'].includes(action)) {\n      return new Response(JSON.stringify({\n        error: 'Invalid action. Must be \"approve\" or \"reject\"'\n      }), {\n        status: 400,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n\n    // 0=rejected, 1=approved, 2=pending\n    const status = action === 'approve' ? 1 : 0;\n\n    await env.DBA.prepare(\n      `UPDATE gallery_items\n       SET status = ?, moderated_by = ?, moderated_at = ?, rejection_reason = ?\n       WHERE id = ?`\n    ).bind(status, user.username, Date.now(), reason || null, itemId).run();\n\n    return new Response(JSON.stringify({\n      success: true,\n      message: `Item ${action}d successfully`\n    }), {\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // POST /api/gallery/like/:id - Toggle like on item\n  if (path.startsWith('like/')) {\n    const itemId = path.split('/')[1];\n\n    try {\n      // Check if item exists and is approved\n      const item = await env.DBA.prepare(\n        'SELECT id, likes FROM gallery_items WHERE id = ? AND status = 1'\n      ).bind(itemId).first();\n\n      if (!item) {\n        return new Response(JSON.stringify({ error: 'Item not found or not approved' }), {\n          status: 404,\n          headers: {\n            'Content-Type': 'application/json',\n            ...CORS_HEADERS\n          }\n        });\n      }\n\n      // Parse likes array\n      const likes = parseLikes(item.likes);\n      const likeIndex = likes.indexOf(user.user_id);\n\n      if (likeIndex > -1) {\n        // Unlike - remove user_id from array\n        likes.splice(likeIndex, 1);\n\n        await env.DBA.prepare(\n          'UPDATE gallery_items SET likes = ?, likes_count = ? WHERE id = ?'\n        ).bind(JSON.stringify(likes), likes.length, itemId).run();\n\n        return new Response(JSON.stringify({\n          success: true,\n          liked: false,\n          message: 'Like removed',\n          likes_count: likes.length\n        }), {\n          headers: {\n            'Content-Type': 'application/json',\n            ...CORS_HEADERS\n          }\n        });\n      } else {\n        // Like - add user_id to array\n        likes.push(user.user_id);\n\n        await env.DBA.prepare(\n          'UPDATE gallery_items SET likes = ?, likes_count = ? WHERE id = ?'\n        ).bind(JSON.stringify(likes), likes.length, itemId).run();\n\n        return new Response(JSON.stringify({\n          success: true,\n          liked: true,\n          message: 'Like added',\n          likes_count: likes.length\n        }), {\n          headers: {\n            'Content-Type': 'application/json',\n            ...CORS_HEADERS\n          }\n        });\n      }\n    } catch (error) {\n      console.error('Error toggling like:', error);\n      return new Response(JSON.stringify({\n        error: 'Failed to toggle like',\n        details: error.message\n      }), {\n        status: 500,\n        headers: {\n          'Content-Type': 'application/json',\n          ...CORS_HEADERS\n        }\n      });\n    }\n  }\n\n  return new Response(JSON.stringify({ error: 'Invalid endpoint' }), {\n    status: 404,\n    headers: {\n      'Content-Type': 'application/json',\n      ...CORS_HEADERS\n    }\n  });\n}\n\n// DELETE /api/gallery/:id - Delete item (owner or admin only)\nasync function handleDelete({ request, env, params }) {\n  const path = params.path ? params.path.join('/') : '';\n\n  if (!path) {\n    return new Response(JSON.stringify({ error: 'Item ID required' }), {\n      status: 400,\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // Get auth token\n  const authHeader = request.headers.get('Authorization');\n  const token = authHeader?.replace('Bearer ', '');\n  const user = await getUserFromToken(token, env);\n\n  if (!user) {\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n      status: 401,\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  const itemId = path;\n\n  // Get item to check ownership\n  const item = await env.DBA.prepare(\n    'SELECT user_id, media_url FROM gallery_items WHERE id = ?'\n  ).bind(itemId).first();\n\n  if (!item) {\n    return new Response(JSON.stringify({ error: 'Item not found' }), {\n      status: 404,\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // Check if user is owner or admin\n  if (item.user_id !== user.user_id && !isAdmin(user)) {\n    return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n      status: 403,\n      headers: {\n        'Content-Type': 'application/json',\n        ...CORS_HEADERS\n      }\n    });\n  }\n\n  // Delete from database\n  await env.DBA.prepare('DELETE FROM gallery_items WHERE id = ?').bind(itemId).run();\n\n  // Delete from Cloudflare Images or Stream\n  const accountId = env.CLOUDFLARE_ACCOUNT_ID;\n  const apiToken = env.CLOUDFLARE_STREAM_TOKEN;\n  \n  if (accountId && apiToken && item.media_url) {\n    try {\n      // Check if it's a Cloudflare Images URL\n      if (item.media_url.includes('imagedelivery.net')) {\n        // Extract image ID from URL (format: .../imagedelivery.net/{account_hash}/{image_id}/...)\n        const parts = item.media_url.split('/');\n        const imageId = parts[parts.length - 2]; // Second to last segment\n        if (imageId && imageId.startsWith('gallery-')) {\n          await fetch(\n            `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1/${imageId}`,\n            {\n              method: 'DELETE',\n              headers: { Authorization: `Bearer ${apiToken}` }\n            }\n          );\n          console.log(`Deleted image: ${imageId}`);\n        }\n      }\n      // Check if it's a Cloudflare Stream URL\n      else if (item.media_url.includes('videodelivery.net') || item.media_url.includes('cloudflarestream.com')) {\n        // Extract stream UID from URL\n        const streamToken = env.CLOUDFLARE_STREAM_TOKEN || apiToken;\n        const parts = item.media_url.split('/');\n        // Try to find the UID (usually after videodelivery.net/)\n        const uidIndex = parts.findIndex(p => p.includes('videodelivery.net') || p.includes('cloudflarestream.com'));\n        const streamUid = uidIndex >= 0 ? parts[uidIndex + 1] : null;\n        if (streamUid) {\n          await fetch(\n            `https://api.cloudflare.com/client/v4/accounts/${accountId}/stream/${streamUid}`,\n            {\n              method: 'DELETE',\n              headers: { Authorization: `Bearer ${streamToken}` }\n            }\n          );\n          console.log(`Deleted video: ${streamUid}`);\n        }\n      }\n    } catch (err) {\n      console.error('Failed to delete from Cloudflare:', err);\n    }\n  }\n\n  return new Response(JSON.stringify({\n    success: true,\n    message: 'Item deleted successfully'\n  }), {\n    headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n  });\n}\n\nexport async function onRequestGet(context) {\n  try {\n    return await handleGet(context);\n  } catch (error) {\n    console.error('Gallery GET error:', error.message, error.stack);\n    return new Response(JSON.stringify({ \n      error: 'Internal server error',\n      details: error.message \n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n    });\n  }\n}\n\nexport async function onRequestPost(context) {\n  try {\n    return await handlePost(context);\n  } catch (error) {\n    console.error('Gallery POST error:', error.message, error.stack);\n    return new Response(JSON.stringify({ \n      error: 'Internal server error',\n      details: error.message \n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n    });\n  }\n}\n\nexport async function onRequestDelete(context) {\n  try {\n    return await handleDelete(context);\n  } catch (error) {\n    console.error('Gallery DELETE error:', error.message, error.stack);\n    return new Response(JSON.stringify({ \n      error: 'Internal server error',\n      details: error.message \n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...CORS_HEADERS }\n    });\n  }\n}\n\nexport async function onRequestOptions(context) {\n  return new Response(null, {\n    status: 204,\n    headers: CORS_HEADERS\n  });\n}", "// Rate limiting helper\nconst rateLimits = new Map();\n\nfunction checkRateLimit(ip, limit = 10, window = 60000) {\n    const now = Date.now();\n    const key = `${ip}`;\n    const requests = rateLimits.get(key) || [];\n\n    // Clean old requests\n    const recent = requests.filter(time => now - time < window);\n\n    if (recent.length >= limit) {\n        return false;\n    }\n\n    recent.push(now);\n    rateLimits.set(key, recent);\n    return true;\n}\nfunction cleanUserRole(roles) {\n    // If user has other roles besides 'user', remove 'user'\n    if (!roles || roles.length === 0) return ['user'];\n\n    const filtered = roles.filter(r => r !== 'user');\n\n    // If after removing 'user' we have other roles, return them\n    // Otherwise keep ['user'] as default\n    return filtered.length > 0 ? filtered : ['user'];\n}\n\n// Lightweight session validation - just verifies token and returns user_id\n// Does NOT update last_online or roles - use for read-only operations\nasync function validateSessionLight(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n        return null;\n    }\n\n    // Use a simpler query that only fetches what we need\n    const session = await env.DBA.prepare(`\n        SELECT s.user_id FROM sessions s\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    return session?.user_id || null;\n}\nfunction generateCode() {\n    return Math.floor(100000 + Math.random() * 900000).toString();\n}\n\nasync function handleGenerateCode(request, env) {\n    const ip = request.headers.get('CF-Connecting-IP');\n    if (!checkRateLimit(ip, 5, 60000)) {\n        return new Response(JSON.stringify({ error: 'Rate limit exceeded' }), {\n            status: 429,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const code = generateCode();\n    const expiresAt = Date.now() + (5 * 60 * 1000); // 5 minutes\n\n    await env.DBA.prepare(\n        'INSERT INTO auth_codes (code, expires_at) VALUES (?, ?)'\n    ).bind(code, expiresAt).run();\n\n    return new Response(JSON.stringify({ code, expiresIn: 300 }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleVerifyCode(request, env) {\n    const data = await request.json();\n    const { code, userId, username, displayName } = data;\n\n    if (!code || !userId || !username) {\n        return new Response(JSON.stringify({ error: 'Missing required fields' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if code exists and hasn't expired\n    const authCode = await env.DBA.prepare(\n        'SELECT * FROM auth_codes WHERE code = ? AND expires_at > ? AND used = 0'\n    ).bind(code, Date.now()).first();\n\n    if (!authCode) {\n        return new Response(JSON.stringify({ error: 'Invalid or expired code' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Mark code as used AND store who used it\n    await env.DBA.prepare(\n        'UPDATE auth_codes SET used = 1, user_id = ? WHERE code = ?'\n    ).bind(userId, code).run();\n\n    // Get or fetch avatar\n    const existingUser = await env.DBA.prepare(\n        'SELECT avatar_url, avatar_cached_at FROM users WHERE user_id = ?'\n    ).bind(userId).first();\n\n    let avatarUrl = null;\n    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);\n\n    if (existingUser?.avatar_url && existingUser.avatar_cached_at > oneDayAgo) {\n        // Use cached avatar (24h cache, background cron refreshes daily)\n        avatarUrl = existingUser.avatar_url;\n    } else {\n        // Fetch fresh avatar from Roblox\n        try {\n            const response = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`);\n            const json = await response.json();\n            avatarUrl = json.data?.[0]?.imageUrl || null;\n        } catch (e) {\n            console.error('Failed to fetch avatar:', e);\n            // Fallback to old cached avatar if fetch fails\n            avatarUrl = existingUser?.avatar_url || null;\n        }\n    }\n\n    const now = Date.now();\n\n    await env.DBA.prepare(`\nINSERT INTO users (user_id, username, display_name, avatar_url, avatar_cached_at, created_at, last_online, role)\nVALUES (?, ?, ?, ?, ?, ?, ?, ?)\nON CONFLICT(user_id) DO UPDATE SET\n    username = excluded.username,\n    display_name = excluded.display_name,\n    avatar_url = excluded.avatar_url,\n    avatar_cached_at = excluded.avatar_cached_at,\n    last_online = excluded.last_online\n`).bind(userId, username, displayName || username, avatarUrl, now, now, now, '[\"user\"]').run();\n\n    // Create session\n    const sessionToken = crypto.randomUUID();\n    const expiresAt = now + (3000 * 24 * 60 * 60 * 1000); // 3000 days\n\n    await env.DBA.prepare(\n        'INSERT INTO sessions (token, user_id, created_at, expires_at) VALUES (?, ?, ?, ?)'\n    ).bind(sessionToken, userId, now, expiresAt).run();\n\n    return new Response(JSON.stringify({\n        success: true,\n        token: sessionToken,\n        user: { userId, username, displayName, avatarUrl, role: ['user'] }  // Add role here\n    }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleGetSession(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n        return new Response(JSON.stringify({ error: 'No token provided' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const now = Date.now();\n    const session = await env.DBA.prepare(`\n        SELECT s.*, u.* FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, now).first();\n\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Invalid session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Safely parse roles with fallback\n    let userRoles;\n    try {\n        userRoles = session.role ? JSON.parse(session.role) : null;\n    } catch (e) {\n        console.error('Failed to parse user role:', e);\n        userRoles = null;\n    }\n\n    // Ensure it's a valid array\n    const needsRoleUpdate = !Array.isArray(userRoles) || userRoles.length === 0;\n    if (needsRoleUpdate) {\n        userRoles = ['user'];\n    }\n\n    // Throttle last_online updates: only update if more than 5 minutes since last update\n    const fiveMinutesAgo = now - (5 * 60 * 1000);\n    const needsOnlineUpdate = !session.last_online || session.last_online < fiveMinutesAgo;\n    \n    // Batch both updates into one query if needed, or do single update, or skip entirely\n    if (needsRoleUpdate && needsOnlineUpdate) {\n        // Both updates needed - batch them\n        await env.DBA.prepare('UPDATE users SET last_online = ?, role = ? WHERE user_id = ?')\n            .bind(now, '[\"user\"]', session.user_id).run();\n    } else if (needsRoleUpdate) {\n        // Only role update\n        await env.DBA.prepare('UPDATE users SET role = ? WHERE user_id = ?')\n            .bind('[\"user\"]', session.user_id).run();\n    } else if (needsOnlineUpdate) {\n        // Only last_online update - fire and forget (don't await)\n        env.DBA.prepare('UPDATE users SET last_online = ? WHERE user_id = ?')\n            .bind(now, session.user_id).run();\n    }\n    // If neither needed, skip database update entirely\n\n    return new Response(JSON.stringify({\n        userId: session.user_id,\n        username: session.username,\n        displayName: session.display_name,\n        avatarUrl: session.avatar_url,\n        role: cleanUserRole(userRoles)\n    }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleLogout(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (token) {\n        await env.DBA.prepare('DELETE FROM sessions WHERE token = ?').bind(token).run();\n    }\n\n    return new Response(JSON.stringify({ success: true }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleUpdateRole(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    // Check if requester is admin\n    const session = await env.DBA.prepare(`\n        SELECT u.role, u.user_id FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    const adminRoles = JSON.parse(session?.role || '[\"user\"]');\n    if (!session || !adminRoles.includes('admin')) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n            status: 403,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const { userId, role, action } = await request.json(); // action: 'add' or 'remove'\n\n    if (!['user', 'vip', 'moderator', 'admin'].includes(role)) {\n        return new Response(JSON.stringify({ error: 'Invalid role' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get current roles\n    const user = await env.DBA.prepare('SELECT role FROM users WHERE user_id = ?').bind(userId).first();\n    const currentRoles = JSON.parse(user?.role || '[\"user\"]');\n\n    let newRoles;\n    if (action === 'add') {\n        // Add role if not already present\n        newRoles = currentRoles.includes(role) ? currentRoles : [...currentRoles, role];\n        newRoles = cleanUserRole(newRoles); // Add this line\n    } else if (action === 'remove') {\n        // Remove role, but ensure at least 'user' remains\n        newRoles = currentRoles.filter(r => r !== role);\n        if (newRoles.length === 0) newRoles = ['user'];\n    } else {\n        return new Response(JSON.stringify({ error: 'Action must be \"add\" or \"remove\"' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    await env.DBA.prepare('UPDATE users SET role = ? WHERE user_id = ?')\n        .bind(JSON.stringify(newRoles), userId).run();\n\n    return new Response(JSON.stringify({ success: true, roles: cleanUserRole(newRoles) }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleUserSearch(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    // Check if requester is admin/moderator\n   // const session = await env.DBA.prepare(`\n       // SELECT u.role, u.user_id FROM sessions s\n        //JOIN users u ON s.user_id = u.user_id\n       //WHERE s.token = ? AND s.expires_at > ?\n    //`).bind(token, Date.now()).first();\n\n    //const adminRoles = JSON.parse(session?.role || '[\"user\"]');\n    //if (!session || (!adminRoles.includes('admin') && !adminRoles.includes('moderator'))) {\n        //return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n            //status: 403,\n            //headers: { 'Content-Type': 'application/json' }\n        //});\n    //}\n\n    // Get search query from URL parameter\n    const url = new URL(request.url);\n    const query = url.searchParams.get('q') || '';\n    const limit = parseInt(url.searchParams.get('limit')) || 10;\n\n    // Ensure limit doesn't exceed 100\n    const safeLimit = Math.min(limit, 100);\n\n    // Search by username or user_id\n    let users;\n\n    try {\n        // Try to query with trade stats (if user_trade_stats table exists)\n        if (!query || query.trim() === '') {\n            // If no query, return recent users with trade stats\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    COALESCE(uts.total_trades, 0) as total_trades,\n                    COALESCE(uts.average_rating, 0) as average_rating\n                FROM users u\n                LEFT JOIN user_trade_stats uts ON u.user_id = uts.user_id\n                ORDER BY u.created_at DESC\n                LIMIT ?\n            `).bind(safeLimit).all();\n        } else if (/^\\d+$/.test(query)) {\n            // Check if query is a number (user_id)\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    COALESCE(uts.total_trades, 0) as total_trades,\n                    COALESCE(uts.average_rating, 0) as average_rating\n                FROM users u\n                LEFT JOIN user_trade_stats uts ON u.user_id = uts.user_id\n                WHERE u.user_id = ?\n                LIMIT ?\n            `).bind(query, safeLimit).all();\n        } else {\n            // Search by username or display name (case-insensitive)\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    COALESCE(uts.total_trades, 0) as total_trades,\n                    COALESCE(uts.average_rating, 0) as average_rating\n                FROM users u\n                LEFT JOIN user_trade_stats uts ON u.user_id = uts.user_id\n                WHERE LOWER(u.username) LIKE LOWER(?) OR LOWER(u.display_name) LIKE LOWER(?)\n                LIMIT ?\n            `).bind(`%${query}%`, `%${query}%`, safeLimit).all();\n        }\n    } catch (error) {\n        // If user_trade_stats table doesn't exist, fall back to basic query without stats\n        console.error('Failed to query with trade stats, falling back to basic query:', error);\n\n        if (!query || query.trim() === '') {\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    0 as total_trades,\n                    0 as average_rating\n                FROM users u\n                ORDER BY u.created_at DESC\n                LIMIT ?\n            `).bind(safeLimit).all();\n        } else if (/^\\d+$/.test(query)) {\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    0 as total_trades,\n                    0 as average_rating\n                FROM users u\n                WHERE u.user_id = ?\n                LIMIT ?\n            `).bind(query, safeLimit).all();\n        } else {\n            users = await env.DBA.prepare(`\n                SELECT\n                    u.user_id,\n                    u.username,\n                    u.display_name,\n                    u.avatar_url,\n                    u.role,\n                    0 as total_trades,\n                    0 as average_rating\n                FROM users u\n                WHERE LOWER(u.username) LIKE LOWER(?) OR LOWER(u.display_name) LIKE LOWER(?)\n                LIMIT ?\n            `).bind(`%${query}%`, `%${query}%`, safeLimit).all();\n        }\n    }\n\n    return new Response(JSON.stringify({ users: users.results || [] }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleCheckCode(request, env) {\n    const { code } = await request.json();\n\n    if (!code) {\n        return new Response(JSON.stringify({ error: 'Code required' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if code was used and get the user_id\n    const authCode = await env.DBA.prepare(\n        'SELECT * FROM auth_codes WHERE code = ? AND used = 1'\n    ).bind(code).first();\n\n    if (!authCode || !authCode.user_id) {\n        return new Response(JSON.stringify({ verified: false }), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get the user's most recent session\n    const session = await env.DBA.prepare(`\n        SELECT s.token, u.* FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.user_id = ? AND s.expires_at > ?\n        ORDER BY s.created_at DESC\n        LIMIT 1\n    `).bind(authCode.user_id, Date.now()).first();\n\n    if (session) {\n        return new Response(JSON.stringify({\n            verified: true,\n            token: session.token,\n            user: {\n                userId: session.user_id,\n                username: session.username,\n                displayName: session.display_name,\n                avatarUrl: session.avatar_url,\n                role: session.role\n            }\n        }), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    return new Response(JSON.stringify({ verified: false }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleDonationStatus(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n        return new Response(JSON.stringify({ error: 'No token provided' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get user from session\n    const session = await env.DBA.prepare(`\n        SELECT u.* FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Invalid session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Parse current roles safely\n    let currentRoles;\n    try {\n        currentRoles = session.role ? JSON.parse(session.role) : ['user'];\n    } catch (e) {\n        currentRoles = ['user'];\n    }\n\n    // Ensure it's a valid array\n    if (!Array.isArray(currentRoles) || currentRoles.length === 0) {\n        currentRoles = ['user'];\n    }\n\n    // Get donation data from KV\n    const donationKey = `purchase:${session.user_id}`;\n    const donationData = await env.DONATIONS_KV.get(donationKey);\n\n    let totalSpent = 0;\n    let purchases = 0;\n\n    if (donationData) {\n        const data = JSON.parse(donationData);\n        totalSpent = data.totalSpent || 0;\n        purchases = data.purchases || 0;\n    }\n\n    const isDonator = totalSpent >= 500;\n    const progress = Math.min((totalSpent / 500) * 100, 100);\n    const remaining = Math.max(500 - totalSpent, 0);\n\n    // Check if user just became a donator (qualifies but doesn't have the role yet)\n    const hasDonatorRole = currentRoles.includes('donator');\n    const justBecameDonator = isDonator && !hasDonatorRole;\n\n    let updatedRoles = currentRoles;\n\n    // Update roles based on donation status\n    if (isDonator && !hasDonatorRole) {\n        // Add donator role\n        updatedRoles = [...currentRoles, 'donator'];\n        updatedRoles = cleanUserRole(updatedRoles);\n        \n        await env.DBA.prepare(\n            'UPDATE users SET role = ? WHERE user_id = ?'\n        ).bind(JSON.stringify(updatedRoles), session.user_id).run();\n    } else if (!isDonator && hasDonatorRole) {\n        // Remove donator role if they no longer qualify (e.g., refund)\n        updatedRoles = currentRoles.filter(r => r !== 'donator');\n        if (updatedRoles.length === 0) updatedRoles = ['user'];\n        \n        await env.DBA.prepare(\n            'UPDATE users SET role = ? WHERE user_id = ?'\n        ).bind(JSON.stringify(updatedRoles), session.user_id).run();\n    }\n\n    return new Response(JSON.stringify({\n        totalSpent,\n        purchases,\n        isDonator,\n        progress,\n        remaining,\n        justBecameDonator,\n        roles: updatedRoles  // Return full roles array instead of single role\n    }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\n// ==================== USER PREFERENCES ====================\n\nasync function handleSavePreferences(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n        return new Response(JSON.stringify({ error: 'No token provided' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get user from session\n    const session = await env.DBA.prepare(`\n        SELECT u.user_id FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Invalid session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const preferences = await request.json();\n    const now = Date.now();\n    const userId = session.user_id;\n\n    // Collect all statements for batch execution\n    const batch = [];\n\n    for (const [key, value] of Object.entries(preferences)) {\n        const valueJson = JSON.stringify(value);\n\n        // Upsert preference\n        batch.push(\n            env.DBA.prepare(`\n                INSERT INTO user_preferences (user_id, preference_key, preference_value, updated_at)\n                VALUES (?, ?, ?, ?)\n                ON CONFLICT(user_id, preference_key) DO UPDATE SET\n                    preference_value = excluded.preference_value,\n                    updated_at = excluded.updated_at\n            `).bind(userId, key, valueJson, now)\n        );\n\n        // Sync favorites/wishlist to normalized table for efficient counting\n        if ((key === 'favorites' || key === 'wishlist') && Array.isArray(value)) {\n            const prefType = key === 'favorites' ? 'favorite' : 'wishlist';\n\n            // Delete existing entries for this user/type\n            batch.push(\n                env.DBA.prepare(`\n                    DELETE FROM user_item_preferences\n                    WHERE user_id = ? AND preference_type = ?\n                `).bind(userId, prefType)\n            );\n\n            // Insert new entries\n            for (const itemName of value) {\n                if (typeof itemName === 'string' && itemName.trim()) {\n                    batch.push(\n                        env.DBA.prepare(`\n                            INSERT OR IGNORE INTO user_item_preferences (user_id, item_name, preference_type)\n                            VALUES (?, ?, ?)\n                        `).bind(userId, itemName, prefType)\n                    );\n                }\n            }\n        }\n    }\n\n    // Execute all statements in a single batch\n    if (batch.length > 0) {\n        await env.DBA.batch(batch);\n    }\n\n    return new Response(JSON.stringify({ success: true }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nasync function handleLoadPreferences(request, env) {\n    // Use lightweight validation for read-only operation\n    const userId = await validateSessionLight(request, env);\n\n    if (!userId) {\n        return new Response(JSON.stringify({ error: 'Invalid session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const url = new URL(request.url);\n    const key = url.searchParams.get('key');\n\n    if (key) {\n        // Load specific preference\n        const pref = await env.DBA.prepare(\n            'SELECT preference_value FROM user_preferences WHERE user_id = ? AND preference_key = ?'\n        ).bind(userId, key).first();\n\n        if (pref) {\n            return new Response(JSON.stringify({\n                [key]: JSON.parse(pref.preference_value)\n            }), {\n                headers: { 'Content-Type': 'application/json' }\n            });\n        }\n\n        return new Response(JSON.stringify({}), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    } else {\n        // Load all preferences\n        const prefs = await env.DBA.prepare(\n            'SELECT preference_key, preference_value FROM user_preferences WHERE user_id = ?'\n        ).bind(userId).all();\n\n        const result = {};\n        prefs.results.forEach(pref => {\n            result[pref.preference_key] = JSON.parse(pref.preference_value);\n        });\n\n        return new Response(JSON.stringify(result), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n}\n\nasync function handleMigratePreferences(request, env) {\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n\n    if (!token) {\n        return new Response(JSON.stringify({ error: 'No token provided' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get user from session\n    const session = await env.DBA.prepare(`\n        SELECT u.user_id FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Invalid session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const localData = await request.json();\n    const now = Date.now();\n\n    // Check if user already has preferences (avoid overwriting cloud data)\n    const existingPrefs = await env.DBA.prepare(\n        'SELECT COUNT(*) as count FROM user_preferences WHERE user_id = ?'\n    ).bind(session.user_id).first();\n\n    // Only migrate if no existing preferences\n    if (existingPrefs.count === 0) {\n        for (const [key, value] of Object.entries(localData)) {\n            const valueJson = JSON.stringify(value);\n\n            await env.DBA.prepare(`\n                INSERT INTO user_preferences (user_id, preference_key, preference_value, updated_at)\n                VALUES (?, ?, ?, ?)\n                ON CONFLICT(user_id, preference_key) DO UPDATE SET\n                    preference_value = excluded.preference_value,\n                    updated_at = excluded.updated_at\n            `).bind(session.user_id, key, valueJson, now).run();\n        }\n\n        return new Response(JSON.stringify({ success: true, migrated: true }), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    return new Response(JSON.stringify({ success: true, migrated: false, message: 'User already has cloud preferences' }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\n// Get aggregated favorite/wishlist counts for items\n// Helper: Calculate displayed flikes based on target and item age\n// Gradually ramps up from 0 to target_flikes over 30 days\nfunction calculateDisplayedFlikes(targetFlikes, createdAt) {\n    if (!targetFlikes || targetFlikes <= 0) return 0;\n    \n    const now = Date.now();\n    const createdAtMs = createdAt * 1000; // created_at is in seconds\n    const ageMs = now - createdAtMs;\n    const ageDays = ageMs / (1000 * 60 * 60 * 24);\n    \n    // Progress from 0 to 1 over 30 days\n    const progress = Math.min(ageDays / 30, 1);\n    \n    return Math.floor(targetFlikes * progress);\n}\n\nasync function handleGetPreferenceStats(request, env) {\n    const url = new URL(request.url);\n    \n    // Check if requesting real counts (for admin/scripts to calculate flikes)\n    const wantReal = url.searchParams.get('real') === 'true';\n    \n    // Support bulk requests via POST with JSON body\n    if (request.method === 'POST') {\n        try {\n            const body = await request.json();\n            const itemNames = body.items || [];\n            \n            if (!Array.isArray(itemNames) || itemNames.length === 0) {\n                return new Response(JSON.stringify({ itemCounts: {} }), {\n                    headers: { 'Content-Type': 'application/json' }\n                });\n            }\n            \n            const placeholders = itemNames.map(() => '?').join(',');\n            \n            if (wantReal) {\n                // Return REAL counts from user_item_preferences table\n                const { results } = await env.DBA.prepare(`\n                    SELECT item_name, COUNT(*) as count\n                    FROM user_item_preferences\n                    WHERE item_name IN (${placeholders})\n                    GROUP BY item_name\n                `).bind(...itemNames).all();\n                \n                const itemCounts = {};\n                itemNames.forEach(name => { itemCounts[name] = 0; });\n                (results || []).forEach(row => {\n                    itemCounts[row.item_name] = row.count;\n                });\n                \n                return new Response(JSON.stringify({ itemCounts }), {\n                    headers: { 'Content-Type': 'application/json' }\n                });\n            }\n            \n            // Get target_flikes and created_at from items table for gradual display\n            const { results } = await env.DBA.prepare(`\n                SELECT name, target_flikes, created_at\n                FROM items\n                WHERE name IN (${placeholders})\n            `).bind(...itemNames).all();\n            \n            // Build result map with gradual flikes calculation\n            const itemCounts = {};\n            itemNames.forEach(name => { itemCounts[name] = 0; });\n            (results || []).forEach(row => {\n                itemCounts[row.name] = calculateDisplayedFlikes(row.target_flikes, row.created_at);\n            });\n            \n            return new Response(JSON.stringify({ itemCounts }), {\n                headers: { \n                    'Content-Type': 'application/json',\n                    'Cache-Control': 'public, max-age=60'\n                }\n            });\n        } catch (e) {\n            console.error('Error fetching bulk preference stats:', e);\n            return new Response(JSON.stringify({ itemCounts: {} }), {\n                headers: { 'Content-Type': 'application/json' }\n            });\n        }\n    }\n    \n    // Support single item via GET query param\n    const itemName = url.searchParams.get('item');\n    \n    if (itemName) {\n        try {\n            if (wantReal) {\n                // Return REAL counts from user_item_preferences table\n                const [favResult, wishResult] = await Promise.all([\n                    env.DBA.prepare(`\n                        SELECT COUNT(*) as count\n                        FROM user_item_preferences\n                        WHERE item_name = ? AND preference_type = 'favorite'\n                    `).bind(itemName).first(),\n                    env.DBA.prepare(`\n                        SELECT COUNT(*) as count\n                        FROM user_item_preferences\n                        WHERE item_name = ? AND preference_type = 'wishlist'\n                    `).bind(itemName).first()\n                ]);\n                \n                const favoritesCount = favResult?.count || 0;\n                const wishlistCount = wishResult?.count || 0;\n                \n                return new Response(JSON.stringify({\n                    favorites_count: favoritesCount,\n                    wishlist_count: wishlistCount,\n                    total_count: favoritesCount + wishlistCount\n                }), {\n                    headers: { 'Content-Type': 'application/json' }\n                });\n            }\n            \n            // Get item's target_flikes and created_at for gradual display calculation\n            const item = await env.DBA.prepare(`\n                SELECT target_flikes, created_at\n                FROM items\n                WHERE name = ?\n            `).bind(itemName).first();\n            \n            // Calculate displayed value based on item age (gradual ramp over 30 days)\n            const displayedCount = item ? calculateDisplayedFlikes(item.target_flikes, item.created_at) : 0;\n            \n            return new Response(JSON.stringify({\n                favorites_count: displayedCount,\n                wishlist_count: 0,\n                total_count: displayedCount\n            }), {\n                headers: { \n                    'Content-Type': 'application/json',\n                    'Cache-Control': 'public, max-age=60' // Cache for 1 minute\n                }\n            });\n        } catch (e) {\n            console.error('Error fetching preference stats:', e);\n            return new Response(JSON.stringify({\n                favorites_count: 0,\n                wishlist_count: 0,\n                total_count: 0\n            }), {\n                headers: { 'Content-Type': 'application/json' }\n            });\n        }\n    }\n    \n    // If no item specified, return empty\n    return new Response(JSON.stringify({\n        favorites_count: 0,\n        wishlist_count: 0,\n        total_count: 0\n    }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\n// Migrate existing JSON preferences to normalized table (one-time admin operation)\nasync function handleMigrateItemPreferences(request, env) {\n    // Admin check - require authorization\n    const authHeader = request.headers.get('Authorization');\n    const token = authHeader?.replace('Bearer ', '');\n    \n    if (!token) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n    \n    const session = await env.DBA.prepare(`\n        SELECT u.user_id, u.role FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n    \n    if (!session || !session.role?.includes('admin')) {\n        return new Response(JSON.stringify({ error: 'Admin access required' }), {\n            status: 403,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n    \n    try {\n        let migratedUsers = 0;\n        let migratedItems = 0;\n        \n        // Get all favorites preferences\n        const { results: favResults } = await env.DBA.prepare(`\n            SELECT user_id, preference_value\n            FROM user_preferences\n            WHERE preference_key = 'favorites'\n        `).all();\n        \n        for (const row of (favResults || [])) {\n            try {\n                const items = JSON.parse(row.preference_value || '[]');\n                if (Array.isArray(items)) {\n                    for (const itemName of items) {\n                        if (typeof itemName === 'string' && itemName.trim()) {\n                            await env.DBA.prepare(`\n                                INSERT OR IGNORE INTO user_item_preferences (user_id, item_name, preference_type)\n                                VALUES (?, ?, 'favorite')\n                            `).bind(row.user_id, itemName).run();\n                            migratedItems++;\n                        }\n                    }\n                    migratedUsers++;\n                }\n            } catch (e) {\n                // Skip invalid JSON\n            }\n        }\n        \n        // Get all wishlist preferences\n        const { results: wishResults } = await env.DBA.prepare(`\n            SELECT user_id, preference_value\n            FROM user_preferences\n            WHERE preference_key = 'wishlist'\n        `).all();\n        \n        for (const row of (wishResults || [])) {\n            try {\n                const items = JSON.parse(row.preference_value || '[]');\n                if (Array.isArray(items)) {\n                    for (const itemName of items) {\n                        if (typeof itemName === 'string' && itemName.trim()) {\n                            await env.DBA.prepare(`\n                                INSERT OR IGNORE INTO user_item_preferences (user_id, item_name, preference_type)\n                                VALUES (?, ?, 'wishlist')\n                            `).bind(row.user_id, itemName).run();\n                            migratedItems++;\n                        }\n                    }\n                }\n            } catch (e) {\n                // Skip invalid JSON\n            }\n        }\n        \n        return new Response(JSON.stringify({\n            success: true,\n            migratedUsers,\n            migratedItems\n        }), {\n            headers: { 'Content-Type': 'application/json' }\n        });\n    } catch (e) {\n        console.error('Migration error:', e);\n        return new Response(JSON.stringify({ error: e.message }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n}\n\n// ==================== OAUTH 2.0 ====================\n\nasync function handleOAuthAuthorize(request, env) {\n    const clientId = env.ROBLOX_OAUTH_CLIENT_ID;\n    const redirectUri = env.ROBLOX_OAUTH_REDIRECT_URI;\n\n    if (!clientId || !redirectUri) {\n        return new Response(JSON.stringify({ error: 'OAuth not configured' }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Generate state parameter for CSRF protection\n    const state = crypto.randomUUID();\n\n    // Store state in a temporary table or use a different method\n    // For now, we'll pass it through and verify it in the callback\n\n    const authUrl = new URL('https://apis.roblox.com/oauth/v1/authorize');\n    authUrl.searchParams.set('client_id', clientId);\n    authUrl.searchParams.set('redirect_uri', redirectUri);\n    authUrl.searchParams.set('scope', 'openid profile');\n    authUrl.searchParams.set('response_type', 'code');\n    authUrl.searchParams.set('state', state);\n\n    // Redirect to Roblox OAuth\n    return Response.redirect(authUrl.toString(), 302);\n}\n\nasync function handleOAuthCallback(request, env) {\n    const url = new URL(request.url);\n    const origin = url.origin; // Get the full origin (e.g., https://emwiki.com)\n    const code = url.searchParams.get('code');\n    const state = url.searchParams.get('state');\n    const error = url.searchParams.get('error');\n\n    if (error) {\n        // Redirect back to site with error\n        return Response.redirect(`${origin}/?auth_error=${encodeURIComponent(error)}`, 302);\n    }\n\n    if (!code) {\n        return Response.redirect(`${origin}/?auth_error=no_code`, 302);\n    }\n\n    const clientId = env.ROBLOX_OAUTH_CLIENT_ID;\n    const clientSecret = env.ROBLOX_OAUTH_CLIENT_SECRET;\n    const redirectUri = env.ROBLOX_OAUTH_REDIRECT_URI;\n\n    try {\n        // Exchange code for access token\n        const tokenResponse = await fetch('https://apis.roblox.com/oauth/v1/token', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/x-www-form-urlencoded',\n                'Authorization': 'Basic ' + btoa(`${clientId}:${clientSecret}`)\n            },\n            body: new URLSearchParams({\n                grant_type: 'authorization_code',\n                code: code,\n                redirect_uri: redirectUri\n            })\n        });\n\n        if (!tokenResponse.ok) {\n            const errorText = await tokenResponse.text();\n            console.error('Token exchange failed:', errorText);\n            return Response.redirect(`${origin}/?auth_error=token_exchange_failed`, 302);\n        }\n\n        const tokenData = await tokenResponse.json();\n        const accessToken = tokenData.access_token;\n\n        // Fetch user info\n        const userInfoResponse = await fetch('https://apis.roblox.com/oauth/v1/userinfo', {\n            headers: {\n                'Authorization': `Bearer ${accessToken}`\n            }\n        });\n\n        if (!userInfoResponse.ok) {\n            console.error('Failed to fetch user info');\n            return Response.redirect(`${origin}/?auth_error=userinfo_failed`, 302);\n        }\n\n        const userInfo = await userInfoResponse.json();\n        const userId = userInfo.sub; // Roblox user ID\n        const username = userInfo.preferred_username;\n        const displayName = userInfo.nickname || username;\n        const avatarUrl = userInfo.picture || null;\n\n        // Create or update user in database\n        const now = Date.now();\n\n        await env.DBA.prepare(`\n            INSERT INTO users (user_id, username, display_name, avatar_url, avatar_cached_at, created_at, last_online, role)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            ON CONFLICT(user_id) DO UPDATE SET\n                username = excluded.username,\n                display_name = excluded.display_name,\n                avatar_url = excluded.avatar_url,\n                avatar_cached_at = excluded.avatar_cached_at,\n                last_online = excluded.last_online\n        `).bind(userId, username, displayName, avatarUrl, now, now, now, '[\"user\"]').run();\n\n        // Create session\n        const sessionToken = crypto.randomUUID();\n        const expiresAt = now + (3000 * 24 * 60 * 60 * 1000); // 3000 days\n\n        await env.DBA.prepare(\n            'INSERT INTO sessions (token, user_id, created_at, expires_at) VALUES (?, ?, ?, ?)'\n        ).bind(sessionToken, userId, now, expiresAt).run();\n\n        // Redirect back to site with token\n        return Response.redirect(`${origin}/?auth_success=true&token=${sessionToken}`, 302);\n    } catch (error) {\n        console.error('OAuth callback error:', error);\n        return Response.redirect(`${origin}/?auth_error=unexpected_error`, 302);\n    }\n}\n\nexport async function onRequest(context) {\n    const { request, env } = context;\n    const url = new URL(request.url);\n    const path = url.pathname.replace('/api/auth/', '');\n\n    // CORS headers\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    };\n\n    if (request.method === 'OPTIONS') {\n        return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n        let response;\n\n        switch (path) {\n            case 'generate-code':\n                response = await handleGenerateCode(request, env);\n                break;\n            case 'verify-code':\n                response = await handleVerifyCode(request, env);\n                break;\n            case 'check-code':\n                response = await handleCheckCode(request, env);\n                break;\n            case 'donation-status':\n                response = await handleDonationStatus(request, env);\n                break;\n            case 'session':\n                response = await handleGetSession(request, env);\n                break;\n            case 'logout':\n                response = await handleLogout(request, env);\n                break;\n            case 'admin/update-role':\n                response = await handleUpdateRole(request, env);\n                break;\n            case 'user/search':\n                response = await handleUserSearch(request, env);\n                break;\n            // NEW PREFERENCE ENDPOINTS\n            case 'user/preferences':\n                if (request.method === 'POST') {\n                    response = await handleSavePreferences(request, env);\n                } else if (request.method === 'GET') {\n                    response = await handleLoadPreferences(request, env);\n                }\n                break;\n            case 'user/preferences/migrate':\n                response = await handleMigratePreferences(request, env);\n                break;\n            case 'user/preferences/stats':\n                response = await handleGetPreferenceStats(request, env);\n                break;\n            case 'admin/migrate-item-preferences':\n                response = await handleMigrateItemPreferences(request, env);\n                break;\n            // OAUTH 2.0 ENDPOINTS\n            case 'oauth/authorize':\n                response = await handleOAuthAuthorize(request, env);\n                break;\n            case 'oauth/callback':\n                response = await handleOAuthCallback(request, env);\n                break;\n            default:\n                response = new Response(JSON.stringify({ error: 'Not found' }), {\n                    status: 404,\n                    headers: { 'Content-Type': 'application/json' }\n                });\n        }\n\n        // Add CORS headers to response (skip for redirects as they're immutable)\n        const isRedirect = response.status >= 300 && response.status < 400;\n        if (!isRedirect) {\n            Object.entries(corsHeaders).forEach(([key, value]) => {\n                response.headers.set(key, value);\n            });\n        }\n\n        return response;\n    } catch (error) {\n        return new Response(JSON.stringify({ error: error.message }), {\n            status: 500,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n}", "// API endpoints for item demand ratings\nimport { verifySession } from '../_utils/auth.js';\n\nexport async function onRequest(context) {\n    const { request, env } = context;\n    const url = new URL(request.url);\n    const path = url.pathname.split('/').slice(4).join('/'); // After /api/demand/\n\n    // CORS headers\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    };\n\n    if (request.method === 'OPTIONS') {\n        return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n        // Route handling\n        if (path === 'all' && request.method === 'GET') {\n            return await getAllDemand(env, corsHeaders);\n        }\n\n        if (path.startsWith('category/') && request.method === 'GET') {\n            const category = path.split('/')[1];\n            return await getCategoryDemand(env, category, corsHeaders);\n        }\n\n        if (path === 'set' && request.method === 'POST') {\n            return await setDemand(request, env, corsHeaders);\n        }\n\n        if (path === 'bulk' && request.method === 'POST') {\n            return await bulkSetDemand(request, env, corsHeaders);\n        }\n\n        return new Response(JSON.stringify({ error: 'Not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    } catch (error) {\n        console.error('Demand API error:', error);\n        return new Response(JSON.stringify({ error: error.message }), {\n            status: 500,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n}\n\n// Get all demand ratings\nasync function getAllDemand(env, corsHeaders) {\n    const { results } = await env.DBA.prepare(`\n        SELECT name as item_name, category, demand, demand_updated_at as updated_at\n        FROM items\n        ORDER BY category, name\n    `).all();\n\n    return new Response(JSON.stringify({ demand: results || [] }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Get demand ratings for a specific category\nasync function getCategoryDemand(env, category, corsHeaders) {\n    const { results } = await env.DBA.prepare(`\n        SELECT name as item_name, demand, demand_updated_at as updated_at\n        FROM items\n        WHERE category = ?\n        ORDER BY name\n    `).bind(category).all();\n\n    return new Response(JSON.stringify({ demand: results || [] }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Set demand for a single item (admin only)\nasync function setDemand(request, env, corsHeaders) {\n    // Verify admin session - check cookie\n    const cookieHeader = request.headers.get('Cookie') || '';\n    const sessionToken = cookieHeader\n        .split('; ')\n        .find(c => c.startsWith('session='))\n        ?.split('=')[1];\n\n    if (!sessionToken) {\n        return new Response(JSON.stringify({ error: 'Unauthorized - No session' }), {\n            status: 401,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const session = await verifySession(sessionToken, env.SECRET_KEY);\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Unauthorized - Invalid session' }), {\n            status: 401,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if user is admin (using DBH for admins table)\n    const admin = await env.DBH.prepare('SELECT name FROM admins WHERE name = ?')\n        .bind(session.name)\n        .first();\n\n    if (!admin) {\n        return new Response(JSON.stringify({ error: 'Insufficient permissions' }), {\n            status: 403,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const data = await request.json();\n    const { item_name, category, demand } = data;\n\n    if (!item_name || !category || demand === undefined) {\n        return new Response(JSON.stringify({ error: 'Missing required fields' }), {\n            status: 400,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    if (demand < 0 || demand > 5 || !Number.isInteger(demand)) {\n        return new Response(JSON.stringify({ error: 'Demand must be an integer between 0 and 5' }), {\n            status: 400,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Update demand rating in items table\n    const result = await env.DBA.prepare(`\n        UPDATE items\n        SET demand = ?, demand_updated_at = strftime('%s', 'now')\n        WHERE name = ? AND category = ?\n    `).bind(demand, item_name, category).run();\n\n    if (result.meta.changes === 0) {\n        return new Response(JSON.stringify({ error: 'Item not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    return new Response(JSON.stringify({\n        success: true,\n        message: 'Demand updated successfully',\n        demand: { item_name, category, demand }\n    }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Bulk set demand ratings (admin only)\nasync function bulkSetDemand(request, env, corsHeaders) {\n    // Verify admin session - check cookie\n    const cookieHeader = request.headers.get('Cookie') || '';\n    const sessionToken = cookieHeader\n        .split('; ')\n        .find(c => c.startsWith('session='))\n        ?.split('=')[1];\n\n    if (!sessionToken) {\n        return new Response(JSON.stringify({ error: 'Unauthorized - No session' }), {\n            status: 401,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const session = await verifySession(sessionToken, env.SECRET_KEY);\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Unauthorized - Invalid session' }), {\n            status: 401,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if user is admin (using DBH for admins table)\n    const admin = await env.DBH.prepare('SELECT name FROM admins WHERE name = ?')\n        .bind(session.name)\n        .first();\n\n    if (!admin) {\n        return new Response(JSON.stringify({ error: 'Insufficient permissions' }), {\n            status: 403,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const data = await request.json();\n    const { items } = data;\n\n    if (!Array.isArray(items) || items.length === 0) {\n        return new Response(JSON.stringify({ error: 'items must be a non-empty array' }), {\n            status: 400,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Validate all items before processing\n    for (const item of items) {\n        if (!item.item_name || !item.category || item.demand === undefined) {\n            return new Response(JSON.stringify({ error: 'Each item must have item_name, category, and demand' }), {\n                status: 400,\n                headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n            });\n        }\n        if (item.demand < 0 || item.demand > 5 || !Number.isInteger(item.demand)) {\n            return new Response(JSON.stringify({ error: 'Demand must be an integer between 0 and 5' }), {\n                status: 400,\n                headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n            });\n        }\n    }\n\n    // Process all items in a batch - update demand in items table\n    const batch = [];\n    for (const item of items) {\n        batch.push(\n            env.DBA.prepare(`\n                UPDATE items\n                SET demand = ?, demand_updated_at = strftime('%s', 'now')\n                WHERE name = ? AND category = ?\n            `).bind(item.demand, item.item_name, item.category)\n        );\n    }\n\n    await env.DBA.batch(batch);\n\n    return new Response(JSON.stringify({\n        success: true,\n        message: `Successfully updated ${items.length} item(s)`,\n        count: items.length\n    }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n", "/**\r\n * Image serving endpoint - redirects to Cloudflare Images URLs with optimizations\r\n * \r\n * This endpoint looks up image paths in the database and redirects to Cloudflare Images URLs.\r\n * Cloudflare Images provides automatic optimization, format conversion (WebP/AVIF), and resizing.\r\n * \r\n * Usage Examples:\r\n *   /api/images/items/gears/yY4PlAA.png                          # Original size\r\n *   /api/images/items/gears/yY4PlAA.png?width=200                # Resize to 200px width\r\n *   /api/images/items/gears/yY4PlAA.png?width=200&height=200     # Resize to 200x200\r\n *   /api/images/items/gears/yY4PlAA.png?width=200&fit=cover      # Cover fit mode\r\n *   /api/images/items/gears/yY4PlAA.png?width=200&quality=90     # Higher quality\r\n *   /api/images/items/gears/yY4PlAA.png?width=200&format=webp     # Force WebP\r\n * \r\n * Query Parameters (passed to Cloudflare Images):\r\n *   - width: Target width in pixels (maintains aspect ratio if height not specified)\r\n *   - height: Target height in pixels (maintains aspect ratio if width not specified)\r\n *   - fit: Resize fit mode:\r\n *     * scale-down: Only resize if image is larger (default)\r\n *     * contain: Fit entire image within dimensions\r\n *     * cover: Fill dimensions, may crop\r\n *     * crop: Crop to exact dimensions\r\n *     * pad: Add padding to fit dimensions\r\n *   - quality: JPEG/WebP quality (1-100, default: 85)\r\n *   - format: Output format (webp, avif, jpeg, png). If not specified, browser-optimal format is chosen automatically.\r\n * \r\n * Note: Format conversion (WebP/AVIF) is automatic based on browser support if format is not specified.\r\n */\r\n\r\nexport async function onRequest(context) {\r\n  const { request, env, params } = context;\r\n  const url = new URL(request.url);\r\n  \r\n  // Cloudflare Images account hash\r\n  const CF_ACCOUNT_HASH = env.CF_ACCOUNT_HASH || 'I2Jsf9fuZwSztWJZaX0DJA';\r\n  \r\n  // Get the image path from params (everything after /api/images/)\r\n  const imagePath = params.path ? params.path.join('/') : '';\r\n  \r\n  if (!imagePath) {\r\n    return new Response('Image path required', { status: 400 });\r\n  }\r\n\r\n  // Normalize path: convert backslashes to forward slashes, remove leading slashes\r\n  const normalizedPath = imagePath.replace(/\\\\/g, '/').replace(/^\\/+/, '');\r\n  \r\n  // Handle both old format (imgs/gears/file.png) and new format (items/gears/file.png)\r\n  let lookupPath = normalizedPath;\r\n  if (lookupPath.startsWith('imgs/')) {\r\n    lookupPath = lookupPath.replace('imgs/', 'items/');\r\n  } else if (!lookupPath.startsWith('items/')) {\r\n    lookupPath = `items/${lookupPath}`;\r\n  }\r\n\r\n  try {\r\n    // Look up image URL in database\r\n    // First, try to find an item with this image path\r\n    const item = await env.DBA.prepare(`\r\n      SELECT img FROM items \r\n      WHERE img LIKE ? OR img LIKE ?\r\n      LIMIT 1\r\n    `).bind(\r\n      `%${normalizedPath}%`,\r\n      `%${lookupPath}%`\r\n    ).first();\r\n\r\n    if (item && item.img) {\r\n      // Check if it's already a Cloudflare Images URL\r\n      if (item.img.includes('imagedelivery.net') || item.img.includes('cloudflare-images.com')) {\r\n        // It's already a Cloudflare Images URL, add transformations via query params\r\n        const imageUrl = new URL(item.img);\r\n        \r\n        // Extract transformation parameters\r\n        const width = url.searchParams.get('width');\r\n        const height = url.searchParams.get('height');\r\n        const fit = url.searchParams.get('fit') || 'scale-down'; // Default fit mode\r\n        const quality = url.searchParams.get('quality');\r\n        const format = url.searchParams.get('format');\r\n        \r\n        // Cloudflare Images supports transformations via query parameters\r\n        // These are applied automatically by Cloudflare's edge\r\n        if (width) imageUrl.searchParams.set('width', width);\r\n        if (height) imageUrl.searchParams.set('height', height);\r\n        if (fit) imageUrl.searchParams.set('fit', fit);\r\n        if (quality) imageUrl.searchParams.set('quality', quality);\r\n        if (format) imageUrl.searchParams.set('format', format);\r\n        \r\n        return Response.redirect(imageUrl.toString(), 302);\r\n      }\r\n      \r\n      // If it's not a Cloudflare Images URL yet, try to extract image ID if it's stored\r\n      // Otherwise, we'll need to look it up or return 404\r\n    }\r\n\r\n    // Fallback: Try to serve from R2 if image not found in database\r\n    // This handles the case where database hasn't been updated yet\r\n    try {\r\n      // Try to get image from R2 as fallback\r\n      const r2Key = normalizedPath.startsWith('items/') ? normalizedPath : `items/${normalizedPath}`;\r\n      \r\n      // Handle uploads differently\r\n      let finalR2Key = r2Key;\r\n      if (r2Key.startsWith('items/uploads/')) {\r\n        finalR2Key = r2Key.replace('items/uploads/', 'uploads/');\r\n      }\r\n      \r\n      const object = await env.MY_BUCKET?.get(finalR2Key);\r\n      \r\n      if (object) {\r\n        // Serve from R2\r\n        const imageData = await object.arrayBuffer();\r\n        const contentType = object.httpMetadata?.contentType || 'image/png';\r\n        \r\n        return new Response(imageData, {\r\n          headers: {\r\n            'Content-Type': contentType,\r\n            'Cache-Control': 'public, max-age=31536000, immutable',\r\n            'Access-Control-Allow-Origin': '*',\r\n            'Access-Control-Allow-Methods': 'GET',\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Not found in R2 either\r\n      return new Response('Image not found', { \r\n        status: 404,\r\n        headers: {\r\n          'Content-Type': 'text/plain',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    } catch (error) {\r\n      return new Response('Image not found', { \r\n        status: 404,\r\n        headers: {\r\n          'Content-Type': 'text/plain',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('Error serving image:', error);\r\n    return new Response('Error serving image: ' + error.message, { \r\n      status: 500,\r\n      headers: {\r\n        'Content-Type': 'text/plain',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n", "// API endpoints for items\n\n/**\n * Normalize image URL to use Cloudflare Images\n * \n * If image is already a Cloudflare Images URL, return as-is.\n * Otherwise, convert local paths to our image API endpoint which will redirect to Cloudflare Images.\n */\nfunction normalizeImageUrl(imgPath) {\n    if (!imgPath) return null;\n    \n    // If already a full URL (Cloudflare Images or other), return as-is\n    if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {\n        return imgPath;\n    }\n    \n    // Convert Windows backslashes to forward slashes\n    let normalized = imgPath.replace(/\\\\/g, '/');\n    \n    // Remove leading ./ or / if present\n    normalized = normalized.replace(/^\\.?\\//, '');\n    \n    // Convert imgs/ to items/ for consistency\n    if (normalized.startsWith('imgs/')) {\n        normalized = normalized.replace('imgs/', 'items/');\n    } else if (!normalized.startsWith('items/')) {\n        normalized = `items/${normalized}`;\n    }\n    \n    // Return URL pointing to our image API endpoint\n    // The endpoint will look up the Cloudflare Images URL from the database\n    return `https://emwiki.com/api/images/${normalized}`;\n}\n\nexport async function onRequest(context) {\n    const { request, env } = context;\n    const url = new URL(request.url);\n    const pathParts = url.pathname.split('/').filter(p => p);\n    \n    // Extract path after /api/items/\n    const pathIndex = pathParts.indexOf('items');\n    const path = pathIndex >= 0 ? pathParts.slice(pathIndex + 1).join('/') : '';\n\n    // CORS headers\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    };\n\n    if (request.method === 'OPTIONS') {\n        return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n        // Route handling\n        if (request.method === 'GET') {\n            // GET /api/items/categories - Get item counts per category\n            if (path === 'categories') {\n                return await getCategories(env, corsHeaders);\n            }\n\n            // GET /api/items/search - Search items by name\n            if (path === 'search') {\n                return await searchItems(request, env, corsHeaders);\n            }\n\n            // GET /api/items/homepage - Get items for homepage (new, weekly, weeklystar, random)\n            if (path === 'homepage') {\n                return await getHomepageItems(env, corsHeaders);\n            }\n\n            // GET /api/items/random - Get a single random item\n            if (path === 'random') {\n                return await getRandomItem(env, corsHeaders);\n            }\n\n            // GET /api/items/:category/:name - Get single item\n            const pathMatch = path.match(/^([^/]+)\\/(.+)$/);\n            if (pathMatch) {\n                const [, category, name] = pathMatch;\n                return await getItem(category, decodeURIComponent(name), env, corsHeaders);\n            }\n\n            // GET /api/items - List items with pagination and filtering\n            return await listItems(request, env, corsHeaders);\n        }\n\n        // POST /api/items/batch - Fetch multiple items by name\n        if (request.method === 'POST' && path === 'batch') {\n            return await batchGetItems(request, env, corsHeaders);\n        }\n\n        // POST /api/items - Create new item (admin only)\n        if (request.method === 'POST' && path === '') {\n            return await createItem(request, env, corsHeaders);\n        }\n\n        // PUT /api/items/:id - Update item (admin only)\n        if (request.method === 'PUT') {\n            const idMatch = path.match(/^(\\d+)$/);\n            if (idMatch) {\n                const [, id] = idMatch;\n                return await updateItem(id, request, env, corsHeaders);\n            }\n        }\n\n        // DELETE /api/items/:id - Delete item (admin only)\n        if (request.method === 'DELETE') {\n            const idMatch = path.match(/^(\\d+)$/);\n            if (idMatch) {\n                const [, id] = idMatch;\n                return await deleteItem(id, env, corsHeaders);\n            }\n        }\n\n        return new Response(JSON.stringify({ error: 'Not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    } catch (error) {\n        console.error('Items API error:', error);\n        return new Response(JSON.stringify({ error: error.message }), {\n            status: 500,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n}\n\n// Get item counts per category\nasync function getCategories(env, corsHeaders) {\n    const { results } = await env.DBA.prepare(`\n        SELECT category, COUNT(*) as count\n        FROM items\n        GROUP BY category\n        ORDER BY category\n    `).all();\n\n    const categories = {};\n    if (results) {\n        results.forEach(row => {\n            categories[row.category] = row.count;\n        });\n    }\n\n    return new Response(JSON.stringify({ categories }), {\n        headers: {\n            ...corsHeaders,\n            'Content-Type': 'application/json',\n            'Cache-Control': 'public, max-age=300' // Cache for 5 minutes\n        }\n    });\n}\n\n// Get items for homepage (new, weekly, weeklystar items + random item + stats)\nasync function getHomepageItems(env, corsHeaders) {\n    // Run queries in parallel for better performance\n    const [featuredResults, statsResult, randomResult] = await Promise.all([\n        // Get all featured items (new, weekly, or weeklystar)\n        env.DBA.prepare(`\n            SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n                   tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup, demand,\n                   credits, lore, alias, quantity, color, demand_updated_at, updated_at\n            FROM items\n            WHERE \"new\" = 1 OR weekly = 1 OR weeklystar = 1\n            ORDER BY category, name\n        `).all(),\n        \n        // Get stats (total items and new items count)\n        env.DBA.prepare(`\n            SELECT \n                COUNT(*) as totalItems,\n                SUM(CASE WHEN \"new\" = 1 THEN 1 ELSE 0 END) as newItemsCount\n            FROM items\n        `).first(),\n        \n        // Get 1 random item\n        env.DBA.prepare(`\n            SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n                   tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup, demand,\n                   credits, lore, alias, quantity, color, demand_updated_at, updated_at\n            FROM items\n            ORDER BY RANDOM()\n            LIMIT 1\n        `).first()\n    ]);\n\n    const featured = featuredResults.results || [];\n    \n    // Transform items helper\n    const transformItem = (item) => ({\n        ...item,\n        img: normalizeImageUrl(item.img),\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        'price/code/rarity': item.price_code_rarity\n    });\n\n    // Separate items into categories\n    const newItems = featured.filter(item => item.new === 1).slice(0, 50).map(transformItem);\n    const weeklyItems = featured.filter(item => item.weekly === 1).slice(0, 8).map(transformItem);\n    const weeklystarItems = featured.filter(item => item.weeklystar === 1).slice(0, 8).map(transformItem);\n    const randomItem = randomResult ? transformItem(randomResult) : null;\n\n    return new Response(JSON.stringify({\n        newItems,\n        weeklyItems,\n        weeklystarItems,\n        randomItem,\n        stats: {\n            totalItems: statsResult?.totalItems || 0,\n            newItemsCount: statsResult?.newItemsCount || 0\n        }\n    }), {\n        headers: {\n            ...corsHeaders,\n            'Content-Type': 'application/json',\n            'Cache-Control': 'public, max-age=60' // Cache for 1 minute\n        }\n    });\n}\n\n// Get a single random item\nasync function getRandomItem(env, corsHeaders) {\n    const item = await env.DBA.prepare(`\n        SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n               tradable, \"new\", weekly, weeklystar, retired, premium, removed, demand,\n               credits, lore, alias, quantity, color, demand_updated_at, updated_at\n        FROM items\n        ORDER BY RANDOM()\n        LIMIT 1\n    `).first();\n\n    if (!item) {\n        return new Response(JSON.stringify({ error: 'No items found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const result = {\n        ...item,\n        img: normalizeImageUrl(item.img),\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        'price/code/rarity': item.price_code_rarity\n    };\n\n    return new Response(JSON.stringify({ item: result }), {\n        headers: {\n            ...corsHeaders,\n            'Content-Type': 'application/json',\n            'Cache-Control': 'no-cache' // Don't cache random items\n        }\n    });\n}\n\n// Search items by name (optimized for autocomplete)\nasync function searchItems(request, env, corsHeaders) {\n    const url = new URL(request.url);\n    const query = url.searchParams.get('q') || '';\n    const category = url.searchParams.get('category') || '';\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n\n    if (!query || query.length < 1) {\n        return new Response(JSON.stringify({ items: [] }), {\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    let sql = `\n        SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n               tradable, \"new\", weekly, weeklystar, retired, premium, removed, demand,\n               credits, lore, alias, quantity, color, demand_updated_at, updated_at\n        FROM items\n        WHERE name LIKE ?\n    `;\n    const params = [`%${query}%`];\n\n    if (category) {\n        sql += ` AND category = ?`;\n        params.push(category);\n    }\n\n    sql += ` ORDER BY name LIMIT ?`;\n    params.push(limit);\n\n    const { results } = await env.DBA.prepare(sql).bind(...params).all();\n\n    const items = (results || []).map(item => ({\n        ...item,\n        img: normalizeImageUrl(item.img), // Normalize image URL to use R2\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        'price/code/rarity': item.price_code_rarity\n    }));\n\n    return new Response(JSON.stringify({ items }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Batch fetch items by name (for wishlists, etc.)\nasync function batchGetItems(request, env, corsHeaders) {\n    let data;\n    try {\n        data = await request.json();\n    } catch (e) {\n        return new Response(JSON.stringify({ error: 'Invalid JSON body' }), {\n            status: 400,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const { names } = data;\n\n    if (!names || !Array.isArray(names) || names.length === 0) {\n        return new Response(JSON.stringify({ items: [] }), {\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Limit to 100 items per batch to prevent abuse\n    const limitedNames = names.slice(0, 100);\n\n    // Build parameterized query with placeholders\n    const placeholders = limitedNames.map(() => '?').join(', ');\n    const sql = `\n        SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n               tradable, \"new\", weekly, weeklystar, retired, premium, removed, demand,\n               credits, lore, alias, quantity, color, demand_updated_at, updated_at\n        FROM items\n        WHERE name IN (${placeholders})\n        ORDER BY name\n    `;\n\n    const { results } = await env.DBA.prepare(sql).bind(...limitedNames).all();\n\n    const items = (results || []).map(item => ({\n        ...item,\n        img: normalizeImageUrl(item.img),\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        typicalgroup: item.typicalgroup === 1,\n        'price/code/rarity': item.price_code_rarity,\n        color: item.color ? JSON.parse(item.color) : null\n    }));\n\n    return new Response(JSON.stringify({ items }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Get single item by category and name\nasync function getItem(category, name, env, corsHeaders) {\n    const item = await env.DBA.prepare(`\n        SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n               tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup,\n               price_history, demand, credits, lore, alias, quantity, color, demand_updated_at, created_at, updated_at\n        FROM items\n        WHERE category = ? AND name = ?\n    `).bind(category, name).first();\n\n    if (!item) {\n        return new Response(JSON.stringify({ error: 'Item not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const result = {\n        ...item,\n        img: normalizeImageUrl(item.img), // Normalize image URL to use R2\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        'price/code/rarity': item.price_code_rarity,\n        priceHistory: item.price_history ? JSON.parse(item.price_history) : null,\n        color: item.color ? JSON.parse(item.color) : null\n    };\n\n    return new Response(JSON.stringify({ item: result }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// List items with pagination and filtering\nasync function listItems(request, env, corsHeaders) {\n    const url = new URL(request.url);\n    \n    // Pagination\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '100'), 2500);\n    const offset = Math.max(parseInt(url.searchParams.get('offset') || '0'), 0);\n    \n    // Filters\n    const category = url.searchParams.get('category') || '';\n    const search = url.searchParams.get('search') || '';\n    const tradable = url.searchParams.get('tradable');\n    const premium = url.searchParams.get('premium');\n    const retired = url.searchParams.get('retired');\n    const newFilter = url.searchParams.get('new');\n    const weekly = url.searchParams.get('weekly');\n    const weeklystar = url.searchParams.get('weeklystar');\n\n    // Build WHERE clause\n    const conditions = [];\n    const params = [];\n\n    if (category) {\n        conditions.push('category = ?');\n        params.push(category);\n    }\n\n    if (search) {\n        conditions.push('name LIKE ?');\n        params.push(`%${search}%`);\n    }\n\n    if (tradable !== null) {\n        conditions.push('tradable = ?');\n        params.push(tradable === 'true' || tradable === '1' ? 1 : 0);\n    }\n\n    if (premium !== null) {\n        conditions.push('premium = ?');\n        params.push(premium === 'true' || premium === '1' ? 1 : 0);\n    }\n\n    if (retired !== null) {\n        conditions.push('retired = ?');\n        params.push(retired === 'true' || retired === '1' ? 1 : 0);\n    }\n\n    if (newFilter !== null) {\n        conditions.push('\"new\" = ?');\n        params.push(newFilter === 'true' || newFilter === '1' ? 1 : 0);\n    }\n\n    if (weekly !== null) {\n        conditions.push('weekly = ?');\n        params.push(weekly === 'true' || weekly === '1' ? 1 : 0);\n    }\n\n    if (weeklystar !== null) {\n        conditions.push('weeklystar = ?');\n        params.push(weeklystar === 'true' || weeklystar === '1' ? 1 : 0);\n    }\n\n    const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';\n\n    // Only run count query if specifically needed (offset pagination or smaller batches)\n    // Skip for bulk fetches (limit >= 500 and offset === 0) to improve performance\n    let total = null;\n    if (offset > 0 || limit < 500) {\n        const countResult = await env.DBA.prepare(`\n            SELECT COUNT(*) as total\n            FROM items\n            ${whereClause}\n        `).bind(...params).first();\n        total = countResult?.total || 0;\n    }\n\n    // Get items (include updated_at for optimistic locking, target_flikes for sorting)\n    const { results } = await env.DBA.prepare(`\n        SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n               tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup, demand, \n               credits, lore, alias, quantity, color, demand_updated_at, updated_at, price_history,\n               target_flikes, created_at\n        FROM items\n        ${whereClause}\n        ORDER BY category, name\n        LIMIT ? OFFSET ?\n    `).bind(...params, limit, offset).all();\n\n    // Helper to calculate displayed flikes (gradual ramp over 30 days)\n    const calculateDisplayedFlikes = (targetFlikes, createdAt) => {\n        if (!targetFlikes || targetFlikes <= 0) return 0;\n        const now = Date.now();\n        const createdAtMs = createdAt * 1000;\n        const ageDays = (now - createdAtMs) / (1000 * 60 * 60 * 24);\n        const progress = Math.min(ageDays / 30, 1);\n        return Math.floor(targetFlikes * progress);\n    };\n\n    const items = (results || []).map(item => ({\n        ...item,\n        img: normalizeImageUrl(item.img), // Normalize image URL to use R2\n        tradable: item.tradable === 1,\n        new: item.new === 1,\n        weekly: item.weekly === 1,\n        weeklystar: item.weeklystar === 1,\n        retired: item.retired === 1,\n        premium: item.premium === 1,\n        removed: item.removed === 1,\n        'price/code/rarity': item.price_code_rarity,\n        priceHistory: item.price_history ? JSON.parse(item.price_history) : null,\n        color: item.color ? JSON.parse(item.color) : null,\n        // Include calculated flikes for sorting (gradual ramp based on item age)\n        flikes: calculateDisplayedFlikes(item.target_flikes, item.created_at)\n    }));\n\n    return new Response(JSON.stringify({\n        items,\n        total,\n        limit,\n        offset\n    }), {\n        headers: {\n            ...corsHeaders,\n            'Content-Type': 'application/json',\n            'Cache-Control': 'public, max-age=3' // Cache for 3 seconds\n        }\n    });\n}\n\n// Create new item (admin only)\nasync function createItem(request, env, corsHeaders) {\n    // TODO: Add admin authentication check\n    const data = await request.json();\n    \n    const {\n        name, category, img, svg, price, from, price_code_rarity,\n        tradable, new: newItem, weekly, weeklystar, retired, premium, removed,\n        price_history, demand, credits, lore, alias, quantity, color\n    } = data;\n\n    if (!name || !category) {\n        return new Response(JSON.stringify({ error: 'Name and category are required' }), {\n            status: 400,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    const result = await env.DBA.prepare(`\n        INSERT INTO items (\n            name, category, img, svg, price, \"from\", price_code_rarity,\n            tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup,\n            price_history, demand, credits, lore, alias, quantity, color, demand_updated_at, created_at, updated_at\n        )\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\n                CASE WHEN ? > 0 THEN strftime('%s', 'now') ELSE NULL END,\n                strftime('%s', 'now'), strftime('%s', 'now'))\n    `).bind(\n        name, category, img || null, svg || null, price || null, from || null,\n        price_code_rarity || null,\n        tradable !== false ? 1 : 0,\n        newItem === true ? 1 : 0,\n        weekly === true ? 1 : 0,\n        weeklystar === true ? 1 : 0,\n        retired === true ? 1 : 0,\n        premium === true ? 1 : 0,\n        removed === true ? 1 : 0,\n        typicalgroup === true ? 1 : 0,\n        price_history ? JSON.stringify(price_history.slice(-15)) : null,\n        demand || 0,\n        credits || null,\n        lore || null,\n        alias || null,\n        quantity || null,\n        color ? JSON.stringify(color) : null,\n        demand || 0 // For demand_updated_at check\n    ).run();\n\n    return new Response(JSON.stringify({\n        success: true,\n        id: result.meta.last_row_id,\n        message: 'Item created successfully'\n    }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Update item (admin only)\nasync function updateItem(id, request, env, corsHeaders) {\n    // TODO: Add admin authentication check\n    const data = await request.json();\n    \n    const {\n        name, category, img, svg, price, from, price_code_rarity,\n        tradable, new: newItem, weekly, weeklystar, retired, premium, removed, typicalgroup,\n        price_history, demand, credits, lore, alias, quantity, color, updated_at: clientUpdatedAt,\n        force_update_demand_timestamp\n    } = data;\n\n    // Optimistic locking: Check if item was modified since client loaded it\n    if (clientUpdatedAt !== undefined) {\n        const currentItem = await env.DBA.prepare(`\n            SELECT updated_at FROM items WHERE id = ?\n        `).bind(id).first();\n\n        if (!currentItem) {\n            return new Response(JSON.stringify({ error: 'Item not found' }), {\n                status: 404,\n                headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n            });\n        }\n\n        // If the item was updated after the client loaded it, return conflict\n        if (currentItem.updated_at !== clientUpdatedAt) {\n            // Get current item data to show what changed\n            const currentItemData = await env.DBA.prepare(`\n                SELECT id, name, category, img, svg, price, \"from\", price_code_rarity,\n                       tradable, \"new\", weekly, weeklystar, retired, premium, removed, typicalgroup,\n                       price_history, demand, credits, lore, demand_updated_at, updated_at\n                FROM items WHERE id = ?\n            `).bind(id).first();\n\n            return new Response(JSON.stringify({\n                error: 'Conflict: Item was modified by another admin',\n                conflict: true,\n                currentItem: {\n                    ...currentItemData,\n                    tradable: currentItemData.tradable === 1,\n                    new: currentItemData.new === 1,\n                    weekly: currentItemData.weekly === 1,\n                    weeklystar: currentItemData.weeklystar === 1,\n                    retired: currentItemData.retired === 1,\n                    premium: currentItemData.premium === 1,\n                    removed: currentItemData.removed === 1,\n                    typicalgroup: currentItemData.typicalgroup === 1,\n                    'price/code/rarity': currentItemData.price_code_rarity,\n                    priceHistory: currentItemData.price_history ? JSON.parse(currentItemData.price_history) : null\n                },\n                clientUpdatedAt,\n                serverUpdatedAt: currentItem.updated_at\n            }), {\n                status: 409,\n                headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n            });\n        }\n    }\n\n    // Check if demand is being updated - if so, update demand_updated_at\n    // Also update if force_update_demand_timestamp flag is set (for \"Keep Demand\" button)\n    let demandChanged = false;\n    if (demand !== undefined) {\n        const currentItem = await env.DBA.prepare(`\n            SELECT demand FROM items WHERE id = ?\n        `).bind(id).first();\n        demandChanged = currentItem && currentItem.demand !== demand;\n    }\n    \n    // Force update demand_updated_at if flag is set (even if demand didn't change)\n    if (force_update_demand_timestamp === true) {\n        demandChanged = true;\n    }\n\n    // Merge price_history: get existing history and merge with incoming history\n    let mergedPriceHistory = null;\n    if (price_history !== undefined) {\n        // Get current price_history from database\n        const currentItem = await env.DBA.prepare(`\n            SELECT price_history FROM items WHERE id = ?\n        `).bind(id).first();\n        \n        let existingHistory = [];\n        if (currentItem && currentItem.price_history) {\n            try {\n                existingHistory = JSON.parse(currentItem.price_history);\n                if (!Array.isArray(existingHistory)) {\n                    existingHistory = [];\n                }\n            } catch (e) {\n                existingHistory = [];\n            }\n        }\n        \n        // Merge: combine existing history with incoming history\n        // Incoming history should be an array of new entries\n        let incomingHistory = Array.isArray(price_history) ? price_history : [];\n        \n        // Combine histories and remove duplicates (same price and timestamp)\n        const combinedHistory = [...existingHistory];\n        incomingHistory.forEach(newEntry => {\n            // Check if this entry already exists (same price and timestamp)\n            const exists = combinedHistory.some(existing => \n                existing.price === newEntry.price && \n                existing.timestamp === newEntry.timestamp\n            );\n            if (!exists) {\n                combinedHistory.push(newEntry);\n            }\n        });\n        \n        // Sort by timestamp and keep only last 15 entries\n        combinedHistory.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));\n        mergedPriceHistory = combinedHistory.slice(-15);\n    }\n\n    const result = await env.DBA.prepare(`\n        UPDATE items SET\n            name = COALESCE(?, name),\n            category = COALESCE(?, category),\n            img = ?,\n            svg = ?,\n            price = ?,\n            \"from\" = ?,\n            price_code_rarity = ?,\n            tradable = COALESCE(?, tradable),\n            \"new\" = COALESCE(?, \"new\"),\n            weekly = COALESCE(?, weekly),\n            weeklystar = COALESCE(?, weeklystar),\n            retired = COALESCE(?, retired),\n            premium = COALESCE(?, premium),\n            removed = COALESCE(?, removed),\n            typicalgroup = COALESCE(?, typicalgroup),\n            price_history = CASE WHEN ? IS NOT NULL THEN ? ELSE price_history END,\n            demand = COALESCE(?, demand),\n            credits = ?,\n            lore = ?,\n            alias = ?,\n            quantity = ?,\n            color = ?,\n            demand_updated_at = CASE WHEN ? = 1 THEN strftime('%s', 'now') ELSE demand_updated_at END,\n            updated_at = strftime('%s', 'now')\n        WHERE id = ?\n    `).bind(\n        name, category, img, svg, price, from, price_code_rarity,\n        tradable !== undefined ? (tradable ? 1 : 0) : null,\n        newItem !== undefined ? (newItem ? 1 : 0) : null,\n        weekly !== undefined ? (weekly ? 1 : 0) : null,\n        weeklystar !== undefined ? (weeklystar ? 1 : 0) : null,\n        retired !== undefined ? (retired ? 1 : 0) : null,\n        premium !== undefined ? (premium ? 1 : 0) : null,\n        removed !== undefined ? (removed ? 1 : 0) : null,\n        typicalgroup !== undefined ? (typicalgroup ? 1 : 0) : null,\n        mergedPriceHistory ? JSON.stringify(mergedPriceHistory) : null,\n        mergedPriceHistory ? JSON.stringify(mergedPriceHistory) : null,\n        demand,\n        credits !== undefined ? credits : null,\n        lore !== undefined ? lore : null,\n        alias !== undefined ? alias : null,\n        quantity !== undefined ? quantity : null,\n        color !== undefined ? (color ? JSON.stringify(color) : null) : null,\n        demandChanged ? 1 : 0, // Update demand_updated_at if demand changed\n        id\n    ).run();\n\n    if (result.meta.changes === 0) {\n        return new Response(JSON.stringify({ error: 'Item not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    return new Response(JSON.stringify({\n        success: true,\n        message: 'Item updated successfully'\n    }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n// Delete item (admin only)\nasync function deleteItem(id, env, corsHeaders) {\n    // TODO: Add admin authentication check\n    const result = await env.DBA.prepare(`\n        DELETE FROM items WHERE id = ?\n    `).bind(id).run();\n\n    if (result.meta.changes === 0) {\n        return new Response(JSON.stringify({ error: 'Item not found' }), {\n            status: 404,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n\n    return new Response(JSON.stringify({\n        success: true,\n        message: 'Item deleted successfully'\n    }), {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n    });\n}\n\n", "// Profile API endpoints\n\nasync function handleGetProfile(request, env) {\n    const url = new URL(request.url);\n    const pathParts = url.pathname.split('/api/profile/').filter(Boolean);\n    let userId = pathParts[0];\n\n    if (!userId) {\n        return new Response(JSON.stringify({ error: 'User ID required' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Try with both userId and userId.0 to handle database inconsistencies\n    const userIdWithSuffix = userId.includes('.') ? userId : `${userId}.0`;\n\n    // Get user basic info\n    const user = await env.DBA.prepare(`\n        SELECT\n            user_id,\n            username,\n            display_name,\n            avatar_url,\n            role,\n            created_at,\n            last_online\n        FROM users\n        WHERE user_id = ? OR user_id = ?\n    `).bind(userId, userIdWithSuffix).first();\n\n    if (!user) {\n        return new Response(JSON.stringify({ error: 'User not found' }), {\n            status: 404,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Use the actual user_id from the database for subsequent queries\n    const actualUserId = user.user_id;\n\n    // Get user trade stats\n    let stats = null;\n    try {\n        stats = await env.DBA.prepare(`\n            SELECT\n                total_trades,\n                successful_trades,\n                average_rating,\n                total_reviews,\n                last_trade_at\n            FROM user_trade_stats\n            WHERE user_id = ?\n        `).bind(actualUserId).first();\n    } catch (e) {\n        console.error('Failed to fetch user_trade_stats (table might not exist):', e);\n        stats = null;\n    }\n\n    // Get user reviews\n    let reviews = [];\n    try {\n        const reviewsResult = await env.DBA.prepare(`\n            SELECT\n                r.*,\n                u.username as reviewer_username,\n                u.display_name as reviewer_display_name,\n                u.avatar_url as reviewer_avatar\n            FROM trade_reviews r\n            JOIN users u ON r.reviewer_id = u.user_id\n            WHERE r.reviewed_user_id = ?\n            ORDER BY r.created_at DESC\n            LIMIT 10\n        `).bind(actualUserId).all();\n        reviews = reviewsResult.results || [];\n    } catch (e) {\n        console.error('Failed to fetch trade_reviews (table might not exist):', e);\n        reviews = [];\n    }\n\n    // Get recent completed trades (limited info for privacy)\n    let recentTrades = [];\n    try {\n        const tradesResult = await env.DBA.prepare(`\n            SELECT\n                ct.id,\n                ct.item_name,\n                ct.completed_at,\n                CASE\n                    WHEN ct.seller_id = ? THEN 'seller'\n                    ELSE 'buyer'\n                END as role\n            FROM completed_trades ct\n            WHERE ct.seller_id = ? OR ct.buyer_id = ?\n            ORDER BY ct.completed_at DESC\n            LIMIT 5\n        `).bind(actualUserId, actualUserId, actualUserId).all();\n        recentTrades = tradesResult.results || [];\n    } catch (e) {\n        console.error('Failed to fetch completed_trades (table might not exist):', e);\n        recentTrades = [];\n    }\n\n    // Parse roles\n    let roles;\n    try {\n        roles = user.role ? JSON.parse(user.role) : ['user'];\n    } catch (e) {\n        roles = ['user'];\n    }\n\n    // Get donation status if available (check KV)\n    let donationData = null;\n    try {\n        // Check if DONATIONS_KV binding exists\n        if (env.DONATIONS_KV) {\n            const donationKey = `purchase:${userId}`;\n            const donationKV = await env.DONATIONS_KV.get(donationKey);\n            if (donationKV) {\n                const data = JSON.parse(donationKV);\n                donationData = {\n                    totalSpent: data.totalSpent || 0,\n                    purchases: data.purchases || 0\n                };\n            }\n        }\n    } catch (e) {\n        console.error('Failed to fetch donation data:', e);\n    }\n\n    // Get user's approved gallery posts\n    let galleryPosts = [];\n    try {\n        const postsResult = await env.DBA.prepare(`\n            SELECT\n                g.id,\n                g.title,\n                g.description,\n                g.media_url,\n                g.thumbnail_url,\n                g.created_at,\n                g.views,\n                g.likes\n            FROM gallery_items g\n            WHERE g.user_id = ? AND g.status = 1\n            ORDER BY g.created_at DESC\n            LIMIT 12\n        `).bind(actualUserId).all();\n\n        // Helper to determine media type from URL\n        const getMediaType = (url) => {\n            if (!url) return 'image';\n            const ext = url.split('.').pop().toLowerCase();\n            const videoExts = ['mp4', 'webm', 'mov'];\n            return videoExts.includes(ext) ? 'video' : 'image';\n        };\n\n        // Parse JSON fields and add computed fields\n        galleryPosts = (postsResult.results || []).map(item => {\n            const likes = JSON.parse(item.likes || '[]');\n            let viewCount = item.views || 0;\n            return {\n                ...item,\n                media_type: getMediaType(item.media_url),\n                views: viewCount,\n                likes_count: likes.length\n            };\n        });\n    } catch (e) {\n        console.error('Failed to fetch gallery posts:', e);\n        galleryPosts = [];\n    }\n\n    // Get user's wishlist\n    let wishlist = [];\n    try {\n        const wishlistPref = await env.DBA.prepare(`\n            SELECT preference_value\n            FROM user_preferences\n            WHERE user_id = ? AND preference_key = 'wishlist'\n        `).bind(actualUserId).first();\n\n        if (wishlistPref && wishlistPref.preference_value) {\n            wishlist = JSON.parse(wishlistPref.preference_value);\n            // Ensure it's an array\n            if (!Array.isArray(wishlist)) {\n                wishlist = [];\n            }\n        }\n    } catch (e) {\n        console.error('Failed to fetch wishlist:', e);\n        wishlist = [];\n    }\n\n    return new Response(JSON.stringify({\n        user: {\n            userId: user.user_id,\n            username: user.username,\n            displayName: user.display_name,\n            avatarUrl: user.avatar_url,\n            roles: roles,\n            createdAt: user.created_at,\n            lastOnline: user.last_online\n        },\n        stats: stats || {\n            total_trades: 0,\n            successful_trades: 0,\n            average_rating: 0,\n            total_reviews: 0,\n            last_trade_at: null\n        },\n        reviews: reviews,\n        recentTrades: recentTrades,\n        donationData: donationData,\n        galleryPosts: galleryPosts,\n        wishlist: wishlist\n    }), {\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\n// Handle POST review for a user profile\nasync function handlePostReview(request, env) {\n    const url = new URL(request.url);\n    const pathParts = url.pathname.split('/api/profile/').filter(Boolean);\n    const pathSegments = pathParts[0].split('/');\n    const userId = pathSegments[0];\n\n    if (!userId) {\n        return new Response(JSON.stringify({ error: 'User ID required' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Authenticate the reviewer\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const token = authHeader.substring(7);\n\n    // Verify session by querying sessions table (same as other endpoints)\n    const session = await env.DBA.prepare(`\n        SELECT s.*, u.* FROM sessions s\n        JOIN users u ON s.user_id = u.user_id\n        WHERE s.token = ? AND s.expires_at > ?\n    `).bind(token, Date.now()).first();\n\n    if (!session) {\n        return new Response(JSON.stringify({ error: 'Invalid or expired session' }), {\n            status: 401,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Get reviewer user from session (already joined above)\n    const reviewer = {\n        user_id: session.user_id,\n        username: session.username,\n        display_name: session.display_name,\n        avatar_url: session.avatar_url,\n        role: session.role\n    };\n\n    if (!reviewer) {\n        return new Response(JSON.stringify({ error: 'User not found' }), {\n            status: 404,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if user is banned/scammer\n    let roles;\n    try {\n        roles = reviewer.role ? JSON.parse(reviewer.role) : ['user'];\n    } catch (e) {\n        roles = ['user'];\n    }\n\n    if (roles.includes('scammer')) {\n        return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n            status: 403,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Parse request body\n    const data = await request.json();\n    const { rating, comment } = data;\n\n    // Validate rating\n    if (!rating || rating < 1 || rating > 5) {\n        return new Response(JSON.stringify({ error: 'Rating must be between 1 and 5' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Prevent self-review\n    if (reviewer.user_id === userId) {\n        return new Response(JSON.stringify({ error: 'You cannot review yourself' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if user being reviewed exists\n    const reviewedUser = await env.DBA.prepare(\n        'SELECT user_id FROM users WHERE user_id = ?'\n    ).bind(userId).first();\n\n    if (!reviewedUser) {\n        return new Response(JSON.stringify({ error: 'User not found' }), {\n            status: 404,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    // Check if reviewer has already reviewed this user (limit one review per user pair)\n    const existingReview = await env.DBA.prepare(\n        'SELECT id FROM trade_reviews WHERE reviewer_id = ? AND reviewed_user_id = ? AND trade_id IS NULL'\n    ).bind(reviewer.user_id, userId).first();\n\n    if (existingReview) {\n        return new Response(JSON.stringify({ error: 'You have already reviewed this user' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' }\n        });\n    }\n\n    const now = Date.now();\n\n    // Insert review (trade_id will be NULL for profile reviews)\n    const result = await env.DBA.prepare(\n        `INSERT INTO trade_reviews\n        (trade_id, reviewer_id, reviewed_user_id, rating, comment, created_at)\n        VALUES (?, ?, ?, ?, ?, ?)`\n    ).bind(\n        null, // No trade_id for profile reviews\n        reviewer.user_id,\n        userId,\n        rating,\n        comment || null,\n        now\n    ).run();\n\n    // Update user stats\n    const { updateUserStats } = await import('../trades/_utils/helpers.js');\n    await updateUserStats(env, userId);\n\n    // Create notification\n    const ratingText = rating === 5 ? 'excellent' :\n                      rating === 4 ? 'good' :\n                      rating === 3 ? 'okay' :\n                      rating === 2 ? 'poor' : 'bad';\n\n    await env.DBA.prepare(\n        'INSERT INTO trade_notifications (user_id, type, title, message, link, created_at) VALUES (?, ?, ?, ?, ?, ?)'\n    ).bind(\n        userId,\n        'review_received',\n        'New Review',\n        `${reviewer.username} gave you a ${ratingText} review (${rating}/5 stars)`,\n        `/profile/${userId}`,\n        now\n    ).run();\n\n    return new Response(JSON.stringify({\n        id: result.meta.last_row_id,\n        message: 'Review submitted successfully'\n    }), {\n        status: 201,\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\nexport async function onRequest(context) {\n    const { request, env } = context;\n\n    // CORS headers\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    };\n\n    if (request.method === 'OPTIONS') {\n        return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n        let response;\n        const url = new URL(request.url);\n        const pathParts = url.pathname.split('/api/profile/').filter(Boolean);\n        const pathSegments = pathParts[0] ? pathParts[0].split('/') : [];\n\n        if (request.method === 'GET') {\n            response = await handleGetProfile(request, env);\n        } else if (request.method === 'POST' && pathSegments[1] === 'review') {\n            response = await handlePostReview(request, env);\n        } else {\n            response = new Response(JSON.stringify({ error: 'Method not allowed' }), {\n                status: 405,\n                headers: { 'Content-Type': 'application/json' }\n            });\n        }\n\n        // Add CORS headers to response\n        Object.entries(corsHeaders).forEach(([key, value]) => {\n            response.headers.set(key, value);\n        });\n\n        return response;\n    } catch (error) {\n        console.error('Profile API error:', error);\n        console.error('Error stack:', error.stack);\n        console.error('Request URL:', request.url);\n        return new Response(JSON.stringify({\n            error: 'Internal server error',\n            details: error.message\n        }), {\n            status: 500,\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' }\n        });\n    }\n}\n", "// functions/api/admin-login.js\r\nimport { createSession } from \"./_utils/auth.js\";\r\n\r\nexport const onRequestPost = async ({ request, env }) => {\r\n  try {\r\n    // Parse JSON body\r\n    let key;\r\n    try {\r\n      const data = await request.json();\r\n      key = data.key?.trim();\r\n      if (!key) throw new Error(\"No key provided\");\r\n    } catch {\r\n      return new Response(JSON.stringify({ error: \"Invalid request body\" }), { status: 400 });\r\n    }\r\n\r\n    // Lookup admin in D1 by raw key\r\n    const row = await env.DBH.prepare(\"SELECT name FROM admins WHERE key_hash = ?\")\r\n      .bind(key)\r\n      .first()\r\n      .catch(() => null);\r\n\r\n    if (!row) {\r\n      return new Response(JSON.stringify({ error: \"Invalid key\" }), { status: 401 });\r\n    }\r\n\r\n    // Create a session token\r\n    if (!env.SECRET_KEY) throw new Error(\"Missing SECRET_KEY in environment\");\r\n    const token = await createSession(row.name, env.SECRET_KEY);\r\n\r\n    // Respond with JSON + Set-Cookie\r\n    return new Response(JSON.stringify({ ok: true, name: row.name }), {\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Set-Cookie\": `session=${token}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=86400`\r\n      }\r\n    });\r\n  } catch (err) {\r\n    console.error(\"admin-login error:\", err);\r\n    return new Response(JSON.stringify({ error: err.message }), { status: 500 });\r\n  }\r\n};\r\n", "// functions/api/check-session.js\r\nimport { verifySession } from \"./_utils/auth.js\";\r\n\r\nexport const onRequestGet = async ({ request, env }) => {\r\n  try {\r\n    const cookieHeader = request.headers.get(\"Cookie\") || \"\";\r\n    const session = cookieHeader\r\n      .split(\"; \")\r\n      .find(c => c.startsWith(\"session=\"))\r\n      ?.split(\"=\")[1];\r\n\r\n    if (!session) {\r\n      return new Response(JSON.stringify({ ok: false }), { status: 401 });\r\n    }\r\n\r\n    const payload = await verifySession(session, env.SECRET_KEY);\r\n    if (!payload) {\r\n      return new Response(JSON.stringify({ ok: false }), { status: 401 });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ ok: true, name: payload.name }), {\r\n      headers: { \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\" }\r\n    });\r\n  } catch (err) {\r\n    console.error(\"check-session error:\", err);\r\n    return new Response(JSON.stringify({ ok: false, error: err.message }), { status: 500 });\r\n  }\r\n};\r\n", "export async function onRequestGet(context) {\r\n  const DBH = context.env.DBH;\r\n\r\n  try {\r\n    // Select the latest record including username\r\n    const row = await DBH.prepare(`\r\n      SELECT username, timestamp, version\r\n      FROM history\r\n      ORDER BY timestamp DESC\r\n      LIMIT 1\r\n    `).first();\r\n\r\n    if (!row) {\r\n      return new Response(`0|`, {\r\n        status: 200,\r\n        headers: {\r\n          \"Content-Type\": \"text/plain\",\r\n          \"Cache-Control\": \"no-cache\",\r\n          \"Access-Control-Allow-Origin\": \"*\"\r\n        }\r\n      });\r\n    }\r\n\r\n    return new Response(`${row.username}\"@\"${row.timestamp}|${row.version}`, {\r\n      headers: {\r\n        \"Content-Type\": \"text/plain\",\r\n        \"Cache-Control\": \"no-cache\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      }\r\n    });\r\n\r\n  } catch (err) {\r\n    return new Response(`Error: ${err.message}`, { status: 500 });\r\n  }\r\n}\r\n", "export async function onRequestPost() {\r\n  return new Response(JSON.stringify({ ok: true }), {\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      \"Set-Cookie\": \"session=; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=0\",\r\n          \"Access-Control-Allow-Origin\": \"*\"\r\n    }\r\n  });\r\n}\r\n", "/**\r\n * ============================================================================\r\n * ROBLOX PROXY API - Main API endpoint for Roblox/Discord data\r\n * ============================================================================\r\n * \r\n * This file handles:\r\n * - Roblox profile fetching (with caching)\r\n * - Discord profile fetching (with caching)\r\n * - Scammer data processing (queue-based)\r\n * - Thread evidence management\r\n * - Media proxying (Discord images/videos)\r\n * - CDN asset proxying\r\n * \r\n * Queue Consumer: See emwiki/workers/scammer-queue-consumer.js\r\n * ============================================================================\r\n */\r\n\r\n// Helper function to fetch Roblox profile with caching\r\n// writeToScammerCache: if false, only reads from cache but doesn't write (for general endpoint use)\r\nasync function fetchRobloxProfile(userId, env, writeToScammerCache = true) {\r\n  if (!userId || !/^\\d+$/.test(userId)) {\r\n    return null;\r\n  }\r\n\r\n  const now = Date.now();\r\n\r\n  // Check cache first (only if writeToScammerCache is true, otherwise don't use scammer cache)\r\n  let cached = null;\r\n  if (writeToScammerCache) {\r\n    cached = await env.DB.prepare(\r\n      \"SELECT roblox_name, roblox_display_name, roblox_avatar FROM scammer_profile_cache WHERE user_id = ?\"\r\n    ).bind(userId).first();\r\n\r\n    if (cached && cached.roblox_name && cached.roblox_display_name && cached.roblox_avatar) {\r\n      return {\r\n        name: cached.roblox_name,\r\n        displayName: cached.roblox_display_name,\r\n        avatar: cached.roblox_avatar\r\n      };\r\n    }\r\n  }\r\n\r\n  // Fetch from API with retry logic\r\n  let fetchSuccess = false;\r\n  let data = null;\r\n\r\n  for (let attempt = 0; attempt < 5; attempt++) {\r\n    try {\r\n      const [userData, avatarData] = await Promise.all([\r\n        fetch(`https://users.roblox.com/v1/users/${userId}`).then(r => r.ok ? r.json() : null),\r\n        fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png&isCircular=true`)\r\n          .then(r => r.ok ? r.json() : null)\r\n      ]);\r\n\r\n      if (userData) {\r\n        data = {\r\n          name: userData.name,\r\n          displayName: userData.displayName,\r\n          avatar: avatarData?.data?.[0]?.imageUrl || null\r\n        };\r\n        fetchSuccess = true;\r\n        break;\r\n      }\r\n    } catch (err) {\r\n      console.warn(`Roblox fetch attempt ${attempt + 1} failed:`, err);\r\n    }\r\n\r\n    if (!fetchSuccess) {\r\n      await new Promise(r => setTimeout(r, 500 * (attempt + 1)));\r\n    }\r\n  }\r\n\r\n  if (!fetchSuccess || !data) {\r\n    return null;\r\n  }\r\n\r\n  // Update cache ONLY if writeToScammerCache is true (for scammer processing)\r\n  if (writeToScammerCache) {\r\n    await env.DB.prepare(`\r\n      INSERT INTO scammer_profile_cache (user_id, roblox_name, roblox_display_name, roblox_avatar)\r\n      VALUES (?, ?, ?, ?)\r\n      ON CONFLICT(user_id) DO UPDATE SET\r\n        roblox_name = excluded.roblox_name,\r\n        roblox_display_name = excluded.roblox_display_name,\r\n        roblox_avatar = excluded.roblox_avatar\r\n    `).bind(userId, data.name || null, data.displayName || null, data.avatar || null).run();\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * Fetch Discord profile with caching\r\n * @param {string} discordId - Discord user ID\r\n * @param {object} env - Environment variables\r\n * @param {string|null} userId - Optional Roblox user ID for cache lookup\r\n * @param {boolean} writeToScammerCache - If false, only reads from cache (for general endpoint use)\r\n */\r\nasync function fetchDiscordProfile(discordId, env, userId = null, writeToScammerCache = true) {\r\n  if (!discordId || !/^\\d+$/.test(discordId)) {\r\n    return null;\r\n  }\r\n\r\n  const now = Date.now();\r\n\r\n  // Check cache first - only if writeToScammerCache is true\r\n  let cached = null;\r\n  if (writeToScammerCache) {\r\n    // Prefer user_id match if provided\r\n    if (userId) {\r\n      cached = await env.DB.prepare(\r\n        \"SELECT discord_display_name FROM scammer_profile_cache WHERE user_id = ?\"\r\n      ).bind(userId).first();\r\n    }\r\n    \r\n    if (!cached) {\r\n      cached = await env.DB.prepare(\r\n        \"SELECT discord_display_name FROM scammer_profile_cache WHERE discord_id = ? LIMIT 1\"\r\n      ).bind(discordId).first();\r\n    }\r\n\r\n    if (cached && cached.discord_display_name) {\r\n      return {\r\n        displayName: cached.discord_display_name\r\n      };\r\n    }\r\n  }\r\n\r\n  // Fetch from Discord API with retry logic\r\n  let fetchSuccess = false;\r\n  let data = null;\r\n\r\n  for (let attempt = 0; attempt < 5; attempt++) {\r\n    try {\r\n      const response = await fetch(`https://discord.com/api/v10/users/${discordId}`, {\r\n        headers: { Authorization: `Bot ${env.DISCORD_BOT_TOKEN}` }\r\n      });\r\n\r\n      if (response.status === 429) {\r\n        const retryAfter = await response.json();\r\n        await new Promise(r => setTimeout(r, (retryAfter.retry_after || 1) * 1000));\r\n        continue;\r\n      }\r\n\r\n      if (response.status === 404) {\r\n        // User not found - return null (don't cache for general endpoint)\r\n        data = { displayName: null };\r\n        fetchSuccess = true;\r\n        break;\r\n      }\r\n\r\n      if (response.ok) {\r\n        const userData = await response.json();\r\n        const displayName = userData.global_name || userData.username || null;\r\n\r\n        data = { displayName };\r\n        fetchSuccess = true;\r\n        break;\r\n      }\r\n    } catch (err) {\r\n      console.warn(`Discord fetch attempt ${attempt + 1} failed:`, err);\r\n    }\r\n\r\n    if (!fetchSuccess) {\r\n      await new Promise(r => setTimeout(r, 500 * (attempt + 1)));\r\n    }\r\n  }\r\n\r\n  if (!fetchSuccess || !data) {\r\n    return null;\r\n  }\r\n\r\n  // Update cache ONLY if writeToScammerCache is true (for scammer processing)\r\n  if (writeToScammerCache) {\r\n    if (userId) {\r\n      await env.DB.prepare(`\r\n        UPDATE scammer_profile_cache\r\n        SET discord_id = ?, discord_display_name = ?\r\n        WHERE user_id = ?\r\n      `).bind(discordId, data.displayName, userId).run();\r\n    } else {\r\n      await env.DB.prepare(`\r\n        UPDATE scammer_profile_cache\r\n        SET discord_display_name = ?\r\n        WHERE discord_id = ?\r\n      `).bind(data.displayName, discordId).run();\r\n    }\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n\r\n// ============================================================================\r\n// SECTION 2: DATA EXTRACTION HELPERS\r\n// ============================================================================\r\n\r\nfunction extractDisplayName(content) {\r\n  // Handle both :emoji: and <:emoji:id> formats, with optional ** markdown\r\n  const patterns = [\r\n    /<:\\w+:\\d+>\\s*\\*{0,2}\\s*display:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i,\r\n    /:\\w+:\\s*\\*{0,2}\\s*display:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i\r\n  ];\r\n  \r\n  for (const pattern of patterns) {\r\n    const match = content.match(pattern);\r\n    if (match) {\r\n      let value = match[1].trim();\r\n      // Remove markdown bold and emoji\r\n      value = value.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/<:\\w+:\\d+>/g, '').replace(/:\\w+:/g, '').trim();\r\n      if (value) return value;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction extractRobloxUsername(content) {\r\n  // Handle both :emoji: and <:emoji:id> formats, with optional ** markdown\r\n  const patterns = [\r\n    /<:\\w+:\\d+>\\s*\\*{0,2}\\s*roblox\\s+user:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i,\r\n    /:\\w+:\\s*\\*{0,2}\\s*roblox\\s+user:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i\r\n  ];\r\n  \r\n  for (const pattern of patterns) {\r\n    const match = content.match(pattern);\r\n    if (match) {\r\n      let value = match[1].trim();\r\n      // Remove markdown bold and emoji\r\n      value = value.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/<:\\w+:\\d+>/g, '').replace(/:\\w+:/g, '').trim();\r\n      if (value) return value;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction extractDiscordIds(content) {\r\n  // Handle both :emoji: and <:emoji:id> formats, with optional ** markdown\r\n  // Also handle multi-line Discord IDs\r\n  const patterns = [\r\n    /<:\\w+:\\d+>\\s*\\*{0,2}\\s*discord\\s+user:\\s*\\*{0,2}\\s*([\\s\\S]+?)(?=\\n\\n|\\n(?::\\w+:|<:\\w+:\\d+>|roblox|victims|items|$))/i,\r\n    /:\\w+:\\s*\\*{0,2}\\s*discord\\s+user:\\s*\\*{0,2}\\s*([\\s\\S]+?)(?=\\n\\n|\\n(?::\\w+:|<:\\w+:\\d+>|roblox|victims|items|$))/i\r\n  ];\r\n  \r\n  let match = null;\r\n  for (const pattern of patterns) {\r\n    match = content.match(pattern);\r\n    if (match) break;\r\n  }\r\n  \r\n  if (!match) return [];\r\n  \r\n  let value = match[1].trim();\r\n  // Remove markdown bold and emoji\r\n  value = value.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/<:\\w+:\\d+>/g, '').replace(/:\\w+:/g, '').trim();\r\n  if (!value || value.toUpperCase() === 'NA') return [];\r\n  \r\n  // Split by comma or newline, then filter\r\n  const ids = value.split(/[,\\n\\r]+/)\r\n    .map(id => id.trim())\r\n    .filter(id => id && id.toUpperCase() !== 'NA' && /^\\d+$/.test(id));\r\n  \r\n  return ids;\r\n}\r\n\r\nfunction extractVictims(content) {\r\n  // Handle both :emoji: and <:emoji:id> formats, with optional ** markdown\r\n  const patterns = [\r\n    /<:\\w+:\\d+>\\s*\\*{0,2}\\s*victims?:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i,\r\n    /:\\w+:\\s*\\*{0,2}\\s*victims?:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i\r\n  ];\r\n  \r\n  for (const pattern of patterns) {\r\n    const match = content.match(pattern);\r\n    if (match) {\r\n      let value = match[1].trim();\r\n      // Remove markdown bold and emoji\r\n      value = value.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/<:\\w+:\\d+>/g, '').replace(/:\\w+:/g, '').trim();\r\n      if (!value || value.toUpperCase() === 'NA') return null;\r\n      return value;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction extractItemsScammed(content) {\r\n  // Handle both :emoji: and <:emoji:id> formats, with optional ** markdown\r\n  const patterns = [\r\n    /<:\\w+:\\d+>\\s*\\*{0,2}\\s*items?\\s+scammed?:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i,\r\n    /:\\w+:\\s*\\*{0,2}\\s*items?\\s+scammed?:\\s*\\*{0,2}\\s*([^\\n\\r]+)/i\r\n  ];\r\n  \r\n  for (const pattern of patterns) {\r\n    const match = content.match(pattern);\r\n    if (match) {\r\n      let value = match[1].trim();\r\n      // Remove markdown bold and emoji\r\n      value = value.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/<:\\w+:\\d+>/g, '').replace(/:\\w+:/g, '').trim();\r\n      if (!value || value.toUpperCase() === 'NA') return null;\r\n      return value;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction extractAltIds(content) {\r\n  // Match \"roblox alts:\" section until next section or end\r\n  const match = content.match(/roblox\\s+alts?:\\s*([\\s\\S]+?)(?:\\n\\n|\\n(?:roblox\\s+profile|$)|$)/i);\r\n  if (!match) return [];\r\n  \r\n  const altBlock = match[1].trim();\r\n  if (!altBlock || altBlock.toUpperCase() === 'NA') return [];\r\n  \r\n  // Extract user IDs from profile URLs\r\n  const userIds = [...altBlock.matchAll(/roblox\\.com\\/users\\/(\\d+)\\/profile/g)].map(m => m[1]);\r\n  \r\n  if (userIds.length === 0) return [];\r\n  \r\n  // Extract usernames - can be in parentheses OR on the next line after URL\r\n  const alts = [];\r\n  const lines = altBlock.split('\\n');\r\n  \r\n  for (let i = 0; i < userIds.length; i++) {\r\n    const userId = userIds[i];\r\n    let username = null;\r\n    \r\n    // Method 1: Check for username in parentheses on same line\r\n    const urlPattern = new RegExp(`roblox\\\\.com/users/${userId}/profile[^\\\\n]*\\\\(([^)]+)\\\\)`, 'i');\r\n    const parenMatch = altBlock.match(urlPattern);\r\n    if (parenMatch) {\r\n      username = parenMatch[1].trim();\r\n    } else {\r\n      // Method 2: Check for username on next line after URL\r\n      // Find the line with the URL\r\n      for (let j = 0; j < lines.length; j++) {\r\n        if (lines[j].includes(`roblox.com/users/${userId}/profile`)) {\r\n          // Check if there's text after the URL on the same line\r\n          const sameLineMatch = lines[j].match(/profile\\s+([^\\s\\n\\r]+)/i);\r\n          if (sameLineMatch) {\r\n            username = sameLineMatch[1].trim();\r\n          } else if (j + 1 < lines.length) {\r\n            // Check next line for username\r\n            const nextLine = lines[j + 1].trim();\r\n            if (nextLine && !nextLine.match(/^https?:\\/\\//) && !nextLine.match(/^roblox\\.com/)) {\r\n              username = nextLine;\r\n            }\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    \r\n    alts.push({\r\n      userId,\r\n      username: username || null\r\n    });\r\n  }\r\n  \r\n  return alts;\r\n}\r\n\r\nfunction extractRobloxUserId(content) {\r\n  // Match Roblox profile URL - handle markdown formatting and various formats\r\n  const patterns = [\r\n    /https:\\/\\/www\\.roblox\\.com\\/users\\/(\\d+)\\/profile/i,\r\n    /roblox\\.com\\/users\\/(\\d+)\\/profile/i,\r\n    /roblox\\.com\\/users\\/(\\d+)\\//i\r\n  ];\r\n  \r\n  for (const pattern of patterns) {\r\n    const match = content.match(pattern);\r\n    if (match && match[1]) {\r\n      return match[1];\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n\r\n// ============================================================================\r\n// SECTION 3: UTILITY FUNCTIONS\r\n// ============================================================================\r\n\r\n/**\r\n * Delay helper for rate limiting\r\n */\r\nconst delay = ms => new Promise(resolve => setTimeout(resolve, ms));\r\n\r\n/**\r\n * Log job activity to database\r\n */\r\nasync function logJobActivity(env, jobId, step, messageId = null, details = null) {\r\n  const now = Date.now();\r\n  try {\r\n    // Get current logs\r\n    const job = await env.DB.prepare(`\r\n      SELECT logs FROM scammer_job_status WHERE job_id = ?\r\n    `).bind(jobId).first();\r\n    \r\n    const logs = job?.logs ? JSON.parse(job.logs) : [];\r\n    logs.push({\r\n      timestamp: now,\r\n      step,\r\n      messageId,\r\n      details\r\n    });\r\n    \r\n    // Keep only last 100 log entries\r\n    if (logs.length > 100) {\r\n      logs.shift();\r\n    }\r\n    \r\n    await env.DB.prepare(`\r\n      UPDATE scammer_job_status \r\n      SET last_activity_at = ?, current_message_id = ?, current_step = ?, logs = ?\r\n      WHERE job_id = ?\r\n    `).bind(now, messageId, step, JSON.stringify(logs), jobId).run();\r\n  } catch (err) {\r\n    console.error(`Failed to log job activity:`, err);\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// SECTION 4: SCAMMER MESSAGE PROCESSING\r\n// ============================================================================\r\n\r\n/**\r\n * Process a single Discord message and extract scammer data\r\n * Called by queue consumer (scammer-queue-consumer.js)\r\n */\r\n\r\nasync function processScammerMessage(msg, env, channelId, jobId = null) {\r\n  // Get content from message content AND embeds (Discord sometimes puts content in embeds)\r\n  let content = msg.content || '';\r\n  const originalContentLength = content.length;\r\n  \r\n  // Check if message references another message (replies) - the referenced message might have the content\r\n  if (msg.referenced_message && msg.referenced_message.content) {\r\n    content += '\\n' + msg.referenced_message.content;\r\n  }\r\n  \r\n  // Also check embeds for content\r\n  if (msg.embeds && msg.embeds.length > 0) {\r\n    for (const embed of msg.embeds) {\r\n      if (embed.description) content += '\\n' + embed.description;\r\n      if (embed.title) content += '\\n' + embed.title;\r\n      if (embed.fields && Array.isArray(embed.fields)) {\r\n        for (const field of embed.fields) {\r\n          if (field.name) content += '\\n' + field.name;\r\n          if (field.value) content += '\\n' + field.value;\r\n        }\r\n      }\r\n      // Also check embed footer and author\r\n      if (embed.footer && embed.footer.text) content += '\\n' + embed.footer.text;\r\n      if (embed.author && embed.author.name) content += '\\n' + embed.author.name;\r\n    }\r\n  }\r\n  \r\n  // Check if message has components (buttons/select menus) - sometimes content is there\r\n  if (msg.components && Array.isArray(msg.components)) {\r\n    for (const row of msg.components) {\r\n      if (row.components && Array.isArray(row.components)) {\r\n        for (const component of row.components) {\r\n          if (component.label) content += '\\n' + component.label;\r\n          if (component.placeholder) content += '\\n' + component.placeholder;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // REQUIRED: Roblox User ID (skip if missing)\r\n  let userId = extractRobloxUserId(content);\r\n  \r\n  // If no userId found and message references another message, check the referenced message\r\n  if (!userId && msg.referenced_message && msg.referenced_message.content) {\r\n    const referencedContent = msg.referenced_message.content;\r\n    userId = extractRobloxUserId(referencedContent);\r\n    if (userId) {\r\n      // Found it in referenced message - use that content instead\r\n      content = referencedContent + '\\n' + content;\r\n      console.log(`[${msg.id}] Found Roblox URL in referenced message ${msg.referenced_message.id}`);\r\n      if (jobId) await logJobActivity(env, jobId, 'found_in_reference', msg.id, `Found Roblox URL in referenced message ${msg.referenced_message.id}`);\r\n    }\r\n  }\r\n  \r\n  if (!userId) {\r\n    // Log more details for debugging - check what's actually in the message\r\n    const hasEmbeds = msg.embeds && msg.embeds.length > 0;\r\n    const hasReference = msg.referenced_message ? true : false;\r\n    let embedDebug = '';\r\n    if (hasEmbeds) {\r\n      embedDebug = ` Embeds: ${msg.embeds.length}`;\r\n      msg.embeds.forEach((embed, idx) => {\r\n        embedDebug += ` [${idx}: title=${embed.title || 'none'}, desc=${embed.description ? embed.description.substring(0, 50) : 'none'}, fields=${embed.fields ? embed.fields.length : 0}]`;\r\n      });\r\n    }\r\n    const refDebug = hasReference ? ` Has referenced_message (${msg.referenced_message.id})` : '';\r\n    \r\n    // Check if \"roblox\" appears anywhere in content (case-insensitive)\r\n    const hasRobloxKeyword = /roblox/i.test(content);\r\n    const robloxDebug = hasRobloxKeyword ? ' (contains \"roblox\")' : ' (NO \"roblox\" keyword)';\r\n    \r\n    // Show first 300 chars and last 300 chars to see if content is truncated\r\n    const firstPart = content.substring(0, 300).replace(/\\n/g, ' ');\r\n    const lastPart = content.length > 300 ? content.substring(content.length - 300).replace(/\\n/g, ' ') : '';\r\n    const preview = lastPart ? `${firstPart} ... [last 300: ${lastPart}]` : firstPart;\r\n    \r\n    console.log(`Skipping message ${msg.id} - no Roblox profile URL found. Original content: ${originalContentLength} chars, Total: ${content.length} chars${embedDebug}${refDebug}${robloxDebug}. Preview: ${preview}`);\r\n    if (jobId) {\r\n      await logJobActivity(env, jobId, 'message_skipped', msg.id, \r\n        `No Roblox profile URL. Original: ${originalContentLength} chars, Total: ${content.length} chars${embedDebug}${refDebug}${robloxDebug}. Preview: ${preview.substring(0, 200)}`);\r\n    }\r\n    return;\r\n  }\r\n  \r\n  if (jobId) await logJobActivity(env, jobId, 'extracting_fields', msg.id, `Extracting fields for user ${userId}`);\r\n  \r\n  // Extract all fields\r\n  const displayName = extractDisplayName(content);\r\n  const robloxUsername = extractRobloxUsername(content);\r\n  const discordIds = extractDiscordIds(content);\r\n  const victims = extractVictims(content);\r\n  const itemsScammed = extractItemsScammed(content);\r\n  const altIds = extractAltIds(content);\r\n  \r\n  console.log(`[PROCESSING] Message ${msg.id} - userId: ${userId}, victims: ${victims || 'none'}, itemsScammed: ${itemsScammed || 'none'}, alts: ${altIds.length}, discordIds: ${discordIds.length}`);\r\n  \r\n  // Fetch Roblox profile with timeout protection\r\n  if (jobId) await logJobActivity(env, jobId, 'fetching_roblox', msg.id, `Fetching Roblox profile for ${userId}`);\r\n  console.log(`[${msg.id}] Fetching Roblox profile for ${userId}`);\r\n  let robloxData = null;\r\n  try {\r\n    const robloxPromise = fetchRobloxProfile(userId, env);\r\n    const timeoutPromise = new Promise((_, reject) => \r\n      setTimeout(() => reject(new Error('Roblox profile fetch timeout')), 15000)\r\n    );\r\n    robloxData = await Promise.race([robloxPromise, timeoutPromise]);\r\n    if (!robloxData) {\r\n      console.warn(`Failed to fetch Roblox profile for ${userId}`);\r\n      if (jobId) await logJobActivity(env, jobId, 'roblox_failed', msg.id, `Roblox profile fetch returned null`);\r\n    } else {\r\n      console.log(`[${msg.id}] Roblox profile fetched: ${robloxData.name}`);\r\n      if (jobId) await logJobActivity(env, jobId, 'roblox_success', msg.id, `Roblox profile: ${robloxData.name}`);\r\n    }\r\n  } catch (err) {\r\n    console.warn(`[${msg.id}] Roblox profile fetch error for ${userId}:`, err.message);\r\n    if (jobId) await logJobActivity(env, jobId, 'roblox_error', msg.id, err.message);\r\n    // Continue anyway with extracted username\r\n  }\r\n  \r\n  // Fetch Discord profiles (for all Discord IDs) with timeout protection\r\n  if (jobId) await logJobActivity(env, jobId, 'fetching_discord', msg.id, `Fetching ${discordIds.length} Discord profiles`);\r\n  const discordProfiles = [];\r\n  for (let i = 0; i < discordIds.length; i++) {\r\n    const discordId = discordIds[i];\r\n    try {\r\n      console.log(`[${msg.id}] Fetching Discord profile ${i+1}/${discordIds.length} for ${discordId}`);\r\n      if (jobId) await logJobActivity(env, jobId, 'discord_fetch', msg.id, `Discord ${i+1}/${discordIds.length}: ${discordId}`);\r\n      \r\n      const profilePromise = fetchDiscordProfile(discordId, env, userId);\r\n      const timeoutPromise = new Promise((_, reject) => \r\n        setTimeout(() => reject(new Error('Discord profile fetch timeout')), 10000)\r\n      );\r\n      \r\n      const profile = await Promise.race([profilePromise, timeoutPromise]);\r\n      if (profile) {\r\n        discordProfiles.push({ id: discordId, ...profile });\r\n        console.log(`[${msg.id}] Discord profile fetched: ${profile.displayName}`);\r\n        if (jobId) await logJobActivity(env, jobId, 'discord_success', msg.id, `Discord ${discordId}: ${profile.displayName}`);\r\n      }\r\n    } catch (err) {\r\n      console.warn(`[${msg.id}] Failed to fetch Discord profile for ${discordId}:`, err.message);\r\n      if (jobId) await logJobActivity(env, jobId, 'discord_error', msg.id, `Discord ${discordId}: ${err.message}`);\r\n      // Continue without this Discord profile\r\n    }\r\n  }\r\n  \r\n  // Fetch alt account profiles with timeout protection\r\n  if (jobId) await logJobActivity(env, jobId, 'fetching_alts', msg.id, `Fetching ${altIds.length} alt profiles`);\r\n  const altProfiles = [];\r\n  for (let i = 0; i < altIds.length; i++) {\r\n    const alt = altIds[i];\r\n    try {\r\n      console.log(`[${msg.id}] Fetching alt profile ${i+1}/${altIds.length} for ${alt.userId}`);\r\n      if (jobId) await logJobActivity(env, jobId, 'alt_fetch', msg.id, `Alt ${i+1}/${altIds.length}: ${alt.userId}`);\r\n      \r\n      const altPromise = fetchRobloxProfile(alt.userId, env);\r\n      const timeoutPromise = new Promise((_, reject) => \r\n        setTimeout(() => reject(new Error('Alt profile fetch timeout')), 15000)\r\n      );\r\n      const altData = await Promise.race([altPromise, timeoutPromise]);\r\n      if (altData) {\r\n        altProfiles.push({\r\n          userId: alt.userId,\r\n          username: alt.username || altData.name,\r\n          displayName: altData.displayName,\r\n          avatar: altData.avatar\r\n        });\r\n        console.log(`[${msg.id}] Alt profile fetched: ${altData.name}`);\r\n        if (jobId) await logJobActivity(env, jobId, 'alt_success', msg.id, `Alt ${alt.userId}: ${altData.name}`);\r\n      }\r\n    } catch (err) {\r\n      console.warn(`[${msg.id}] Failed to fetch alt profile for ${alt.userId}:`, err.message);\r\n      if (jobId) await logJobActivity(env, jobId, 'alt_error', msg.id, `Alt ${alt.userId}: ${err.message}`);\r\n      // Continue without this alt\r\n    }\r\n  }\r\n  \r\n  // Detect thread ID during message processing (but don't fetch messages yet)\r\n  // We'll fetch all thread messages after processing all main messages\r\n  let threadId = null;\r\n  try {\r\n    if (msg.thread && msg.thread.id) {\r\n      threadId = msg.thread.id;\r\n      console.log(`[${msg.id}] Found thread ${threadId} via msg.thread property`);\r\n      if (jobId) await logJobActivity(env, jobId, 'thread_detected', msg.id, `Thread detected: ${threadId}`);\r\n    }\r\n  } catch (err) {\r\n    console.warn(`[${msg.id}] Error detecting thread:`, err.message);\r\n    // Continue without thread\r\n  }\r\n  \r\n  // Store in D1\r\n  if (jobId) await logJobActivity(env, jobId, 'storing_data', msg.id, `Storing data for user ${userId}`);\r\n  console.log(`[${msg.id}] Storing data for user ${userId}`);\r\n  try {\r\n    await storeScammerData({\r\n      userId,\r\n      robloxUsername: robloxData?.name || robloxUsername,\r\n      robloxDisplayName: robloxData?.displayName || displayName,\r\n      robloxAvatar: robloxData?.avatar,\r\n      discordProfiles,\r\n      victims,\r\n      itemsScammed,\r\n      altProfiles,\r\n      threadId,\r\n      messageId: msg.id\r\n    }, env);\r\n    console.log(`[${msg.id}] Data stored successfully`);\r\n    if (jobId) await logJobActivity(env, jobId, 'store_success', msg.id, `Data stored for user ${userId}`);\r\n  } catch (err) {\r\n    console.error(`[${msg.id}] Error storing data:`, err.message);\r\n    if (jobId) await logJobActivity(env, jobId, 'store_error', msg.id, err.message);\r\n    throw err; // Re-throw to be caught by outer handler\r\n  }\r\n}\r\n\r\n/**\r\n * Store scammer data in D1 database\r\n */\r\n\r\nasync function storeScammerData(data, env) {\r\n  // Primary Discord ID (first one, or null if none)\r\n  const primaryDiscordId = data.discordProfiles[0]?.id || null;\r\n  const primaryDiscordDisplay = data.discordProfiles[0]?.displayName || null;\r\n  \r\n  // Thread evidence (just thread_id, no messages)\r\n  const threadEvidence = data.threadId ? JSON.stringify({\r\n    thread_id: data.threadId,\r\n    _pending_fetch: true\r\n  }) : null;\r\n  \r\n  await env.DB.prepare(`\r\n    INSERT INTO scammer_profile_cache (\r\n      user_id, roblox_name, roblox_display_name, roblox_avatar,\r\n      discord_id, discord_display_name,\r\n      victims, items_scammed, roblox_alts,\r\n      thread_evidence, last_message_id\r\n    )\r\n    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    ON CONFLICT(user_id) DO UPDATE SET\r\n      roblox_name = excluded.roblox_name,\r\n      roblox_display_name = excluded.roblox_display_name,\r\n      roblox_avatar = excluded.roblox_avatar,\r\n      discord_id = excluded.discord_id,\r\n      discord_display_name = excluded.discord_display_name,\r\n      victims = excluded.victims,\r\n      items_scammed = excluded.items_scammed,\r\n      roblox_alts = excluded.roblox_alts,\r\n      thread_evidence = CASE \r\n        WHEN excluded.thread_evidence IS NOT NULL THEN excluded.thread_evidence \r\n        ELSE thread_evidence \r\n      END,\r\n      last_message_id = excluded.last_message_id\r\n  `).bind(\r\n    data.userId,\r\n    data.robloxUsername,\r\n    data.robloxDisplayName,\r\n    data.robloxAvatar,\r\n    primaryDiscordId,\r\n    primaryDiscordDisplay,\r\n    data.victims,\r\n    data.itemsScammed,\r\n    JSON.stringify(data.altProfiles),\r\n    threadEvidence,\r\n    data.messageId\r\n  ).run();\r\n  \r\n  console.log(`[STORED] User ${data.userId} - ${data.robloxUsername || 'unknown'}`);\r\n}\r\n\r\n// ============================================================================\r\n// SECTION 5: QUEUE MANAGEMENT - THREAD-FIRST APPROACH\r\n// ============================================================================\r\n\r\n/**\r\n * NEW APPROACH: Fetch threads first, then channel messages\r\n * \r\n * 1. Get all threads (active + archived) in the channel\r\n * 2. For each thread, fetch all messages and download attachments\r\n * 3. Build a map: threadId -> evidence[]\r\n * 4. Get all channel messages\r\n * 5. For each message:\r\n *    - If message.id is in thread map, attach the evidence\r\n *    - Process message with its evidence bundled\r\n * \r\n * Benefits:\r\n * - Threads are fetched upfront, no \"missing thread\" bugs\r\n * - Thread ID = Message ID (Discord's design)\r\n * - Evidence is already downloaded before processing\r\n * - More efficient - fewer API calls\r\n */\r\n\r\nasync function enqueueScammerMessages(env, jobId) {\r\n  const channelId = env.DISCORD_CHANNEL_ID;\r\n  \r\n  try {\r\n    await logJobActivity(env, jobId, 'starting', null, 'Job started - fetching threads first');\r\n    \r\n    // Validate environment\r\n    if (!env.DISCORD_BOT_TOKEN) {\r\n      throw new Error('DISCORD_BOT_TOKEN not set');\r\n    }\r\n    if (!channelId) {\r\n      throw new Error('DISCORD_CHANNEL_ID not set');\r\n    }\r\n    if (!env.SCAMMER_QUEUE) {\r\n      throw new Error('SCAMMER_QUEUE binding not configured');\r\n    }\r\n    \r\n    // =========================================================================\r\n    // STEP 1: Fetch all threads (active + archived)\r\n    // =========================================================================\r\n    await logJobActivity(env, jobId, 'fetching_threads', null, 'Fetching all threads from channel');\r\n    \r\n    const allThreads = [];\r\n    \r\n    // Fetch active threads\r\n    const activeRes = await fetch(\r\n      `https://discord.com/api/v10/channels/${channelId}/threads/active`,\r\n      { headers: { Authorization: `Bot ${env.DISCORD_BOT_TOKEN}` } }\r\n    );\r\n    if (activeRes.ok) {\r\n      const activeData = await activeRes.json();\r\n      if (activeData.threads) allThreads.push(...activeData.threads);\r\n    }\r\n    await delay(500);\r\n    \r\n    // Fetch archived threads (paginated)\r\n    let hasMore = true;\r\n    let beforeTimestamp = null;\r\n    while (hasMore) {\r\n      const url = new URL(`https://discord.com/api/v10/channels/${channelId}/threads/archived/public`);\r\n      if (beforeTimestamp) url.searchParams.set('before', beforeTimestamp);\r\n      url.searchParams.set('limit', '100');\r\n      \r\n      const archivedRes = await fetch(url.toString(), {\r\n        headers: { Authorization: `Bot ${env.DISCORD_BOT_TOKEN}` }\r\n      });\r\n      \r\n      if (!archivedRes.ok) break;\r\n      \r\n      const archivedData = await archivedRes.json();\r\n      if (archivedData.threads?.length) {\r\n        allThreads.push(...archivedData.threads);\r\n        // Get the oldest thread's archive timestamp for pagination\r\n        const oldestThread = archivedData.threads[archivedData.threads.length - 1];\r\n        beforeTimestamp = oldestThread.thread_metadata?.archive_timestamp;\r\n      }\r\n      \r\n      hasMore = archivedData.has_more === true;\r\n      await delay(500);\r\n    }\r\n    \r\n    // Build a set of known thread IDs (for quick lookup)\r\n    const knownThreadIds = new Set(allThreads.map(t => t.id));\r\n    await logJobActivity(env, jobId, 'threads_indexed', null, `Indexed ${knownThreadIds.size} thread IDs`);\r\n    \r\n    // =========================================================================\r\n    // STEP 2: Fetch all channel messages (FAST - no thread evidence fetching)\r\n    // =========================================================================\r\n    await logJobActivity(env, jobId, 'fetching_messages', null, 'Fetching channel messages');\r\n    \r\n    let allMessages = [];\r\n    let lastId = null;\r\n    \r\n    while (true) {\r\n      const url = new URL(`https://discord.com/api/v10/channels/${channelId}/messages`);\r\n      url.searchParams.set('limit', '100');\r\n      if (lastId) url.searchParams.set('before', lastId);\r\n      \r\n      const response = await fetch(url.toString(), {\r\n        headers: { Authorization: `Bot ${env.DISCORD_BOT_TOKEN}` }\r\n      });\r\n      \r\n      if (response.status === 429) {\r\n        const retryAfter = await response.json();\r\n        await delay((retryAfter.retry_after || 1) * 1000);\r\n        continue;\r\n      }\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`Discord API error: ${response.status}`);\r\n      }\r\n      \r\n      const messages = await response.json();\r\n      if (messages.length === 0) break;\r\n      \r\n      allMessages.push(...messages);\r\n      lastId = messages[messages.length - 1].id;\r\n      await delay(500); // Faster - just fetching, not processing\r\n    }\r\n    \r\n    await logJobActivity(env, jobId, 'messages_fetched', null, \r\n      `Fetched ${allMessages.length} channel messages`);\r\n    \r\n    // =========================================================================\r\n    // STEP 3: Identify which messages have threads (from msg.thread or thread list)\r\n    // =========================================================================\r\n    \r\n    // Count messages with threads\r\n    const messagesWithThread = allMessages.filter(msg => \r\n      msg.thread?.id || knownThreadIds.has(msg.id)\r\n    );\r\n    \r\n    await logJobActivity(env, jobId, 'threads_identified', null, \r\n      `${messagesWithThread.length} messages have threads (will be fetched by queue consumer)`);\r\n    \r\n    // =========================================================================\r\n    // STEP 4: Bundle messages with thread IDs and enqueue\r\n    // Thread evidence will be fetched by the queue consumer for each message\r\n    // =========================================================================\r\n    \r\n    // Update total\r\n    await env.DB.prepare(`\r\n      UPDATE scammer_job_status \r\n      SET total_messages = ?, last_activity_at = ?\r\n      WHERE job_id = ?\r\n    `).bind(allMessages.length, Date.now(), jobId).run();\r\n    \r\n    // Track messages in DB\r\n    const now = Date.now();\r\n    const insertStmt = env.DB.prepare(`\r\n      INSERT INTO scammer_job_messages (job_id, message_id, status, enqueued_at)\r\n      VALUES (?, ?, ?, ?)\r\n    `);\r\n    \r\n    for (let i = 0; i < allMessages.length; i += 100) {\r\n      const chunk = allMessages.slice(i, i + 100);\r\n      const statements = chunk.map(msg => \r\n        insertStmt.bind(jobId, msg.id, 'queued', now)\r\n      );\r\n      await env.DB.batch(statements);\r\n    }\r\n    \r\n    await logJobActivity(env, jobId, 'messages_tracked', null, \r\n      `Tracked ${allMessages.length} messages`);\r\n    \r\n    // Create queue messages with thread ID (evidence will be fetched by consumer)\r\n    const queueMessages = allMessages.map(msg => {\r\n      // Check if this message has a thread\r\n      // Thread ID comes from: msg.thread.id (Discord includes it) OR the message ID is in our thread list\r\n      const threadId = msg.thread?.id || (knownThreadIds.has(msg.id) ? msg.id : null);\r\n      \r\n        return {\r\n        body: {\r\n          jobId,\r\n          messageId: msg.id,\r\n          channelId,\r\n          message: msg,\r\n          threadId: threadId // Just the ID - consumer will fetch evidence\r\n        }\r\n      };\r\n    });\r\n    \r\n    // Send to queue\r\n    for (let i = 0; i < queueMessages.length; i += 100) {\r\n      const batch = queueMessages.slice(i, i + 100);\r\n      await env.SCAMMER_QUEUE.sendBatch(batch);\r\n    }\r\n    \r\n    const withThreads = queueMessages.filter(m => m.body.threadId).length;\r\n    await logJobActivity(env, jobId, 'queued', null, \r\n      `Queued ${allMessages.length} messages (${withThreads} have threads - evidence will be fetched by consumer)`);\r\n    \r\n    return {\r\n      queued: allMessages.length,\r\n      total: allMessages.length,\r\n      threads: allThreads.length,\r\n      withThreads: withThreads,\r\n      message: `Added ${allMessages.length} messages to queue. ${withThreads} have pre-fetched thread evidence.`\r\n    };\r\n    \r\n    } catch (err) {\r\n    await logJobActivity(env, jobId, 'failed', null, `Failed: ${err.message}`);\r\n    await env.DB.prepare(`\r\n      UPDATE scammer_job_status \r\n      SET status = 'failed', error = ?, last_activity_at = ?\r\n      WHERE job_id = ?\r\n    `).bind(err.message, Date.now(), jobId).run();\r\n    throw err;\r\n  }\r\n}\r\n\r\n/**\r\n * NOTE: Queue consumer is handled by emwiki/workers/scammer-queue-consumer.js\r\n * Pages Functions do not support queue consumers directly.\r\n */\r\n\r\n// ============================================================================\r\n// NOTE: Media handling moved to queue consumer\r\n// See: emwiki/workers/scammer-queue-consumer.js  \r\n// ============================================================================\r\n\r\n// ============================================================================\r\n// SECTION 7: API ENDPOINT HANDLER\r\n// ============================================================================\r\n\r\n/**\r\n * Main API endpoint handler\r\n * Handles all GET requests to /api/roblox-proxy\r\n */\r\nexport async function onRequestGet(context) {\r\n  const { request, env } = context;\r\n  const url = new URL(request.url);\r\n  const mode = url.searchParams.get(\"mode\");\r\n  const userId = url.searchParams.get(\"userId\");\r\n  const isLiteMode = url.searchParams.get(\"mode\") === \"lite\";\r\n  const discordId = url.searchParams.get(\"discordId\");\r\n  const forceRefresh = url.searchParams.get(\"refresh\") === \"true\";\r\n\r\n  // Helper function to get CDN URL from hash\r\n  function getCdnUrl(hash) {\r\n    let i = 31;\r\n    for (let t = 0; t < 38; t++) {\r\n      i ^= hash.charCodeAt(t);\r\n    }\r\n    return `https://t${(i % 8).toString()}.rbxcdn.com/${hash}`;\r\n  }\r\n\r\n  // Handle Discord video/media proxy (for videos and other media that require auth)\r\n  if (mode === \"discord-media\") {\r\n    const mediaUrl = url.searchParams.get(\"url\");\r\n    if (!mediaUrl) {\r\n      return new Response(JSON.stringify({ error: 'Media URL required' }), {\r\n        status: 400,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n\r\n    // Validate that it's a Discord CDN URL\r\n    if (!mediaUrl.startsWith('https://cdn.discordapp.com/') && !mediaUrl.startsWith('https://media.discordapp.net/')) {\r\n      return new Response(JSON.stringify({ error: 'Invalid Discord media URL' }), {\r\n        status: 400,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n\r\n    try {\r\n      // Fetch the media with Discord bot authentication\r\n      const mediaResponse = await fetch(mediaUrl, {\r\n        headers: { Authorization: `Bot ${env.DISCORD_BOT_TOKEN}` }\r\n      });\r\n\r\n      if (!mediaResponse.ok) {\r\n        return new Response(JSON.stringify({\r\n          error: 'Media not found',\r\n          status: mediaResponse.status\r\n        }), {\r\n          status: mediaResponse.status,\r\n          headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n        });\r\n      }\r\n\r\n      // Get the content type from the original response\r\n      const contentType = mediaResponse.headers.get('content-type') || 'application/octet-stream';\r\n      const contentLength = mediaResponse.headers.get('content-length');\r\n      \r\n      // Stream the response directly (better for large videos)\r\n      // Cloudflare Workers will handle streaming automatically\r\n      const headers = {\r\n        \"Content-Type\": contentType,\r\n        \"Access-Control-Allow-Origin\": \"*\",\r\n        \"Cache-Control\": \"public, max-age=86400\", // Cache for 24 hours\r\n        \"Accept-Ranges\": \"bytes\" // Support range requests for video seeking\r\n      };\r\n      \r\n      if (contentLength) {\r\n        headers[\"Content-Length\"] = contentLength;\r\n      }\r\n\r\n      // Return the response body directly - Cloudflare Workers streams it automatically\r\n      return new Response(mediaResponse.body, { headers });\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Handle CDN asset proxy (for OBJ, MTL, textures)\r\n  if (mode === \"cdn-asset\") {\r\n    const hash = url.searchParams.get(\"hash\");\r\n    if (!hash) {\r\n      return new Response(JSON.stringify({ error: 'Hash required' }), {\r\n        status: 400,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n\r\n    try {\r\n      const cdnUrl = getCdnUrl(hash);\r\n      console.log('Fetching CDN URL:', cdnUrl);\r\n      const assetResponse = await fetch(cdnUrl);\r\n\r\n      if (!assetResponse.ok) {\r\n        console.error('CDN fetch failed:', assetResponse.status, cdnUrl);\r\n        return new Response(JSON.stringify({\r\n          error: 'Asset not found',\r\n          cdnUrl: cdnUrl,\r\n          status: assetResponse.status\r\n        }), {\r\n          status: 404,\r\n          headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n        });\r\n      }\r\n\r\n      // Get the content type from the original response\r\n      const contentType = assetResponse.headers.get('content-type') || 'application/octet-stream';\r\n      const assetData = await assetResponse.arrayBuffer();\r\n\r\n      return new Response(assetData, {\r\n        headers: {\r\n          \"Content-Type\": contentType,\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Cache-Control\": \"public, max-age=86400\" // Cache for 24 hours\r\n        }\r\n      });\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Handle badge data proxy (for CORS)\r\n  if (mode === \"badge\") {\r\n    const badgeId = url.searchParams.get(\"badgeId\");\r\n    if (!badgeId || !/^\\d{9,}$/.test(badgeId)) {\r\n      return new Response(JSON.stringify({ error: 'Valid 9+ digit badge ID required' }), {\r\n        status: 400,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n\r\n    try {\r\n      const badgeResponse = await fetch(`https://badges.roblox.com/v1/badges/${badgeId}`);\r\n      \r\n      if (!badgeResponse.ok) {\r\n        return new Response(JSON.stringify({ error: 'Badge not found', status: badgeResponse.status }), {\r\n          status: badgeResponse.status,\r\n          headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n        });\r\n      }\r\n\r\n      const badgeData = await badgeResponse.json();\r\n      return new Response(JSON.stringify(badgeData), {\r\n        headers: { \r\n          \"Content-Type\": \"application/json\", \r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Cache-Control\": \"public, max-age=3600\" // Cache for 1 hour\r\n        }\r\n      });\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Handle 3D avatar mode\r\n  if (mode === \"avatar-3d\" && userId) {\r\n    try {\r\n      // Fetch 3D avatar data\r\n      const avatar3dResponse = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-3d?userId=${userId}`);\r\n      const avatar3dData = await avatar3dResponse.json();\r\n\r\n      if (avatar3dData.state !== 'Completed' || !avatar3dData.imageUrl) {\r\n        return new Response(JSON.stringify({\r\n          error: 'Avatar not ready',\r\n          state: avatar3dData.state\r\n        }), {\r\n          status: 404,\r\n          headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n        });\r\n      }\r\n\r\n      // Fetch the metadata\r\n      const metadataResponse = await fetch(avatar3dData.imageUrl);\r\n      const metadata = await metadataResponse.json();\r\n\r\n      return new Response(JSON.stringify(metadata), {\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n      });\r\n    }\r\n  }\r\n\r\n  if (isLiteMode) {\r\n    // Just fetch live and return directly without writing to DB\r\n    const [userData, avatarData] = await Promise.all([\r\n      fetch(`https://users.roblox.com/v1/users/${userId}`).then(r => r.ok ? r.json() : null),\r\n      fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png&isCircular=true`)\r\n        .then(r => r.ok ? r.json() : null)\r\n    ]);\r\n\r\n    if (!userData) throw new Error(\"Failed to fetch Roblox user data\");\r\n\r\n    return new Response(JSON.stringify({\r\n      name: userData.name,\r\n      displayName: userData.displayName,\r\n      avatar: avatarData?.data?.[0]?.imageUrl || null\r\n    }), { headers: { \"Content-Type\": \"application/json\",\"Access-Control-Allow-Origin\": \"*\" } });\r\n  }\r\n  // =========================================================================\r\n  // DEPRECATED ENDPOINTS\r\n  // Legacy R2 migration modes - return 410 Gone\r\n  // Media now uses Cloudflare Images/Stream via scammer-queue-consumer.js\r\n  // =========================================================================\r\n  if (mode === \"migrate-videos-to-stream\" || mode === \"migrate-videos-to-r2\" || \r\n      mode === \"update-thread-evidence\" || mode === \"migrate-images-to-r2\") {\r\n    return new Response(JSON.stringify({ \r\n      error: \"Deprecated. Use the queue-based system.\",\r\n      redirect: \"/api/roblox-proxy?mode=discord-scammers&action=start\"\r\n    }), {\r\n      status: 410,\r\n      headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" }\r\n    });\r\n  }\r\n\r\n  // Handle thread evidence endpoint - MUST come before general endpoint check\r\n  if (mode === \"thread-evidence\" && userId) {\r\n    try {\r\n      const result = await env.DB.prepare(\r\n        \"SELECT thread_evidence FROM scammer_profile_cache WHERE user_id = ?\"\r\n      ).bind(userId).first();\r\n\r\n      if (!result) {\r\n        return new Response(JSON.stringify({ \r\n          error: \"No thread evidence found for this user\",\r\n          thread_evidence: null,\r\n          user_id: userId,\r\n          debug: \"User not found in database\"\r\n        }), {\r\n          status: 404,\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n\r\n      if (!result.thread_evidence) {\r\n        return new Response(JSON.stringify({ \r\n          error: \"No thread evidence found for this user\",\r\n          thread_evidence: null,\r\n          user_id: userId,\r\n          debug: \"User found but thread_evidence is null\"\r\n        }), {\r\n          status: 404,\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n\r\n      const threadEvidence = JSON.parse(result.thread_evidence);\r\n      return new Response(JSON.stringify({ \r\n        user_id: userId,\r\n        thread_evidence: threadEvidence \r\n      }), {\r\n        headers: { \r\n          \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\" \r\n        },\r\n      });\r\n    } catch (err) {\r\n      console.error(\"Thread evidence fetch error:\", err);\r\n      return new Response(JSON.stringify({ \r\n        error: err.message,\r\n        user_id: userId,\r\n        debug: err.stack\r\n      }), {\r\n        status: 500,\r\n        headers: { \r\n          \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\" \r\n        },\r\n      });\r\n    }\r\n  }\r\n\r\n  // General roblox-proxy endpoint (for credits, item makers, etc.)\r\n  // Must come AFTER thread-evidence check to avoid conflicts\r\n  if (url.pathname.endsWith(\"/api/roblox-proxy\") && userId && mode !== \"thread-evidence\") {\r\n    try {\r\n      // Fetch Roblox data - DON'T write to scammer cache (writeToScammerCache = false)\r\n      const robloxData = await fetchRobloxProfile(userId, env, false);\r\n      \r\n      if (!robloxData) {\r\n        throw new Error(\"Failed to fetch Roblox user data\");\r\n      }\r\n\r\n      // Fetch Discord data if discordId provided - DON'T write to scammer cache\r\n      let discordData = null;\r\n      if (discordId) {\r\n        discordData = await fetchDiscordProfile(discordId, env, null, false);\r\n      }\r\n\r\n      return new Response(JSON.stringify({\r\n        name: robloxData.name,\r\n        displayName: robloxData.displayName,\r\n        avatar: robloxData.avatar || null,\r\n        discordDisplayName: discordData?.displayName || null,\r\n        discordAvatar: discordData?.avatar || null\r\n      }), { \r\n        headers: { \r\n          \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\" \r\n        } \r\n      });\r\n\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), { \r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\" }\r\n      });\r\n    }\r\n  }\r\n\r\n  if (mode === \"discord-scammers\") {\r\n    try {\r\n      const urlParams = new URL(request.url).searchParams;\r\n      const action = urlParams.get('action');\r\n      const jobId = urlParams.get('jobId');\r\n      \r\n      // Action: start - Start a new processing job\r\n      if (action === 'start') {\r\n        // Check if there's already a running job\r\n        const runningJob = await env.DB.prepare(`\r\n          SELECT job_id, started_at, messages_processed, total_messages\r\n          FROM scammer_job_status\r\n          WHERE status = 'running'\r\n          ORDER BY started_at DESC\r\n          LIMIT 1\r\n        `).first();\r\n        \r\n        if (runningJob) {\r\n          const runningTime = Date.now() - runningJob.started_at;\r\n          const tenMinutes = 10 * 60 * 1000;\r\n          \r\n          // If job is stuck (running > 10 minutes), cancel it\r\n          if (runningTime > tenMinutes) {\r\n            await env.DB.prepare(`\r\n              UPDATE scammer_job_status \r\n              SET status = 'failed', error = 'Cancelled - stuck for too long'\r\n              WHERE job_id = ?\r\n            `).bind(runningJob.job_id).run();\r\n            } else {\r\n            // Job is still running and not stuck\r\n          return new Response(JSON.stringify({ \r\n              error: 'A job is already running',\r\n              runningJob: {\r\n                jobId: runningJob.job_id,\r\n                startedAt: runningJob.started_at,\r\n                messagesProcessed: runningJob.messages_processed,\r\n                totalMessages: runningJob.total_messages,\r\n                runningTimeMinutes: Math.round(runningTime / 1000 / 60)\r\n              },\r\n              message: 'Use ?action=status&jobId=' + runningJob.job_id + ' to check progress, or ?action=cancel&jobId=' + runningJob.job_id + ' to cancel it.'\r\n            }), {\r\n              status: 409, // Conflict\r\n            headers: { \r\n              \"Content-Type\": \"application/json\", \r\n              \"Access-Control-Allow-Origin\": \"*\" \r\n            },\r\n          });\r\n        }\r\n      }\r\n\r\n        // Cancel any other stuck jobs (running > 10 minutes)\r\n        const tenMinutesAgo = Date.now() - (10 * 60 * 1000);\r\n        await env.DB.prepare(`\r\n          UPDATE scammer_job_status \r\n          SET status = 'failed', error = 'Cancelled - stuck for too long'\r\n          WHERE status = 'running' AND started_at < ?\r\n        `).bind(tenMinutesAgo).run();\r\n        \r\n        const newJobId = `job_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n        const now = Date.now();\r\n        \r\n        // Create job status entry\r\n        await env.DB.prepare(`\r\n          INSERT INTO scammer_job_status (job_id, status, started_at, messages_processed, messages_seen, total_messages)\r\n          VALUES (?, 'running', ?, 0, 0, 0)\r\n        `).bind(newJobId, now).run();\r\n        \r\n        // Enqueue all messages - they'll be processed automatically by queue consumer\r\n        const queueResult = await enqueueScammerMessages(env, newJobId);\r\n\r\n            return new Response(JSON.stringify({ \r\n          jobId: newJobId,\r\n          status: 'queued',\r\n          queued: queueResult.queued,\r\n          total: queueResult.total,\r\n          message: `Added ${queueResult.queued} messages to queue. They will be processed automatically. Use ?action=status&jobId=${newJobId} to check progress.`\r\n            }), {\r\n              headers: { \r\n                \"Content-Type\": \"application/json\", \r\n                \"Access-Control-Allow-Origin\": \"*\" \r\n              },\r\n            });\r\n          }\r\n\r\n      // Action: status - Check job status\r\n      if (action === 'status') {\r\n        // If jobId provided, check specific job\r\n        if (jobId) {\r\n          const jobStatus = await env.DB.prepare(`\r\n            SELECT job_id, status, messages_processed, total_messages, started_at, completed_at, \r\n                   last_activity_at, current_message_id, current_step, error, logs\r\n            FROM scammer_job_status\r\n            WHERE job_id = ?\r\n          `).bind(jobId).first();\r\n          \r\n          if (!jobStatus) {\r\n            return new Response(JSON.stringify({ error: 'Job not found' }), {\r\n              status: 404,\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n        });\r\n      }\r\n\r\n          // Parse logs\r\n          if (jobStatus.logs) {\r\n            try {\r\n              jobStatus.logs = JSON.parse(jobStatus.logs);\r\n            } catch (e) {\r\n              jobStatus.logs = [];\r\n        }\r\n      } else {\r\n            jobStatus.logs = [];\r\n          }\r\n          \r\n          // Add summary information\r\n          const messagesSkipped = (jobStatus.total_messages || 0) - (jobStatus.messages_processed || 0);\r\n          jobStatus.summary = {\r\n            total_messages: jobStatus.total_messages || 0,\r\n            messages_processed: jobStatus.messages_processed || 0,\r\n            messages_skipped: messagesSkipped,\r\n            note: messagesSkipped > 0 ? `${messagesSkipped} messages were skipped (no Roblox profile URL found). This is normal - not all Discord messages contain scammer reports.` : 'All messages processed successfully.'\r\n          };\r\n          \r\n          // Check if job is stuck (running for more than 10 minutes)\r\n          if (jobStatus.status === 'running') {\r\n            const now = Date.now();\r\n            const runningTime = now - jobStatus.started_at;\r\n            const timeSinceLastActivity = jobStatus.last_activity_at ? now - jobStatus.last_activity_at : runningTime;\r\n            const tenMinutes = 10 * 60 * 1000;\r\n            \r\n            if (runningTime > tenMinutes) {\r\n              // Mark as failed if stuck\r\n              const stuckReason = `Job stuck - running for ${Math.round(runningTime / 1000 / 60)} minutes, last activity ${Math.round(timeSinceLastActivity / 1000 / 60)} minutes ago. Current step: ${jobStatus.current_step || 'unknown'}, Current message: ${jobStatus.current_message_id || 'none'}`;\r\n              await env.DB.prepare(`\r\n                UPDATE scammer_job_status \r\n                SET status = 'failed', error = ?\r\n                WHERE job_id = ?\r\n              `).bind(stuckReason, jobId).run();\r\n              \r\n              jobStatus.status = 'failed';\r\n              jobStatus.error = stuckReason;\r\n            }\r\n          }\r\n          \r\n          return new Response(JSON.stringify(jobStatus), {\r\n            headers: { \r\n              \"Content-Type\": \"application/json\",\r\n              \"Access-Control-Allow-Origin\": \"*\" \r\n            },\r\n          });\r\n        } else {\r\n          // No jobId - return all jobs\r\n          const allJobs = await env.DB.prepare(`\r\n            SELECT job_id, status, messages_processed, total_messages, started_at, completed_at, error\r\n            FROM scammer_job_status\r\n            ORDER BY started_at DESC\r\n            LIMIT 20\r\n          `).all();\r\n          \r\n          return new Response(JSON.stringify({ jobs: allJobs.results || [] }), {\r\n            headers: { \r\n              \"Content-Type\": \"application/json\",\r\n              \"Access-Control-Allow-Origin\": \"*\" \r\n            },\r\n          });\r\n        }\r\n      }\r\n      \r\n      // Action: cancel - Cancel a running job\r\n      if (action === 'cancel' && jobId) {\r\n        const result = await env.DB.prepare(`\r\n          UPDATE scammer_job_status \r\n          SET status = 'failed', error = 'Cancelled by user'\r\n          WHERE job_id = ? AND status = 'running'\r\n        `).bind(jobId).run();\r\n        \r\n        return new Response(JSON.stringify({ \r\n          success: result.changes > 0,\r\n          message: result.changes > 0 ? 'Job cancelled' : 'Job not found or not running'\r\n        }), {\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n      \r\n      // Action: force-complete - Force complete a stuck job\r\n      if (action === 'force-complete' && jobId) {\r\n        const result = await env.DB.prepare(`\r\n          UPDATE scammer_job_status \r\n          SET status = 'completed', completed_at = ?, error = 'Force completed by user'\r\n          WHERE job_id = ? AND status IN ('running', 'completing')\r\n        `).bind(Date.now(), jobId).run();\r\n        \r\n        // Get scammer count for confirmation\r\n        const scammerCount = await env.DB.prepare(`\r\n          SELECT COUNT(*) as count FROM scammer_profile_cache\r\n        `).first();\r\n        \r\n        return new Response(JSON.stringify({ \r\n          success: result.changes > 0,\r\n          message: result.changes > 0 \r\n            ? `Job force-completed. You have ${scammerCount?.count || 0} scammers in the database.` \r\n            : 'Job not found or already completed',\r\n          scammers_in_db: scammerCount?.count || 0\r\n        }), {\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n      \r\n      // Action: cleanup - Mark all stuck jobs as failed\r\n      if (action === 'cleanup') {\r\n        const tenMinutesAgo = Date.now() - (10 * 60 * 1000);\r\n        const result = await env.DB.prepare(`\r\n          UPDATE scammer_job_status \r\n          SET status = 'failed', error = 'Cleaned up - stuck job'\r\n          WHERE status IN ('running', 'completing') AND last_activity_at < ?\r\n        `).bind(tenMinutesAgo).run();\r\n        \r\n        return new Response(JSON.stringify({ \r\n          cleaned: result.changes,\r\n          message: `Cleaned up ${result.changes} stuck jobs`\r\n        }), {\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n      \r\n      // Action: debug - Check message tracking table status\r\n      if (action === 'debug' && jobId) {\r\n        // Check job status\r\n        const jobStatus = await env.DB.prepare(`\r\n          SELECT * FROM scammer_job_status WHERE job_id = ?\r\n        `).bind(jobId).first();\r\n        \r\n        // Check message tracking counts\r\n        const messageCounts = await env.DB.prepare(`\r\n          SELECT status, COUNT(*) as count \r\n          FROM scammer_job_messages \r\n          WHERE job_id = ?\r\n          GROUP BY status\r\n        `).bind(jobId).all();\r\n        \r\n        // Check scammer count\r\n        const scammerCount = await env.DB.prepare(`\r\n          SELECT COUNT(*) as count FROM scammer_profile_cache\r\n        `).first();\r\n        \r\n        // Sample of messages\r\n        const sampleMessages = await env.DB.prepare(`\r\n          SELECT message_id, status, error, processed_at\r\n          FROM scammer_job_messages \r\n          WHERE job_id = ?\r\n          ORDER BY processed_at DESC\r\n          LIMIT 10\r\n        `).bind(jobId).all();\r\n        \r\n        return new Response(JSON.stringify({ \r\n          job: jobStatus,\r\n          messagesByStatus: messageCounts.results || [],\r\n          scammersInDb: scammerCount?.count || 0,\r\n          sampleMessages: sampleMessages.results || [],\r\n          tip: 'If all messages are still \"queued\", the queue consumer is not processing them. Check: 1) Consumer is deployed, 2) Consumer logs in Cloudflare dashboard'\r\n        }, null, 2), {\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\" \r\n          },\r\n        });\r\n      }\r\n      \r\n      // No action or default: Return results from D1\r\n      const { results } = await env.DB.prepare(`\r\n        SELECT \r\n          user_id,\r\n          roblox_name,\r\n          roblox_display_name,\r\n          roblox_avatar,\r\n          discord_id,\r\n          discord_display_name,\r\n          victims,\r\n          items_scammed,\r\n          roblox_alts,\r\n          thread_evidence\r\n        FROM scammer_profile_cache\r\n        WHERE user_id IS NOT NULL \r\n        ORDER BY updated_at DESC\r\n      `).all();\r\n\r\n      const scammers = results.map(row => ({\r\n          user_id: row.user_id,\r\n        robloxDisplay: row.roblox_display_name || null,\r\n        robloxUser: row.roblox_name || null,\r\n        avatar: row.roblox_avatar || \"https://emwiki.com/imgs/plr.jpg\",\r\n          discordDisplay: row.discord_display_name || null,\r\n        discordId: row.discord_id || null,\r\n          victims: row.victims || null,\r\n          itemsScammed: row.items_scammed || null,\r\n          robloxAlts: row.roblox_alts ? JSON.parse(row.roblox_alts) : [],\r\n          hasThreadEvidence: !!row.thread_evidence\r\n      }));\r\n\r\n      return new Response(JSON.stringify({ \r\n        scammers\r\n      }), {\r\n        headers: { \r\n          \"Content-Type\": \"application/json\", \r\n          \"Access-Control-Allow-Origin\": \"*\" \r\n        },\r\n      });\r\n\r\n    } catch (err) {\r\n      console.error(\"Discord Scammers Error:\", err);\r\n      return new Response(JSON.stringify({ error: err.message, stack: err.stack }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      });\r\n    }\r\n  }\r\n\r\n  // Fallback userId/discordId logic remains unchanged...\r\n}\r\n", "/**\n * Legacy upload endpoint - uses Cloudflare Images\n * \n * This endpoint now uploads directly to Cloudflare Images instead of R2.\n * Maintains backwards compatibility with existing admin panel code.\n * \n * For new code, use /api/images/upload directly.\n */\nexport async function onRequestPost({ request, env }) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get(\"file\");\n\n    if (!file) {\n      return new Response(JSON.stringify({ error: \"No file uploaded\" }), { \n        status: 400,\n        headers: { \"Content-Type\": \"application/json\" }\n      });\n    }\n\n    // Get Cloudflare Images credentials\n    const accountId = env.CF_ACCOUNT_ID || 'd9fecb3357660ea0fcfee5b23d5dd2f6';\n    const accountHash = env.CF_ACCOUNT_HASH || 'I2Jsf9fuZwSztWJZaX0DJA';\n    const apiToken = env.CF_IMAGES_API_TOKEN;\n\n    if (!accountId || !apiToken) {\n      return new Response(JSON.stringify({ \n        error: 'Cloudflare Images not configured' \n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Prepare form data for Cloudflare Images API\n    const cfFormData = new FormData();\n    cfFormData.append('file', file);\n\n    // Upload to Cloudflare Images\n    const response = await fetch(\n      `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${apiToken}`\n        },\n        body: cfFormData\n      }\n    );\n\n    if (!response.ok) {\n      const errorData = await response.text();\n      console.error('Cloudflare Images API error:', errorData);\n      return new Response(JSON.stringify({ \n        error: 'Failed to upload image',\n        details: errorData\n      }), {\n        status: response.status,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const data = await response.json();\n\n    if (!data.success) {\n      return new Response(JSON.stringify({ \n        error: 'Upload failed',\n        details: data.errors\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    // Return the image URL (use account hash to construct URL)\n    const imageId = data.result.id;\n    const variants = data.result.variants || [];\n    const publicVariant = variants.find(v => v.includes('/public')) || variants[0] || '';\n    const imageUrl = publicVariant || `https://imagedelivery.net/${accountHash}/${imageId}/public`;\n\n    return new Response(JSON.stringify({ \n      success: true,\n      url: imageUrl,\n      id: imageId,\n      variants: variants\n    }), {\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  } catch (err) {\n    return new Response(JSON.stringify({ \n      error: \"Upload failed: \" + err.message \n    }), { \n      status: 500,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  }\n}\n", "/**\r\n * ============================================================================\r\n * DONATIONS API - Handles donation tracking with webhook and scheduled updates\r\n * ============================================================================\r\n * \r\n * Endpoints:\r\n * - POST /api/donations - Legacy endpoint (backward compatibility)\r\n * - POST /api/donations/webhook - Webhook endpoint from Roblox game\r\n * - GET /api/donations?mode=fetch - Scheduled fetch from Roblox API (for cron)\r\n * - GET /api/donations - Returns donation leaderboard\r\n * \r\n * Storage Structure:\r\n * - purchase:{userId} - Aggregated totals per user (userId, totalSpent, purchases)\r\n * - token:{purchaseToken} - Lookup to prevent duplicate processing\r\n * ============================================================================\r\n */\r\n\r\n/**\r\n * Replace aggregated totals for a user (used when recalculating from scratch)\r\n */\r\nasync function replaceUserTotals(kv, userId, totalSpent, purchases) {\r\n  const userIdStr = String(userId);\r\n  const purchaseKey = `purchase:${userIdStr}`;\r\n  \r\n  await kv.put(purchaseKey, JSON.stringify({\r\n    userId: parseInt(userIdStr),\r\n    totalSpent,\r\n    purchases\r\n  }));\r\n\r\n  return { totalSpent, purchases };\r\n}\r\n\r\n/**\r\n * Process Roblox transaction API response and replace totals (recalculate from scratch)\r\n * Filters by universe name: \"\uD83D\uDC64 EMWIKI Account Linker \uD83C\uDF10\"\r\n */\r\nasync function processRobloxTransactionsReplace(kv, transactions, allowedUniverseName) {\r\n  // Group transactions by buyer (agent.id)\r\n  const userTotals = new Map(); // userId -> { totalSpent, purchases }\r\n  const foundUniverseNames = new Set(); // For debugging\r\n  let skippedCount = 0;\r\n  let processedCount = 0;\r\n\r\n  // Default universe name if not specified\r\n  const targetUniverseName = allowedUniverseName || \"\uD83D\uDC64 EMWIKI Account Linker \uD83C\uDF10\";\r\n\r\n  for (const tx of transactions) {\r\n    // Only process \"Sale\" transactions with currency type \"Robux\"\r\n    if (tx.transactionType !== 'Sale' || tx.currency?.type !== 'Robux') {\r\n      skippedCount++;\r\n      continue;\r\n    }\r\n\r\n    // Filter by universe name\r\n    const universeName = tx.details?.place?.name;\r\n    if (universeName) {\r\n      foundUniverseNames.add(universeName);\r\n    }\r\n\r\n    // Check if universe name matches\r\n    if (universeName !== targetUniverseName) {\r\n      skippedCount++;\r\n      continue; // Skip transactions not from our universe\r\n    }\r\n\r\n    // Extract user ID from agent (the buyer)\r\n    const userId = tx.agent?.id;\r\n    if (!userId) {\r\n      skippedCount++;\r\n      continue;\r\n    }\r\n\r\n    // Extract price (in Robux, after Roblox takes 30% tax)\r\n    // Add back the 30% tax to get the actual amount the user paid\r\n    const priceAfterTax = tx.currency?.amount || 0;\r\n    if (priceAfterTax <= 0) {\r\n      skippedCount++;\r\n      continue;\r\n    }\r\n    // Calculate actual price: priceAfterTax / 0.7 = priceBeforeTax\r\n    // Example: 70 Robux after tax = 100 Robux before tax\r\n    const price = Math.round(priceAfterTax / 0.7);\r\n\r\n    // Accumulate totals per user\r\n    const userIdStr = String(userId);\r\n    if (!userTotals.has(userIdStr)) {\r\n      userTotals.set(userIdStr, { totalSpent: 0, purchases: 0 });\r\n    }\r\n    \r\n    const totals = userTotals.get(userIdStr);\r\n    totals.totalSpent += price;\r\n    totals.purchases += 1;\r\n    processedCount++;\r\n  }\r\n\r\n  // Replace all user totals in KV\r\n  const processed = [];\r\n  for (const [userIdStr, totals] of userTotals.entries()) {\r\n    await replaceUserTotals(kv, userIdStr, totals.totalSpent, totals.purchases);\r\n    processed.push({\r\n      userId: userIdStr,\r\n      totalSpent: totals.totalSpent,\r\n      purchases: totals.purchases\r\n    });\r\n  }\r\n\r\n  // Add debug info to response\r\n  return {\r\n    processed,\r\n    debug: {\r\n      totalTransactions: transactions.length,\r\n      processedCount,\r\n      skippedCount,\r\n      targetUniverseName,\r\n      foundUniverseNames: Array.from(foundUniverseNames) // Show all found universe names\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Fetch transactions from Roblox API for a specific user (requires authentication cookie)\r\n */\r\nasync function fetchUserTransactions(userId, robloxCookie, cursor = '') {\r\n  try {\r\n    const url = new URL(`https://apis.roblox.com/transaction-records/v1/users/${userId}/transactions`);\r\n    if (cursor) {\r\n      url.searchParams.set('cursor', cursor);\r\n    }\r\n    url.searchParams.set('limit', '100');\r\n    url.searchParams.set('transactionType', 'Sale');\r\n    url.searchParams.set('itemPricingType', 'PaidAndLimited');\r\n\r\n    // Format cookie header correctly: .ROBLOSECURITY=<value>\r\n    // Handle both cases: if user provides just the value or the full cookie string\r\n    const cookieValue = robloxCookie.startsWith('.ROBLOSECURITY=') \r\n      ? robloxCookie \r\n      : `.ROBLOSECURITY=${robloxCookie}`;\r\n\r\n    const headers = {\r\n      'Cookie': cookieValue,\r\n      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\r\n    };\r\n\r\n    const response = await fetch(url.toString(), { headers });\r\n    if (!response.ok) {\r\n      console.error(`Failed to fetch transactions for user ${userId}: ${response.status} ${response.statusText}`);\r\n      return null;\r\n    }\r\n\r\n    return await response.json();\r\n  } catch (e) {\r\n    console.error(`Error fetching transactions for user ${userId}:`, e);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Scheduled fetch mode - processes transactions from Roblox API\r\n * Only fetches for owner's user ID using their cookie\r\n * Filters by specific developer product IDs and replaces totals\r\n */\r\nasync function handleScheduledFetch(request, env, kv) {\r\n  try {\r\n    // Get owner's user ID and Roblox cookie from environment variables\r\n    const ownerUserId = env.DONATIONS_OWNER_USER_ID;\r\n    const robloxCookie = env.ROBLOX_COOKIE;\r\n    const universeName = env.DONATIONS_UNIVERSE_NAME; // Optional: universe name to filter by\r\n\r\n    if (!ownerUserId) {\r\n      return new Response(JSON.stringify({ error: 'DONATIONS_OWNER_USER_ID not configured' }), {\r\n        status: 500,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    }\r\n\r\n    if (!robloxCookie) {\r\n      return new Response(JSON.stringify({ error: 'ROBLOX_COOKIE not configured' }), {\r\n        status: 500,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    }\r\n\r\n    // Use universe name from env or default to \"\uD83D\uDC64 EMWIKI Account Linker \uD83C\uDF10\"\r\n    const targetUniverseName = universeName || \"\uD83D\uDC64 EMWIKI Account Linker \uD83C\uDF10\";\r\n\r\n    // Fetch all transactions for owner's account\r\n    let allTransactions = [];\r\n    let cursor = '';\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const data = await fetchUserTransactions(ownerUserId, robloxCookie, cursor);\r\n      if (!data || !data.data || data.data.length === 0) {\r\n        hasMore = false;\r\n        break;\r\n      }\r\n\r\n      allTransactions.push(...data.data);\r\n\r\n      cursor = data.nextPageCursor || null;\r\n      hasMore = !!cursor;\r\n\r\n      // Rate limiting: wait between API calls\r\n      if (hasMore) {\r\n        await new Promise(r => setTimeout(r, 500));\r\n      }\r\n    }\r\n\r\n    // Process all transactions and replace totals\r\n    const result = await processRobloxTransactionsReplace(kv, allTransactions, targetUniverseName);\r\n    const processed = result.processed;\r\n    const debug = result.debug;\r\n\r\n    return new Response(JSON.stringify({\r\n      status: 'ok',\r\n      ownerUserId,\r\n      totalTransactions: allTransactions.length,\r\n      processedUsers: processed.length,\r\n      targetUniverseName: debug.targetUniverseName,\r\n      results: processed,\r\n      debug: {\r\n        processedCount: debug.processedCount,\r\n        skippedCount: debug.skippedCount,\r\n        foundUniverseNames: debug.foundUniverseNames\r\n      }\r\n    }), {\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.error('Scheduled fetch error:', e);\r\n    return new Response(JSON.stringify({ error: e.message }), {\r\n      status: 500,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Webhook endpoint - receives transaction data from Roblox game\r\n */\r\nasync function handleWebhook(request, env, kv) {\r\n  try {\r\n    const data = await request.json();\r\n\r\n    // Support multiple formats:\r\n    // 1. Game format: {userId, productId, price}\r\n    // 2. Full Roblox API format: {transactionType: 'Sale', agent: {id}, currency: {amount}, ...}\r\n    // 3. Array of either format\r\n    let transactions = [];\r\n    \r\n    if (Array.isArray(data)) {\r\n      transactions = data;\r\n    } else if (data.transactions && Array.isArray(data.transactions)) {\r\n      transactions = data.transactions;\r\n    } else if (data.userId && data.price !== undefined) {\r\n      // Game format: simple {userId, productId, price}\r\n      transactions = [data];\r\n    } else if (data.transactionType === 'Sale') {\r\n      // Full Roblox API format\r\n      transactions = [data];\r\n    } else {\r\n      return new Response(JSON.stringify({ error: 'Invalid webhook format' }), {\r\n        status: 400,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Access-Control-Allow-Origin': '*'\r\n        }\r\n      });\r\n    }\r\n\r\n    // Process transactions (handles both formats)\r\n    const processed = [];\r\n    const seenTokens = new Set();\r\n\r\n    for (const tx of transactions) {\r\n      let userId, price;\r\n\r\n      // Check if it's the game format (simple: {userId, productId, price})\r\n      if (tx.userId !== undefined && tx.price !== undefined) {\r\n        userId = tx.userId;\r\n        price = tx.price;\r\n        \r\n        // Validate\r\n        if (!userId || price <= 0) continue;\r\n      }\r\n      // Check if it's the full Roblox API format\r\n      else if (tx.transactionType === 'Sale' && tx.currency?.type === 'Robux') {\r\n        // Skip if already processed (check by purchaseToken)\r\n        if (tx.purchaseToken && seenTokens.has(tx.purchaseToken)) {\r\n          continue;\r\n        }\r\n        if (tx.purchaseToken) {\r\n          seenTokens.add(tx.purchaseToken);\r\n        }\r\n\r\n        // Extract user ID from agent (the buyer)\r\n        userId = tx.agent?.id;\r\n        if (!userId) continue;\r\n\r\n        // Extract price (in Robux, after Roblox takes 30% tax)\r\n        // Add back the 30% tax to get the actual amount the user paid\r\n        const priceAfterTax = tx.currency?.amount || 0;\r\n        if (priceAfterTax <= 0) continue;\r\n        // Calculate actual price: priceAfterTax / 0.7 = priceBeforeTax\r\n        // Example: 70 Robux after tax = 100 Robux before tax\r\n        price = Math.round(priceAfterTax / 0.7);\r\n      } else {\r\n        // Unknown format, skip\r\n        continue;\r\n      }\r\n\r\n      // Increment totals for this user\r\n      const userIdStr = String(userId);\r\n      const purchaseKey = `purchase:${userIdStr}`;\r\n      const existing = await kv.get(purchaseKey);\r\n      \r\n      let totalSpent = price;\r\n      let purchases = 1;\r\n      \r\n      if (existing) {\r\n        try {\r\n          const existingData = JSON.parse(existing);\r\n          totalSpent = (existingData.totalSpent || 0) + price;\r\n          purchases = (existingData.purchases || 0) + 1;\r\n        } catch (e) {\r\n          console.error('Failed to parse existing purchase data:', e);\r\n        }\r\n      }\r\n\r\n      await replaceUserTotals(kv, userId, totalSpent, purchases);\r\n      processed.push({\r\n        userId: userIdStr,\r\n        price,\r\n        totalSpent,\r\n        purchases\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({\r\n      status: 'ok',\r\n      processed: processed.length,\r\n      transactions: processed\r\n    }), {\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  } catch (e) {\r\n    console.error('Webhook processing error:', e);\r\n    return new Response(JSON.stringify({ error: e.message }), {\r\n      status: 500,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*'\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function onRequest(context) {\r\n  const { request, env } = context;\r\n  const kv = env.DONATIONS_KV;\r\n  const url = new URL(request.url);\r\n\r\n  const corsHeaders = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n  };\r\n\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, { status: 204, headers: corsHeaders });\r\n  }\r\n\r\n  // Scheduled fetch mode (for cron trigger)\r\n  const mode = url.searchParams.get('mode');\r\n  if (mode === 'fetch' && request.method === 'GET') {\r\n    return handleScheduledFetch(request, env, kv);\r\n  }\r\n\r\n  // Webhook endpoint via query parameter (from Roblox game)\r\n  // Can also be called as /api/donations/webhook via donations/webhook.js\r\n  const isWebhook = url.searchParams.get('webhook') === 'true' || url.pathname.endsWith('/webhook');\r\n  if (isWebhook && request.method === 'POST') {\r\n    return handleWebhook(request, env, kv);\r\n  }\r\n\r\n  // Legacy POST endpoint (backward compatibility)\r\n  if (request.method === 'POST') {\r\n    try {\r\n      const { userId, productId, price } = await request.json();\r\n      if (!userId || !productId || typeof price !== 'number') {\r\n        return new Response(JSON.stringify({ error: 'Missing or invalid fields' }), {\r\n          status: 400,\r\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n        });\r\n      }\r\n\r\n      // Legacy endpoint still increments (for backward compatibility)\r\n      const userIdStr = String(userId);\r\n      const purchaseKey = `purchase:${userIdStr}`;\r\n      const existing = await kv.get(purchaseKey);\r\n      \r\n      let totalSpent = price;\r\n      let purchases = 1;\r\n      \r\n      if (existing) {\r\n        try {\r\n          const data = JSON.parse(existing);\r\n          totalSpent = (data.totalSpent || 0) + price;\r\n          purchases = (data.purchases || 0) + 1;\r\n        } catch (e) {\r\n          console.error('Failed to parse existing purchase data:', e);\r\n        }\r\n      }\r\n\r\n      const result = await replaceUserTotals(kv, userId, totalSpent, purchases);\r\n\r\n      return new Response(JSON.stringify({ status: 'ok', ...result }), {\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      });\r\n    } catch (e) {\r\n      return new Response(JSON.stringify({ error: e.message }), {\r\n        status: 500,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n  }\r\n\r\n  // GET endpoint - returns leaderboard\r\n  if (request.method === 'GET') {\r\n    try {\r\n      const list = await kv.list({ prefix: 'purchase:', limit: 1000 });\r\n\r\n      const users = await Promise.all(\r\n        list.keys.map(async (entry) => {\r\n          const raw = await kv.get(entry.name);\r\n          if (!raw) return null;\r\n\r\n          try {\r\n            const data = JSON.parse(raw);\r\n            const userId = data.userId;\r\n\r\n            // Fetch user profile from roblox-proxy\r\n            const res = await fetch(`https://emwiki.com/api/roblox-proxy?userId=${userId}&mode=lite`);\r\n            const profile = res.ok ? await res.json() : {};\r\n\r\n            return {\r\n              userId,\r\n              totalSpent: data.totalSpent || 0,\r\n              purchases: data.purchases || 0,\r\n              name: profile.name || null,\r\n              displayName: profile.displayName || null,\r\n              avatar: profile.avatar || null,\r\n            };\r\n          } catch (err) {\r\n            console.error('Failed to parse user data:', err);\r\n            return null;\r\n          }\r\n        })\r\n      );\r\n\r\n      const filtered = users.filter(Boolean);\r\n      filtered.sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));\r\n\r\n      const limit = parseInt(url.searchParams.get('limit') || '50');\r\n      return new Response(JSON.stringify(filtered.slice(0, limit)), {\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n      });\r\n    } catch (e) {\r\n      return new Response(JSON.stringify({ error: e.message }), {\r\n        status: 500,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n  }\r\n\r\n  return new Response(JSON.stringify({ error: 'Not found' }), {\r\n    status: 404,\r\n    headers: { ...corsHeaders, 'Content-Type': 'application/json' }\r\n  });\r\n}", "export async function onRequest(context) {\r\n  const { request } = context;\r\n  const corsHeaders = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Origin\": \"*\",\r\n    \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\r\n    \"Access-Control-Allow-Headers\": \"Content-Type\"\r\n  };\r\n\r\n  // Handle CORS preflight\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, { headers: corsHeaders });\r\n  }\r\n\r\n  if (request.method === 'GET') {\r\n    return await onRequestGet(context, corsHeaders);\r\n  }\r\n\r\n  if (request.method === 'POST') {\r\n    return await onRequestPost(context, corsHeaders);\r\n  }\r\n\r\n  return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n    status: 405,\r\n    headers: corsHeaders\r\n  });\r\n}\r\n\r\nasync function onRequestGet(context, corsHeaders) {\r\n  const DBH = context.env.DBH;\r\n\r\n  try {\r\n    const result = await DBH.prepare(`\r\n      SELECT id, timestamp, username, diff, version\r\n      FROM history\r\n      ORDER BY timestamp DESC\r\n      LIMIT 50\r\n    `).all();\r\n\r\n    const data = result?.results ?? [];\r\n\r\n    return new Response(JSON.stringify(data), {\r\n      status: 200,\r\n      headers: corsHeaders\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ error: err.message, stack: err.stack }), {\r\n      status: 500,\r\n      headers: corsHeaders\r\n    });\r\n  }\r\n}\r\n\r\nasync function onRequestPost(context, corsHeaders) {\r\n  const DBH = context.env.DBH;\r\n\r\n  try {\r\n    const body = await context.request.json();\r\n    const { username, diff, version } = body;\r\n\r\n    if (!diff) {\r\n      return new Response(JSON.stringify({ error: \"diff is required\" }), {\r\n        status: 400,\r\n        headers: corsHeaders\r\n      });\r\n    }\r\n\r\n    const timestamp = new Date().toISOString();\r\n    const finalUsername = username || \"unknown\";\r\n    const finalVersion = version || null;\r\n\r\n    await DBH.prepare(`\r\n      INSERT INTO history (timestamp, username, diff, version)\r\n      VALUES (?, ?, ?, ?)\r\n    `).bind(timestamp, finalUsername, diff, finalVersion).run();\r\n\r\n    return new Response(JSON.stringify({ \r\n      success: true, \r\n      message: \"History entry saved\" \r\n    }), {\r\n      status: 200,\r\n      headers: corsHeaders\r\n    });\r\n  } catch (err) {\r\n    return new Response(JSON.stringify({ \r\n      error: err.message, \r\n      stack: err.stack \r\n    }), {\r\n      status: 500,\r\n      headers: corsHeaders\r\n    });\r\n  }\r\n}", "// Gallery Post Embed - Server-side rendered page for Discord/social media embeds\nexport async function onRequest(context) {\n  const { params, request, env } = context;\n  const postId = params.id;\n  const base = 'https://emwiki.com';\n\n  // Helper: bot detection for Discord, Twitter, Facebook crawlers\n  function isBot(ua) {\n    return /bot|crawler|spider|facebookexternalhit|twitterbot|slackbot|discordbot|whatsapp/i.test(ua);\n  }\n\n  const userAgent = request.headers.get('user-agent') || '';\n\n  // Redirect normal users to gallery page with hash\n  if (!isBot(userAgent)) {\n    return Response.redirect(`${base}/gallery#post-${postId}`, 302);\n  }\n\n  try {\n    // Fetch gallery post data from API\n    const galleryItem = await env.DBA.prepare(`\n      SELECT\n        g.id,\n        g.title,\n        g.description,\n        g.media_url,\n        g.thumbnail_url,\n        g.views,\n        g.likes,\n        g.created_at,\n        u.username,\n        u.display_name\n      FROM gallery_items g\n      LEFT JOIN users u ON g.user_id = u.user_id\n      WHERE g.id = ? AND g.status = 1\n    `).bind(postId).first();\n\n    if (!galleryItem) {\n      return new Response('Gallery post not found', { status: 404 });\n    }\n\n    // Helper to determine media type from URL\n    const getMediaType = (url) => {\n      if (!url) return 'image';\n      const ext = url.split('.').pop().toLowerCase();\n      const videoExts = ['mp4', 'webm', 'mov'];\n      return videoExts.includes(ext) ? 'video' : 'image';\n    };\n\n    // Parse JSON fields\n    const likes = JSON.parse(galleryItem.likes || '[]');\n    const mediaType = getMediaType(galleryItem.media_url);\n    let viewsCount = galleryItem.views || 0;\n\n    // Sanitize data for HTML\n    const title = escapeHtml(galleryItem.title || 'Gallery Post');\n    const description = escapeHtml(galleryItem.description || '');\n    const author = escapeHtml(galleryItem.display_name || galleryItem.username || 'Unknown');\n    const likesCount = likes.length;\n\n    // Use thumbnail for videos, direct URL for images\n    const imageUrl = mediaType === 'video' && galleryItem.thumbnail_url\n      ? galleryItem.thumbnail_url\n      : galleryItem.media_url;\n\n    // Format metadata description with stats\n    const metaDescription = description\n      ? `${description} \u2022 ${likesCount} likes \u2022 ${viewsCount} views`\n      : `${likesCount} likes \u2022 ${viewsCount} views \u2022 Posted by ${author}`;\n\n    // Generate HTML with OpenGraph tags\n    return new Response(`<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n<title>${title} - Epic Wiki Gallery</title>\n\n<!-- OpenGraph tags for Discord/Facebook -->\n<meta property=\"og:type\" content=\"article\" />\n<meta property=\"og:title\" content=\"${title}\" />\n<meta property=\"og:description\" content=\"${metaDescription}\" />\n<meta property=\"og:image\" content=\"${imageUrl}\" />\n<meta property=\"og:url\" content=\"${base}/gallery/${postId}\" />\n<meta property=\"og:site_name\" content=\"Epic Wiki Gallery\" />\n\n<!-- Twitter Card tags -->\n<meta name=\"twitter:card\" content=\"summary_large_image\" />\n<meta name=\"twitter:title\" content=\"${title}\" />\n<meta name=\"twitter:description\" content=\"${metaDescription}\" />\n<meta name=\"twitter:image\" content=\"${imageUrl}\" />\n\n<!-- Additional metadata -->\n<meta property=\"article:author\" content=\"${author}\" />\n<meta property=\"article:published_time\" content=\"${galleryItem.created_at}\" />\n\n<!-- Theme color for Discord embed -->\n<meta name=\"theme-color\" content=\"#667eea\" />\n</head>\n<body>\n<script>\n  // Redirect to gallery page with hash for users with JS enabled\n  window.location.href = '${base}/gallery#post-${postId}';\n</script>\n<noscript>\n  <meta http-equiv=\"refresh\" content=\"0; url=${base}/gallery#post-${postId}\" />\n</noscript>\n</body>\n</html>`, {\n      headers: {\n        'Content-Type': 'text/html',\n        'Cache-Control': 'public, max-age=300' // Cache for 5 minutes\n      }\n    });\n\n  } catch (error) {\n    console.error('Gallery embed error:', error);\n    return new Response(`Error loading gallery post: ${error.message}`, {\n      status: 500,\n      headers: { 'Content-Type': 'text/plain' }\n    });\n  }\n}\n\n// Helper to escape HTML special chars\nfunction escapeHtml(text) {\n  if (!text) return '';\n  return text\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n}\n", "// Profile Page with Dynamic Meta Tags for Discord/social media embeds\r\nexport async function onRequest(context) {\r\n  const { params, request, env } = context;\r\n  const userId = params.userId;\r\n  const base = 'https://emwiki.com';\r\n\r\n  // Helper: bot detection for Discord, Twitter, Facebook crawlers\r\n  function isBot(ua) {\r\n    return /bot|crawler|spider|facebookexternalhit|twitterbot|slackbot|discordbot|whatsapp/i.test(ua);\r\n  }\r\n\r\n  const userAgent = request.headers.get('user-agent') || '';\r\n\r\n  try {\r\n    // Fetch user data from database\r\n    const user = await env.DBA.prepare(`\r\n      SELECT\r\n        user_id,\r\n        username,\r\n        display_name,\r\n        avatar_url,\r\n        role,\r\n        created_at,\r\n        last_online\r\n      FROM users\r\n      WHERE user_id = ?\r\n    `).bind(userId).first();\r\n\r\n    if (!user) {\r\n      return new Response('User not found', { status: 404 });\r\n    }\r\n\r\n    // Get user trade stats\r\n    let stats = null;\r\n    try {\r\n      stats = await env.DBA.prepare(`\r\n        SELECT\r\n          total_trades,\r\n          successful_trades,\r\n          average_rating,\r\n          total_reviews\r\n        FROM user_trade_stats\r\n        WHERE user_id = ?\r\n      `).bind(userId).first();\r\n    } catch (e) {\r\n      console.error('Failed to fetch user_trade_stats:', e);\r\n      stats = null;\r\n    }\r\n\r\n    // Parse roles\r\n    let roles;\r\n    try {\r\n      roles = user.role ? JSON.parse(user.role) : ['user'];\r\n    } catch (e) {\r\n      roles = ['user'];\r\n    }\r\n\r\n    // Sanitize data for HTML\r\n    const displayName = escapeHtml(user.display_name || user.username);\r\n    const username = escapeHtml(user.username);\r\n    const avatarUrl = user.avatar_url || 'https://emwiki.com/imgs/placeholder.png';\r\n\r\n    // Build description with stats\r\n    const totalTrades = stats?.total_trades || 0;\r\n    const rating = stats?.average_rating || 0;\r\n    const reviews = stats?.total_reviews || 0;\r\n\r\n    const rolesBadges = roles.filter(r => r !== 'user').map(r => r.toUpperCase()).join(', ');\r\n    const rolesText = rolesBadges ? ` \u2022 ${rolesBadges}` : '';\r\n\r\n    const metaDescription = `@${username}${rolesText} \u2022 ${totalTrades} trades \u2022 ${rating.toFixed(1)}\u2B50 rating (${reviews} reviews)`;\r\n\r\n    // If it's a bot, serve static HTML with OpenGraph tags\r\n    if (isBot(userAgent)) {\r\n      return new Response(`<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n<meta charset=\"UTF-8\" />\r\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n<title>${displayName} - EMwiki</title>\r\n\r\n<!-- OpenGraph tags for Discord/Facebook -->\r\n<meta property=\"og:type\" content=\"profile\" />\r\n<meta property=\"og:title\" content=\"${displayName}\" />\r\n<meta property=\"og:description\" content=\"${metaDescription}\" />\r\n<meta property=\"og:image\" content=\"${avatarUrl}\" />\r\n<meta property=\"og:url\" content=\"${base}/profile/${userId}\" />\r\n<meta property=\"og:site_name\" content=\"EMwiki\" />\r\n\r\n<!-- Twitter Card tags -->\r\n<meta name=\"twitter:card\" content=\"summary\" />\r\n<meta name=\"twitter:title\" content=\"${displayName}\" />\r\n<meta name=\"twitter:description\" content=\"${metaDescription}\" />\r\n<meta name=\"twitter:image\" content=\"${avatarUrl}\" />\r\n\r\n<!-- Profile metadata -->\r\n<meta property=\"profile:username\" content=\"${username}\" />\r\n\r\n<!-- Theme color for Discord embed -->\r\n<meta name=\"theme-color\" content=\"#667eea\" />\r\n</head>\r\n<body>\r\n<h1>${displayName}</h1>\r\n<p>${metaDescription}</p>\r\n</body>\r\n</html>`, {\r\n        headers: {\r\n          'Content-Type': 'text/html',\r\n          'Cache-Control': 'public, max-age=300' // Cache for 5 minutes\r\n        }\r\n      });\r\n    }\r\n\r\n    // For regular users, fetch and serve profile.html from assets\r\n    // The JavaScript in profile.html will parse the URL path\r\n    try {\r\n      const profileAsset = await env.ASSETS.fetch(`${base}/profile.html`);\r\n      let html = await profileAsset.text();\r\n\r\n      // Replace meta tags with dynamic ones for better SEO and sharing\r\n      html = html.replace(\r\n        /<title>.*?<\\/title>/,\r\n        `<title>${displayName} - EMwiki</title>`\r\n      );\r\n\r\n      html = html.replace(\r\n        /<meta name=\"description\" content=\".*?\">/,\r\n        `<meta name=\"description\" content=\"${metaDescription}\">`\r\n      );\r\n\r\n      html = html.replace(\r\n        /<meta property=\"og:title\" content=\".*?\">/,\r\n        `<meta property=\"og:title\" content=\"${displayName}\">`\r\n      );\r\n\r\n      // Add og:description if not present, otherwise replace\r\n      if (!html.includes('og:description')) {\r\n        html = html.replace(\r\n          /<meta property=\"og:image\"/,\r\n          `<meta property=\"og:description\" content=\"${metaDescription}\">\\n    <meta property=\"og:image\"`\r\n        );\r\n      } else {\r\n        html = html.replace(\r\n          /<meta property=\"og:description\" content=\".*?\">/,\r\n          `<meta property=\"og:description\" content=\"${metaDescription}\">`\r\n        );\r\n      }\r\n\r\n      html = html.replace(\r\n        /<meta property=\"og:image\" content=\".*?\">/,\r\n        `<meta property=\"og:image\" content=\"${avatarUrl}\">`\r\n      );\r\n\r\n      return new Response(html, {\r\n        headers: {\r\n          'Content-Type': 'text/html',\r\n          'Cache-Control': 'public, max-age=60'\r\n        }\r\n      });\r\n    } catch (assetError) {\r\n      console.error('Failed to fetch profile.html from assets:', assetError);\r\n      // Fallback: redirect to profile.html and let it handle the URL\r\n      return Response.redirect(`${base}/profile.html`, 302);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('Profile embed error:', error);\r\n    return new Response(`Error loading profile: ${error.message}`, {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'text/plain' }\r\n    });\r\n  }\r\n}\r\n\r\n// Helper to escape HTML special chars\r\nfunction escapeHtml(text) {\r\n  if (!text) return '';\r\n  return text\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#039;\");\r\n}\r\n", "export async function onRequest(context) {\r\n  const url = new URL(context.request.url);\r\n\r\n  // Allow all /api/* through without rerouting\r\n  if (url.pathname.startsWith(\"/api/\")) {\r\n    return await context.next();\r\n  }\r\n\r\n  // Redirect old profile URLs to new format\r\n  // /profile?user=X or /profile.html?user=X -> /profile/X\r\n  if ((url.pathname === \"/profile\" || url.pathname === \"/profile.html\") && url.searchParams.has(\"user\")) {\r\n    const userId = url.searchParams.get(\"user\").replace(/\\.0$/, ''); // Remove .0 suffix\r\n    return Response.redirect(`https://emwiki.com/profile/${userId}`, 301);\r\n  }\r\n\r\n  const item = url.searchParams.get(\"item\");\r\n  const userAgent = context.request.headers.get(\"user-agent\")?.toLowerCase() || \"\";\r\n  const isBot = userAgent.includes(\"discordbot\") || userAgent.includes(\"bot\");\r\n\r\n  if (item && isBot) {\r\n    return Response.redirect(`https://emwiki.com/api/embed/${encodeURIComponent(item)}`, 302);\r\n  }\r\n\r\n  return await context.next();\r\n}\r\n", "import { onRequest as __api_forum_comments___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\forum\\\\comments\\\\[[path]].js\"\nimport { onRequest as __api_forum_posts___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\forum\\\\posts\\\\[[path]].js\"\nimport { onRequest as __api_trades_listings___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\trades\\\\listings\\\\[[path]].js\"\nimport { onRequest as __api_trades_messages___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\trades\\\\messages\\\\[[path]].js\"\nimport { onRequest as __api_trades_notifications___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\trades\\\\notifications\\\\[[path]].js\"\nimport { onRequest as __api_trades_offers___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\trades\\\\offers\\\\[[path]].js\"\nimport { onRequest as __api_trades_reviews___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\trades\\\\reviews\\\\[[path]].js\"\nimport { onRequestOptions as __api_images_upload_js_onRequestOptions } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\images\\\\upload.js\"\nimport { onRequestPost as __api_images_upload_js_onRequestPost } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\images\\\\upload.js\"\nimport { onRequest as __api_cron_refresh_avatars_js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\cron\\\\refresh-avatars.js\"\nimport { onRequest as __api_donations_webhook_js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\donations\\\\webhook.js\"\nimport { onRequest as __api_embed__item__js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\embed\\\\[item].js\"\nimport { onRequestDelete as __api_gallery___path___js_onRequestDelete } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\gallery\\\\[[path]].js\"\nimport { onRequestGet as __api_gallery___path___js_onRequestGet } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\gallery\\\\[[path]].js\"\nimport { onRequestOptions as __api_gallery___path___js_onRequestOptions } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\gallery\\\\[[path]].js\"\nimport { onRequestPost as __api_gallery___path___js_onRequestPost } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\gallery\\\\[[path]].js\"\nimport { onRequest as __api_auth___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\auth\\\\[[path]].js\"\nimport { onRequest as __api_demand___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\demand\\\\[[path]].js\"\nimport { onRequest as __api_images___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\images\\\\[[path]].js\"\nimport { onRequest as __api_items___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\items\\\\[[path]].js\"\nimport { onRequest as __api_profile___path___js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\profile\\\\[[path]].js\"\nimport { onRequestPost as __api_admin_login_js_onRequestPost } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\admin-login.js\"\nimport { onRequestGet as __api_check_session_js_onRequestGet } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\check-session.js\"\nimport { onRequestGet as __api_latest_version_js_onRequestGet } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\latest-version.js\"\nimport { onRequestPost as __api_logout_js_onRequestPost } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\logout.js\"\nimport { onRequestGet as __api_roblox_proxy_js_onRequestGet } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\roblox-proxy.js\"\nimport { onRequestPost as __api_upload_js_onRequestPost } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\upload.js\"\nimport { onRequest as __api_donations_js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\donations.js\"\nimport { onRequest as __api_history_js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\api\\\\history.js\"\nimport { onRequest as __gallery__id__js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\gallery\\\\[id].js\"\nimport { onRequest as __profile__userId__js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\profile\\\\[userId].js\"\nimport { onRequest as ___middleware_js_onRequest } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\functions\\\\_middleware.js\"\n\nexport const routes = [\n    {\n      routePath: \"/api/forum/comments/:path*\",\n      mountPath: \"/api/forum/comments\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_forum_comments___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/forum/posts/:path*\",\n      mountPath: \"/api/forum/posts\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_forum_posts___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/trades/listings/:path*\",\n      mountPath: \"/api/trades/listings\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_trades_listings___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/trades/messages/:path*\",\n      mountPath: \"/api/trades/messages\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_trades_messages___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/trades/notifications/:path*\",\n      mountPath: \"/api/trades/notifications\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_trades_notifications___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/trades/offers/:path*\",\n      mountPath: \"/api/trades/offers\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_trades_offers___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/trades/reviews/:path*\",\n      mountPath: \"/api/trades/reviews\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_trades_reviews___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/images/upload\",\n      mountPath: \"/api/images\",\n      method: \"OPTIONS\",\n      middlewares: [],\n      modules: [__api_images_upload_js_onRequestOptions],\n    },\n  {\n      routePath: \"/api/images/upload\",\n      mountPath: \"/api/images\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_images_upload_js_onRequestPost],\n    },\n  {\n      routePath: \"/api/cron/refresh-avatars\",\n      mountPath: \"/api/cron\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_cron_refresh_avatars_js_onRequest],\n    },\n  {\n      routePath: \"/api/donations/webhook\",\n      mountPath: \"/api/donations\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_donations_webhook_js_onRequest],\n    },\n  {\n      routePath: \"/api/embed/:item\",\n      mountPath: \"/api/embed\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_embed__item__js_onRequest],\n    },\n  {\n      routePath: \"/api/gallery/:path*\",\n      mountPath: \"/api/gallery\",\n      method: \"DELETE\",\n      middlewares: [],\n      modules: [__api_gallery___path___js_onRequestDelete],\n    },\n  {\n      routePath: \"/api/gallery/:path*\",\n      mountPath: \"/api/gallery\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_gallery___path___js_onRequestGet],\n    },\n  {\n      routePath: \"/api/gallery/:path*\",\n      mountPath: \"/api/gallery\",\n      method: \"OPTIONS\",\n      middlewares: [],\n      modules: [__api_gallery___path___js_onRequestOptions],\n    },\n  {\n      routePath: \"/api/gallery/:path*\",\n      mountPath: \"/api/gallery\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_gallery___path___js_onRequestPost],\n    },\n  {\n      routePath: \"/api/auth/:path*\",\n      mountPath: \"/api/auth\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_auth___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/demand/:path*\",\n      mountPath: \"/api/demand\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_demand___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/images/:path*\",\n      mountPath: \"/api/images\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_images___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/items/:path*\",\n      mountPath: \"/api/items\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_items___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/profile/:path*\",\n      mountPath: \"/api/profile\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_profile___path___js_onRequest],\n    },\n  {\n      routePath: \"/api/admin-login\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_admin_login_js_onRequestPost],\n    },\n  {\n      routePath: \"/api/check-session\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_check_session_js_onRequestGet],\n    },\n  {\n      routePath: \"/api/latest-version\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_latest_version_js_onRequestGet],\n    },\n  {\n      routePath: \"/api/logout\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_logout_js_onRequestPost],\n    },\n  {\n      routePath: \"/api/roblox-proxy\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_roblox_proxy_js_onRequestGet],\n    },\n  {\n      routePath: \"/api/upload\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_upload_js_onRequestPost],\n    },\n  {\n      routePath: \"/api/donations\",\n      mountPath: \"/api\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_donations_js_onRequest],\n    },\n  {\n      routePath: \"/api/history\",\n      mountPath: \"/api\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_history_js_onRequest],\n    },\n  {\n      routePath: \"/gallery/:id\",\n      mountPath: \"/gallery\",\n      method: \"\",\n      middlewares: [],\n      modules: [__gallery__id__js_onRequest],\n    },\n  {\n      routePath: \"/profile/:userId\",\n      mountPath: \"/profile\",\n      method: \"\",\n      middlewares: [],\n      modules: [__profile__userId__js_onRequest],\n    },\n  {\n      routePath: \"/\",\n      mountPath: \"/\",\n      method: \"\",\n      middlewares: [___middleware_js_onRequest],\n      modules: [],\n    },\n  ]", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\.wrangler\\\\tmp\\\\bundle-Aa1sFN\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\ADMIN\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\.wrangler\\\\tmp\\\\bundle-Aa1sFN\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\ADMIN\\\\Desktop\\\\EpicCatalogue\\\\emwiki\\\\.wrangler\\\\tmp\\\\bundle-Aa1sFN\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\ADMIN\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\pages-template-worker.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\ADMIN\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\ADMIN\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\ADMIN\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\pages-template-worker.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { match } from \"path-to-regexp\";\n\n//note: this explicitly does not include the * character, as pages requires this\nconst escapeRegex = /[.+?^${}()|[\\]\\\\]/g;\n\ntype HTTPMethod =\n\t| \"HEAD\"\n\t| \"OPTIONS\"\n\t| \"GET\"\n\t| \"POST\"\n\t| \"PUT\"\n\t| \"PATCH\"\n\t| \"DELETE\";\n\n/* TODO: Grab these from @cloudflare/workers-types instead */\ntype Params<P extends string = string> = Record<P, string | string[]>;\n\ntype EventContext<Env, P extends string, Data> = {\n\trequest: Request;\n\tfunctionPath: string;\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n\tnext: (input?: Request | string, init?: RequestInit) => Promise<Response>;\n\tenv: Env & { ASSETS: { fetch: typeof fetch } };\n\tparams: Params<P>;\n\tdata: Data;\n};\n\ndeclare type PagesFunction<\n\tEnv = unknown,\n\tP extends string = string,\n\tData extends Record<string, unknown> = Record<string, unknown>,\n> = (context: EventContext<Env, P, Data>) => Response | Promise<Response>;\n/* end @cloudflare/workers-types */\n\ntype RouteHandler = {\n\troutePath: string;\n\tmountPath: string;\n\tmethod?: HTTPMethod;\n\tmodules: PagesFunction[];\n\tmiddlewares: PagesFunction[];\n};\n\n// inject `routes` via ESBuild\ndeclare const routes: RouteHandler[];\n// define `__FALLBACK_SERVICE__` via ESBuild\ndeclare const __FALLBACK_SERVICE__: string;\n\n// expect an ASSETS fetcher binding pointing to the asset-server stage\ntype FetchEnv = {\n\t[name: string]: { fetch: typeof fetch };\n\tASSETS: { fetch: typeof fetch };\n};\n\ntype WorkerContext = {\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n};\n\nfunction* executeRequest(request: Request) {\n\tconst requestPath = new URL(request.url).pathname;\n\n\t// First, iterate through the routes (backwards) and execute \"middlewares\" on partial route matches\n\tfor (const route of [...routes].reverse()) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\n\t\t// replaces with \"\\\\$&\", this prepends a backslash to the matched string, e.g. \"[\" becomes \"\\[\"\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult) {\n\t\t\tfor (const handler of route.middlewares.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: mountMatchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\t// Then look for the first exact route match and execute its \"modules\"\n\tfor (const route of routes) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: true,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult && route.modules.length) {\n\t\t\tfor (const handler of route.modules.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: matchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nexport default {\n\tasync fetch(\n\t\toriginalRequest: Request,\n\t\tenv: FetchEnv,\n\t\tworkerContext: WorkerContext\n\t) {\n\t\tlet request = originalRequest;\n\t\tconst handlerIterator = executeRequest(request);\n\t\tlet data = {}; // arbitrary data the user can set between functions\n\t\tlet isFailOpen = false;\n\n\t\tconst next = async (input?: RequestInfo, init?: RequestInit) => {\n\t\t\tif (input !== undefined) {\n\t\t\t\tlet url = input;\n\t\t\t\tif (typeof input === \"string\") {\n\t\t\t\t\turl = new URL(input, request.url).toString();\n\t\t\t\t}\n\t\t\t\trequest = new Request(url, init);\n\t\t\t}\n\n\t\t\tconst result = handlerIterator.next();\n\t\t\t// Note we can't use `!result.done` because this doesn't narrow to the correct type\n\t\t\tif (result.done === false) {\n\t\t\t\tconst { handler, params, path } = result.value;\n\t\t\t\tconst context = {\n\t\t\t\t\trequest: new Request(request.clone()),\n\t\t\t\t\tfunctionPath: path,\n\t\t\t\t\tnext,\n\t\t\t\t\tparams,\n\t\t\t\t\tget data() {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t},\n\t\t\t\t\tset data(value) {\n\t\t\t\t\t\tif (typeof value !== \"object\" || value === null) {\n\t\t\t\t\t\t\tthrow new Error(\"context.data must be an object\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// user has overriden context.data, so we need to merge it with the existing data\n\t\t\t\t\t\tdata = value;\n\t\t\t\t\t},\n\t\t\t\t\tenv,\n\t\t\t\t\twaitUntil: workerContext.waitUntil.bind(workerContext),\n\t\t\t\t\tpassThroughOnException: () => {\n\t\t\t\t\t\tisFailOpen = true;\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tconst response = await handler(context);\n\n\t\t\t\tif (!(response instanceof Response)) {\n\t\t\t\t\tthrow new Error(\"Your Pages function should return a Response\");\n\t\t\t\t}\n\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else if (__FALLBACK_SERVICE__) {\n\t\t\t\t// There are no more handlers so finish with the fallback service (`env.ASSETS.fetch` in Pages' case)\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else {\n\t\t\t\t// There was not fallback service so actually make the request to the origin.\n\t\t\t\tconst response = await fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\treturn await next();\n\t\t} catch (error) {\n\t\t\tif (isFailOpen) {\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t},\n};\n\n// This makes a Response mutable\nconst cloneResponse = (response: Response) =>\n\t// https://fetch.spec.whatwg.org/#null-body-status\n\tnew Response(\n\t\t[101, 204, 205, 304].includes(response.status) ? null : response.body,\n\t\tresponse\n\t);\n", "/**\n * Tokenizer results.\n */\ninterface LexToken {\n  type:\n    | \"OPEN\"\n    | \"CLOSE\"\n    | \"PATTERN\"\n    | \"NAME\"\n    | \"CHAR\"\n    | \"ESCAPED_CHAR\"\n    | \"MODIFIER\"\n    | \"END\";\n  index: number;\n  value: string;\n}\n\n/**\n * Tokenize input string.\n */\nfunction lexer(str: string): LexToken[] {\n  const tokens: LexToken[] = [];\n  let i = 0;\n\n  while (i < str.length) {\n    const char = str[i];\n\n    if (char === \"*\" || char === \"+\" || char === \"?\") {\n      tokens.push({ type: \"MODIFIER\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"\\\\\") {\n      tokens.push({ type: \"ESCAPED_CHAR\", index: i++, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"{\") {\n      tokens.push({ type: \"OPEN\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"}\") {\n      tokens.push({ type: \"CLOSE\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \":\") {\n      let name = \"\";\n      let j = i + 1;\n\n      while (j < str.length) {\n        const code = str.charCodeAt(j);\n\n        if (\n          // `0-9`\n          (code >= 48 && code <= 57) ||\n          // `A-Z`\n          (code >= 65 && code <= 90) ||\n          // `a-z`\n          (code >= 97 && code <= 122) ||\n          // `_`\n          code === 95\n        ) {\n          name += str[j++];\n          continue;\n        }\n\n        break;\n      }\n\n      if (!name) throw new TypeError(`Missing parameter name at ${i}`);\n\n      tokens.push({ type: \"NAME\", index: i, value: name });\n      i = j;\n      continue;\n    }\n\n    if (char === \"(\") {\n      let count = 1;\n      let pattern = \"\";\n      let j = i + 1;\n\n      if (str[j] === \"?\") {\n        throw new TypeError(`Pattern cannot start with \"?\" at ${j}`);\n      }\n\n      while (j < str.length) {\n        if (str[j] === \"\\\\\") {\n          pattern += str[j++] + str[j++];\n          continue;\n        }\n\n        if (str[j] === \")\") {\n          count--;\n          if (count === 0) {\n            j++;\n            break;\n          }\n        } else if (str[j] === \"(\") {\n          count++;\n          if (str[j + 1] !== \"?\") {\n            throw new TypeError(`Capturing groups are not allowed at ${j}`);\n          }\n        }\n\n        pattern += str[j++];\n      }\n\n      if (count) throw new TypeError(`Unbalanced pattern at ${i}`);\n      if (!pattern) throw new TypeError(`Missing pattern at ${i}`);\n\n      tokens.push({ type: \"PATTERN\", index: i, value: pattern });\n      i = j;\n      continue;\n    }\n\n    tokens.push({ type: \"CHAR\", index: i, value: str[i++] });\n  }\n\n  tokens.push({ type: \"END\", index: i, value: \"\" });\n\n  return tokens;\n}\n\nexport interface ParseOptions {\n  /**\n   * Set the default delimiter for repeat parameters. (default: `'/'`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters to automatically consider prefixes when parsing.\n   */\n  prefixes?: string;\n}\n\n/**\n * Parse a string for the raw tokens.\n */\nexport function parse(str: string, options: ParseOptions = {}): Token[] {\n  const tokens = lexer(str);\n  const { prefixes = \"./\", delimiter = \"/#?\" } = options;\n  const result: Token[] = [];\n  let key = 0;\n  let i = 0;\n  let path = \"\";\n\n  const tryConsume = (type: LexToken[\"type\"]): string | undefined => {\n    if (i < tokens.length && tokens[i].type === type) return tokens[i++].value;\n  };\n\n  const mustConsume = (type: LexToken[\"type\"]): string => {\n    const value = tryConsume(type);\n    if (value !== undefined) return value;\n    const { type: nextType, index } = tokens[i];\n    throw new TypeError(`Unexpected ${nextType} at ${index}, expected ${type}`);\n  };\n\n  const consumeText = (): string => {\n    let result = \"\";\n    let value: string | undefined;\n    while ((value = tryConsume(\"CHAR\") || tryConsume(\"ESCAPED_CHAR\"))) {\n      result += value;\n    }\n    return result;\n  };\n\n  const isSafe = (value: string): boolean => {\n    for (const char of delimiter) if (value.indexOf(char) > -1) return true;\n    return false;\n  };\n\n  const safePattern = (prefix: string) => {\n    const prev = result[result.length - 1];\n    const prevText = prefix || (prev && typeof prev === \"string\" ? prev : \"\");\n\n    if (prev && !prevText) {\n      throw new TypeError(\n        `Must have text between two parameters, missing text after \"${(prev as Key).name}\"`,\n      );\n    }\n\n    if (!prevText || isSafe(prevText)) return `[^${escapeString(delimiter)}]+?`;\n    return `(?:(?!${escapeString(prevText)})[^${escapeString(delimiter)}])+?`;\n  };\n\n  while (i < tokens.length) {\n    const char = tryConsume(\"CHAR\");\n    const name = tryConsume(\"NAME\");\n    const pattern = tryConsume(\"PATTERN\");\n\n    if (name || pattern) {\n      let prefix = char || \"\";\n\n      if (prefixes.indexOf(prefix) === -1) {\n        path += prefix;\n        prefix = \"\";\n      }\n\n      if (path) {\n        result.push(path);\n        path = \"\";\n      }\n\n      result.push({\n        name: name || key++,\n        prefix,\n        suffix: \"\",\n        pattern: pattern || safePattern(prefix),\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    const value = char || tryConsume(\"ESCAPED_CHAR\");\n    if (value) {\n      path += value;\n      continue;\n    }\n\n    if (path) {\n      result.push(path);\n      path = \"\";\n    }\n\n    const open = tryConsume(\"OPEN\");\n    if (open) {\n      const prefix = consumeText();\n      const name = tryConsume(\"NAME\") || \"\";\n      const pattern = tryConsume(\"PATTERN\") || \"\";\n      const suffix = consumeText();\n\n      mustConsume(\"CLOSE\");\n\n      result.push({\n        name: name || (pattern ? key++ : \"\"),\n        pattern: name && !pattern ? safePattern(prefix) : pattern,\n        prefix,\n        suffix,\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    mustConsume(\"END\");\n  }\n\n  return result;\n}\n\nexport interface TokensToFunctionOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * Function for encoding input strings for output.\n   */\n  encode?: (value: string, token: Key) => string;\n  /**\n   * When `false` the function can produce an invalid (unmatched) path. (default: `true`)\n   */\n  validate?: boolean;\n}\n\n/**\n * Compile a string to a template function for the path.\n */\nexport function compile<P extends object = object>(\n  str: string,\n  options?: ParseOptions & TokensToFunctionOptions,\n) {\n  return tokensToFunction<P>(parse(str, options), options);\n}\n\nexport type PathFunction<P extends object = object> = (data?: P) => string;\n\n/**\n * Expose a method for transforming tokens into the path function.\n */\nexport function tokensToFunction<P extends object = object>(\n  tokens: Token[],\n  options: TokensToFunctionOptions = {},\n): PathFunction<P> {\n  const reFlags = flags(options);\n  const { encode = (x: string) => x, validate = true } = options;\n\n  // Compile all the tokens into regexps.\n  const matches = tokens.map((token) => {\n    if (typeof token === \"object\") {\n      return new RegExp(`^(?:${token.pattern})$`, reFlags);\n    }\n  });\n\n  return (data: Record<string, any> | null | undefined) => {\n    let path = \"\";\n\n    for (let i = 0; i < tokens.length; i++) {\n      const token = tokens[i];\n\n      if (typeof token === \"string\") {\n        path += token;\n        continue;\n      }\n\n      const value = data ? data[token.name] : undefined;\n      const optional = token.modifier === \"?\" || token.modifier === \"*\";\n      const repeat = token.modifier === \"*\" || token.modifier === \"+\";\n\n      if (Array.isArray(value)) {\n        if (!repeat) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to not repeat, but got an array`,\n          );\n        }\n\n        if (value.length === 0) {\n          if (optional) continue;\n\n          throw new TypeError(`Expected \"${token.name}\" to not be empty`);\n        }\n\n        for (let j = 0; j < value.length; j++) {\n          const segment = encode(value[j], token);\n\n          if (validate && !(matches[i] as RegExp).test(segment)) {\n            throw new TypeError(\n              `Expected all \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n            );\n          }\n\n          path += token.prefix + segment + token.suffix;\n        }\n\n        continue;\n      }\n\n      if (typeof value === \"string\" || typeof value === \"number\") {\n        const segment = encode(String(value), token);\n\n        if (validate && !(matches[i] as RegExp).test(segment)) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n          );\n        }\n\n        path += token.prefix + segment + token.suffix;\n        continue;\n      }\n\n      if (optional) continue;\n\n      const typeOfMessage = repeat ? \"an array\" : \"a string\";\n      throw new TypeError(`Expected \"${token.name}\" to be ${typeOfMessage}`);\n    }\n\n    return path;\n  };\n}\n\nexport interface RegexpToFunctionOptions {\n  /**\n   * Function for decoding strings for params.\n   */\n  decode?: (value: string, token: Key) => string;\n}\n\n/**\n * A match result contains data about the path match.\n */\nexport interface MatchResult<P extends object = object> {\n  path: string;\n  index: number;\n  params: P;\n}\n\n/**\n * A match is either `false` (no match) or a match result.\n */\nexport type Match<P extends object = object> = false | MatchResult<P>;\n\n/**\n * The match function takes a string and returns whether it matched the path.\n */\nexport type MatchFunction<P extends object = object> = (\n  path: string,\n) => Match<P>;\n\n/**\n * Create path match function from `path-to-regexp` spec.\n */\nexport function match<P extends object = object>(\n  str: Path,\n  options?: ParseOptions & TokensToRegexpOptions & RegexpToFunctionOptions,\n) {\n  const keys: Key[] = [];\n  const re = pathToRegexp(str, keys, options);\n  return regexpToFunction<P>(re, keys, options);\n}\n\n/**\n * Create a path match function from `path-to-regexp` output.\n */\nexport function regexpToFunction<P extends object = object>(\n  re: RegExp,\n  keys: Key[],\n  options: RegexpToFunctionOptions = {},\n): MatchFunction<P> {\n  const { decode = (x: string) => x } = options;\n\n  return function (pathname: string) {\n    const m = re.exec(pathname);\n    if (!m) return false;\n\n    const { 0: path, index } = m;\n    const params = Object.create(null);\n\n    for (let i = 1; i < m.length; i++) {\n      if (m[i] === undefined) continue;\n\n      const key = keys[i - 1];\n\n      if (key.modifier === \"*\" || key.modifier === \"+\") {\n        params[key.name] = m[i].split(key.prefix + key.suffix).map((value) => {\n          return decode(value, key);\n        });\n      } else {\n        params[key.name] = decode(m[i], key);\n      }\n    }\n\n    return { path, index, params };\n  };\n}\n\n/**\n * Escape a regular expression string.\n */\nfunction escapeString(str: string) {\n  return str.replace(/([.+*?=^!:${}()[\\]|/\\\\])/g, \"\\\\$1\");\n}\n\n/**\n * Get the flags for a regexp from the options.\n */\nfunction flags(options?: { sensitive?: boolean }) {\n  return options && options.sensitive ? \"\" : \"i\";\n}\n\n/**\n * Metadata about a key.\n */\nexport interface Key {\n  name: string | number;\n  prefix: string;\n  suffix: string;\n  pattern: string;\n  modifier: string;\n}\n\n/**\n * A token is a string (nothing special) or key metadata (capture group).\n */\nexport type Token = string | Key;\n\n/**\n * Pull out keys from a regexp.\n */\nfunction regexpToRegexp(path: RegExp, keys?: Key[]): RegExp {\n  if (!keys) return path;\n\n  const groupsRegex = /\\((?:\\?<(.*?)>)?(?!\\?)/g;\n\n  let index = 0;\n  let execResult = groupsRegex.exec(path.source);\n  while (execResult) {\n    keys.push({\n      // Use parenthesized substring match if available, index otherwise\n      name: execResult[1] || index++,\n      prefix: \"\",\n      suffix: \"\",\n      modifier: \"\",\n      pattern: \"\",\n    });\n    execResult = groupsRegex.exec(path.source);\n  }\n\n  return path;\n}\n\n/**\n * Transform an array into a regexp.\n */\nfunction arrayToRegexp(\n  paths: Array<string | RegExp>,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n): RegExp {\n  const parts = paths.map((path) => pathToRegexp(path, keys, options).source);\n  return new RegExp(`(?:${parts.join(\"|\")})`, flags(options));\n}\n\n/**\n * Create a path regexp from string input.\n */\nfunction stringToRegexp(\n  path: string,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  return tokensToRegexp(parse(path, options), keys, options);\n}\n\nexport interface TokensToRegexpOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * When `true` the regexp won't allow an optional trailing delimiter to match. (default: `false`)\n   */\n  strict?: boolean;\n  /**\n   * When `true` the regexp will match to the end of the string. (default: `true`)\n   */\n  end?: boolean;\n  /**\n   * When `true` the regexp will match from the beginning of the string. (default: `true`)\n   */\n  start?: boolean;\n  /**\n   * Sets the final character for non-ending optimistic matches. (default: `/`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters that can also be \"end\" characters.\n   */\n  endsWith?: string;\n  /**\n   * Encode path tokens for use in the `RegExp`.\n   */\n  encode?: (value: string) => string;\n}\n\n/**\n * Expose a function for taking tokens and returning a RegExp.\n */\nexport function tokensToRegexp(\n  tokens: Token[],\n  keys?: Key[],\n  options: TokensToRegexpOptions = {},\n) {\n  const {\n    strict = false,\n    start = true,\n    end = true,\n    encode = (x: string) => x,\n    delimiter = \"/#?\",\n    endsWith = \"\",\n  } = options;\n  const endsWithRe = `[${escapeString(endsWith)}]|$`;\n  const delimiterRe = `[${escapeString(delimiter)}]`;\n  let route = start ? \"^\" : \"\";\n\n  // Iterate over the tokens and create our regexp string.\n  for (const token of tokens) {\n    if (typeof token === \"string\") {\n      route += escapeString(encode(token));\n    } else {\n      const prefix = escapeString(encode(token.prefix));\n      const suffix = escapeString(encode(token.suffix));\n\n      if (token.pattern) {\n        if (keys) keys.push(token);\n\n        if (prefix || suffix) {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            const mod = token.modifier === \"*\" ? \"?\" : \"\";\n            route += `(?:${prefix}((?:${token.pattern})(?:${suffix}${prefix}(?:${token.pattern}))*)${suffix})${mod}`;\n          } else {\n            route += `(?:${prefix}(${token.pattern})${suffix})${token.modifier}`;\n          }\n        } else {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            throw new TypeError(\n              `Can not repeat \"${token.name}\" without a prefix and suffix`,\n            );\n          }\n\n          route += `(${token.pattern})${token.modifier}`;\n        }\n      } else {\n        route += `(?:${prefix}${suffix})${token.modifier}`;\n      }\n    }\n  }\n\n  if (end) {\n    if (!strict) route += `${delimiterRe}?`;\n\n    route += !options.endsWith ? \"$\" : `(?=${endsWithRe})`;\n  } else {\n    const endToken = tokens[tokens.length - 1];\n    const isEndDelimited =\n      typeof endToken === \"string\"\n        ? delimiterRe.indexOf(endToken[endToken.length - 1]) > -1\n        : endToken === undefined;\n\n    if (!strict) {\n      route += `(?:${delimiterRe}(?=${endsWithRe}))?`;\n    }\n\n    if (!isEndDelimited) {\n      route += `(?=${delimiterRe}|${endsWithRe})`;\n    }\n  }\n\n  return new RegExp(route, flags(options));\n}\n\n/**\n * Supported `path-to-regexp` input types.\n */\nexport type Path = string | RegExp | Array<string | RegExp>;\n\n/**\n * Normalize the given path string, returning a regular expression.\n *\n * An empty array can be passed in for the keys, which will hold the\n * placeholder key descriptions. For example, using `/user/:id`, `keys` will\n * contain `[{ name: 'id', delimiter: '/', optional: false, repeat: false }]`.\n */\nexport function pathToRegexp(\n  path: Path,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  if (path instanceof RegExp) return regexpToRegexp(path, keys);\n  if (Array.isArray(path)) return arrayToRegexp(path, keys, options);\n  return stringToRegexp(path, keys, options);\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["getUserFromToken", "isAdmin", "getLikeCount", "handlePost", "handlePut", "handleDelete", "onRequest", "init_path", "handleGet", "handlePost", "handlePut", "handleDelete", "onRequest", "init_path", "handleGet", "handlePost", "onRequest", "init_path", "handleGet", "handlePost", "handleDelete", "onRequest", "init_path", "handleGet", "handlePost", "onRequest", "init_path", "handleGet", "handlePost", "handlePut", "handleDelete", "onRequest", "init_path", "onRequest", "onRequest", "onRequest", "match", "getUserFromToken", "isAdmin", "handleGet", "processedItems", "currentUser", "handlePost", "handleDelete", "onRequestPost", "onRequestOptions", "init_path", "results", "itemCounts", "error", "onRequest", "init_path", "onRequest", "init_path", "onRequest", "init_path", "onRequest", "calculateDisplayedFlikes", "typicalgroup", "init_path", "getMediaType", "url", "updateUserStats", "onRequest", "init_path", "onRequestPost", "onRequestGet", "onRequestGet", "onRequestPost", "onRequestGet", "onRequestPost", "init_upload", "replaceUserTotals", "onRequest", "onRequest", "onRequestGet", "onRequestPost", "onRequest", "getMediaType", "escapeHtml", "onRequest", "escapeHtml", "onRequest", "init_path", "init_upload", "onRequest", "onRequestOptions", "onRequestPost", "onRequestGet", "value", "_a", "result", "char", "prefix", "i"]
}
